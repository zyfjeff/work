## Tip of the Week #90: Retired Flags

> Originally posted as TotW #90 on March 19, 2015
> *by Titus Winters

关于我们使用命令行标志的一个令人沮丧的事情是很难安全地从二进制和生产服务器上删除标志（请访问https://abseil.io/tips/45了解一些令人沮丧的误用）。麻烦？
如果指定不再定义的标志，二进制将不会启动，因此删除标志可能需要C++代码与作业启动脚本和配置之间的协调。

在一些场景下，这种协调是相当有挑战的(基于二进制版本来调整生产代码)，那有更好的方式吗？

有。前段时间我们在`C++`命令行标志系统中添加了一个名为“退役标志”的新概念 [ABSL_RETIRED_FLAG](https://github.com/abseil/abseil-cpp/blob/master/absl/flags/flag.h#L255)

退役标志在C++中不创建符号(不再需要依赖FLAGS_some_flag全局变量)，不会出现在`--help`中。但在命令行中指定时将被接受（虽然将记录ERROR日志），
通过这种方式，代码将不再使用的标志可以标记为“退役”，从而将`C++`代码更改与生产配置更改分开。一旦配置更改全部清除，就可以一劳永逸地删除退役标志。

退役标志被设计用于许多情况（包括涉及交叉仓库、非原子提交要求等情况）。一个非常简单的退役标志的步骤可能如下所示：

1. 在代码中移除对于`FLAGS_frobber`的使用

如果你遵循https://abseil.io/tips/45的建议并主要使用来自`main()`的标志，这应该很容易做并检查。

2. 更改标志的定义以使其退役

```cpp
ABSL_FLAG(type, frobber, "default", "Which frobber to use?");
```

将其变成:

```cpp
ABSL_RETIRED_FLAG(type, frobber, "default", "retired");
```

3. 等待二进制版本。一旦所有服务单元中的所有作业都调用新二进制文件，您就可以继续

4. 从生产配置中删除标志。一旦搜索相关的生产配置显示没有命中`frobber`标志，你可以继续。

5. 移除退役标志

到此为止，我们已经成功地删除了非常复杂的标志：这项工作的动机是删除遗留内部文件系统中定义的标志，这更为复杂，因为这些标志是在库中定义的(因此许多二进制文件在使用)。
从我们所看到的情况来看，即使是最复杂的标志删除也可以使用此系统安全地启用。所以，下次你想知道如何安全地移除一个标志时，可以考虑将其退役，然后一步一步地进行。