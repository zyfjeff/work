
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://zyfjeff.github.io/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/leveldb/leveldb/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>Leveldb源码分析 - 程序员的Cookbook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#leveldb" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="程序员的Cookbook" class="md-header__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            程序员的Cookbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Leveldb源码分析
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      About
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-tabs__link">
        博客
      </a>
    </li>
  

  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/blog/" class="md-tabs__link">
        学习笔记
      </a>
    </li>
  

  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../envoy/bootstrap/" class="md-tabs__link md-tabs__link--active">
        开源项目
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-tabs__link">
        编程语言
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-tabs__link">
        计算机基础
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="程序员的Cookbook" class="md-nav__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    程序员的Cookbook
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        博客
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="博客" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          博客
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Doc
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Doc" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Doc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_1" type="checkbox" id="__nav_2_1_1" >
      
      <label class="md-nav__link" for="__nav_2_1_1">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_1">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-nav__link">
        如何在Linux环境下实现一个调试器
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2" type="checkbox" id="__nav_2_1_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_2">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/%E5%A6%82%E4%BD%95mock%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" class="md-nav__link">
        如何mock系统调用
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2_2" type="checkbox" id="__nav_2_1_2_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2_2">
        Effective Model Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Effective Model Cpp" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_1_2_2">
          <span class="md-nav__icon md-icon"></span>
          Effective Model Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item1/" class="md-nav__link">
        Item1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item38/" class="md-nav__link">
        Item38 Be aware of varying thread handle destructor behavior
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item39/" class="md-nav__link">
        Item39 Consider void futures for one-shot event communication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item40/" class="md-nav__link">
        Item40 Use std::atomic for concurrency, volatile for specific memory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item41/" class="md-nav__link">
        Item41 Consider pass by value for copyable parameters that are cheap to move and always copied.
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item42/" class="md-nav__link">
        Item42 Consider emplacement instead of insertion
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_3" type="checkbox" id="__nav_2_1_3" >
      
      <label class="md-nav__link" for="__nav_2_1_3">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_3">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/dispatcher/" class="md-nav__link">
        Envoy源码分析之Dispatcher
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/thread_local/" class="md-nav__link">
        Envoy源码分析之ThreadLocal
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_4" type="checkbox" id="__nav_2_1_4" >
      
      <label class="md-nav__link" for="__nav_2_1_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%B8%AD%E7%9A%84%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E6%9C%89%E4%BB%80%E4%B9%88%3F/" class="md-nav__link">
        Linux中的可执行程序有什么?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%BF%A1%E5%8F%B7%E4%B8%93%E9%A2%98FAQ/" class="md-nav__link">
        Linux 信号FAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/%E5%85%B3%E4%BA%8E%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E8%AE%A8%E8%AE%BA/" class="md-nav__link">
        关于文件写入的原子性讨论
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_5" type="checkbox" id="__nav_2_1_5" >
      
      <label class="md-nav__link" for="__nav_2_1_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/lifetime-error-cases/" class="md-nav__link">
        常见的生命周期错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/macros/" class="md-nav__link">
        Macros
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/match-pattern/" class="md-nav__link">
        Match pattern
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-error-handle/" class="md-nav__link">
        Rust错误处理指南
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-match/" class="md-nav__link">
        Rust match
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-misconceptions/" class="md-nav__link">
        常见的生命周期概念错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-module/" class="md-nav__link">
        Rust module
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-variance/" class="md-nav__link">
        Rust variance
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        学习笔记
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="学习笔记" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          学习笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Blog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Blog" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/blog/" class="md-nav__link">
        Can Reordering of Release/Acquire Operations Introduce Deadlock?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/blog/readling_list/" class="md-nav__link">
        待阅读列表
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Book
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Book" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Book
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/%20PracticalSystemProgrammingForRust/" class="md-nav__link">
        Practical System Programing For Rust
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/ConcurrencyModernCpp/" class="md-nav__link">
        Concurrency Modern C++
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/CppTemplate/" class="md-nav__link">
        C++ Templates
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/KubernetesPrograming/" class="md-nav__link">
        Programming Kubernetes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/LuaPrograming/" class="md-nav__link">
        Lua Programing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/MathematicsForComputerScience/" class="md-nav__link">
        Mathematics For Computer Science
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/MuduoCpp/" class="md-nav__link">
        Linux C++ 服务端编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/OS/" class="md-nav__link">
        操作系统导论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/ebpf/" class="md-nav__link">
        ebpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3">
        Course
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Course" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Course
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1" type="checkbox" id="__nav_3_3_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1">
        6.824
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="6.824" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_1">
          <span class="md-nav__icon md-icon"></span>
          6.824
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1_1" type="checkbox" id="__nav_3_3_1_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1_1">
        Lecture1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lecture1" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_3_1_1">
          <span class="md-nav__icon md-icon"></span>
          Lecture1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/6.824/lecture1/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/6.824/lecture1/paper-note/" class="md-nav__link">
        Paper note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_2" type="checkbox" id="__nav_3_3_2" >
      
      <label class="md-nav__link" for="__nav_3_3_2">
        Ultimate Go Programing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ultimate Go Programing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_2">
          <span class="md-nav__icon md-icon"></span>
          Ultimate Go Programing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/Ultimate_Go_Programing/" class="md-nav__link">
        Ultimate Go Programing
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_3" type="checkbox" id="__nav_3_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3_3">
        信息论
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="信息论" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_3">
          <span class="md-nav__icon md-icon"></span>
          信息论
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/%E4%BF%A1%E6%81%AF%E8%AE%BA/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      <label class="md-nav__link" for="__nav_3_4">
        English
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="English" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          English
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_1" type="checkbox" id="__nav_3_4_1" >
      
      <label class="md-nav__link" for="__nav_3_4_1">
        Class1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class1" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_1">
          <span class="md-nav__icon md-icon"></span>
          Class1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class1/READMEN/" class="md-nav__link">
        READMEN
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class1/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class1/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_2" type="checkbox" id="__nav_3_4_2" >
      
      <label class="md-nav__link" for="__nav_3_4_2">
        Class2
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class2" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_2">
          <span class="md-nav__icon md-icon"></span>
          Class2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class2/kk/" class="md-nav__link">
        Kk
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class2/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class2/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_3" type="checkbox" id="__nav_3_4_3" >
      
      <label class="md-nav__link" for="__nav_3_4_3">
        Hearing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Hearing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_3">
          <span class="md-nav__icon md-icon"></span>
          Hearing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/hearing/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_4" type="checkbox" id="__nav_3_4_4" >
      
      <label class="md-nav__link" for="__nav_3_4_4">
        Open lan
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Open lan" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_4">
          <span class="md-nav__icon md-icon"></span>
          Open lan
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/open-lan/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_5" type="checkbox" id="__nav_3_4_5" >
      
      <label class="md-nav__link" for="__nav_3_4_5">
        Syntax
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Syntax" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_5">
          <span class="md-nav__icon md-icon"></span>
          Syntax
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/syntax/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_6" type="checkbox" id="__nav_3_4_6" >
      
      <label class="md-nav__link" for="__nav_3_4_6">
        Walk for us
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Walk for us" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_6">
          <span class="md-nav__icon md-icon"></span>
          Walk for us
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/walk_for_us/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_7" type="checkbox" id="__nav_3_4_7" >
      
      <label class="md-nav__link" for="__nav_3_4_7">
        Word list
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Word list" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_7">
          <span class="md-nav__icon md-icon"></span>
          Word list
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/word_list/word/" class="md-nav__link">
        Word
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" type="checkbox" id="__nav_3_5" >
      
      <label class="md-nav__link" for="__nav_3_5">
        Paper
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Paper" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Paper
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/paper/bitcask/" class="md-nav__link">
        Bitcask
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        开源项目
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="开源项目" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          开源项目
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      <label class="md-nav__link" for="__nav_4_1">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/bootstrap/" class="md-nav__link">
        Bootstrap启动过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/cluster/" class="md-nav__link">
        Cluster分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/cluster_manager/" class="md-nav__link">
        Cluster Manager初始化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/dpdk/" class="md-nav__link">
        DPDK
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/drain_manager/" class="md-nav__link">
        Drain manager分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/eds/" class="md-nav__link">
        EDS更新过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/load_balancer/" class="md-nav__link">
        Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/lua/" class="md-nav__link">
        Lua filter实现分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/overload_manager/" class="md-nav__link">
        Overload manager分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/proxy/" class="md-nav__link">
        Envoy源码分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/stats_symbol/" class="md-nav__link">
        Stats Symbol分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/subset_lb/" class="md-nav__link">
        Subset Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/wasm/" class="md-nav__link">
        Envoy Proxy Wasm分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../envoy/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89Cluster/" class="md-nav__link">
        如何实现自定义Cluster
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/" class="md-nav__link">
        Helm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/basic/" class="md-nav__link">
        Basic
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/tips/" class="md-nav__link">
        Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      <label class="md-nav__link" for="__nav_4_3">
        Leveldb
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Leveldb" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Leveldb
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Leveldb源码分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Leveldb源码分析
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#skiplist" class="md-nav__link">
    Skiplist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memtable" class="md-nav__link">
    Memtable
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#walwrite-ahead-logging" class="md-nav__link">
    WAL(Write-ahead logging)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#batch" class="md-nav__link">
    Batch
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sstable" class="md-nav__link">
    SStable
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#table-cache" class="md-nav__link">
    Table Cache
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-versionedit-versionset" class="md-nav__link">
    Version / VersionEdit / VersionSet
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manifest" class="md-nav__link">
    Manifest
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compation" class="md-nav__link">
    Compation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filetype" class="md-nav__link">
    FileType
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    参考文献
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      <label class="md-nav__link" for="__nav_4_4">
        Pilot
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Pilot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Pilot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/" class="md-nav__link">
        WIP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/ConfigUpdate/" class="md-nav__link">
        配置更新分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/EnvoyFilter/" class="md-nav__link">
        EnvoyFilter分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/PushContext/" class="md-nav__link">
        PushContext分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/concept/" class="md-nav__link">
        基本概念和接口
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/xds-process/" class="md-nav__link">
        XDS处理流程分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        编程语言
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="编程语言" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          编程语言
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      <label class="md-nav__link" for="__nav_5_1">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-nav__link">
        C++基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp17/" class="md-nav__link">
        C++17 In Details
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp20/" class="md-nav__link">
        C++20
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/design/" class="md-nav__link">
        Design
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/guidelines/" class="md-nav__link">
        Guidelines
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/libevent/" class="md-nav__link">
        Libevent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/memory_order/" class="md-nav__link">
        C++ Memory Order
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_8" type="checkbox" id="__nav_5_1_8" >
      
      <label class="md-nav__link" for="__nav_5_1_8">
        Tips
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tips" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_8">
          <span class="md-nav__icon md-icon"></span>
          Tips
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-1/" class="md-nav__link">
        Tip of the Week #1: string_view
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-10/" class="md-nav__link">
        Tip of the Week #10: Splitting Strings, not Hairs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-101/" class="md-nav__link">
        Tip of the Week #101: Return Values, References, and Lifetimes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-103/" class="md-nav__link">
        Tip of the Week #103: Flags Are Globals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-107/" class="md-nav__link">
        Tip of the Week #107: Reference Lifetime Extension
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-108/" class="md-nav__link">
        Tip of the Week #108: Avoid std::bind
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-109/" class="md-nav__link">
        Tip of the Week #109: Meaningful `const` in Function Declarations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-11/" class="md-nav__link">
        Tip of the Week #11: Return Policy
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-112/" class="md-nav__link">
        Tip of the Week #112: emplace vs. push_back
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-117/" class="md-nav__link">
        Tip of the Week #117: Copy Elision and Pass-by-value
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-119/" class="md-nav__link">
        Tip of the Week #119: Using-declarations and namespace aliases
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-120/" class="md-nav__link">
        Tip of the Week #120: Return Values are Untouchable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-122/" class="md-nav__link">
        Tip of the Week #122: Test Fixtures, Clarity, and Dataflow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-123/" class="md-nav__link">
        Tip of the Week #123: absl::optional and std::unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-126/" class="md-nav__link">
        Tip of the Week #126: `make_unique` is the new `new`
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-24/" class="md-nav__link">
        Tip of the Week #24: Copies, Abbrv
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-3/" class="md-nav__link">
        Tip of the Week #3: String Concatenation and operator+ vs. StrCat()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-36/" class="md-nav__link">
        Tip of the Week #36: New Join API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-42/" class="md-nav__link">
        Tip of the Week #42: Prefer Factory Functions to Initializer Methods
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-45/" class="md-nav__link">
        Tip of the Week #45: Avoid Flags, Especially in Library Code
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-49/" class="md-nav__link">
        Tip of the Week #49: Argument-Dependent Lookup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-55/" class="md-nav__link">
        Tip of the Week #55: Name Counting and unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-59/" class="md-nav__link">
        Tip of the Week #59: Joining Tuples
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-61/" class="md-nav__link">
        Tip of the Week #61: Default Member Initializers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-64/" class="md-nav__link">
        Tip of the Week #64: Raw String Literals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-65/" class="md-nav__link">
        Tip of the Week #65: Putting Things in their Place
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-74/" class="md-nav__link">
        Tip of the Week #74: Delegating and Inheriting Constructors
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-77/" class="md-nav__link">
        Tip of the Week #77: Temporaries, Moves, and Copies
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-86/" class="md-nav__link">
        Tip of the Week #86: Enumerating with Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-88/" class="md-nav__link">
        Tip of the Week #88: Initialization: =, (), and {}
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-90/" class="md-nav__link">
        Tip of the Week #90: Retired Flags
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-93/" class="md-nav__link">
        Tip of the Week #93: using absl::Span
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-94/" class="md-nav__link">
        Tip of the Week #94: Callsite Readability and bool Parameters
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-99/" class="md-nav__link">
        Tip of the Week #99: Nonmember Interface Etiquette
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      <label class="md-nav__link" for="__nav_5_2">
        Golang
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Golang" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Golang
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/note/" class="md-nav__link">
        Go Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      <label class="md-nav__link" for="__nav_5_3">
        Lua
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lua" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Lua
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/lua/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" >
      
      <label class="md-nav__link" for="__nav_5_4">
        Python
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/python/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" >
      
      <label class="md-nav__link" for="__nav_5_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/Note/" class="md-nav__link">
        Rust学习笔记
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5_3" type="checkbox" id="__nav_5_5_3" >
      
      <label class="md-nav__link" for="__nav_5_5_3">
        Library
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Library" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_5_3">
          <span class="md-nav__icon md-icon"></span>
          Library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/library/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        计算机基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="计算机基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          计算机基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      <label class="md-nav__link" for="__nav_6_1">
        Algorithm
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Algorithm" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          Algorithm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-nav__link">
        负载均衡算法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/skiplist/" class="md-nav__link">
        跳表分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      <label class="md-nav__link" for="__nav_6_2">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/" class="md-nav__link">
        OS基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/Reverse/" class="md-nav__link">
        Reverse
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/compiler/" class="md-nav__link">
        编译器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/concurrency/" class="md-nav__link">
        并发编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/gdb/" class="md-nav__link">
        GDB Tips
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/review/" class="md-nav__link">
        面试题
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/tls/" class="md-nav__link">
        SSL
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_8" type="checkbox" id="__nav_6_2_8" >
      
      <label class="md-nav__link" for="__nav_6_2_8">
        Bazel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bazel" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_8">
          <span class="md-nav__icon md-icon"></span>
          Bazel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/bazel/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      <label class="md-nav__link" for="__nav_6_3">
        Design
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Design" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Design
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/design/" class="md-nav__link">
        设计模式
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      <label class="md-nav__link" for="__nav_6_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/asm_syscall/" class="md-nav__link">
        Linux: x86-64 syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_socket_balancing/" class="md-nav__link">
        三种常见的socket balancing模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_syscall/" class="md-nav__link">
        Linux syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/shell/" class="md-nav__link">
        Shell
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_6" type="checkbox" id="__nav_6_4_6" >
      
      <label class="md-nav__link" for="__nav_6_4_6">
        Bpf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bpf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_6">
          <span class="md-nav__icon md-icon"></span>
          Bpf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/READMME/" class="md-nav__link">
        READMME
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/seccomp-bpf/" class="md-nav__link">
        Seccomp bpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_7" type="checkbox" id="__nav_6_4_7" >
      
      <label class="md-nav__link" for="__nav_6_4_7">
        Ftrace
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ftrace" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_7">
          <span class="md-nav__icon md-icon"></span>
          Ftrace
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/ftrace/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_8" type="checkbox" id="__nav_6_4_8" >
      
      <label class="md-nav__link" for="__nav_6_4_8">
        Fuse
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Fuse" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_8">
          <span class="md-nav__icon md-icon"></span>
          Fuse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/fuse/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_9" type="checkbox" id="__nav_6_4_9" >
      
      <label class="md-nav__link" for="__nav_6_4_9">
        Io
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Io" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_9">
          <span class="md-nav__icon md-icon"></span>
          Io
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/io/io_uring/" class="md-nav__link">
        Io uring
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_10" type="checkbox" id="__nav_6_4_10" >
      
      <label class="md-nav__link" for="__nav_6_4_10">
        Network
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Network" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_10">
          <span class="md-nav__icon md-icon"></span>
          Network
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/epoll/" class="md-nav__link">
        Epoll
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/ip_transparent/" class="md-nav__link">
        Ip transparent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp-ip-program/" class="md-nav__link">
        Tcp ip program
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_back_log/" class="md-nav__link">
        Tcp back log
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_fast_open/" class="md-nav__link">
        Tcp fast open
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_splicing/" class="md-nav__link">
        SOCKMAP - TCP splicing of the future
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/time_wait/" class="md-nav__link">
        Time wait
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/virtual-network/" class="md-nav__link">
        Virtual network
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_11" type="checkbox" id="__nav_6_4_11" >
      
      <label class="md-nav__link" for="__nav_6_4_11">
        Perf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Perf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_11">
          <span class="md-nav__icon md-icon"></span>
          Perf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/perf/" class="md-nav__link">
        性能优化基础
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_12" type="checkbox" id="__nav_6_4_12" >
      
      <label class="md-nav__link" for="__nav_6_4_12">
        Synchronization
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Synchronization" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_12">
          <span class="md-nav__icon md-icon"></span>
          Synchronization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/memory_order/" class="md-nav__link">
        Memory order
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_13" type="checkbox" id="__nav_6_4_13" >
      
      <label class="md-nav__link" for="__nav_6_4_13">
        System interface
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="System interface" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_13">
          <span class="md-nav__icon md-icon"></span>
          System interface
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/system_interface/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      <label class="md-nav__link" for="__nav_6_5">
        Why
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Why" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          Why
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/why/" class="md-nav__link">
        计算机基础百科
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zyfjeff/zyfjeff.github.io/edit/master/docs/开源项目/leveldb/leveldb.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="leveldb">Leveldb源码分析</h1>
<h2 id="skiplist">Skiplist</h2>
<p>Leveldb内部的Memtable其核心就是Skiplist，通过Skiplist来存放所有的数据，首先我们来看下Skiplist的结构，如下图:</p>
<p><img alt="skiplist_arch" src="img/skiplist_arch.jpeg" /></p>
<p>通过上面的Skiplist结构可知，一个Skiplist是多个链表的集合，每一个链表都有一个header指针，指向这个链表，Leveldb中使用一个数组来存储
所有的链表header.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">Node</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Node</span><span class="p">(</span><span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">)</span> <span class="o">:</span> <span class="n">key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">Key</span> <span class="k">const</span> <span class="n">key</span><span class="p">;</span>

  <span class="c1">// Accessors/mutators for links.  Wrapped in methods so we can</span>
  <span class="c1">// add the appropriate barriers as necessary.</span>
  <span class="n">Node</span><span class="o">*</span> <span class="nf">Next</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// Use an &#39;acquire load&#39; so that we observe a fully initialized</span>
    <span class="c1">// version of the returned Node.</span>
    <span class="k">return</span> <span class="n">next_</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">SetNext</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// Use a &#39;release store&#39; so that anybody who reads through this</span>
    <span class="c1">// pointer observes a fully initialized version of the inserted node.</span>
    <span class="n">next_</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">store</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// No-barrier variants that can be safely used in a few locations.</span>
  <span class="n">Node</span><span class="o">*</span> <span class="nf">NoBarrier_Next</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">next_</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">NoBarrier_SetNext</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">next_</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">store</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
  <span class="p">}</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="c1">// Array of length equal to the node height.  next_[0] is lowest level link.</span>
  <span class="c1">// 这是一个数组，使用了C/C++中的柔性数组的能力。</span>
  <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*&gt;</span> <span class="n">next_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">typename</span> <span class="nc">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">Node</span><span class="o">*</span> <span class="n">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">NewNode</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 根据指定的高度分配数组。</span>
  <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">node_memory</span> <span class="o">=</span> <span class="n">arena_</span><span class="o">-&gt;</span><span class="n">AllocateAligned</span><span class="p">(</span>
      <span class="k">sizeof</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*&gt;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="k">return</span> <span class="k">new</span> <span class="p">(</span><span class="n">node_memory</span><span class="p">)</span> <span class="n">Node</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>这个链表数组中的第一个链表被称为Level0，通过这个链表可以遍历所有的数据，Levele1以及后面的链表则这是包含了部分数据。而且越大的level所包含的数据越少。
这么做的目的是为了在查找的时候可以更快的找到数据的位置，接下来我们来看下整个查找过程是如何的，</p>
<p><img alt="skiplist_search" src="../img/skiplist_search.jpeg" /></p>
<ol>
<li>首先从最大的Level所对应的链表进行查找(上图中就是level3)</li>
<li>在当前遍历链表找到第一个大于或者等于要查找的key的位置或者直接查找到结束(也就是元素6的位置，因为后面没有节点了)</li>
<li>如果当前level没有查找到就继续切换到下一个level进行查找(切换到level2，继续查找，还是在当前位置，因为25大于17找到了，继续切换到level1，这个时候找到了9)</li>
<li>直到在level0中找到这样的位置，并返回(找到了12，然后和17进行对比发现不相等。)</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">bool</span> <span class="n">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">Contains</span><span class="p">(</span><span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Node</span><span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">FindGreaterOrEqual</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">Equal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Key</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Comparator</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">KeyIsAfterNode</span><span class="p">(</span><span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// null n is considered infinite</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">compare_</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 总是返回第一个大于等于key的前一个节点。</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Key</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Comparator</span><span class="o">&gt;</span>
<span class="k">typename</span> <span class="nc">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">Node</span><span class="o">*</span>
<span class="n">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">FindGreaterOrEqual</span><span class="p">(</span><span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span>
                                              <span class="n">Node</span><span class="o">**</span> <span class="n">prev</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Node</span><span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
  <span class="c1">// 1. 从最大的Level开始查找</span>
  <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">GetMaxHeight</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 2. 遍历链表，找到第一个大于等于key的节点。</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">next</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">KeyIsAfterNode</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">next</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 没有大于等于key，并且还未遍历结束，继续在当前链表进行查找</span>
      <span class="c1">// Keep searching in this list</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 找到第一个大于等于key的节点或者当前level遍历结束了。</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="n">prev</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
      <span class="c1">// 如果是最后一层了，就直接返回</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">next</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 切换到下一个level继续查找</span>
        <span class="c1">// Switch to next list</span>
        <span class="n">level</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>从上面的查找过程可以看到从高的level开始查找的目的是为了快速找到要查找的数据在level0的大概位置，有点类似二分查找。所有的数据都可以通过level0遍历到，
高的level中只包含了level0中的部分数据。最后我们来看下如果插入数据来构建skiplist，插入过程如下图:</p>
<p><img alt="skiplist_insert" src="../img/skiplist_insert.jpeg" /></p>
<ol>
<li>首先找到大于等于要查找节点的前一个节点，并记录每一个level下找到的大于等于要查找数据的前一个节点。</li>
<li>如果有相同的key就插入失败。</li>
<li>随机获取一个高度，比如这里获取的高度是1</li>
<li>构造新节点，并让level0指向新节点，然后找到随机获取的level所对应的前一个节点，然后指向这个新节点。</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="n">SkipList</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Comparator</span><span class="o">&gt;::</span><span class="n">Insert</span><span class="p">(</span><span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO(opt): We can use a barrier-free variant of FindGreaterOrEqual()</span>
  <span class="c1">// here since Insert() is externally synchronized.</span>
  <span class="n">Node</span><span class="o">*</span> <span class="n">prev</span><span class="p">[</span><span class="n">kMaxHeight</span><span class="p">];</span>
  <span class="n">Node</span><span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">FindGreaterOrEqual</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>

  <span class="c1">// Our data structure does not allow duplicate insertion</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="o">!</span><span class="n">Equal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>

  <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">RandomHeight</span><span class="p">();</span>
  <span class="c1">// 如果大于当前的最大高度就进行扩展，从最大高度到获取的随机高度之间设置prev为header</span>
  <span class="c1">// 也就是在这个范围内，直接用header指针指向新创建的元素。</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">GetMaxHeight</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">GetMaxHeight</span><span class="p">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">head_</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// It is ok to mutate max_height_ without any synchronization</span>
    <span class="c1">// with concurrent readers.  A concurrent reader that observes</span>
    <span class="c1">// the new value of max_height_ will see either the old value of</span>
    <span class="c1">// new level pointers from head_ (nullptr), or a new value set in</span>
    <span class="c1">// the loop below.  In the former case the reader will</span>
    <span class="c1">// immediately drop to the next level since nullptr sorts after all</span>
    <span class="c1">// keys.  In the latter case the reader will use the new node.</span>
    <span class="n">max_height_</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 创建新的节点</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">NewNode</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
  <span class="c1">// 从level0开始，插入到每一层。</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// NoBarrier_SetNext() suffices since we will add a barrier when</span>
    <span class="c1">// we publish a pointer to &quot;x&quot; in prev[i].</span>
    <span class="n">x</span><span class="o">-&gt;</span><span class="n">NoBarrier_SetNext</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">NoBarrier_Next</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
    <span class="n">prev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetNext</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>通过上面的代码可以看到，核心点在于随机获取了一个高度，然后从level0开始到这个高度的每一层都会插入这个新节点。</p>
<h2 id="memtable">Memtable</h2>
<p>Leveldb写入数据时并不是直接写磁盘，而是首先写入到内存中，然后通过后台线程进行compact并写入到磁盘，而Memtable就是leveldb在内存中用来存储写入数据的结构。
所有写入的内容都会同Memtable进行排序存储，等这个Memtable的容量达到一个阀值时就将其设置为只读，然后重新创建一个新的Memtable继续提供写入操作。一个<code>Memtable</code>
核心提供了下面两个接口，通过这两个接口来实现增删查。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// Add an entry into memtable that maps key to value at the</span>
  <span class="c1">// specified sequence number and with the specified type.</span>
  <span class="c1">// Typically value will be empty if type==kTypeDeletion.</span>
  <span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">SequenceNumber</span> <span class="n">seq</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span>
           <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>

  <span class="c1">// If memtable contains a value for key, store it in *value and return true.</span>
  <span class="c1">// If memtable contains a deletion for key, store a NotFound() error</span>
  <span class="c1">// in *status and return true.</span>
  <span class="c1">// Else, return false.</span>
  <span class="kt">bool</span> <span class="nf">Get</span><span class="p">(</span><span class="k">const</span> <span class="n">LookupKey</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="n">Status</span><span class="o">*</span> <span class="n">s</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>首先我们来看下它的<code>Add</code>方法的实现。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">MemTable::Add</span><span class="p">(</span><span class="n">SequenceNumber</span> <span class="n">s</span><span class="p">,</span> <span class="n">ValueType</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span>
                   <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Format of an entry is concatenation of:</span>
  <span class="c1">//  key_size     : varint32 of internal_key.size()</span>
  <span class="c1">//  key bytes    : char[internal_key.size()]</span>
  <span class="c1">//  value_size   : varint32 of value.size()</span>
  <span class="c1">//  value bytes  : char[value.size()]</span>
  <span class="kt">size_t</span> <span class="n">key_size</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="kt">size_t</span> <span class="n">val_size</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="kt">size_t</span> <span class="n">internal_key_size</span> <span class="o">=</span> <span class="n">key_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">encoded_len</span> <span class="o">=</span> <span class="n">VarintLength</span><span class="p">(</span><span class="n">internal_key_size</span><span class="p">)</span> <span class="o">+</span>
                             <span class="n">internal_key_size</span> <span class="o">+</span> <span class="n">VarintLength</span><span class="p">(</span><span class="n">val_size</span><span class="p">)</span> <span class="o">+</span>
                             <span class="n">val_size</span><span class="p">;</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">arena_</span><span class="p">.</span><span class="n">Allocate</span><span class="p">(</span><span class="n">encoded_len</span><span class="p">);</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">EncodeVarint32</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">internal_key_size</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">key_size</span><span class="p">);</span>
  <span class="n">p</span> <span class="o">+=</span> <span class="n">key_size</span><span class="p">;</span>
  <span class="n">EncodeFixed64</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">type</span><span class="p">);</span>
  <span class="n">p</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">EncodeVarint32</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">val_size</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">val_size</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">val_size</span> <span class="o">==</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">encoded_len</span><span class="p">);</span>
  <span class="n">table_</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>将key和value进行编码，编码的格式为<code>key_size</code>、<code>key</code>、<code>value_size</code>、<code>value</code>，其中key部分又做了一次编码，包装成了internal_key，其编码格式如下图：</p>
<p><img alt="internalkey" src="../img/internalkey.jpeg" /></p>
<p>这么做的目的是为了解决两个问题，第一个问题就是将删除变成add，真正的删除在进行Compaction的时候进行，因此在编码Key的时候添加了type标志，标记这个key是删除
还是添加。另外一个问题就是对象相同key的处理，如何区分新旧，因此Leveldb引入了<code>sequence number</code>，每次插入都会进行递增，因此相同的key一定具有不同的<code>sequence number</code>，
谁的<code>sequence number</code>大谁就是最新的key。所以需要将<code>sequence number</code>也编码到key中，最终产生了这个internal_key。 </p>
<p>Memtable是在内存中的，而且只有到达一定的大小才会通过Compaction写入到磁盘，如果在这过程中出现了异常如何保证数据不丢失呢? 这就需要WAL了。</p>
<h2 id="walwrite-ahead-logging">WAL(Write-ahead logging)</h2>
<p>Leveldb每次在进行数据写入的时候都会先将数据写到日志文件中，然后再往Memtable中写，这样做的目的是为了防止在写入Memtable的过程中因为进程异常、系统掉电等情况导致数据丢失。
日志文件是按照Block来组织的，每个Block大小为32K，一个Block中会包含多个记录。每条记录都包含了四个部分，分别是: <code>Checksum</code>、<code>Length</code>、<code>RecordType</code>、<code>Data</code>。格式如下图:</p>
<p><img alt="journal" src="../img/journal.jpeg" /></p>
<p>其中这里的<code>RecordType</code>其取值范围如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="nc">RecordType</span> <span class="p">{</span>
  <span class="c1">// Zero is reserved for preallocated files</span>
  <span class="n">kZeroType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

  <span class="n">kFullType</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

  <span class="c1">// For fragments</span>
  <span class="n">kFirstType</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
  <span class="n">kMiddleType</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
  <span class="n">kLastType</span> <span class="o">=</span> <span class="mi">4</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>这个<code>RecordType</code>的目的主要是为了解决那些单条数据超过32K大小的问题，对于这类数据只能分成多条记录来写，因此有了<code>RecordType</code>来表示当前的记录是否是完整的，还是片段，如果是片段，那那个是第一个片段、
那些是中间片段、那个是最后一个片段，通过<code>RecordType</code>就可以将多个片段组装一条完整的记录。<code>Chechsum</code>部分很好理解，就是记录了当前记录的校验和，用来做数据正确性校验的。<code>Length</code>部分则是用来标识</p>
<p>Leveldb规定<code>Checksum</code>占4个字节(正好满足crc32算法的需求)，<code>Length</code>占2个字节(2^16次方正好是32K，一个block的大小，所以是足够的)、 <code>RecordType</code>占用1个字节。这三个部分被称为固定的Header，总共
占用7个字节，下面这个方法就是用来写入一条完整记录的方法。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">Writer::EmitPhysicalRecord</span><span class="p">(</span><span class="n">RecordType</span> <span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span>
                                  <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">);</span>  <span class="c1">// Must fit in two bytes</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">block_offset_</span> <span class="o">+</span> <span class="n">kHeaderSize</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">kBlockSize</span><span class="p">);</span>

  <span class="c1">// Format the header</span>
  <span class="c1">// 1. 先写入header和RecordType</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kHeaderSize</span><span class="p">];</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
  <span class="c1">// 2. 开始计算crc32，然后写入</span>
  <span class="c1">// Compute the crc of the record type and the payload.</span>
  <span class="kt">uint32_t</span> <span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="o">::</span><span class="n">Extend</span><span class="p">(</span><span class="n">type_crc_</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
  <span class="n">crc</span> <span class="o">=</span> <span class="n">crc32c</span><span class="o">::</span><span class="n">Mask</span><span class="p">(</span><span class="n">crc</span><span class="p">);</span>  <span class="c1">// Adjust for storage</span>
  <span class="n">EncodeFixed32</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">crc</span><span class="p">);</span>
  <span class="c1">// 3. 最后写入Data</span>
  <span class="c1">// Write the header and the payload</span>
  <span class="n">Status</span> <span class="n">s</span> <span class="o">=</span> <span class="n">dest_</span><span class="o">-&gt;</span><span class="n">Append</span><span class="p">(</span><span class="n">Slice</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">kHeaderSize</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">dest_</span><span class="o">-&gt;</span><span class="n">Append</span><span class="p">(</span><span class="n">Slice</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">dest_</span><span class="o">-&gt;</span><span class="n">Flush</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">block_offset_</span> <span class="o">+=</span> <span class="n">kHeaderSize</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>到此为止日志的写入过程就分析完了，接下来我们看下WAL实际是如何使用的，下面是Leveldb批量写的实现。</p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>Leveldb的写入总是批量的，即使有单次写入的API，最终在内部使用的时候，也是使用批量写的方式来做的。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">DB::Put</span><span class="p">(</span><span class="k">const</span> <span class="n">WriteOptions</span><span class="o">&amp;</span> <span class="n">opt</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">WriteBatch</span> <span class="n">batch</span><span class="p">;</span>
    <span class="n">batch</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Write</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">batch</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">DBImpl::Write</span><span class="p">(</span><span class="k">const</span> <span class="n">WriteOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="n">WriteBatch</span><span class="o">*</span> <span class="n">updates</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">......</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">updates</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// nullptr batch is for compactions</span>
    <span class="n">WriteBatch</span><span class="o">*</span> <span class="n">write_batch</span> <span class="o">=</span> <span class="n">BuildBatchGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last_writer</span><span class="p">);</span>
    <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">SetSequence</span><span class="p">(</span><span class="n">write_batch</span><span class="p">,</span> <span class="n">last_sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">last_sequence</span> <span class="o">+=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Count</span><span class="p">(</span><span class="n">write_batch</span><span class="p">);</span>

    <span class="c1">// Add to log and apply to memtable.  We can release the lock</span>
    <span class="c1">// during this phase since &amp;w is currently responsible for logging</span>
    <span class="c1">// and protects against concurrent loggers and concurrent writes</span>
    <span class="c1">// into mem_.</span>
    <span class="p">{</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
      <span class="c1">// 1. 先写WAL</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">log_</span><span class="o">-&gt;</span><span class="n">AddRecord</span><span class="p">(</span><span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Contents</span><span class="p">(</span><span class="n">write_batch</span><span class="p">));</span>
      <span class="kt">bool</span> <span class="n">sync_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="p">.</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">logfile_</span><span class="o">-&gt;</span><span class="n">Sync</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">sync_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
       <span class="c1">// 2. 再写入Memtable</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">InsertInto</span><span class="p">(</span><span class="n">write_batch</span><span class="p">,</span> <span class="n">mem_</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sync_error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// The state of the log file is indeterminate: the log record we</span>
        <span class="c1">// just added may or may not show up when the DB is re-opened.</span>
        <span class="c1">// So we force the DB into a mode where all future writes fail.</span>
        <span class="n">RecordBackgroundError</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write_batch</span> <span class="o">==</span> <span class="n">tmp_batch_</span><span class="p">)</span> <span class="n">tmp_batch_</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>

    <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">SetLastSequence</span><span class="p">(</span><span class="n">last_sequence</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="p">......</span>
</code></pre></div>
</td></tr></table>
<p>通过上面的代码我们可以看到，实际上一条记录中的数据包含了<code>WriteBatch</code>中的多个key/value，那么问题来了，我通过WAL读取到记录后，也成功拿到了保存的数据，那么我如何从这个数据中获取到多个key/value呢？
WAL是不管数据中有多少key/value的，他只负责存储和读取数据，至于读到的数据如何解析成多个key/value，这个是交由使用者来处理的。WAL可以在多个地方被使用，其Data部分的格式可以是任意的，在Leveldb中不仅仅
是用来存放key/value，还被用来存放<code>Manifest</code>了。</p>
<p>WAL文件何时删除呢? 如果一直持续的写入那么WAL文件迟早会撑暴。而且WAL文件那么大，在出现故障的时候恢复也是一个问题，另外在Leveldb进行Compaction后部分key/value将会落盘，那么WAL中对应的数据也应该要被清理掉。否则就会导致数据重复的问题。在<code>Memtable</code>部分我们介绍过，<code>Memtable</code>的大小到达一个阀值时会被冻结变成<code>immutable</code>，只能被读取无法进行写入，这个时候对应的WAL文件也会被冻结，然后创建一个新的WAL文件，等<code>immutable</code>进行Compaction后被写入到磁盘时，对应的WAL文件才能安全的删除。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">DBImpl::MakeRoomForWrite</span><span class="p">(</span><span class="kt">bool</span> <span class="n">force</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">......</span>
  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bg_error_</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// Yield previous error</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">bg_error_</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">allow_delay</span> <span class="o">&amp;&amp;</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">NumLevelFiles</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span>
                                  <span class="n">config</span><span class="o">::</span><span class="n">kL0_SlowdownWritesTrigger</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// We are getting close to hitting a hard limit on the number of</span>
      <span class="c1">// L0 files.  Rather than delaying a single write by several</span>
      <span class="c1">// seconds when we hit the hard limit, start delaying each</span>
      <span class="c1">// individual write by 1ms to reduce latency variance.  Also,</span>
      <span class="c1">// this delay hands over some CPU to the compaction thread in</span>
      <span class="c1">// case it is sharing the same core as the writer.</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
      <span class="n">env_</span><span class="o">-&gt;</span><span class="n">SleepForMicroseconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
      <span class="n">allow_delay</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// Do not delay a single write more than once</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span>
               <span class="p">(</span><span class="n">mem_</span><span class="o">-&gt;</span><span class="n">ApproximateMemoryUsage</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">options_</span><span class="p">.</span><span class="n">write_buffer_size</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// There is room in current memtable</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imm_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// We have filled up the current memtable, but the previous</span>
      <span class="c1">// one is still being compacted, so we wait.</span>
      <span class="n">Log</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">info_log</span><span class="p">,</span> <span class="s">&quot;Current memtable full; waiting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">background_work_finished_signal_</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">versions_</span><span class="o">-&gt;</span><span class="n">NumLevelFiles</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">::</span><span class="n">kL0_StopWritesTrigger</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// There are too many level-0 files.</span>
      <span class="n">Log</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">info_log</span><span class="p">,</span> <span class="s">&quot;Too many L0 files; waiting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">background_work_finished_signal_</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 创建immutable，获取新的WAL文件名，然后重新打开，后续使用新的WAL文件。</span>
      <span class="c1">// Attempt to switch to a new memtable and trigger compaction of old</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">versions_</span><span class="o">-&gt;</span><span class="n">PrevLogNumber</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
      <span class="kt">uint64_t</span> <span class="n">new_log_number</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">NewFileNumber</span><span class="p">();</span>
      <span class="n">WritableFile</span><span class="o">*</span> <span class="n">lfile</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">env_</span><span class="o">-&gt;</span><span class="n">NewWritableFile</span><span class="p">(</span><span class="n">LogFileName</span><span class="p">(</span><span class="n">dbname_</span><span class="p">,</span> <span class="n">new_log_number</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lfile</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// Avoid chewing through file number space in a tight loop.</span>
        <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">ReuseFileNumber</span><span class="p">(</span><span class="n">new_log_number</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">delete</span> <span class="n">log_</span><span class="p">;</span>
      <span class="k">delete</span> <span class="n">logfile_</span><span class="p">;</span>
      <span class="n">logfile_</span> <span class="o">=</span> <span class="n">lfile</span><span class="p">;</span>
      <span class="n">logfile_number_</span> <span class="o">=</span> <span class="n">new_log_number</span><span class="p">;</span>
      <span class="n">log_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">log</span><span class="o">::</span><span class="n">Writer</span><span class="p">(</span><span class="n">lfile</span><span class="p">);</span>
      <span class="n">imm_</span> <span class="o">=</span> <span class="n">mem_</span><span class="p">;</span>
      <span class="n">has_imm_</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
      <span class="n">mem_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemTable</span><span class="p">(</span><span class="n">internal_comparator_</span><span class="p">);</span>
      <span class="n">mem_</span><span class="o">-&gt;</span><span class="n">Ref</span><span class="p">();</span>
      <span class="n">force</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// Do not force another compaction if have room</span>
      <span class="n">MaybeScheduleCompaction</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p><code>MakeRoomForWrite</code>每次在发生写入的时候都会调用，会判断当前的<code>Memtable</code>大小是否超过阀值，如果超过了就切换成功<code>immutable</code>，并重新打开一个新的WAL文件用于记录。
接着我们来看下Compaction的实现。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">DBImpl::CompactMemTable</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">AssertHeld</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">imm_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>

  <span class="c1">// Save the contents of the memtable as a new Table</span>
  <span class="n">VersionEdit</span> <span class="n">edit</span><span class="p">;</span>
  <span class="n">Version</span><span class="o">*</span> <span class="n">base</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">();</span>
  <span class="n">base</span><span class="o">-&gt;</span><span class="n">Ref</span><span class="p">();</span>
  <span class="c1">// 将Memtable写成sstable</span>
  <span class="n">Status</span> <span class="n">s</span> <span class="o">=</span> <span class="n">WriteLevel0Table</span><span class="p">(</span><span class="n">imm_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edit</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
  <span class="n">base</span><span class="o">-&gt;</span><span class="n">Unref</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">shutting_down_</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">IOError</span><span class="p">(</span><span class="s">&quot;Deleting DB during memtable compaction&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Replace immutable memtable with the generated Table</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">edit</span><span class="p">.</span><span class="n">SetPrevLogNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">edit</span><span class="p">.</span><span class="n">SetLogNumber</span><span class="p">(</span><span class="n">logfile_number_</span><span class="p">);</span>  <span class="c1">// Earlier logs no longer needed</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">LogAndApply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Commit to the new state</span>
    <span class="n">imm_</span><span class="o">-&gt;</span><span class="n">Unref</span><span class="p">();</span>
    <span class="n">imm_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">has_imm_</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
    <span class="c1">// Compaction完成后，删除不需要的文件，包含了WAL文件。</span>
    <span class="n">RemoveObsoleteFiles</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">RecordBackgroundError</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="batch">Batch</h2>
<p>Leveldb中每次都写都是通过Batch的方式进行批量操作，而Batch本质上做的事情就是将多次操作进行了编码，先通过WAL日志将编码后的内容落盘，然后交由Memtable进行批量写入，首先让我们看下Batch的结构。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LEVELDB_EXPORT</span> <span class="n">WriteBatch</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="p">.....</span>
  <span class="k">private</span><span class="o">:</span>
  <span class="k">friend</span> <span class="k">class</span> <span class="nc">WriteBatchInternal</span><span class="p">;</span>
  <span class="c1">// 核心就是一个string，每次操作都会编码成string放在这里。</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">rep_</span><span class="p">;</span>  <span class="c1">// See comment in write_batch.cc for the format of rep_</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>接着我们看下WriteBatch是如何存放一次操作的。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">WriteBatch::Put</span><span class="p">(</span><span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">SetCount</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Count</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">rep_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kTypeValue</span><span class="p">));</span>
  <span class="c1">// 先通过varint把size写入，接着写内容</span>
  <span class="n">PutLengthPrefixedSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep_</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
  <span class="n">PutLengthPrefixedSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rep_</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>先更新了WriteBatch中存放的操作个数</li>
<li>接着写入操作类型</li>
<li>最后将key和value的内容写入</li>
</ol>
<p>最后我们来看下，一个WriteBatch编码后的内容格式，如下图:</p>
<p><img alt="journal_content" src="../img/journal_content.jpeg" /></p>
<p>一条数据包含了<code>sequence number</code>、<code>entry number</code>、<code>batch data</code>，前8个字节用来存放sequence nunber，一次WriteBatch会分配一个递增的sequence nunber。
接着8个字节用来存放这个WriteBatch中包含了多少次操作，接着就是每一次操作的具体内容了，就是上面提到的写入操作类型、key/value值等。</p>
<h2 id="sstable">SStable</h2>
<p>Leveldb通过WriteBatch批量进行多次操作，将多次操作编码后交由WAL进行日志落盘，最后交给Memtable进行批量写入到内存，每次写入之前会调用<code>MakeRoomForWrite</code>来决定是否需要进行
Compation将Memtable变成SStable，那么SStable到底是什么呢? <code>WriteLevel0Table</code>就是其中最为关键的一个函数，通过这个函数将Memtable变成了SStable。 接下来让我们来看下这个
函数到底做了什么?</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">DBImpl::WriteLevel0Table</span><span class="p">(</span><span class="n">MemTable</span><span class="o">*</span> <span class="n">mem</span><span class="p">,</span> <span class="n">VersionEdit</span><span class="o">*</span> <span class="n">edit</span><span class="p">,</span>
                                <span class="n">Version</span><span class="o">*</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">AssertHeld</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">start_micros</span> <span class="o">=</span> <span class="n">env_</span><span class="o">-&gt;</span><span class="n">NowMicros</span><span class="p">();</span>
  <span class="c1">// 1. 创建FileMetaData，用来描述产生的sstable文件</span>
  <span class="n">FileMetaData</span> <span class="n">meta</span><span class="p">;</span>
  <span class="c1">// 1.1 生成一个新的FileNumber，sstable文件的名字是有FileNumber组成的</span>
  <span class="n">meta</span><span class="p">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">NewFileNumber</span><span class="p">();</span>
  <span class="n">pending_outputs_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="n">number</span><span class="p">);</span>
  <span class="c1">// 1.2 创建Memtable迭代器准备写入到sstable文件中</span>
  <span class="n">Iterator</span><span class="o">*</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">NewIterator</span><span class="p">();</span>
  <span class="n">Log</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">info_log</span><span class="p">,</span> <span class="s">&quot;Level-0 table #%llu: started&quot;</span><span class="p">,</span>
      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">meta</span><span class="p">.</span><span class="n">number</span><span class="p">);</span>

  <span class="n">Status</span> <span class="n">s</span><span class="p">;</span>
  <span class="p">{</span>
    <span class="n">mutex_</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
    <span class="c1">// 2. 构建Table</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">BuildTable</span><span class="p">(</span><span class="n">dbname_</span><span class="p">,</span> <span class="n">env_</span><span class="p">,</span> <span class="n">options_</span><span class="p">,</span> <span class="n">table_cache_</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta</span><span class="p">);</span>
    <span class="n">mutex_</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">Log</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">info_log</span><span class="p">,</span> <span class="s">&quot;Level-0 table #%llu: %lld bytes %s&quot;</span><span class="p">,</span>
      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">meta</span><span class="p">.</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">meta</span><span class="p">.</span><span class="n">file_size</span><span class="p">,</span>
      <span class="n">s</span><span class="p">.</span><span class="n">ToString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="k">delete</span> <span class="n">iter</span><span class="p">;</span>
  <span class="n">pending_outputs_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="n">number</span><span class="p">);</span>

  <span class="c1">// Note that if file_size is zero, the file has been deleted and</span>
  <span class="c1">// should not be added to the manifest.</span>
  <span class="c1">// 3. 将文件添加到VersionEdit中</span>
  <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">meta</span><span class="p">.</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">Slice</span> <span class="n">min_user_key</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">smallest</span><span class="p">.</span><span class="n">user_key</span><span class="p">();</span>
    <span class="k">const</span> <span class="n">Slice</span> <span class="n">max_user_key</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">largest</span><span class="p">.</span><span class="n">user_key</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">level</span> <span class="o">=</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">PickLevelForMemTableOutput</span><span class="p">(</span><span class="n">min_user_key</span><span class="p">,</span> <span class="n">max_user_key</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">edit</span><span class="o">-&gt;</span><span class="n">AddFile</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">meta</span><span class="p">.</span><span class="n">number</span><span class="p">,</span> <span class="n">meta</span><span class="p">.</span><span class="n">file_size</span><span class="p">,</span> <span class="n">meta</span><span class="p">.</span><span class="n">smallest</span><span class="p">,</span>
                  <span class="n">meta</span><span class="p">.</span><span class="n">largest</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">CompactionStats</span> <span class="n">stats</span><span class="p">;</span>
  <span class="n">stats</span><span class="p">.</span><span class="n">micros</span> <span class="o">=</span> <span class="n">env_</span><span class="o">-&gt;</span><span class="n">NowMicros</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_micros</span><span class="p">;</span>
  <span class="n">stats</span><span class="p">.</span><span class="n">bytes_written</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">file_size</span><span class="p">;</span>
  <span class="n">stats_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">Add</span><span class="p">(</span><span class="n">stats</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>可以看到，构建sstable的核心在于<code>BuildTable</code>，构建好后会产生一个文件，这个文件的元信息则是通过<code>FileMetaData</code>来描述的，最后会将这个文件的元信息存入到<code>VersionEdit</code>中。
然后Apply到<code>Version</code>中。关于<code>Version</code>和<code>VersionEdit</code>后面的重点分析，现在我们重点来看下BuildTable的实现。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">BuildTable</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">Env</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span>
                  <span class="n">TableCache</span><span class="o">*</span> <span class="n">table_cache</span><span class="p">,</span> <span class="n">Iterator</span><span class="o">*</span> <span class="n">iter</span><span class="p">,</span> <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">meta</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Status</span> <span class="n">s</span><span class="p">;</span>
  <span class="n">meta</span><span class="o">-&gt;</span><span class="n">file_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">iter</span><span class="o">-&gt;</span><span class="n">SeekToFirst</span><span class="p">();</span>
  <span class="c1">// 1. 构造Table文件名</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">TableFileName</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">Valid</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">WritableFile</span><span class="o">*</span> <span class="n">file</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewWritableFile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">TableBuilder</span><span class="o">*</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TableBuilder</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
    <span class="n">meta</span><span class="o">-&gt;</span><span class="n">smallest</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">());</span>
    <span class="n">Slice</span> <span class="n">key</span><span class="p">;</span>
    <span class="c1">// 2. 遍历Memtable，将key/value存入到Table中</span>
    <span class="c1">// 因为Memtable是有序的，因此第一个key是最小的key，最后的key是最大的key</span>
    <span class="c1">// 将最小key和最大key这两个元信息存入到FileMeta中</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">Valid</span><span class="p">();</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">();</span>
      <span class="n">builder</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">meta</span><span class="o">-&gt;</span><span class="n">largest</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Finish and check for builder errors</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">Finish</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">meta</span><span class="o">-&gt;</span><span class="n">file_size</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">FileSize</span><span class="p">();</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="n">builder</span><span class="p">;</span>

    <span class="c1">// Finish and check for file errors</span>
    <span class="c1">// 3. 完成table构建后，开始进行文件sync，确保文件落盘</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">Sync</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">Close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="n">file</span><span class="p">;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// Verify that the table is usable</span>
      <span class="n">Iterator</span><span class="o">*</span> <span class="n">it</span> <span class="o">=</span> <span class="n">table_cache</span><span class="o">-&gt;</span><span class="n">NewIterator</span><span class="p">(</span><span class="n">ReadOptions</span><span class="p">(),</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
                                              <span class="n">meta</span><span class="o">-&gt;</span><span class="n">file_size</span><span class="p">);</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">();</span>
      <span class="k">delete</span> <span class="n">it</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Check for input iterator errors</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Keep it</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">RemoveFile</span><span class="p">(</span><span class="n">fname</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>通过上面的代码我们可以知道<code>TableBuilder</code>就是用来构建sstable的核心，而sstable本质上就是一个文件，文件内容是一系列排序好的key/value进行编码后的内容，那么它的格式到底是如何的呢?</p>
<p><img alt="sstable_physic" src="../img/sstable_physic.jpeg" /></p>
<p>为了提高整体的读写效率，一个sstable文件按照固定大小进行块划分，默认每个块的大小为4KiB。每个Block中，除了存储数据以外，还会存储两个额外的辅助字段：压缩类型和CRC校验码，上图就是其整体的
物理结构。进一步上面的Data部分又被分为了五类:</p>
<ol>
<li>data block 用来存储具体的key value数据</li>
<li>filter block 用来存储一些过滤器相关的数据</li>
<li>meta index block 用来存储filter block的索引信息(也就是filter block在sstable文件中的偏移量，以及数据的长度)</li>
<li>index block 用来存储每个data block的索引信息</li>
<li>footer 用来存储meta index block和index block的索引信息</li>
</ol>
<p><img alt="sstable_logic" src="../img/sstable_logic.jpeg" /></p>
<p>首先我们来看下data block的数据格式，如下图:</p>
<p><img alt="datablock" src="../img/datablock.jpeg" /></p>
<p>可以看到一个datablock内部包含了多个Entry，每一个Entry就是一个要存取的数据条目，也就是用户存入的key/value，让我们来看下Entry的编码格式，如下图:</p>
<p><img alt="entry_format" src="../img/entry_format.jpeg" /></p>
<p>一个Entry包含了5个部分，他们分别是:</p>
<ol>
<li>与前一条记录key共享部分的长度；</li>
<li>与前一条记录key不共享部分的长度；</li>
<li>value长度；</li>
<li>与前一条记录key非共享的内容；</li>
<li>value内容；</li>
</ol>
<p>可以看到，一个Entry并非包含了完整的key，而是和前一个key的共享前缀，因此编码和解码的时候都需要保存上一个key的信息，才能对key进行编码或解码。这种编码方式可以有效的避免key重复内容的存储，
因为key总是有序的，所以可以最大程度的通过共享前缀的部分来节省key存储的成本，但是带来的问题也是显而易见意见的，如果要从这个文件中检索一个key的话需要完整的将所有的key都解析出来。为此leveldb
设计了<code>Restart point</code>，也就是每间隔若干个keyvalue对，将为该条记录重新存储一个完整的key。重复该过程（默认间隔值为16），每个重新存储完整key的点称之为<code>Restart point</code>。有了<code>Restart point</code>
就可以通过这些完整的key快速定位目标key所在的区域。然后通过完整的key就可以还原这个区域中所有的key信息了。为了快速找到每一个<code>Restart point</code>，leveldb会在data block的末尾存储一系列的索引信息，
和长度，方便我们在加载data block的时候就可以把这些<code>Restart point</code>加载到内存中进行快速查找，接下来我们通过下面的代码再次验证上面描述到的原理。</p>
<blockquote>
<p>这个思想和skiplist有点类似，都是按照一定方式从原始数据进行抽样，典型的统计学原理。</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">BlockBuilder::Add</span><span class="p">(</span><span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Slice</span> <span class="n">last_key_piece</span><span class="p">(</span><span class="n">last_key_</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">finished_</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">counter_</span> <span class="o">&lt;=</span> <span class="n">options_</span><span class="o">-&gt;</span><span class="n">block_restart_interval</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">buffer_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span>  <span class="c1">// No values yet?</span>
         <span class="o">||</span> <span class="n">options_</span><span class="o">-&gt;</span><span class="n">comparator</span><span class="o">-&gt;</span><span class="n">Compare</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">last_key_piece</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">shared</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// 1. 没有到Restart point的间隔，因此这里需要计算共享前缀</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">counter_</span> <span class="o">&lt;</span> <span class="n">options_</span><span class="o">-&gt;</span><span class="n">block_restart_interval</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// See how much sharing to do with previous string</span>
    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">min_length</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">last_key_piece</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">key</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">shared</span> <span class="o">&lt;</span> <span class="n">min_length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">last_key_piece</span><span class="p">[</span><span class="n">shared</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">[</span><span class="n">shared</span><span class="p">]))</span> <span class="p">{</span>
      <span class="n">shared</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 2. 达到了Restart point的间隔了，因此这里需要存储完整的key/value，还需要记录索引信息(也就是restart poont的offset信息)</span>
    <span class="c1">// Restart compression</span>
    <span class="n">restarts_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">buffer_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="c1">// 计数器清零</span>
    <span class="n">counter_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">non_shared</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">shared</span><span class="p">;</span>

  <span class="c1">// 3. 开始写入共享部分的长度、非共享部分的长度、value的长度</span>
  <span class="c1">// Add &quot;&lt;shared&gt;&lt;non_shared&gt;&lt;value_size&gt;&quot; to buffer_</span>
  <span class="n">PutVarint32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">,</span> <span class="n">shared</span><span class="p">);</span>
  <span class="n">PutVarint32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">,</span> <span class="n">non_shared</span><span class="p">);</span>
  <span class="n">PutVarint32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

  <span class="c1">// 4. 写入共享部分的key内容、写入value的内容</span>
  <span class="c1">// Add string delta to buffer_ followed by value</span>
  <span class="n">buffer_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">shared</span><span class="p">,</span> <span class="n">non_shared</span><span class="p">);</span>
  <span class="n">buffer_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

  <span class="c1">// 5. 更新last key，用于下一个key计算前缀</span>
  <span class="c1">// Update state</span>
  <span class="n">last_key_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">shared</span><span class="p">);</span>
  <span class="n">last_key_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">shared</span><span class="p">,</span> <span class="n">non_shared</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">Slice</span><span class="p">(</span><span class="n">last_key_</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span><span class="p">);</span>
  <span class="n">counter_</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>每次添加key时产生的<code>Restart point</code>都存在了<code>restarts_</code>中，这是一个<code>std::vector&lt;uint32_t&gt;</code>类型，存储了每一个<code>Restart point</code>在data block中的offset。
在构建完<code>Restart point</code>后会将这些索引信息写入到data block中的尾部。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Slice</span> <span class="nf">BlockBuilder::Finish</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Append restart array</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">restarts_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PutFixed32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">,</span> <span class="n">restarts_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">PutFixed32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">,</span> <span class="n">restarts_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">finished_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">Slice</span><span class="p">(</span><span class="n">buffer_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>到此为止data block的构建就分析完了，通过<code>Restart point</code>可以让我们快速定位要查询的数据在data block中的位置，但是这一切的前提是我们已经知道这个data block中存在我们要查询的数据。
否则我们依然先需要遍历每一个data block。如果我们能高效的先过滤处包含要查询数据的data block那该多棒啊。Leveldb中设计了filter block帮助我们实现这个能力。接下来让我们看看filter block的格式，
以及设计filter block是如何帮助我们快速查询的吧。</p>
<p><img alt="filter block" src="../img/filterblock_format.jpeg" /></p>
<p>通过上图可知，filter block中包含了三个部分，第一个部分存放过滤的数据、第二个部分则存放每个过滤数据的索引位置，第三个部分是用来记录第二个部分的开始位置避免和第一个部分的数据混在一起无法区分，
最后一个部分的数据是Base lg，占用1个字节，默认值是11，表示每隔2KB的数据就创建一个新的过滤器来存放。一个sstable文件只有一个filter block，其内部存储了所有data block的filter数据。
接下来让我们看下filter block是如何构建的。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">FilterBlockBuilder::StartBlock</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">block_offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint64_t</span> <span class="n">filter_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_offset</span> <span class="o">/</span> <span class="n">kFilterBase</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">filter_index</span> <span class="o">&gt;=</span> <span class="n">filter_offsets_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>\
  <span class="c1">// StartBlock(0) 这个时候不会产生任何filter数据</span>
  <span class="c1">// StartBlock(3K) 因为kFilterBase是2k，因此只需要产生一条filter数据即可，这个时候会调用一次GenerateFilter产生一个filter数据</span>
  <span class="c1">// 可以看到filter数据的产生并非严格意义上的按照2k为单位的，而只是将0~3K这个范围内添加的key一起生成一个filter数据而已。</span>
  <span class="c1">// StartBlock(4K) 因为kFilterBase是2k，因此需要产生二条filter数据，实际上只会生成两条内容相同的filter数据</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">filter_index</span> <span class="o">&gt;</span> <span class="n">filter_offsets_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">GenerateFilter</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">FilterBlockBuilder::AddKey</span><span class="p">(</span><span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Slice</span> <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
  <span class="n">start_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">keys_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">keys_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">k</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// 对所有的key计算处filter数据，并存入result_中</span>
<span class="kt">void</span> <span class="nf">FilterBlockBuilder::GenerateFilter</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">num_keys</span> <span class="o">=</span> <span class="n">start_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">num_keys</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Fast path if there are no keys for this filter</span>
    <span class="n">filter_offsets_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">result_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Make list of keys from flattened key structure</span>
  <span class="n">start_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">keys_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>  <span class="c1">// Simplify length computation</span>
  <span class="n">tmp_keys_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">num_keys</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_keys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">base</span> <span class="o">=</span> <span class="n">keys_</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">start_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">length</span> <span class="o">=</span> <span class="n">start_</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">tmp_keys_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Generate filter for current set of keys and append to result_.</span>
  <span class="n">filter_offsets_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">result_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">policy_</span><span class="o">-&gt;</span><span class="n">CreateFilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_keys_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">num_keys</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">result_</span><span class="p">);</span>

  <span class="n">tmp_keys_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">keys_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">start_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>构建filter数据是通过指定的filter过滤器，拿着所有的key作为输入，然后产生一个filter数据的结果。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Slice</span> <span class="nf">FilterBlockBuilder::Finish</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 如果最后还有key存在，就把剩下的key生成filter数据</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">GenerateFilter</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Append array of per-filter offsets</span>
  <span class="c1">// 记录filter offet的位置</span>
  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">array_offset</span> <span class="o">=</span> <span class="n">result_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter_offsets_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 添加filter offset</span>
    <span class="n">PutFixed32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_</span><span class="p">,</span> <span class="n">filter_offsets_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">PutFixed32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_</span><span class="p">,</span> <span class="n">array_offset</span><span class="p">);</span>
  <span class="n">result_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">kFilterBaseLg</span><span class="p">);</span>  <span class="c1">// Save encoding parameter in result</span>
  <span class="k">return</span> <span class="n">Slice</span><span class="p">(</span><span class="n">result_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>所有产生的filter数据都会放在一个Block中，当我们想对某一个Data Block进行过滤的时候，如何知道自己需要使用哪个filter数据呢? 这是通过Data Block的offset除以Base lg
就可以知道这块数据要使用第几个filter数据了，即使知道使用第几个filter数据，仍然不足以知道对应filter数据在Block中的offset，除非从头开始遍历。但是这样效率就太低了。
因此leveldb在Filter Block的尾部存放了索引，这些索引指明了第N个filter在Block中的offset，我们只要提前把索引加载到内存中就可以快速的找到第N个filter数据了。但是索引数据
和filter数据本身都是放在同一个block中的，我们要如何找到索引数据在Block中的位置的呢? 这就靠尾部存放的offset了，在data block尾部的有两个固定大小的内容，它告诉我们缩影数据的位置，
有了这个位置后就可以快速找到索引数据了。通过下面的<code>FilterBlockReader</code>也可以验证我们上述分析的结论。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">FilterBlockReader</span><span class="o">::</span><span class="n">FilterBlockReader</span><span class="p">(</span><span class="k">const</span> <span class="n">FilterPolicy</span><span class="o">*</span> <span class="n">policy</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">contents</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">policy_</span><span class="p">(</span><span class="n">policy</span><span class="p">),</span> <span class="n">data_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span> <span class="n">offset_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span> <span class="n">num_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">base_lg_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">contents</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="c1">// 至少需要 1 + 4 个字节，1个字节存放Base lg、4个字节filter offset位置</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  <span class="c1">// 1 byte for base_lg_ and 4 for start of offset array</span>
  <span class="c1">// 先获取到base lg</span>
  <span class="n">base_lg_</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="c1">// 获取到filter offset位置</span>
  <span class="kt">uint32_t</span> <span class="n">last_word</span> <span class="o">=</span> <span class="n">DecodeFixed32</span><span class="p">(</span><span class="n">contents</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">last_word</span> <span class="o">&gt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">data_</span> <span class="o">=</span> <span class="n">contents</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="n">offset_</span> <span class="o">=</span> <span class="n">data_</span> <span class="o">+</span> <span class="n">last_word</span><span class="p">;</span>
  <span class="c1">// 获取有多少个filter数据</span>
  <span class="n">num_</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">-</span> <span class="n">last_word</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">FilterBlockReader</span><span class="o">::</span><span class="n">KeyMayMatch</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">block_offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// block offset / base lg就可以计算出对应的filter数据在哪个位置</span>
  <span class="kt">uint64_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">block_offset</span> <span class="o">&gt;&gt;</span> <span class="n">base_lg_</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">num_</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//找到对应filter的位置，以及下一个filter的位置</span>
    <span class="kt">uint32_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">DecodeFixed32</span><span class="p">(</span><span class="n">offset_</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">DecodeFixed32</span><span class="p">(</span><span class="n">offset_</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="c1">// 确认数据是合法的，就将filter数据保存下来，然后开始进行过滤器匹配</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">offset_</span> <span class="o">-</span> <span class="n">data_</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">Slice</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">data_</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span> <span class="n">limit</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">policy_</span><span class="o">-&gt;</span><span class="n">KeyMayMatch</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Empty filters do not match any keys</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>  <span class="c1">// Errors are treated as potential matches</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Filter block本质上也是一个和Data Block一样的Block块，他们都是一起放在一个sstable文件中的，那我们如何知道Filter Block在文件中的位置呢? 
在Leveldb中是通过meta index block来进行索引的，这是一个和Data Block格式相同的block，也是key/value形式，key就是，"filter."与过滤器名字组成的常量字符串，
value为filter block在sstable中的索引信息序列化后的内容，索引信息包括：</p>
<ol>
<li>在sstable中的偏移量</li>
<li>数据长度</li>
</ol>
<p>索引信息在Leveldb中使用BlockHandle对象来表示。 </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// BlockHandle is a pointer to the extent of a file that stores a data</span>
<span class="c1">// block or a meta block.</span>
<span class="k">class</span> <span class="nc">BlockHandle</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">// Maximum encoding length of a BlockHandle</span>
  <span class="k">enum</span> <span class="p">{</span> <span class="n">kMaxEncodedLength</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">};</span>

  <span class="n">BlockHandle</span><span class="p">();</span>

  <span class="c1">// The offset of the block in the file.</span>
  <span class="kt">uint64_t</span> <span class="nf">offset</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">offset_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">set_offset</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span> <span class="n">offset_</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span> <span class="p">}</span>

  <span class="c1">// The size of the stored block</span>
  <span class="kt">uint64_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">set_size</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="n">size_</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">EncodeTo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">dst</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="n">Status</span> <span class="nf">DecodeFrom</span><span class="p">(</span><span class="n">Slice</span><span class="o">*</span> <span class="n">input</span><span class="p">);</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="kt">uint64_t</span> <span class="n">offset_</span><span class="p">;</span>
  <span class="kt">uint64_t</span> <span class="n">size_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>除了filter block需要索引，我们的Data Block也需要索引，Leveldb中通过index block来对Data Block进行索引，其block的格式和Data Block一样，也是key/value
形式，其key为对应Data Block的最大key，value为Data Block在sstable中的索引信息序列化后的内容，也就是offset和size。</p>
<p>可以看出meta index block和index block用途是相同的，都是为了对某一类block的索引，而且这两类block和Data Block本身的格式又是相同的，因此可以完全复用相同的DBlock对象。
最后为了索引meta index block和index block，Leveldb在整个sstable的尾部添加了Footer，目的是为了添加一个magic number以确保sstable是完整的，以及对meta index block
index block进行索引。下面是footer的格式。</p>
<p><img alt="footer block" src="../img/footer_format.jpeg" /></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">Footer::DecodeFrom</span><span class="p">(</span><span class="n">Slice</span><span class="o">*</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 解码出magic number</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">magic_ptr</span> <span class="o">=</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">kEncodedLength</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">magic_lo</span> <span class="o">=</span> <span class="n">DecodeFixed32</span><span class="p">(</span><span class="n">magic_ptr</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">magic_hi</span> <span class="o">=</span> <span class="n">DecodeFixed32</span><span class="p">(</span><span class="n">magic_ptr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">magic</span> <span class="o">=</span> <span class="p">((</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">magic_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
                          <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">magic_lo</span><span class="p">)));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">kTableMagicNumber</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">&quot;not an sstable (bad magic number)&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 解码出meta index的索引信息</span>
  <span class="n">Status</span> <span class="n">result</span> <span class="o">=</span> <span class="n">metaindex_handle_</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// 解码出index的索引信息</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">index_handle_</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// We skip over any leftover data (just padding for now) in &quot;input&quot;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">end</span> <span class="o">=</span> <span class="n">magic_ptr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
    <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">end</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>到此维持sstable就全部分析完了，一个sstable中包含了5类信息，Data block、Filter block、meta index block、index block、footer。 读取sstable的时候
先读取footer，通过footer找到index block和meta index block，有了meta index block后就可以对查询做filter过滤，有了index block就可以定位到Data Block
最终通过遍历Data block找到最终要查询的key所对应的value。对照的代码我们再次验证我们的猜想。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">Table::Open</span><span class="p">(</span><span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="n">RandomAccessFile</span><span class="o">*</span> <span class="n">file</span><span class="p">,</span>
                   <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">Table</span><span class="o">**</span> <span class="n">table</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">Footer</span><span class="o">::</span><span class="n">kEncodedLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">&quot;file is too short to be an sstable&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">char</span> <span class="n">footer_space</span><span class="p">[</span><span class="n">Footer</span><span class="o">::</span><span class="n">kEncodedLength</span><span class="p">];</span>
  <span class="n">Slice</span> <span class="n">footer_input</span><span class="p">;</span>
  <span class="c1">// 1. 读取footer</span>
  <span class="n">Status</span> <span class="n">s</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">Read</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">Footer</span><span class="o">::</span><span class="n">kEncodedLength</span><span class="p">,</span> <span class="n">Footer</span><span class="o">::</span><span class="n">kEncodedLength</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">footer_input</span><span class="p">,</span> <span class="n">footer_space</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="k">return</span> <span class="n">s</span><span class="p">;</span>

  <span class="n">Footer</span> <span class="n">footer</span><span class="p">;</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">footer</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">footer_input</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="k">return</span> <span class="n">s</span><span class="p">;</span>

  <span class="c1">// Read the index block</span>
  <span class="c1">// 2. 读取index block</span>
  <span class="n">BlockContents</span> <span class="n">index_block_contents</span><span class="p">;</span>
  <span class="n">ReadOptions</span> <span class="n">opt</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">paranoid_checks</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">opt</span><span class="p">.</span><span class="n">verify_checksums</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 通过index block的索引信息找到index block</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">ReadBlock</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">footer</span><span class="p">.</span><span class="n">index_handle</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">index_block_contents</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// We&#39;ve successfully read the footer and the index block: we&#39;re</span>
    <span class="c1">// ready to serve requests.</span>
    <span class="n">Block</span><span class="o">*</span> <span class="n">index_block</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Block</span><span class="p">(</span><span class="n">index_block_contents</span><span class="p">);</span>
    <span class="n">Rep</span><span class="o">*</span> <span class="n">rep</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Table</span><span class="o">::</span><span class="n">Rep</span><span class="p">;</span>
    <span class="n">rep</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
    <span class="n">rep</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
    <span class="n">rep</span><span class="o">-&gt;</span><span class="n">metaindex_handle</span> <span class="o">=</span> <span class="n">footer</span><span class="p">.</span><span class="n">metaindex_handle</span><span class="p">();</span>
    <span class="n">rep</span><span class="o">-&gt;</span><span class="n">index_block</span> <span class="o">=</span> <span class="n">index_block</span><span class="p">;</span>
    <span class="n">rep</span><span class="o">-&gt;</span><span class="n">cache_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">block_cache</span> <span class="o">?</span> <span class="n">options</span><span class="p">.</span><span class="n">block_cache</span><span class="o">-&gt;</span><span class="n">NewId</span><span class="p">()</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">rep</span><span class="o">-&gt;</span><span class="n">filter_data</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">rep</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Table</span><span class="p">(</span><span class="n">rep</span><span class="p">);</span>
    <span class="c1">// 3. 读取filter block</span>
    <span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ReadMeta</span><span class="p">(</span><span class="n">footer</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>上面的代码是打开sstable文件，构建一个Table的过程，可以看到和我们上述描述的基本一致，通过footer加载了filter block和index block。 接着我们来看下如果在Table查询key。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">Table::InternalGet</span><span class="p">(</span><span class="k">const</span> <span class="n">ReadOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">,</span>
                          <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handle_result</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">,</span>
                                                <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">Status</span> <span class="n">s</span><span class="p">;</span>
  <span class="c1">// 1. 遍历index block中的内容</span>
  <span class="n">Iterator</span><span class="o">*</span> <span class="n">iiter</span> <span class="o">=</span> <span class="n">rep_</span><span class="o">-&gt;</span><span class="n">index_block</span><span class="o">-&gt;</span><span class="n">NewIterator</span><span class="p">(</span><span class="n">rep_</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">comparator</span><span class="p">);</span>
  <span class="c1">// 2. 通过key找到第一个大于要查询key的entry(index block的key就是每个data block中的最大key)</span>
  <span class="n">iiter</span><span class="o">-&gt;</span><span class="n">Seek</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">iiter</span><span class="o">-&gt;</span><span class="n">Valid</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// 获取value(value就是真正的Data Block的索引)</span>
    <span class="n">Slice</span> <span class="n">handle_value</span> <span class="o">=</span> <span class="n">iiter</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">();</span>
    <span class="c1">// 3. 先进行filter过滤</span>
    <span class="n">FilterBlockReader</span><span class="o">*</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">rep_</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>
    <span class="n">BlockHandle</span> <span class="n">handle</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">handle</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle_value</span><span class="p">).</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">KeyMayMatch</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">offset</span><span class="p">(),</span> <span class="n">k</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Not found</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 读取Data Block</span>
      <span class="n">Iterator</span><span class="o">*</span> <span class="n">block_iter</span> <span class="o">=</span> <span class="n">BlockReader</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">iiter</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>
      <span class="c1">// 4. 找到key的位置，调用handle_result处理查询到的结果</span>
      <span class="n">block_iter</span><span class="o">-&gt;</span><span class="n">Seek</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">block_iter</span><span class="o">-&gt;</span><span class="n">Valid</span><span class="p">())</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">*</span><span class="n">handle_result</span><span class="p">)(</span><span class="n">arg</span><span class="p">,</span> <span class="n">block_iter</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">(),</span> <span class="n">block_iter</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">block_iter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">();</span>
      <span class="k">delete</span> <span class="n">block_iter</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">iiter</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">delete</span> <span class="n">iiter</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="table-cache">Table Cache</h2>
<p>通过Table Cache缓存Table(是sstable加载到内存后的形式)，缓存的key是file_number</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">TableCache::Get</span><span class="p">(</span><span class="k">const</span> <span class="n">ReadOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">file_number</span><span class="p">,</span>
                       <span class="kt">uint64_t</span> <span class="n">file_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">,</span>
                       <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handle_result</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">,</span>
                                             <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">Cache</span><span class="o">::</span><span class="n">Handle</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="c1">// 根据给的file number、file size等信息将sstable加载到内存中，然后进行查询。</span>
  <span class="c1">// TableCache就是用来缓存sstable的。</span>
  <span class="n">Status</span> <span class="n">s</span> <span class="o">=</span> <span class="n">FindTable</span><span class="p">(</span><span class="n">file_number</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Table</span><span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">TableAndFile</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">InternalGet</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">handle_result</span><span class="p">);</span>
    <span class="n">cache_</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Status</span> <span class="nf">TableCache::FindTable</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">file_number</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">file_size</span><span class="p">,</span>
                             <span class="n">Cache</span><span class="o">::</span><span class="n">Handle</span><span class="o">**</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Status</span> <span class="n">s</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">file_number</span><span class="p">)];</span>
  <span class="n">EncodeFixed64</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">file_number</span><span class="p">);</span>
  <span class="c1">// file number作为Table的key</span>
  <span class="n">Slice</span> <span class="n">key</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="c1">// 先查询这个file number对应的sstable是否已经缓存</span>
  <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cache_</span><span class="o">-&gt;</span><span class="n">Lookup</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
  <span class="c1">// 如果没有缓存就创建Table，并缓存起来</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">handle</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">TableFileName</span><span class="p">(</span><span class="n">dbname_</span><span class="p">,</span> <span class="n">file_number</span><span class="p">);</span>
    <span class="n">RandomAccessFile</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">Table</span><span class="o">*</span> <span class="n">table</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env_</span><span class="o">-&gt;</span><span class="n">NewRandomAccessFile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">old_fname</span> <span class="o">=</span> <span class="n">SSTTableFileName</span><span class="p">(</span><span class="n">dbname_</span><span class="p">,</span> <span class="n">file_number</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">env_</span><span class="o">-&gt;</span><span class="n">NewRandomAccessFile</span><span class="p">(</span><span class="n">old_fname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">).</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">OK</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">Table</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="n">options_</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">);</span>
      <span class="k">delete</span> <span class="n">file</span><span class="p">;</span>
      <span class="c1">// We do not cache error results so that if the error is transient,</span>
      <span class="c1">// or somebody repairs the file, we recover automatically.</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">TableAndFile</span><span class="o">*</span> <span class="n">tf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TableAndFile</span><span class="p">;</span>
      <span class="n">tf</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
      <span class="n">tf</span><span class="o">-&gt;</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">;</span>
      <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cache_</span><span class="o">-&gt;</span><span class="n">Insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DeleteEntry</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="version-versionedit-versionset">Version / VersionEdit / VersionSet</h2>
<p>每次我们进行Compation的时候，可能会新增sstable文件，也有可能会删除老的sstable文件，无论删除还是新增，这些变化都会生成VersionEdit对象，通过这个对象来描述
sstable文件的变化。VersionEdit需要Apply到Version中，通过Version我们就可以知道当前版本下有多少sstable文件。因为Leveldb可能会存在多个版本，因此就有了
VersionSet，通过链表的方式来管理多个Version。下面是一个VersionEdit如何Apply到Version的过程。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Status</span> <span class="nf">VersionSet::LogAndApply</span><span class="p">(</span><span class="n">VersionEdit</span><span class="o">*</span> <span class="n">edit</span><span class="p">,</span> <span class="n">port</span><span class="o">::</span><span class="n">Mutex</span><span class="o">*</span> <span class="n">mu</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">edit</span><span class="o">-&gt;</span><span class="n">has_log_number_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">edit</span><span class="o">-&gt;</span><span class="n">log_number_</span> <span class="o">&gt;=</span> <span class="n">log_number_</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">edit</span><span class="o">-&gt;</span><span class="n">log_number_</span> <span class="o">&lt;</span> <span class="n">next_file_number_</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">edit</span><span class="o">-&gt;</span><span class="n">SetLogNumber</span><span class="p">(</span><span class="n">log_number_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edit</span><span class="o">-&gt;</span><span class="n">has_prev_log_number_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">edit</span><span class="o">-&gt;</span><span class="n">SetPrevLogNumber</span><span class="p">(</span><span class="n">prev_log_number_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">edit</span><span class="o">-&gt;</span><span class="n">SetNextFile</span><span class="p">(</span><span class="n">next_file_number_</span><span class="p">);</span>
  <span class="n">edit</span><span class="o">-&gt;</span><span class="n">SetLastSequence</span><span class="p">(</span><span class="n">last_sequence_</span><span class="p">);</span>

  <span class="c1">// 1. 创建一个新的Version</span>
  <span class="n">Version</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Version</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">{</span>
    <span class="c1">// 2. 将VersionEdit做Apply当前的Version，然后产生一个新的Version</span>
    <span class="n">Builder</span> <span class="n">builder</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">current_</span><span class="p">);</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Apply</span><span class="p">(</span><span class="n">edit</span><span class="p">);</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">SaveTo</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// 3. 提前计算出下一次Compation需要合并的level和sstable文件</span>
  <span class="n">Finalize</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

  <span class="c1">// 4. 最后将Version信息存入到Manifest文件中。</span>
  <span class="c1">// Initialize new descriptor log file if necessary by creating</span>
  <span class="c1">// a temporary file that contains a snapshot of the current version.</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">new_manifest_file</span><span class="p">;</span>
  <span class="n">Status</span> <span class="n">s</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">descriptor_log_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// No reason to unlock *mu here since we only hit this path in the</span>
    <span class="c1">// first call to LogAndApply (when opening the database).</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">descriptor_file_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">);</span>
    <span class="n">new_manifest_file</span> <span class="o">=</span> <span class="n">DescriptorFileName</span><span class="p">(</span><span class="n">dbname_</span><span class="p">,</span> <span class="n">manifest_file_number_</span><span class="p">);</span>
    <span class="n">edit</span><span class="o">-&gt;</span><span class="n">SetNextFile</span><span class="p">(</span><span class="n">next_file_number_</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env_</span><span class="o">-&gt;</span><span class="n">NewWritableFile</span><span class="p">(</span><span class="n">new_manifest_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">descriptor_file_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">descriptor_log_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">log</span><span class="o">::</span><span class="n">Writer</span><span class="p">(</span><span class="n">descriptor_file_</span><span class="p">);</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">WriteSnapshot</span><span class="p">(</span><span class="n">descriptor_log_</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Unlock during expensive MANIFEST log write</span>
  <span class="p">{</span>
    <span class="n">mu</span><span class="o">-&gt;</span><span class="n">Unlock</span><span class="p">();</span>

    <span class="c1">// Write new record to MANIFEST log</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">record</span><span class="p">;</span>
      <span class="n">edit</span><span class="o">-&gt;</span><span class="n">EncodeTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">record</span><span class="p">);</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">descriptor_log_</span><span class="o">-&gt;</span><span class="n">AddRecord</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">descriptor_file_</span><span class="o">-&gt;</span><span class="n">Sync</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">(</span><span class="n">options_</span><span class="o">-&gt;</span><span class="n">info_log</span><span class="p">,</span> <span class="s">&quot;MANIFEST write: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">ToString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// If we just created a new descriptor file, install it by writing a</span>
    <span class="c1">// new CURRENT file that points to it.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">new_manifest_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">SetCurrentFile</span><span class="p">(</span><span class="n">env_</span><span class="p">,</span> <span class="n">dbname_</span><span class="p">,</span> <span class="n">manifest_file_number_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">mu</span><span class="o">-&gt;</span><span class="n">Lock</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Install the new version</span>
  <span class="c1">// 5. 重新设置当前Version为最新产生的Version</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">AppendVersion</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="n">log_number_</span> <span class="o">=</span> <span class="n">edit</span><span class="o">-&gt;</span><span class="n">log_number_</span><span class="p">;</span>
    <span class="n">prev_log_number_</span> <span class="o">=</span> <span class="n">edit</span><span class="o">-&gt;</span><span class="n">prev_log_number_</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_manifest_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="n">descriptor_log_</span><span class="p">;</span>
      <span class="k">delete</span> <span class="n">descriptor_file_</span><span class="p">;</span>
      <span class="n">descriptor_log_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
      <span class="n">descriptor_file_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
      <span class="n">env_</span><span class="o">-&gt;</span><span class="n">RemoveFile</span><span class="p">(</span><span class="n">new_manifest_file</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="manifest">Manifest</h2>
<h2 id="compation">Compation</h2>
<p>在Leveldb中Compation分为两种，第一种被称为Minor Compation，只有当immutable存在的时候才会触发，将immutable变成sstable，其过程如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">DBImpl::CompactMemTable</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">AssertHeld</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">imm_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>

  <span class="c1">// Save the contents of the memtable as a new Table</span>
  <span class="n">VersionEdit</span> <span class="n">edit</span><span class="p">;</span>
  <span class="n">Version</span><span class="o">*</span> <span class="n">base</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">();</span>
  <span class="n">base</span><span class="o">-&gt;</span><span class="n">Ref</span><span class="p">();</span>
  <span class="c1">// 1. 产生新的sstable文件，因此这里初始化了VersionEdit来记录sstable文件的变化</span>
  <span class="n">Status</span> <span class="n">s</span> <span class="o">=</span> <span class="n">WriteLevel0Table</span><span class="p">(</span><span class="n">imm_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edit</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
  <span class="n">base</span><span class="o">-&gt;</span><span class="n">Unref</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">shutting_down_</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">IOError</span><span class="p">(</span><span class="s">&quot;Deleting DB during memtable compaction&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Replace immutable memtable with the generated Table</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">edit</span><span class="p">.</span><span class="n">SetPrevLogNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">edit</span><span class="p">.</span><span class="n">SetLogNumber</span><span class="p">(</span><span class="n">logfile_number_</span><span class="p">);</span>  <span class="c1">// Earlier logs no longer needed</span>
    <span class="c1">// 2. 应用到VersionSet中。</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">LogAndApply</span><span class="p">(</span><span class="o">&amp;</span><span class="n">edit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// 3. 释放immutable，然后异常一些废弃的文件</span>
    <span class="c1">// Commit to the new state</span>
    <span class="n">imm_</span><span class="o">-&gt;</span><span class="n">Unref</span><span class="p">();</span>
    <span class="n">imm_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">has_imm_</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
    <span class="n">RemoveObsoleteFiles</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">RecordBackgroundError</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>产生的sstable文件也是分为多个level的。在sstable中查找的时候，先从高level的sstable文件中查找，然后依次从下一个level中进行查找，高level的sstable包含的key范围越广。
上面的<code>WriteLevel0Table</code>也并非只是将sstable写入到level0中，而是会通过下面这个函数找到一个合适的level。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">Version::PickLevelForMemTableOutput</span><span class="p">(</span><span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">smallest_user_key</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">largest_user_key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// 1. 先判断level0中的sstable和新增的sstable是否重叠，如果重叠就直接添加进去等着Major Compaction</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OverlapInLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smallest_user_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">largest_user_key</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Push to next level if there is no overlap in next level,</span>
    <span class="c1">// and the #bytes overlapping in the level after that are limited.</span>
    <span class="n">InternalKey</span> <span class="n">start</span><span class="p">(</span><span class="n">smallest_user_key</span><span class="p">,</span> <span class="n">kMaxSequenceNumber</span><span class="p">,</span> <span class="n">kValueTypeForSeek</span><span class="p">);</span>
    <span class="n">InternalKey</span> <span class="n">limit</span><span class="p">(</span><span class="n">largest_user_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ValueType</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FileMetaData</span><span class="o">*&gt;</span> <span class="n">overlaps</span><span class="p">;</span>
    <span class="c1">// 2. 如果不重叠就继续往下一个level查找，如果下一个level也不重叠，并且下下个level重叠的大小小于 10 * 2M。</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">::</span><span class="n">kMaxMemCompactLevel</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">OverlapInLevel</span><span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smallest_user_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">largest_user_key</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Check that file does not overlap too many grandparent bytes.</span>
        <span class="n">GetOverlappingInputs</span><span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">limit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">overlaps</span><span class="p">);</span>
        <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">TotalFileSize</span><span class="p">(</span><span class="n">overlaps</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&gt;</span> <span class="n">MaxGrandParentOverlapBytes</span><span class="p">(</span><span class="n">vset_</span><span class="o">-&gt;</span><span class="n">options_</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// 3. 符合条件递增level，继续查找。</span>
      <span class="n">level</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>这么做的目的是为了避免Compation，当一个sstable文件准备添加进去的时候，如果和level0并没有任何键重叠，并且上一层也没有重叠，而且上上层重叠大小不超过20M，那么可以直接
将文件放到上一层，避免Major Compaction，算是一种优化吧。不过这个条件还是挺苛刻的。后面在谈到Major Compaction的时候会说到leveldb中更多关于Compation的优化。
到此为止minor Compation算是讲完了，还是比较简单的，这也是leveldb对于Minor Compation的要求，要求其尽可能短的时间内完成，否则会堵塞正常的写入操作，因此Minor Compation
的优先级是高于major compation。</p>
<p>Leveldb中除了上面谈到的Minor Compation外，还有一个最重要的Compation就是Major Compation了，上面说到一次minor compaction的产出是一个0层的sstable文件(也有可能因为优化产生一个高level的文件)，
其中包含了所有的内存数据。但是若干个0层文件中是可能存在数据overlap的。如果只有minor compaction，那么要查询一个数据的时候，就导致了我们需要遍历所有的level0文件。为此有了Major Compation。
通过Major Compation将level0层中重叠的文件进行merge变成不重叠的文件，并放到level1中。以确保level1的文件都是不重叠的，那么我们只需要在level1中搜索依次就可以找到目的文件了。那么到底何时触发Major Compation呢? Major Compation的过程是如何的? 首先来看下Major Compation发生的条件:</p>
<ol>
<li>当0层文件数超过预定的上限（默认为4个）</li>
<li>当level i层文件的总大小超过(10 ^ i) MB；</li>
<li>当某个文件无效读取的次数过多</li>
</ol>
<p>每次做完Minor Compation的时候都会调用<code>Finalize</code>来计算Major Compation需要操作的文件和level，计算的条件就是上面的第一条和第二条，下面这个函数会将第一个和第二条件转换分数进行计算。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">VersionSet::Finalize</span><span class="p">(</span><span class="n">Version</span><span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Precomputed best level for next compaction</span>
  <span class="kt">int</span> <span class="n">best_level</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">best_score</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// We treat level-0 specially by bounding the number of files</span>
      <span class="c1">// instead of number of bytes for two reasons:</span>
      <span class="c1">//</span>
      <span class="c1">// (1) With larger write-buffer sizes, it is nice not to do too</span>
      <span class="c1">// many level-0 compactions.</span>
      <span class="c1">//</span>
      <span class="c1">// (2) The files in level-0 are merged on every read and</span>
      <span class="c1">// therefore we wish to avoid too many files when the individual</span>
      <span class="c1">// file size is small (perhaps because of a small write-buffer</span>
      <span class="c1">// setting, or very high compression ratios, or lots of</span>
      <span class="c1">// overwrites/deletions).</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span>
              <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="o">::</span><span class="n">kL0_CompactionTrigger</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Compute the ratio of current size to size limit.</span>
      <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">level_bytes</span> <span class="o">=</span> <span class="n">TotalFileSize</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
      <span class="n">score</span> <span class="o">=</span>
          <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">level_bytes</span><span class="p">)</span> <span class="o">/</span> <span class="n">MaxBytesForLevel</span><span class="p">(</span><span class="n">options_</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">best_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
      <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">v</span><span class="o">-&gt;</span><span class="n">compaction_level_</span> <span class="o">=</span> <span class="n">best_level</span><span class="p">;</span>
  <span class="n">v</span><span class="o">-&gt;</span><span class="n">compaction_score_</span> <span class="o">=</span> <span class="n">best_score</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>每次进行数据查询的时候，都会产生stats，这些stats记录了哪个文件未查询到的次数，如果无效读取次数太多就会记录下来，保存在<code>file_to_compact_</code>中，这就是对应到上面的第三个条件。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">bool</span> <span class="nf">Version::UpdateStats</span><span class="p">(</span><span class="k">const</span> <span class="n">GetStats</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">seek_file</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">f</span><span class="o">-&gt;</span><span class="n">allowed_seeks</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">allowed_seeks</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">file_to_compact_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">file_to_compact_</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
      <span class="n">file_to_compact_level_</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">seek_file_level</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>最后通过compaction_score_和file_to_compact_两个值来决定是否需要做Major Compation。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// Returns true iff some level needs a compaction.</span>
  <span class="kt">bool</span> <span class="nf">NeedsCompaction</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">Version</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">current_</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">compaction_score_</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">file_to_compact_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">DBImpl::MaybeScheduleCompaction</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">AssertHeld</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">background_compaction_scheduled_</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Already scheduled</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shutting_down_</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// DB is being deleted; no more background compactions</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bg_error_</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Already got an error; no more changes</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imm_</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">manual_compaction_</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span>
             <span class="o">!</span><span class="n">versions_</span><span class="o">-&gt;</span><span class="n">NeedsCompaction</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// No work to be done</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 如果满足Compation的条件，开始进行下一次Compation</span>
    <span class="n">background_compaction_scheduled_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">env_</span><span class="o">-&gt;</span><span class="n">Schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DBImpl</span><span class="o">::</span><span class="n">BGWork</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>MaybeScheduleCompaction会在以下几个地方执行。</p>
<ol>
<li>上一次Compation完成后，会调用MaybeScheduleCompaction，决定是否需要进行下一次Compation</li>
<li>每次查询完数据后，会调用MaybeScheduleCompaction</li>
<li>Mmemtab切换成immutable的时候</li>
<li>RecordReadSample</li>
</ol>
<p>说完了Major Compation触发的条件，那么接下来我们来看看Major Compation的过程是如何的?</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Compaction</span><span class="o">*</span> <span class="nf">VersionSet::PickCompaction</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Compaction</span><span class="o">*</span> <span class="n">c</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

  <span class="c1">// We prefer compactions triggered by too much data in a level over</span>
  <span class="c1">// the compactions triggered by seeks.</span>
  <span class="k">const</span> <span class="kt">bool</span> <span class="n">size_compaction</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">compaction_score_</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">bool</span> <span class="n">seek_compaction</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">file_to_compact_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size_compaction</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">compaction_level_</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span><span class="p">);</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Compaction</span><span class="p">(</span><span class="n">options_</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

    <span class="c1">// Pick the first file that comes after compact_pointer_[level]</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">compact_pointer_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span>
          <span class="n">icmp_</span><span class="p">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">largest</span><span class="p">.</span><span class="n">Encode</span><span class="p">(),</span> <span class="n">compact_pointer_</span><span class="p">[</span><span class="n">level</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// Wrap-around to the beginning of the key space</span>
      <span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seek_compaction</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">file_to_compact_level_</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Compaction</span><span class="p">(</span><span class="n">options_</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">file_to_compact_</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">c</span><span class="o">-&gt;</span><span class="n">input_version_</span> <span class="o">=</span> <span class="n">current_</span><span class="p">;</span>
  <span class="n">c</span><span class="o">-&gt;</span><span class="n">input_version_</span><span class="o">-&gt;</span><span class="n">Ref</span><span class="p">();</span>

  <span class="c1">// Files in level 0 may overlap each other, so pick up all overlapping ones</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InternalKey</span> <span class="n">smallest</span><span class="p">,</span> <span class="n">largest</span><span class="p">;</span>
    <span class="n">GetRange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">smallest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">largest</span><span class="p">);</span>
    <span class="c1">// Note that the next call will discard the file we placed in</span>
    <span class="c1">// c-&gt;inputs_[0] earlier and replace it with an overlapping set</span>
    <span class="c1">// which will include the picked file.</span>
    <span class="n">current_</span><span class="o">-&gt;</span><span class="n">GetOverlappingInputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smallest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">largest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">empty</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">SetupOtherInputs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="filetype">FileType</h2>
<ol>
<li><code>CURRENT</code></li>
</ol>
<p>里面存放了当前的MANIFEST文件名称，通过CURRENT文件可以找到MANIFEST文件路径</p>
<ol>
<li><code>LOCK</code></li>
</ol>
<p>文件锁，避免多个进程同时操作相同的数据库文件</p>
<ol>
<li><code>LOG</code></li>
</ol>
<p>Leveldb自己的日志</p>
<ol>
<li>
<p><code>LOG.old</code></p>
</li>
<li>
<p><code>MANIFEST-[0-9]+</code></p>
</li>
<li><code>[0-9]+.(log|sst|ldb)</code></li>
</ol>
<h2 id="_1">参考文献</h2>
<ul>
<li><a href="https://leveldb-handbook.readthedocs.io/zh/latest">Leveldb-handbook</a></li>
</ul>
                
              
              
                
<script src="https://utteranc.es/client.js"
        repo="zyfjeff/zyfjeff.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../../kubernetes/tips/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Tips" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Tips
            </div>
          </div>
        </a>
      
      
        
        <a href="../../pilot/" class="md-footer__link md-footer__link--next" aria-label="下一页: WIP" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              WIP
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 - 2021 程序员的Cookbook
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/zyfjeff" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "toc.integrate"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
    
  </body>
</html>