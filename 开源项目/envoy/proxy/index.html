
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://zyfjeff.github.io/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/proxy/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>Envoy源码分析 - 程序员的Cookbook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#envoy" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="程序员的Cookbook" class="md-header__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            程序员的Cookbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Envoy源码分析
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      About
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-tabs__link">
        博客
      </a>
    </li>
  

  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/blog/" class="md-tabs__link">
        学习笔记
      </a>
    </li>
  

  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../bootstrap/" class="md-tabs__link md-tabs__link--active">
        开源项目
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-tabs__link">
        编程语言
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-tabs__link">
        计算机基础
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="程序员的Cookbook" class="md-nav__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    程序员的Cookbook
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        博客
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="博客" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          博客
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Doc
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Doc" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Doc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_1" type="checkbox" id="__nav_2_1_1" >
      
      <label class="md-nav__link" for="__nav_2_1_1">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_1">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-nav__link">
        如何在Linux环境下实现一个调试器
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2" type="checkbox" id="__nav_2_1_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_2">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/%E5%A6%82%E4%BD%95mock%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" class="md-nav__link">
        如何mock系统调用
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2_2" type="checkbox" id="__nav_2_1_2_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2_2">
        Effective Model Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Effective Model Cpp" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_1_2_2">
          <span class="md-nav__icon md-icon"></span>
          Effective Model Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item1/" class="md-nav__link">
        Item1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item38/" class="md-nav__link">
        Item38 Be aware of varying thread handle destructor behavior
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item39/" class="md-nav__link">
        Item39 Consider void futures for one-shot event communication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item40/" class="md-nav__link">
        Item40 Use std::atomic for concurrency, volatile for specific memory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item41/" class="md-nav__link">
        Item41 Consider pass by value for copyable parameters that are cheap to move and always copied.
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item42/" class="md-nav__link">
        Item42 Consider emplacement instead of insertion
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_3" type="checkbox" id="__nav_2_1_3" >
      
      <label class="md-nav__link" for="__nav_2_1_3">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_3">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/dispatcher/" class="md-nav__link">
        Envoy源码分析之Dispatcher
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/thread_local/" class="md-nav__link">
        Envoy源码分析之ThreadLocal
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_4" type="checkbox" id="__nav_2_1_4" >
      
      <label class="md-nav__link" for="__nav_2_1_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%B8%AD%E7%9A%84%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E6%9C%89%E4%BB%80%E4%B9%88%3F/" class="md-nav__link">
        Linux中的可执行程序有什么?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%BF%A1%E5%8F%B7%E4%B8%93%E9%A2%98FAQ/" class="md-nav__link">
        Linux 信号FAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/%E5%85%B3%E4%BA%8E%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E8%AE%A8%E8%AE%BA/" class="md-nav__link">
        关于文件写入的原子性讨论
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_5" type="checkbox" id="__nav_2_1_5" >
      
      <label class="md-nav__link" for="__nav_2_1_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/lifetime-error-cases/" class="md-nav__link">
        常见的生命周期错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/macros/" class="md-nav__link">
        Macros
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/match-pattern/" class="md-nav__link">
        Match pattern
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-error-handle/" class="md-nav__link">
        Rust错误处理指南
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-match/" class="md-nav__link">
        Rust match
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-misconceptions/" class="md-nav__link">
        常见的生命周期概念错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-module/" class="md-nav__link">
        Rust module
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-variance/" class="md-nav__link">
        Rust variance
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        学习笔记
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="学习笔记" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          学习笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Blog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Blog" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/blog/" class="md-nav__link">
        Can Reordering of Release/Acquire Operations Introduce Deadlock?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/blog/readling_list/" class="md-nav__link">
        待阅读列表
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Book
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Book" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Book
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/%20PracticalSystemProgrammingForRust/" class="md-nav__link">
        Practical System Programing For Rust
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/ConcurrencyModernCpp/" class="md-nav__link">
        Concurrency Modern C++
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/CppTemplate/" class="md-nav__link">
        C++ Templates
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/KubernetesPrograming/" class="md-nav__link">
        Programming Kubernetes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/LuaPrograming/" class="md-nav__link">
        Lua Programing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/MathematicsForComputerScience/" class="md-nav__link">
        Mathematics For Computer Science
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/MuduoCpp/" class="md-nav__link">
        Linux C++ 服务端编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/OS/" class="md-nav__link">
        操作系统导论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/ebpf/" class="md-nav__link">
        ebpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3">
        Course
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Course" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Course
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1" type="checkbox" id="__nav_3_3_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1">
        6.824
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="6.824" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_1">
          <span class="md-nav__icon md-icon"></span>
          6.824
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1_1" type="checkbox" id="__nav_3_3_1_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1_1">
        Lecture1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lecture1" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_3_1_1">
          <span class="md-nav__icon md-icon"></span>
          Lecture1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/6.824/lecture1/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/6.824/lecture1/paper-note/" class="md-nav__link">
        Paper note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_2" type="checkbox" id="__nav_3_3_2" >
      
      <label class="md-nav__link" for="__nav_3_3_2">
        Ultimate Go Programing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ultimate Go Programing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_2">
          <span class="md-nav__icon md-icon"></span>
          Ultimate Go Programing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/Ultimate_Go_Programing/" class="md-nav__link">
        Ultimate Go Programing
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_3" type="checkbox" id="__nav_3_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3_3">
        信息论
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="信息论" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_3">
          <span class="md-nav__icon md-icon"></span>
          信息论
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/%E4%BF%A1%E6%81%AF%E8%AE%BA/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      <label class="md-nav__link" for="__nav_3_4">
        English
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="English" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          English
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_1" type="checkbox" id="__nav_3_4_1" >
      
      <label class="md-nav__link" for="__nav_3_4_1">
        Class1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class1" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_1">
          <span class="md-nav__icon md-icon"></span>
          Class1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class1/READMEN/" class="md-nav__link">
        READMEN
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class1/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class1/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_2" type="checkbox" id="__nav_3_4_2" >
      
      <label class="md-nav__link" for="__nav_3_4_2">
        Class2
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class2" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_2">
          <span class="md-nav__icon md-icon"></span>
          Class2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class2/kk/" class="md-nav__link">
        Kk
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class2/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/class2/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_3" type="checkbox" id="__nav_3_4_3" >
      
      <label class="md-nav__link" for="__nav_3_4_3">
        Hearing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Hearing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_3">
          <span class="md-nav__icon md-icon"></span>
          Hearing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/hearing/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_4" type="checkbox" id="__nav_3_4_4" >
      
      <label class="md-nav__link" for="__nav_3_4_4">
        Open lan
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Open lan" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_4">
          <span class="md-nav__icon md-icon"></span>
          Open lan
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/open-lan/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_5" type="checkbox" id="__nav_3_4_5" >
      
      <label class="md-nav__link" for="__nav_3_4_5">
        Syntax
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Syntax" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_5">
          <span class="md-nav__icon md-icon"></span>
          Syntax
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/syntax/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_6" type="checkbox" id="__nav_3_4_6" >
      
      <label class="md-nav__link" for="__nav_3_4_6">
        Walk for us
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Walk for us" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_6">
          <span class="md-nav__icon md-icon"></span>
          Walk for us
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/walk_for_us/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_7" type="checkbox" id="__nav_3_4_7" >
      
      <label class="md-nav__link" for="__nav_3_4_7">
        Word list
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Word list" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_7">
          <span class="md-nav__icon md-icon"></span>
          Word list
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/english/word_list/word/" class="md-nav__link">
        Word
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" type="checkbox" id="__nav_3_5" >
      
      <label class="md-nav__link" for="__nav_3_5">
        Paper
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Paper" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Paper
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/paper/bitcask/" class="md-nav__link">
        Bitcask
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        开源项目
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="开源项目" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          开源项目
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      <label class="md-nav__link" for="__nav_4_1">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../bootstrap/" class="md-nav__link">
        Bootstrap启动过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster/" class="md-nav__link">
        Cluster分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster_manager/" class="md-nav__link">
        Cluster Manager初始化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../dpdk/" class="md-nav__link">
        DPDK
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../drain_manager/" class="md-nav__link">
        Drain manager分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../eds/" class="md-nav__link">
        EDS更新过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../load_balancer/" class="md-nav__link">
        Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../lua/" class="md-nav__link">
        Lua filter实现分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../overload_manager/" class="md-nav__link">
        Overload manager分析
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Envoy源码分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Envoy源码分析
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    线程模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    热重启
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    性能优化
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../stats_symbol/" class="md-nav__link">
        Stats Symbol分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../subset_lb/" class="md-nav__link">
        Subset Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../wasm/" class="md-nav__link">
        Envoy Proxy Wasm分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89Cluster/" class="md-nav__link">
        如何实现自定义Cluster
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/" class="md-nav__link">
        Helm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/basic/" class="md-nav__link">
        Basic
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/tips/" class="md-nav__link">
        Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      <label class="md-nav__link" for="__nav_4_3">
        Leveldb
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Leveldb" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Leveldb
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../leveldb/leveldb/" class="md-nav__link">
        Leveldb源码分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      <label class="md-nav__link" for="__nav_4_4">
        Pilot
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Pilot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Pilot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/" class="md-nav__link">
        WIP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/ConfigUpdate/" class="md-nav__link">
        配置更新分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/EnvoyFilter/" class="md-nav__link">
        EnvoyFilter分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/PushContext/" class="md-nav__link">
        PushContext分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/concept/" class="md-nav__link">
        基本概念和接口
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pilot/xds-process/" class="md-nav__link">
        XDS处理流程分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        编程语言
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="编程语言" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          编程语言
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      <label class="md-nav__link" for="__nav_5_1">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-nav__link">
        C++基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp17/" class="md-nav__link">
        C++17 In Details
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp20/" class="md-nav__link">
        C++20
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/design/" class="md-nav__link">
        Design
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/guidelines/" class="md-nav__link">
        Guidelines
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/libevent/" class="md-nav__link">
        Libevent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/memory_order/" class="md-nav__link">
        C++ Memory Order
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_8" type="checkbox" id="__nav_5_1_8" >
      
      <label class="md-nav__link" for="__nav_5_1_8">
        Tips
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tips" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_8">
          <span class="md-nav__icon md-icon"></span>
          Tips
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-1/" class="md-nav__link">
        Tip of the Week #1: string_view
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-10/" class="md-nav__link">
        Tip of the Week #10: Splitting Strings, not Hairs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-101/" class="md-nav__link">
        Tip of the Week #101: Return Values, References, and Lifetimes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-103/" class="md-nav__link">
        Tip of the Week #103: Flags Are Globals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-107/" class="md-nav__link">
        Tip of the Week #107: Reference Lifetime Extension
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-108/" class="md-nav__link">
        Tip of the Week #108: Avoid std::bind
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-109/" class="md-nav__link">
        Tip of the Week #109: Meaningful `const` in Function Declarations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-11/" class="md-nav__link">
        Tip of the Week #11: Return Policy
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-112/" class="md-nav__link">
        Tip of the Week #112: emplace vs. push_back
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-117/" class="md-nav__link">
        Tip of the Week #117: Copy Elision and Pass-by-value
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-119/" class="md-nav__link">
        Tip of the Week #119: Using-declarations and namespace aliases
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-120/" class="md-nav__link">
        Tip of the Week #120: Return Values are Untouchable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-122/" class="md-nav__link">
        Tip of the Week #122: Test Fixtures, Clarity, and Dataflow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-123/" class="md-nav__link">
        Tip of the Week #123: absl::optional and std::unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-126/" class="md-nav__link">
        Tip of the Week #126: `make_unique` is the new `new`
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-24/" class="md-nav__link">
        Tip of the Week #24: Copies, Abbrv
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-3/" class="md-nav__link">
        Tip of the Week #3: String Concatenation and operator+ vs. StrCat()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-36/" class="md-nav__link">
        Tip of the Week #36: New Join API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-42/" class="md-nav__link">
        Tip of the Week #42: Prefer Factory Functions to Initializer Methods
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-45/" class="md-nav__link">
        Tip of the Week #45: Avoid Flags, Especially in Library Code
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-49/" class="md-nav__link">
        Tip of the Week #49: Argument-Dependent Lookup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-55/" class="md-nav__link">
        Tip of the Week #55: Name Counting and unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-59/" class="md-nav__link">
        Tip of the Week #59: Joining Tuples
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-61/" class="md-nav__link">
        Tip of the Week #61: Default Member Initializers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-64/" class="md-nav__link">
        Tip of the Week #64: Raw String Literals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-65/" class="md-nav__link">
        Tip of the Week #65: Putting Things in their Place
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-74/" class="md-nav__link">
        Tip of the Week #74: Delegating and Inheriting Constructors
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-77/" class="md-nav__link">
        Tip of the Week #77: Temporaries, Moves, and Copies
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-86/" class="md-nav__link">
        Tip of the Week #86: Enumerating with Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-88/" class="md-nav__link">
        Tip of the Week #88: Initialization: =, (), and {}
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-90/" class="md-nav__link">
        Tip of the Week #90: Retired Flags
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-93/" class="md-nav__link">
        Tip of the Week #93: using absl::Span
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-94/" class="md-nav__link">
        Tip of the Week #94: Callsite Readability and bool Parameters
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-99/" class="md-nav__link">
        Tip of the Week #99: Nonmember Interface Etiquette
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      <label class="md-nav__link" for="__nav_5_2">
        Golang
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Golang" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Golang
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/note/" class="md-nav__link">
        Go Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      <label class="md-nav__link" for="__nav_5_3">
        Lua
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lua" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Lua
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/lua/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" >
      
      <label class="md-nav__link" for="__nav_5_4">
        Python
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/python/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" >
      
      <label class="md-nav__link" for="__nav_5_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/Note/" class="md-nav__link">
        Rust学习笔记
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5_3" type="checkbox" id="__nav_5_5_3" >
      
      <label class="md-nav__link" for="__nav_5_5_3">
        Library
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Library" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_5_3">
          <span class="md-nav__icon md-icon"></span>
          Library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/library/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        计算机基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="计算机基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          计算机基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      <label class="md-nav__link" for="__nav_6_1">
        Algorithm
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Algorithm" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          Algorithm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-nav__link">
        负载均衡算法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/skiplist/" class="md-nav__link">
        跳表分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      <label class="md-nav__link" for="__nav_6_2">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/" class="md-nav__link">
        OS基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/Reverse/" class="md-nav__link">
        Reverse
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/compiler/" class="md-nav__link">
        编译器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/concurrency/" class="md-nav__link">
        并发编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/gdb/" class="md-nav__link">
        GDB Tips
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/review/" class="md-nav__link">
        面试题
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/tls/" class="md-nav__link">
        SSL
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_8" type="checkbox" id="__nav_6_2_8" >
      
      <label class="md-nav__link" for="__nav_6_2_8">
        Bazel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bazel" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_8">
          <span class="md-nav__icon md-icon"></span>
          Bazel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/bazel/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      <label class="md-nav__link" for="__nav_6_3">
        Design
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Design" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Design
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/design/" class="md-nav__link">
        设计模式
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      <label class="md-nav__link" for="__nav_6_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/asm_syscall/" class="md-nav__link">
        Linux: x86-64 syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_socket_balancing/" class="md-nav__link">
        三种常见的socket balancing模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_syscall/" class="md-nav__link">
        Linux syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/shell/" class="md-nav__link">
        Shell
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_6" type="checkbox" id="__nav_6_4_6" >
      
      <label class="md-nav__link" for="__nav_6_4_6">
        Bpf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bpf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_6">
          <span class="md-nav__icon md-icon"></span>
          Bpf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/READMME/" class="md-nav__link">
        READMME
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/seccomp-bpf/" class="md-nav__link">
        Seccomp bpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_7" type="checkbox" id="__nav_6_4_7" >
      
      <label class="md-nav__link" for="__nav_6_4_7">
        Ftrace
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ftrace" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_7">
          <span class="md-nav__icon md-icon"></span>
          Ftrace
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/ftrace/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_8" type="checkbox" id="__nav_6_4_8" >
      
      <label class="md-nav__link" for="__nav_6_4_8">
        Fuse
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Fuse" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_8">
          <span class="md-nav__icon md-icon"></span>
          Fuse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/fuse/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_9" type="checkbox" id="__nav_6_4_9" >
      
      <label class="md-nav__link" for="__nav_6_4_9">
        Io
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Io" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_9">
          <span class="md-nav__icon md-icon"></span>
          Io
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/io/io_uring/" class="md-nav__link">
        Io uring
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_10" type="checkbox" id="__nav_6_4_10" >
      
      <label class="md-nav__link" for="__nav_6_4_10">
        Network
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Network" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_10">
          <span class="md-nav__icon md-icon"></span>
          Network
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/epoll/" class="md-nav__link">
        Epoll
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/ip_transparent/" class="md-nav__link">
        Ip transparent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp-ip-program/" class="md-nav__link">
        Tcp ip program
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_back_log/" class="md-nav__link">
        Tcp back log
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_fast_open/" class="md-nav__link">
        Tcp fast open
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_splicing/" class="md-nav__link">
        SOCKMAP - TCP splicing of the future
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/time_wait/" class="md-nav__link">
        Time wait
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/virtual-network/" class="md-nav__link">
        Virtual network
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_11" type="checkbox" id="__nav_6_4_11" >
      
      <label class="md-nav__link" for="__nav_6_4_11">
        Perf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Perf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_11">
          <span class="md-nav__icon md-icon"></span>
          Perf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/perf/" class="md-nav__link">
        性能优化基础
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_12" type="checkbox" id="__nav_6_4_12" >
      
      <label class="md-nav__link" for="__nav_6_4_12">
        Synchronization
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Synchronization" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_12">
          <span class="md-nav__icon md-icon"></span>
          Synchronization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/memory_order/" class="md-nav__link">
        Memory order
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_13" type="checkbox" id="__nav_6_4_13" >
      
      <label class="md-nav__link" for="__nav_6_4_13">
        System interface
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="System interface" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_13">
          <span class="md-nav__icon md-icon"></span>
          System interface
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/system_interface/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      <label class="md-nav__link" for="__nav_6_5">
        Why
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Why" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          Why
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/why/" class="md-nav__link">
        计算机基础百科
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zyfjeff/zyfjeff.github.io/edit/master/docs/开源项目/envoy/proxy.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="envoy">Envoy源码分析</h1>
<h2 id="_1">线程模型</h2>
<p>单进程多线程架构，一个主线程控制各种零星的协调任务，多个worker线程执行listening、filtering、和数据转发等，只要一个连接被listener接受，那么这个连接上
所有的工作都是在一个线程中完成的。</p>
<h2 id="_2">热重启</h2>
<ol>
<li>请求关闭Admin功能，并开始接管，这个过程是非原子的。</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="n">restarter_</span><span class="p">.</span><span class="n">shutdownParentAdmin</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
  <span class="n">original_start_time_</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">original_start_time_</span><span class="p">;</span>
  <span class="n">admin_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">AdminImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">initial_config</span><span class="p">.</span><span class="n">admin</span><span class="p">().</span><span class="n">profilePath</span><span class="p">(),</span> <span class="o">*</span><span class="k">this</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">initial_config</span><span class="p">.</span><span class="n">admin</span><span class="p">().</span><span class="n">address</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initial_config</span><span class="p">.</span><span class="n">admin</span><span class="p">().</span><span class="n">accessLogPath</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">EnvoyException</span><span class="p">(</span><span class="s">&quot;An admin access log path is required for a listening server.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;admin address: {}&quot;</span><span class="p">,</span> <span class="n">initial_config</span><span class="p">.</span><span class="n">admin</span><span class="p">().</span><span class="n">address</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">asString</span><span class="p">());</span>
    <span class="n">admin_</span><span class="o">-&gt;</span><span class="n">startHttpListener</span><span class="p">(</span><span class="n">initial_config</span><span class="p">.</span><span class="n">admin</span><span class="p">().</span><span class="n">accessLogPath</span><span class="p">(),</span> <span class="n">options</span><span class="p">.</span><span class="n">adminAddressPath</span><span class="p">(),</span>
                              <span class="n">initial_config</span><span class="p">.</span><span class="n">admin</span><span class="p">().</span><span class="n">address</span><span class="p">(),</span>
                              <span class="n">stats_store_</span><span class="p">.</span><span class="n">createScope</span><span class="p">(</span><span class="s">&quot;listener.admin.&quot;</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">warn</span><span class="p">,</span> <span class="s">&quot;No admin address given, so no admin HTTP server started.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>创建ListenerManager、ClusterManagerFactory，一些管理数据结构</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">overload_manager_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">OverloadManagerImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">(),</span> <span class="n">stats</span><span class="p">(),</span> <span class="n">threadLocal</span><span class="p">(),</span>
                                                          <span class="n">bootstrap_</span><span class="p">.</span><span class="n">overload_manager</span><span class="p">());</span>

<span class="c1">// Workers get created first so they register for thread local updates.</span>
<span class="n">listener_manager_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">ListenerManagerImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">listener_component_factory_</span><span class="p">,</span>
                                                          <span class="n">worker_factory_</span><span class="p">,</span> <span class="n">time_system_</span><span class="p">);</span>

<span class="c1">// The main thread is also registered for thread local updates so that code that does not care</span>
<span class="c1">// whether it runs on the main thread or on workers can still use TLS.</span>
<span class="n">thread_local_</span><span class="p">.</span><span class="n">registerThread</span><span class="p">(</span><span class="o">*</span><span class="n">dispatcher_</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

<span class="c1">// We can now initialize stats for threading.</span>
<span class="n">stats_store_</span><span class="p">.</span><span class="n">initializeThreading</span><span class="p">(</span><span class="o">*</span><span class="n">dispatcher_</span><span class="p">,</span> <span class="n">thread_local_</span><span class="p">);</span>

<span class="c1">// Runtime gets initialized before the main configuration since during main configuration</span>
<span class="c1">// load things may grab a reference to the loader for later use.</span>
<span class="n">runtime_loader_</span> <span class="o">=</span> <span class="n">component_factory</span><span class="p">.</span><span class="n">createRuntime</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">initial_config</span><span class="p">);</span>

<span class="c1">// Once we have runtime we can initialize the SSL context manager.</span>
<span class="n">ssl_context_manager_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Ssl</span><span class="o">::</span><span class="n">ContextManagerImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">time_system_</span><span class="p">);</span>

<span class="n">cluster_manager_factory_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Upstream</span><span class="o">::</span><span class="n">ProdClusterManagerFactory</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="n">runtime</span><span class="p">(),</span> <span class="n">stats</span><span class="p">(),</span> <span class="n">threadLocal</span><span class="p">(),</span> <span class="n">random</span><span class="p">(),</span> <span class="n">dnsResolver</span><span class="p">(),</span> <span class="n">sslContextManager</span><span class="p">(),</span> <span class="n">dispatcher</span><span class="p">(),</span>
    <span class="n">localInfo</span><span class="p">(),</span> <span class="n">secretManager</span><span class="p">());</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>Bootstrap初始化</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// Now the configuration gets parsed. The configuration may start setting thread local data</span>
  <span class="c1">// per above. See MainImpl::initialize() for why we do this pointer dance.</span>
  <span class="n">Configuration</span><span class="o">::</span><span class="n">MainImpl</span><span class="o">*</span> <span class="n">main_config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="o">::</span><span class="n">MainImpl</span><span class="p">();</span>
  <span class="n">config_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">main_config</span><span class="p">);</span>
  <span class="n">main_config</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="n">bootstrap_</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="o">*</span><span class="n">cluster_manager_factory_</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>初始化静态secret</li>
<li>初始化静态cluster</li>
<li>初始化静态listener</li>
<li>初始化ralimit service</li>
<li>初始化tracing</li>
<li>
<p>初始化sats sinks</p>
</li>
<li>
<p>创建LDS API，注册init target</p>
</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// Instruct the listener manager to create the LDS provider if needed. This must be done later</span>
  <span class="c1">// because various items do not yet exist when the listener manager is created.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bootstrap_</span><span class="p">.</span><span class="n">dynamic_resources</span><span class="p">().</span><span class="n">has_lds_config</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">listener_manager_</span><span class="o">-&gt;</span><span class="n">createLdsApi</span><span class="p">(</span><span class="n">bootstrap_</span><span class="p">.</span><span class="n">dynamic_resources</span><span class="p">().</span><span class="n">lds_config</span><span class="p">());</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>集群初始化</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// We need the RunHelper to be available to call from InstanceImpl::shutdown() below, so</span>
  <span class="c1">// we save it as a member variable.</span>
  <span class="n">run_helper_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">RunHelper</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="o">*</span><span class="n">dispatcher_</span><span class="p">,</span> <span class="n">clusterManager</span><span class="p">(),</span>
                                            <span class="n">access_log_manager_</span><span class="p">,</span> <span class="n">init_manager_</span><span class="p">,</span> <span class="n">overloadManager</span><span class="p">(),</span>
                                            <span class="p">[</span><span class="k">this</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span> <span class="n">startWorkers</span><span class="p">();</span> <span class="p">});</span>

  <span class="c1">// starts.</span>
  <span class="n">cm</span><span class="p">.</span><span class="n">setInitializedCb</span><span class="p">([</span><span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm</span><span class="p">,</span> <span class="n">workers_start_cb</span><span class="p">]()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">isShutdown</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Pause RDS to ensure that we don&#39;t send any requests until we&#39;ve</span>
    <span class="c1">// subscribed to all the RDS resources. The subscriptions happen in the init callbacks,</span>
    <span class="c1">// so we pause RDS until we&#39;ve completed all the callbacks.</span>
    <span class="n">cm</span><span class="p">.</span><span class="n">adsMux</span><span class="p">().</span><span class="n">pause</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">TypeUrl</span><span class="o">::</span><span class="n">get</span><span class="p">().</span><span class="n">RouteConfiguration</span><span class="p">);</span>

    <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;all clusters initialized. initializing init manager&quot;</span><span class="p">);</span>

    <span class="c1">// Note: the lamda below should not capture &quot;this&quot; since the RunHelper object may</span>
    <span class="c1">// have been destructed by the time it gets executed.</span>
    <span class="n">init_manager</span><span class="p">.</span><span class="n">initialize</span><span class="p">([</span><span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="n">workers_start_cb</span><span class="p">]()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">isShutdown</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">workers_start_cb</span><span class="p">();</span>
    <span class="p">});</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>等集群初始化完成，执行init manager</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="c1">// Note: the lamda below should not capture &quot;this&quot; since the RunHelper object may</span>
    <span class="c1">// have been destructed by the time it gets executed.</span>
    <span class="n">init_manager</span><span class="p">.</span><span class="n">initialize</span><span class="p">([</span><span class="o">&amp;</span><span class="n">instance</span><span class="p">,</span> <span class="n">workers_start_cb</span><span class="p">]()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">isShutdown</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">workers_start_cb</span><span class="p">();</span>
    <span class="p">});</span>
</code></pre></div>
</td></tr></table>
<p>会等到LDS、RDS、SDS的第一个配置拿到这个初始化才会完成，然后调用workers_start_cb</p>
<ol>
<li>开始worker，开启接收流量，并通知老进程drain listener</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">InstanceImpl::startWorkers</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">listener_manager_</span><span class="o">-&gt;</span><span class="n">startWorkers</span><span class="p">(</span><span class="o">*</span><span class="n">guard_dog_</span><span class="p">);</span>

  <span class="c1">// At this point we are ready to take traffic and all listening ports are up. Notify our parent</span>
  <span class="c1">// if applicable that they can stop listening and drain.</span>
  <span class="n">restarter_</span><span class="p">.</span><span class="n">drainParentListeners</span><span class="p">();</span>
  <span class="n">drain_manager_</span><span class="o">-&gt;</span><span class="n">startParentShutdownSequence</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>不主动过关闭连接，连接的关闭依靠空闲时间、被动关闭还有shutdown(依赖--parent-shutdown-time-s)</li>
</ul>
<h2 id="_3">性能优化</h2>
<ol>
<li><code>--disable-hot-restart</code> 关闭热重启，避免使用共享内存存放stats统计信息</li>
<li><code>--concurrency</code> 和绑定的核心数一致，避免多个CPU切换导致cache失效</li>
<li>关闭stats统计和添加自定义header</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">http_filters</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.router</span>
  <span class="nt">config</span><span class="p">:</span>
      <span class="nt">dynamic_stats</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="nt">suppress_envoy_headers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>关闭circuit_breakers</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">circuit_breakers</span><span class="p">:</span>
  <span class="nt">thresholds</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">priority</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">HIGH</span>
    <span class="nt">max_connections</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000000000</span>
    <span class="nt">max_pending_requests</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000000000</span>
    <span class="nt">max_requests</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000000000</span>
    <span class="nt">max_retries</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000000000</span>
</code></pre></div>
</td></tr></table>
<h1 id="listener">listener</h1>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="nt">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span><span class="p">,</span>
  <span class="err">//</span> <span class="err">lis</span><span class="kc">tener</span> <span class="kc">f</span><span class="err">il</span><span class="kc">ter</span>
  <span class="nt">&quot;filter_chains&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="err">//</span> <span class="err">废弃了，改用origi</span><span class="kc">nal</span> <span class="err">ds</span><span class="kc">t</span> <span class="kc">f</span><span class="err">il</span><span class="kc">ter</span>
  <span class="nt">&quot;use_original_dst&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span><span class="p">,</span>
  <span class="err">//</span> <span class="err">设置wri</span><span class="kc">ter</span> <span class="err">bu</span><span class="kc">ffer</span><span class="err">的大小限制，这个指的是e</span><span class="kc">n</span><span class="err">voy忘dow</span><span class="kc">nstrea</span><span class="err">m、或者往ups</span><span class="kc">trea</span><span class="err">m写入数据的bu</span><span class="kc">ffer</span><span class="err">大小</span>
  <span class="nt">&quot;per_connection_buffer_limit_bytes&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span><span class="p">,</span>
  <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span><span class="p">,</span>
  <span class="err">//</span> <span class="err">lis</span><span class="kc">tener</span><span class="err">何时析构，默认在lis</span><span class="kc">tener</span><span class="err">的移除和修改、还有热重启、/heal</span><span class="kc">t</span><span class="err">hcheck/</span><span class="kc">fa</span><span class="err">il的时候</span>
  <span class="err">//</span> <span class="err">也可以设置为仅仅在lis</span><span class="kc">tener</span><span class="err">的移除和修改、还有热重启的时候析构</span>
  <span class="nt">&quot;drain_type&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span>
  <span class="err">//</span> <span class="err">lis</span><span class="kc">tener</span> <span class="kc">f</span><span class="err">il</span><span class="kc">ter</span>
  <span class="nt">&quot;listener_filters&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nt">&quot;listener_filters_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span><span class="p">,</span>
  <span class="err">//</span>
  <span class="nt">&quot;transparent&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span><span class="p">,</span>
  <span class="err">//</span> <span class="err">可以监听在一个非本地ip上，通常配置origi</span><span class="kc">nal</span> <span class="err">ds</span><span class="kc">t</span> <span class="kc">f</span><span class="err">il</span><span class="kc">ter</span><span class="err">来做lis</span><span class="kc">tener</span><span class="err">的匹配</span>
  <span class="err">//</span> <span class="err">本质上就是给socke</span><span class="kc">t</span><span class="err">设置IP_FREEBIND</span> <span class="err">op</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">参数</span>
  <span class="nt">&quot;freebind&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span><span class="p">,</span>
  <span class="nt">&quot;socket_options&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="err">//</span> <span class="err">第一次三次握手生成cookie后，第二次直接带着cookie就避免了三次握手。</span>
  <span class="err">//</span> <span class="err">这个参数用来设置FAST</span> <span class="err">OPEN的队列长度。</span>
  <span class="err">//</span> <span class="err">就是设置socke</span><span class="kc">t</span><span class="err">的TCP_FASTOPEN</span> <span class="err">op</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">参数</span>
  <span class="nt">&quot;tcp_fast_open_queue_length&quot;</span><span class="p">:</span> <span class="s2">&quot;{...}&quot;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li><code>per_connection_buffer_limit_bytes</code></li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">ConnectionHandlerImpl::ActiveListener::newConnection</span><span class="p">(</span><span class="n">Network</span><span class="o">::</span><span class="n">ConnectionSocketPtr</span><span class="o">&amp;&amp;</span> <span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Find matching filter chain.</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="n">filter_chain</span> <span class="o">=</span> <span class="n">config_</span><span class="p">.</span><span class="n">filterChainManager</span><span class="p">().</span><span class="n">findFilterChain</span><span class="p">(</span><span class="o">*</span><span class="n">socket</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">filter_chain</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ENVOY_LOG_TO_LOGGER</span><span class="p">(</span><span class="n">parent_</span><span class="p">.</span><span class="n">logger_</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span>
                        <span class="s">&quot;closing connection: no matching filter chain found&quot;</span><span class="p">);</span>
    <span class="n">stats_</span><span class="p">.</span><span class="n">no_filter_chain_match_</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
    <span class="n">socket</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">auto</span> <span class="n">transport_socket</span> <span class="o">=</span> <span class="n">filter_chain</span><span class="o">-&gt;</span><span class="n">transportSocketFactory</span><span class="p">().</span><span class="n">createTransportSocket</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
  <span class="c1">// 创建连接后，设置buffer limit</span>
  <span class="n">Network</span><span class="o">::</span><span class="n">ConnectionPtr</span> <span class="n">new_connection</span> <span class="o">=</span>
      <span class="n">parent_</span><span class="p">.</span><span class="n">dispatcher_</span><span class="p">.</span><span class="n">createServerConnection</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">socket</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">transport_socket</span><span class="p">));</span>
  <span class="n">new_connection</span><span class="o">-&gt;</span><span class="n">setBufferLimits</span><span class="p">(</span><span class="n">config_</span><span class="p">.</span><span class="n">perConnectionBufferLimitBytes</span><span class="p">());</span>

  <span class="k">const</span> <span class="kt">bool</span> <span class="n">empty_filter_chain</span> <span class="o">=</span> <span class="o">!</span><span class="n">config_</span><span class="p">.</span><span class="n">filterChainFactory</span><span class="p">().</span><span class="n">createNetworkFilterChain</span><span class="p">(</span>
      <span class="o">*</span><span class="n">new_connection</span><span class="p">,</span> <span class="n">filter_chain</span><span class="o">-&gt;</span><span class="n">networkFilterFactories</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">empty_filter_chain</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ENVOY_CONN_LOG_TO_LOGGER</span><span class="p">(</span><span class="n">parent_</span><span class="p">.</span><span class="n">logger_</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;closing connection: no filters&quot;</span><span class="p">,</span>
                             <span class="o">*</span><span class="n">new_connection</span><span class="p">);</span>
    <span class="n">new_connection</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">Network</span><span class="o">::</span><span class="n">ConnectionCloseType</span><span class="o">::</span><span class="n">NoFlush</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">onNewConnection</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_connection</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ConnectionImpl::setBufferLimits</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">read_buffer_limit_</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
  <span class="c1">// 其实就是注册了一个writer buffer的水位回调</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">::</span><span class="n">WatermarkBuffer</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">write_buffer_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">setWatermarks</span><span class="p">(</span><span class="n">limit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Reference: http://man7.org/linux/man-pages/man7/ip.7.html</p>
<h2 id="listener-filter">listener filter</h2>
<p>作用在listen socket上，当有连接到来的时候，通过libevent会触发可读事件，调用listen socket的accept获取到连接socket封装为ConnectionSocket，
最后调用ActiveListener::onAccept，将获取到的连接socket作为其参数。</p>
<ol>
<li>创建filter chain</li>
<li>continueFilterChain 调用filter chain</li>
<li>如果有filter返回了StopIteration，那么就开启timer，在这个时间内还没有继续continue就直接关闭当前socket</li>
<li>filter返回StopIteration后，要继续运行剩下的filter可以回调continueFilterChain</li>
</ol>
<blockquote>
<p>比如proxy_protocol这个listener filter当接收到一个filter后会注册读事件，从socket读取proxy协议头，所以会返回StopIteration
等到有数据可读的时候，并且读到了协议头才会回调continueFilterChain继续执行下面的filter</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">ConnectionHandlerImpl::ActiveListener::onAccept</span><span class="p">(</span>
    <span class="n">Network</span><span class="o">::</span><span class="n">ConnectionSocketPtr</span><span class="o">&amp;&amp;</span> <span class="n">socket</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">hand_off_restored_destination_connections</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">active_socket</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">ActiveSocket</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">socket</span><span class="p">),</span>
                                                      <span class="n">hand_off_restored_destination_connections</span><span class="p">);</span>

  <span class="c1">// Create and run the filters</span>
  <span class="n">config_</span><span class="p">.</span><span class="n">filterChainFactory</span><span class="p">().</span><span class="n">createListenerFilterChain</span><span class="p">(</span><span class="o">*</span><span class="n">active_socket</span><span class="p">);</span>
  <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">continueFilterChain</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

  <span class="c1">// Move active_socket to the sockets_ list if filter iteration needs to continue later.</span>
  <span class="c1">// Otherwise we let active_socket be destructed when it goes out of scope.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">iter_</span> <span class="o">!=</span> <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">accept_filters_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// 启动了一个timer，避免filter长时间不调用</span>
    <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">startTimer</span><span class="p">();</span>
    <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">moveIntoListBack</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">active_socket</span><span class="p">),</span> <span class="n">sockets_</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 如果超时就从socket list中移除当前socket</span>
<span class="kt">void</span> <span class="nf">ConnectionHandlerImpl::ActiveSocket::onTimeout</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">listener_</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">downstream_pre_cx_timeout_</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">inserted</span><span class="p">());</span>
  <span class="n">unlink</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ConnectionHandlerImpl::ActiveSocket::startTimer</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">listener_</span><span class="p">.</span><span class="n">listener_filters_timeout_</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">timer_</span> <span class="o">=</span> <span class="n">listener_</span><span class="p">.</span><span class="n">parent_</span><span class="p">.</span><span class="n">dispatcher_</span><span class="p">.</span><span class="n">createTimer</span><span class="p">([</span><span class="k">this</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span> <span class="n">onTimeout</span><span class="p">();</span> <span class="p">});</span>
    <span class="n">timer_</span><span class="o">-&gt;</span><span class="n">enableTimer</span><span class="p">(</span><span class="n">listener_</span><span class="p">.</span><span class="n">listener_filters_timeout_</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>目前实现的listener filter主要有<code>original_dst</code>、<code>original_src</code>、<code>proxy_protocol</code>、<code>tls_inspector</code>等</p>
<h2 id="original_dst-filter">original_dst filter</h2>
<p>一般应用于通过iptables或者tproxy的方式将流量发送给envoy，导致原来要访问的地址信息丢失，但是可以通过从socket中获取到这些信息，交给envoy做listen转发。</p>
<ol>
<li>主要就是从socket中获取到原来的目的地址信息 (<code>getsockopt(fd, SOL_IP, SO_ORIGINAL_DST, &amp;orig_addr, &amp;addr_len)</code>)</li>
<li>然后设置socket的restore_local_address为原来的目的地址</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span> <span class="nf">OriginalDstFilter::onAccept</span><span class="p">(</span><span class="n">Network</span><span class="o">::</span><span class="n">ListenerFilterCallbacks</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;original_dst: New connection accepted&quot;</span><span class="p">);</span>
  <span class="n">Network</span><span class="o">::</span><span class="n">ConnectionSocket</span><span class="o">&amp;</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">cb</span><span class="p">.</span><span class="n">socket</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">Network</span><span class="o">::</span><span class="n">Address</span><span class="o">::</span><span class="n">Instance</span><span class="o">&amp;</span> <span class="n">local_address</span> <span class="o">=</span> <span class="o">*</span><span class="n">socket</span><span class="p">.</span><span class="n">localAddress</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">local_address</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">Network</span><span class="o">::</span><span class="n">Address</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">Ip</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Network</span><span class="o">::</span><span class="n">Address</span><span class="o">::</span><span class="n">InstanceConstSharedPtr</span> <span class="n">original_local_address</span> <span class="o">=</span>
        <span class="n">getOriginalDst</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">ioHandle</span><span class="p">().</span><span class="n">fd</span><span class="p">());</span>

    <span class="c1">// A listener that has the use_original_dst flag set to true can still receive</span>
    <span class="c1">// connections that are NOT redirected using iptables. If a connection was not redirected,</span>
    <span class="c1">// the address returned by getOriginalDst() matches the local address of the new socket.</span>
    <span class="c1">// In this case the listener handles the connection directly and does not hand it off.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">original_local_address</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Restore the local address to the original one.</span>
      <span class="n">socket</span><span class="p">.</span><span class="n">restoreLocalAddress</span><span class="p">(</span><span class="n">original_local_address</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span><span class="o">::</span><span class="n">Continue</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>Reference: https://www.kernel.org/doc/Documentation/networking/tproxy.txt
TODO(tianqian.zyf): 例子</p>
<h2 id="original_src-filter">original_src filter</h2>
<p>L3/L4 transparency的含义: L3要求源IP可见、L4要求端口可见，这个filter的目的是将原地址信息透传到upstream，让upstream可以
获取到真实的源IP和端口信息。</p>
<p>TODO(tianqian.zyf): 例子</p>
<p>Reference: https://github.com/envoyproxy/envoy/pull/5255
Reference: https://docs.google.com/document/d/1md08XUBfVG9FwPUZixhR3f77dFRCVGJz2359plhzXxo/edit</p>
<h2 id="proxy_protocol-filter">proxy_protocol filter</h2>
<p>建立连接后发送一段数据来传递源地址和端口信息。</p>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// 连接建立后，开始注册读事件，读取传递过来的数据。</span>
<span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span> <span class="nf">Filter::onAccept</span><span class="p">(</span><span class="n">Network</span><span class="o">::</span><span class="n">ListenerFilterCallbacks</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;proxy_protocol: New connection accepted&quot;</span><span class="p">);</span>
  <span class="n">Network</span><span class="o">::</span><span class="n">ConnectionSocket</span><span class="o">&amp;</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">cb</span><span class="p">.</span><span class="n">socket</span><span class="p">();</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">file_event_</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">);</span>
  <span class="n">file_event_</span> <span class="o">=</span>
      <span class="n">cb</span><span class="p">.</span><span class="n">dispatcher</span><span class="p">().</span><span class="n">createFileEvent</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">ioHandle</span><span class="p">().</span><span class="n">fd</span><span class="p">(),</span>
                                      <span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="kt">uint32_t</span> <span class="n">events</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">ASSERT</span><span class="p">(</span><span class="n">events</span> <span class="o">==</span> <span class="n">Event</span><span class="o">::</span><span class="n">FileReadyType</span><span class="o">::</span><span class="n">Read</span><span class="p">);</span>
                                        <span class="n">onRead</span><span class="p">();</span>
                                      <span class="p">},</span>
                                      <span class="n">Event</span><span class="o">::</span><span class="n">FileTriggerType</span><span class="o">::</span><span class="n">Edge</span><span class="p">,</span> <span class="n">Event</span><span class="o">::</span><span class="n">FileReadyType</span><span class="o">::</span><span class="n">Read</span><span class="p">);</span>
  <span class="n">cb_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cb</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span><span class="o">::</span><span class="n">StopIteration</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">Filter::onRead</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">onReadWorker</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">EnvoyException</span><span class="o">&amp;</span> <span class="n">ee</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">config_</span><span class="o">-&gt;</span><span class="n">stats_</span><span class="p">.</span><span class="n">downstream_cx_proxy_proto_error_</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
    <span class="n">cb_</span><span class="o">-&gt;</span><span class="n">continueFilterChain</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 读取proxy头，这里的读取是通过ioctl(fd, FIONREAD, &amp;bytes_avail) 来获取缓存中的数据大小 ,</span>
<span class="c1">// 然后通过MSG_PEEK的方式查看数据。并不是直接read，因为一旦不是proxy ptorocol协议头会导致数据不完整(被读走了)。</span>

<span class="kt">void</span> <span class="nf">Filter::onReadWorker</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Network</span><span class="o">::</span><span class="n">ConnectionSocket</span><span class="o">&amp;</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">cb_</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">proxy_protocol_header_</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">readProxyHeader</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">ioHandle</span><span class="p">().</span><span class="n">fd</span><span class="p">()))</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">proxy_protocol_header_</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parseExtensions</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">ioHandle</span><span class="p">().</span><span class="n">fd</span><span class="p">())))</span> <span class="p">{</span>
    <span class="c1">// We return if a) we do not yet have the header, or b) we have the header but not yet all</span>
    <span class="c1">// the extension data. In both cases we&#39;ll be called again when the socket is ready to read</span>
    <span class="c1">// and pick up where we left off.</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">....</span>
  <span class="c1">// 读取完成后，拿到获取的源地址信息进行操作。</span>

  <span class="c1">// Only set the local address if it really changed, and mark it as address being restored.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">proxy_protocol_header_</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">local_address_</span> <span class="o">!=</span> <span class="o">*</span><span class="n">socket</span><span class="p">.</span><span class="n">localAddress</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">socket</span><span class="p">.</span><span class="n">restoreLocalAddress</span><span class="p">(</span><span class="n">proxy_protocol_header_</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">local_address_</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">socket</span><span class="p">.</span><span class="n">setRemoteAddress</span><span class="p">(</span><span class="n">proxy_protocol_header_</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">remote_address_</span><span class="p">);</span>
  <span class="p">....</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
TODO(tianqian.zyf): 例子
Reference: https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt</p>
<h2 id="tls-inspector-filter">TLS Inspector filter</h2>
<p>TLS Inspector listener filter allows detecting whether the transport appears to be TLS or plaintext, and if it is TLS,
it detects the Server Name Indication and/or Application-Layer Protocol Negotiation from the client.
This can be used to select a FilterChain via the server_names and/or application_protocols of a FilterChainMatch.</p>
<ol>
<li>注册读数据，等待数据到来</li>
<li>解析Client hello报文</li>
<li>找到TLS信息，设置TransportSocket为Tls</li>
</ol>
<h2 id="data-sharing-between-filters">data sharing between filters</h2>
<p>Network level filters can also share state (static and dynamic) among themselves within the context of a single downstream connection</p>
<ol>
<li>Static State</li>
</ol>
<p>不可变的状态，指的是配置加载的时候指定的一些状态信息，主要有三类Static State</p>
<ul>
<li>Metadata</li>
</ul>
<p>在Envoy的配置中有部分字段会包含metadata信息，比如listeners, routes, clusters等，对应到Protobuf就是</p>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="n">message</span> <span class="n">Metadata</span> <span class="p">{</span>
    <span class="c1">// Key is the reverse DNS filter name, e.g. com.acme.widget. The envoy.*</span>
    <span class="c1">// namespace is reserved for Envoy&#39;s built-in filters.</span>
    <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">google</span><span class="p">.</span><span class="n">protobuf</span><span class="p">.</span><span class="n">Struct</span><span class="o">&gt;</span> <span class="n">filter_metadata</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
  比如集群的权重、负载均衡中的subset metadata信息等</p>
<ul>
<li>Typed Metadata
  Metadata是无类型，因此在使用之前需要将其转换为内部定义的对象，每次新建连接或者新的请求的时候，都需要重复执行，带来的开销是不小的。
  Typed Metadata就是用来解决这个问题，可以给特定的key注册一个转换逻辑，对于输入的Metadata在配置加载的时候就会自动转换成对应的对象。
  这样就可以直接使用，避免每次获取Metadata进行转换。</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>class ClusterTypedMetadataFactory : public Envoy::Config::TypedMetadataFactory {};
class HttpRouteTypedMetadataFactory : public Envoy::Config::TypedMetadataFactory {};
</code></pre></div>
</td></tr></table>
<ul>
<li>
<p>HTTP Per-Route Filter Configuration
  per_filter_config允许HTTP filters可以有自己独立的virtualhost和路由配置</p>
</li>
<li>
<p>Dynamic State
由每一个网络连接、或者是每一个HTTP stream产生，这个对象包含了当前TCP connection和HTTP stream相关的一些信息。这些信息是由固定的属性组成的，
比如HTTP的协议、请求的server name等等。此外还提供了存储typed objects的能力<code>map&lt;string, FilterState::Object&gt;</code>，用于给用户提供存储一些自定义信息的。
<code>ConnectionImpl</code>中包含的StreamInfo，用于在连接级别共享一些State，<code>Http::ConnectionManagerImpl::ActiveStream</code>中包含的则是per stream。</p>
</li>
</ul>
<h2 id="http-routing">HTTP routing</h2>
<ol>
<li>基于Virtual hosts的路由</li>
<li>前缀匹配、或者是精确匹配(大小写敏感或者不敏感都可以)，目前还不支持基于正则的匹配。</li>
<li>TLS redirection</li>
<li>Direct Response</li>
<li>显示的host重写</li>
<li>自动根据选择的upstream的DNS name进行host重写</li>
<li>前缀重写</li>
<li>基于正则表达式捕获组的方式进行path重写</li>
<li>请求重试(基于配置和http header两种方式)</li>
<li>请求超时控制(基于配置和http header两种方式)</li>
<li>Request hedging</li>
<li>Traffic shifting</li>
<li>Traffic splitting</li>
<li>任何的header match</li>
<li>可以指定虚拟集群</li>
<li>基于优先级的路由</li>
<li>基于hash policy的路由</li>
<li>
<p>基于绝对url的代理转发</p>
</li>
<li>
<p>Route Scope</p>
</li>
</ol>
<p>For example, for the following scoped route configuration, Envoy will look into the “addr” header value, split the header value by “;” first,
and use the first value for key ‘x-foo-key’ as the scope key. If the “addr” header value is “foo=1;x-foo-key=127.0.0.1;x-bar-key=1.1.1.1”, then “127.0.0.1”
will be computed as the scope key to look up for corresponding route configuration.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>HttpConnectionManager config:
scoped_routes:
  name: foo-scoped-routes
  scope_key_builder:
    fragments:
      - header_value_extractor:
          name: X-Route-Selector
          element_separator: ,
          element:
            separator: =
            key: vip


scoped_route_configurations_list/SRDS:
 (1)
 name: route-scope1
 route_configuration_name: route-config1
 key:
    fragments:
      - string_key: 172.10.10.20

(2)
 name: route-scope2
 route_configuration_name: route-config2
 key:
   fragments:
     - string_key: 172.20.20.30

GET / HTTP/1.1
Host: foo.com
X-Route-Selector: vip=172.10.10.20

最终匹配到route-config1
</code></pre></div>
</td></tr></table>
<p>根据<code>scoped_routes</code>获取请求中的指定字段，然后切割获取到对应的value，然后拿着value和定义的<code>scoped_route_configurations</code>知道要使用的路由配置名称</p>
<ul>
<li>重试语义</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p p-Indicator">{</span>
  <span class="s">&quot;retry_on&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;num_retries&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;per_try_timeout&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;retry_priority&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;retry_host_predicate&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[],</span>
  <span class="s">&quot;host_selection_retry_max_attempts&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;retriable_status_codes&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[],</span>
  <span class="s">&quot;retry_back_off&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;retriable_headers&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[],</span>
  <span class="s">&quot;retriable_request_headers&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>
<span class="p p-Indicator">}</span>
</code></pre></div>
</td></tr></table>
<p>可以配置重试的最大次数、重试的条件(可以是基于reseponse code、可以是网络等等)，Request budgets可以防止大量的请求重试、可以进行host selection rerty</p>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">message</span> <span class="n">DirectResponseAction</span> <span class="p">{</span>
  <span class="c1">// Specifies the HTTP response status to be returned.</span>
  <span class="n">uint32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[(</span><span class="n">validate</span><span class="p">.</span><span class="n">rules</span><span class="p">).</span><span class="n">uint32</span> <span class="o">=</span> <span class="p">{</span><span class="nl">gte</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nl">lt</span><span class="p">:</span> <span class="mi">600</span><span class="p">}];</span>

  <span class="c1">// Specifies the content of the response body. If this setting is omitted,</span>
  <span class="c1">// no body is included in the generated response.</span>
  <span class="c1">//</span>
  <span class="c1">// .. note::</span>
  <span class="c1">//</span>
  <span class="c1">//   Headers can be specified using *response_headers_to_add* in the enclosing</span>
  <span class="c1">//   :ref:`envoy_api_msg_route.Route`, :ref:`envoy_api_msg_RouteConfiguration` or</span>
  <span class="c1">//   :ref:`envoy_api_msg_route.VirtualHost`.</span>
  <span class="n">core</span><span class="p">.</span><span class="n">DataSource</span> <span class="n">body</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
可以指定response status code和body，body可以是内联字符串或者是一个文件路径，但是都必须限制在4K以内，因为Envoy会缓存body。
5. 显示的主机名重写</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">route</span><span class="p">.</span><span class="nl">RouteAction</span><span class="p">:</span>
<span class="nl">host_rewrite</span><span class="p">:</span> <span class="s">&quot;....&quot;</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>自动主机重写</li>
</ol>
<p>host header会被重写为选择的cluster中的名字，要求cluster需要是strict_dns或者是logical_dns类型。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">route</span><span class="p">.</span><span class="nl">RouteAction</span><span class="p">:</span>
<span class="nl">auto_host_rewrite</span><span class="p">:</span> <span class="s">&quot;....&quot;</span> <span class="c1">// 和host_rewrite二选其一</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">Filter::UpstreamRequest::onPoolReady</span><span class="p">(</span><span class="n">Http</span><span class="o">::</span><span class="n">StreamEncoder</span><span class="o">&amp;</span> <span class="n">request_encoder</span><span class="p">,</span>
                                          <span class="n">Upstream</span><span class="o">::</span><span class="n">HostDescriptionConstSharedPtr</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">.......</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">parent_</span><span class="p">.</span><span class="n">route_entry_</span><span class="o">-&gt;</span><span class="n">autoHostRewrite</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">parent_</span><span class="p">.</span><span class="n">downstream_headers_</span><span class="o">-&gt;</span><span class="n">Host</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="p">.......</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>前缀重写</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span> <span class="nt">match</span><span class="p">:</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&quot;/prefix/&quot;</span>
  <span class="nt">route</span><span class="p">:</span>
    <span class="nt">prefix_rewrite</span><span class="p">:</span> <span class="s">&quot;/&quot;</span>
<span class="p p-Indicator">-</span> <span class="nt">match</span><span class="p">:</span>
    <span class="nt">prefix</span><span class="p">:</span> <span class="s">&quot;/prefix&quot;</span>
  <span class="nt">route</span><span class="p">:</span>
    <span class="nt">prefix_rewrite</span><span class="p">:</span> <span class="s">&quot;/&quot;</span>
</code></pre></div>
</td></tr></table>
<p>第一个将<code>/prefix/</code>替换为<code>/</code>，第二个则是将<code>/prefix</code>替换为<code>/</code>，重写完成后会将之前的路径放在<code>x-envoy-original-path</code> header中。</p>
<ol>
<li>
<p>请求重试
可以基于请求中携带的header来开启重试、也可以配置一个VirtualHost级别的重试、也可以是RouteAction级别的重试。如果上游返回<code>x-envoy-overloaded</code> header
那么就关闭重试。如果upstream返回的header中带有<code>x-envoy-ratelimited</code>也要禁止重试。</p>
</li>
<li>
<p>timeout
默认的超时时间是15s，这个时间包含了从downstream request接收到end stream开始到处理到upstream response响应结束还包括了整个重试期间的时间。可以通过
<code>x-envoy-upstream-rq-timeout-ms</code> header来设置这个值。<code>x-envoy-upstream-rq-per-try-timeout-ms</code> 通过这个header来可以控制单词响应的超时时间
不包括retry。</p>
</li>
<li>
<p>流量拆分/转移</p>
</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">virtual_hosts</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">www2</span>
     <span class="nt">domains</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">&#39;*&#39;</span>
     <span class="nt">routes</span><span class="p">:</span>
       <span class="p p-Indicator">-</span> <span class="nt">match</span><span class="p">:</span>
           <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
           <span class="nt">runtime_fraction</span><span class="p">:</span>
             <span class="nt">default_value</span><span class="p">:</span>
               <span class="nt">numerator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
               <span class="nt">denominator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">HUNDRED</span>
             <span class="nt">runtime_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">routing.traffic_shift.helloworld</span>
         <span class="nt">route</span><span class="p">:</span>
           <span class="nt">cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">helloworld_v1</span>
       <span class="p p-Indicator">-</span> <span class="nt">match</span><span class="p">:</span>
           <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
         <span class="nt">route</span><span class="p">:</span>
           <span class="nt">cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">helloworld_v2</span>
</code></pre></div>
</td></tr></table>
<h2 id="connection-pooling">Connection pooling</h2>
<p>HTTP/1.1 连接池，同步的，一个请求绑定一个连接，这个连接处理完这个请求，才会变成可用状态，才能处理下一个请求，单个downstream断链只能导致一个请求出问题。
HTTP2/2 一个upstream host只会建立一条连接，上游所有的请求都会通过整条连接发送到upstream的主机，如果收到GOAWAY frame或者到达最大流限制，那么连接池
会重新创建一个新的连接，然后drain掉正在服务的连接。</p>
<h2 id="runtime">Runtime</h2>
<h2 id="xds-rest-and-grpc-protocol">xDS REST and gRPC protocol</h2>
<p>Envoy支持通过文件系统、查询管理服务器的方式获取各种类型的动态资源。这种发现服务和其对应的API被称为xDS，资源需要通过指定一个文件系统路径去watch、
或者初始化一个grpc stream或者是通过RESET-JSON URL进行pooling的方式进行订阅。后两种方式会通过发送一个<code>DiscoveryRequest</code>请求来获取资源，
管理服务器会返回<code>DiscoveryResponse</code>，其中包含了请求的资源。</p>
<p>目前有五种类型的资源，分别如下:</p>
<ul>
<li><a href="https://github.com/envoyproxy/envoy/blob/master/api/envoy/api/v2/lds.proto">LDS: <code>envoy.api.v2.Listener</code></a></li>
<li><a href="https://github.com/envoyproxy/envoy/blob/master/api/envoy/api/v2/rds.proto">RDS: <code>envoy.api.v2.RouteConfiguration</code></a></li>
<li><a href="https://github.com/envoyproxy/envoy/blob/master/api/envoy/api/v2/cds.proto">CDS: <code>envoy.api.v2.Cluster</code></a></li>
<li><a href="https://github.com/envoyproxy/envoy/blob/master/api/envoy/api/v2/eds.proto">EDS: <code>envoy.api.v2.ClusterLoadAssignment</code></a></li>
<li><a href="https://github.com/envoyproxy/envoy/blob/master/api/envoy/api/v2/sds.proto">SDS: <code>envoy.api.v2.Auth.Secret</code></a></li>
</ul>
<p>每一个类型的资源都有一个URL来唯一表示，其形式为<code>type.googleapis.com/&lt;resource type&gt;</code></p>
<p>下面是一个DiscoveryRequest的例子:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">version_info</span><span class="p">:</span>
<span class="nt">node</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> id</span><span class="p">:</span> <span class="nv">envoy</span> <span class="p p-Indicator">}</span>
<span class="nt">resource_names</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">foo</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
<span class="nt">type_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.api.v2.ClusterLoadAssignment</span>
<span class="nt">response_nonce</span><span class="p">:</span>
</code></pre></div>
</td></tr></table></p>
<ol>
<li>其中<code>version_info</code>取的是上一次成功收到的response中携带的<code>version_info</code>的值，如果是第一个请求，那么这个值就是空的，每一个type url的<code>version_info</code>是独立的。</li>
<li><code>node</code>则是Envoy节点的相关信息</li>
<li><code>resource_names</code> Envoy中每一类资源都是有名字的，通过携带这个字段可以告诉管理服务器只返回对应的资源即可，如果不携带则表示需要获取这类资源的全部</li>
<li><code>type_url</code> 唯一标识一类资源的，ADS需要这个字段来识别出这个请求是哪种类型的</li>
<li><code>response_nonce</code> 用于显示的对<code>DiscoverResponse</code>做ack</li>
</ol>
<blockquote>
<p>如果请求被接收了，那么envoy会进行ack，返回的response_nonce对应DiscoveryResponse中的nonce，version_info则对应DiscoveryResponse中的version_info
如果拒绝了DiscoveryResponse则返回的response_nonce对应DiscoveryResponse中的nonce，version_info则对应上一次DiscoveryResponse中的version_info
同一时间有多个DiscoveryRequest的时候，mangement server只会影响最后的一个DiscoverRequest
如果管理server返回的response_nonce是一个新的值，Envoy会拒绝这次请求</p>
</blockquote>
<p>If Envoy had instead rejected configuration update X, it would reply with error_detail populated and its previous version, which in this case was the empty initial version. The error_detail has more details around the exact error message populated in the message field:</p>
<p>LDS/CDS的resource_names一般为空，表示获取所有的cluster和listener资源，而EDS和RDS一般会带上resource name获取感兴趣的资源，这个resource name来自于LDS和CDS。
如果一个EDS没有对应的CDS，那么这个EDS是无效的，Envoy会忽略这个EDS。</p>
<p>LDS和CDS请求存在requesting wramming的过程，要求获取到LDS和EDS以及依赖的EDS和RDS，Envoy才算初始化完成。</p>
<p>xDS对于各个资源的顺序没有约束，因为每一个资源都是一个单独的流，资源的到达顺序会导致流量存在下降的问题，比如，LDS就绪了但是依赖的CDS还没有继续，那么这会导致请求无效。
但是如果CDS先就绪，然后LDS再就绪就可以避免这个问题了。所以为了避免因为资源更新的顺序问题导致流量被drop，要求资源更新的顺序如下:</p>
<ul>
<li>CDS updates (if any) must always be pushed first.</li>
<li>EDS updates (if any) must arrive after CDS updates for the respective clusters.</li>
<li>LDS updates must arrive after corresponding CDS/EDS updates.</li>
<li>RDS updates related to the newly added listeners must arrive after CDS/EDS/LDS updates.</li>
<li>VHDS updates (if any) related to the newly added RouteConfigurations must arrive after RDS updates.</li>
<li>Stale CDS clusters and related EDS endpoints (ones no longer being referenced) can then be removed.</li>
</ul>
<p>为了保证资源请求的顺序可以按照上述定义的顺序，需要将所有的资源请求和响应控制在同一个流中。</p>
<p>xDS中资源的更新是没办法单独推送的，每次推送的资源都是全量的，即使其中部分资源发生了变更，都是全量下发，envoy则会进行资源对比，有变更的则进行应用。
这样带来的传输消耗还是蛮大的，为此有了<code>Incremental xDS</code>，只下发有变更的资源。</p>
<p><code>Incremental xDS</code> 一般用在以下几个场景:</p>
<ul>
<li>
<p>Initial message in a xDS bidirectional gRPC stream.</p>
</li>
<li>
<p>As an ACK or NACK response to a previous DeltaDiscoveryResponse.
In this case the response_nonce is set to the nonce value in the Response. ACK or NACK is determined by the absence or presence of error_detail.</p>
</li>
<li>
<p>Spontaneous DeltaDiscoveryRequest from the client.
This can be done to dynamically add or remove elements from the tracked resource_names set. In this case response_nonce must be omitted.</p>
</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">DeltaDiscoveryRequest</span>
<span class="l l-Scalar l-Scalar-Plain">{</span>
  <span class="l l-Scalar l-Scalar-Plain">&quot;node&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="err">,</span>
  <span class="s">&quot;type_url&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span><span class="err">,</span>
  <span class="s">&quot;resource_names_subscribe&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span><span class="err">,</span>
  <span class="s">&quot;resource_names_unsubscribe&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span><span class="err">,</span>
  <span class="s">&quot;initial_resource_versions&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="err">,</span>
  <span class="s">&quot;response_nonce&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span><span class="err">,</span>
  <span class="s">&quot;error_detail&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span>
<span class="err">}</span>

<span class="l l-Scalar l-Scalar-Plain">DeltaDiscoveryResponse</span>
<span class="p p-Indicator">{</span>
  <span class="s">&quot;system_version_info&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;resources&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[],</span>
  <span class="s">&quot;type_url&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;removed_resources&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[],</span>
  <span class="s">&quot;nonce&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span>
<span class="p p-Indicator">}</span>
</code></pre></div>
</td></tr></table>
<p>目前增量的xDS只有grpc版本的，没有REST版本，要求<code>response_nonce</code>字段必须成对出现，而全量xDS则不需要，<code>system_version_info</code>字段用于debug目的。</p>
<p><code>DeltaDiscoveryRequest</code>用于几个场景:</p>
<ol>
<li>xDS建立后发起的第一次请求</li>
<li>作为ACK/NACK对于前一个<code>DeltaDiscoveryResponse</code>进行响应，其response_nonce的值为前一个<code>DeltaDiscoveryResponse</code>中的值，至于是ACK还是NACK取决于<code>error_detail</code>是否存在</li>
<li>client主动发起<code>DeltaDiscoveryRequest</code>请求，用于动态添加和移除跟踪的资源，在这种情况下<code>response_nonce</code>必须为空</li>
</ol>
<blockquote>
<p>哪些情况需要动态添加和移除跟踪的资源?</p>
</blockquote>
<p>当发生连接段掉的情况下，客户端重新连接后需要告知自己所拥有的资源名(initial_resource_versions)，当客户端不再对某些资源感兴趣的时候需要在<code>resource_names_unsubscribe</code>中列出来</p>
<p>Reference:
1. https://github.com/envoyproxy/envoy/blob/master/api/XDS_PROTOCOL.md
2. https://developers.google.com/protocol-buffers/docs/proto3#any</p>
<h2 id="envoycallback">Envoy生命周期callback</h2>
<p>https://github.com/envoyproxy/envoy/pull/6254</p>
<h2 id="envoyfilter">Envoy四层filter执行链</h2>
<ol>
<li>Downstream连接建立后，开始创建filter，然后初始化filter</li>
<li>回调onNewConnection</li>
<li>回调onData</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">bool</span> <span class="nf">FilterManagerImpl::initializeReadFilters</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">upstream_filters_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 初始化完成后，开始从头开始执行filter</span>
  <span class="n">onContinueReading</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 传入的是nullptr的时候，从头开始执行filter的</span>
<span class="c1">// 设置initialized_标志为true</span>
<span class="c1">// 回调onNewConnection，如果是返回stop就停止运行了</span>
<span class="c1">// 等待filter返回通过ReadFilterCallbacks回调onContinueReading来继续执行</span>
<span class="kt">void</span> <span class="nf">FilterManagerImpl::onContinueReading</span><span class="p">(</span><span class="n">ActiveReadFilter</span><span class="o">*</span> <span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">ActiveReadFilterPtr</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">entry</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">upstream_filters_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(;</span> <span class="n">entry</span> <span class="o">!=</span> <span class="n">upstream_filters_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">initialized_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">FilterStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">filter_</span><span class="o">-&gt;</span><span class="n">onNewConnection</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">FilterStatus</span><span class="o">::</span><span class="n">StopIteration</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">BufferSource</span><span class="o">::</span><span class="n">StreamBuffer</span> <span class="n">read_buffer</span> <span class="o">=</span> <span class="n">buffer_source_</span><span class="p">.</span><span class="n">getReadBuffer</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read_buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">read_buffer</span><span class="p">.</span><span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">FilterStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">filter_</span><span class="o">-&gt;</span><span class="n">onData</span><span class="p">(</span><span class="n">read_buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">read_buffer</span><span class="p">.</span><span class="n">end_stream</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">FilterStatus</span><span class="o">::</span><span class="n">StopIteration</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Example:
有三个filter、其中任何一个filter其中的一个callback返回StopIteration那么整个流程就停止了，需要等待调用onContinueReading才能继续
执行下一个callback方法。</p>
<p>FilterA::onNewConnection
FilterA::onData</p>
<p>FilterB::onNewConnection
FilterB::onData</p>
<p>FilterC::onNewConnection
FilterC::onData</p>
<p>执行顺序为:
FilterA::onNewConnection-&gt;FilterA::onData-&gt;FilterB::onNewConnection-&gt;FilterB::onData-&gt;FilterC::onNewConnection-&gt;FilterC::onData
任何一个callback返回StopIteration整个流程就不会继续往下走了，需要等待对应的filter回调onContinueReading，这样就会带来一个问题，一旦停止filter chain
继续往下走，那么网络层依然会收数据存在内部buffer里面，这会导致内存上涨，因此TCP PROXY中会在调用onNewConnection的时候先关闭读，然后和upstream建立连接
连接建立后才会开启读，防止内存被打爆。</p>
<h2 id="envoy-internal-header">Envoy internal header</h2>
<h2 id="load-balancer">Load balancer</h2>
<p><strong>实现增量更新的思路</strong>:</p>
<p>默认Config Server获取到Host包含了ip、所在机房、单元、machine group、权重还有一些metadata等，都是机器纬度的信息，除了这些信息外，Envoy还需要优先级信息、机器健康状况等
目前可以默认使用优先级0代替 。除了这些机器纬度的信息外，还需要有服务纬度的信息(也可以称为集群纬度的信息)，比如区域权重(每个区域的权重)、过载因子、Endpoint过期时间等。目前这个部分可以不实现，
等开始支持这类功能的时候再单独通过Config Server的SDK通知我这类元信息发生了改变。这个时候就可以更新Locality weight，修改<code>PriorityState</code>以及过载因子等。这个时候就需要触发forch rebuild(重新建立LB)。</p>
<ol>
<li>判断host是新增还是updated</li>
<li>如果是update则先清除<code>PENDING_DYNAMIC_REMOVAL</code>，因为马上要加回来了。</li>
<li>判断是否需要原地更新 (有健康检查、并且健康检查的地址不同，这个时候不能跳过原地更新，必须要更新)</li>
<li>如果是原地更新</li>
<li>判断健康状态是否发生了变化，有变化的话都会导致forch rebuild</li>
<li>metadata变化也需要导致forch rebuild(config server最好直接告知我metadata发生了变化)，并更新host的metadata</li>
<li>
<p>优先级发生了改变，需要更新对应机器的优先级，然后把这个机器添加到当前优先级的列表中</p>
</li>
<li>
<p>如果不是原地更新</p>
</li>
<li>添加host到当前优先级</li>
<li>如果健康检查开启的话，先设置这个机器为FAILED_ACTIVE_AC</li>
<li>然后看是否是warmHosts，如果是就设置为PENDING_ACTIVE_HC</li>
</ol>
<p>一个主机发生变化了，有几种情况:</p>
<ol>
<li>新ip的添加</li>
<li>老ip的删除</li>
<li>机房、单元等locality发生了变化 (这个不考虑，这个如果发生了变化会产生添加ip和删除ip两个事件)</li>
<li>健康状态发生了变化</li>
<li>优先级发生了变化</li>
<li>元信息发生了变化</li>
</ol>
<blockquote>
<p>健康状态、优先级、元信息发生变化更新host即可</p>
</blockquote>
<p>Config Server Cluster计算逻辑:</p>
<ol>
<li>按照优先级将added_host和removed_hosts以优先级为纬度分成一个个host vector</li>
<li>
<p>取出一个优先级往all_host_中查找如果是新添加的就放到hosts_added_to_current_priority中(并执行healthy check相关的flag设置)
   如果不是新的host那就看是否做原地更新，如果是原地更新就直接更新就好了，否则就把这个机器放到hosts_added_to_current_priority中
   如果发生了优先级改变，那么不光光要更新机器的优先级还需要将这个机器添加到hosts_added_to_current_priority列表中，然后对应的要从
   这个机器原来所在优先级中进行删除。(这个我们占时不处理，对于增量的场景，可以简单的将修改前的优先级的机器放到removed列表中)</p>
</li>
<li>
<p>更新host_change，如果都是原地更新，那么很自然host_change为false、优先级发生变化了也是为true、metadata变化了也是true
   需要将所有host_change为true的场景梳理出来，用于rebuild lb。</p>
</li>
<li>
<p>拿到当前优先级的host，将hosts_added_to_current_priority追加到当前优先级的列表中，另外需要考虑一个特殊的case:
  host是存在的，但是健康检查地址发生了改变，那么这个机器需要对当前优先级的host做替换而不是追加了。</p>
</li>
<li>
<p>调用updateClusterPrioritySet进行更新。</p>
</li>
<li>
<p>如果locality weight发生了改变就设置host_change为true</p>
</li>
</ol>
<blockquote>
<p>updateClusterPrioritySet仍然是全量host进行计算(计算出per locality的结构)，能否再度优化? TODO
LocalityWeightMap发生改变需要rebuild，这个如何识别出来? Config Server SDK对于locality weight的变化单独通知，然后我来更新PriorityState结构</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">ClusterLoadAssignment.Policy</span>
<span class="l l-Scalar l-Scalar-Plain">{</span>
  <span class="l l-Scalar l-Scalar-Plain">&quot;drop_overloads&quot;</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span><span class="err">,</span>
  <span class="s">&quot;overprovisioning_factor&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="err">,</span>
  <span class="s">&quot;endpoint_stale_after&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span>
<span class="err">}</span>
</code></pre></div>
</td></tr></table>
<p>overprovisioning_factor一个过度配置的因子，默认是140，当一个priority或者一个locality中的健康主机百分比乘以这个因子小于100，那么就认为这个priority或者locality是不健康的。</p>
<h2 id="degraded-endpoints">Degraded endpoints</h2>
<p>Envoy支持将某些endpoint标记为degraded的，这种类型的endpoint可以接收流量，但是只有在没有足够的健康机器的时候才会接收流量来处理
上游主机通过在返回的header中添加<code>x-envoy-degraded</code>头来表明当前的健康检查的主机是degraded。</p>
<h2 id="priority-levels">Priority levels</h2>
<p>当某一个Priority是健康的，那么会接收全部流量，但是如果发现流这个Priority是不健康的，那么就需要按照100%比将流量打到下一个优先级。
比如健康程度是71%，那么0.71 * 140约等于99%，那么这个Priorit就接收99%的流量，剩下的1%流量就发送到下一个Priority。如果所有的Priority加起来的健康程度不满足100%，还需要
将流量按比例缩放。比如有两个Priority，第一个Priority的健康程度是20%，第二个是30%，总的健康程度只有50%，那么流量就会往第一个Priority打40，第二个Priority打60%，而不是
0.2 * 140的流量打到第一个Priority了。</p>
<h2 id="panic-threshold">Panic threshold</h2>
<p>正常情况下Envoy做负载均衡的时候，会考虑到healthy和degraded的机器所占的比例。但是如果这个比例太低的情况下，Envoy则不考虑健康状况会在所有的机器上进行balancer，而这个被称为panic，
这个比例是panic阀值，默认是50%。如果host的健康程度低于72%就会将流量打向低一级的Priority，如果所有的Priority的健康程序程度比例加起来少于100%，那么哪个优先级低于50%，那么这个优先级
就处于panic模式，流量是发到这个Priority下所有的机器。如果所有的Priority的健康程序程度比例加起来等于或大于100%就都不会出现panic模式，即使某些Priority的健康程度是小于50%的。</p>
<h2 id="zone-aware-routing">Zone aware routing</h2>
<ol>
<li>要求始发集群和upstream集群不是panic mode</li>
<li>Zone aware routing是开启的(配置中的<code>routing_enabled</code>字段表示进行zone aware的请求百分百，默认是100%)</li>
<li>始发集群和upstream集群有相同的zone数量</li>
<li>upstream集群有足够的机器(<code>min_cluster_size</code> zone aware集群的最小大小)</li>
<li>如果始发集群中的本地zone占比要比upstream集群中的本地zone占比高的话，那么Envoy会按照本地zone所在占比例只转发部分流量到upstream集群中，剩余的流量进行跨区域转发</li>
<li>如果始发集群中的本地zone占比要比upstream集群中的本地zone占比小的话，所有的流量都会直接打到upstream中的本地zone</li>
</ol>
<p>需要定一个一个本地集群，这个集群就是Envoy网格组成的集群</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">cluster_manager</span><span class="p">:</span>
  <span class="nt">local_cluster_name</span><span class="p">:</span> <span class="s">&quot;local_cluster_name&quot;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p p-Indicator">{</span>
  <span class="s">&quot;routing_enabled&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;min_cluster_size&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span>
<span class="p p-Indicator">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="load-ststs-reporter">Load Ststs reporter</h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">config.bootstrap.v2.ClusterManager</span><span class="p">:</span>
<span class="p p-Indicator">{</span>
  <span class="s">&quot;local_cluster_name&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;...&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;outlier_detection&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;upstream_bind_config&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span><span class="p p-Indicator">,</span>
  <span class="s">&quot;load_stats_config&quot;</span><span class="p p-Indicator">:</span> <span class="s">&quot;{...}&quot;</span>
<span class="p p-Indicator">}</span>
</code></pre></div>
</td></tr></table>
<p>load_stats_config 用于配置管理集群，启动的时候，会等待管理平面发送LoadStatsResponse，响应中带有需要获取stats的集群名词列表，Envoy会定时将这些集群的stats信息发送到控制平面。</p>
<h2 id="ip-transparency">IP Transparency</h2>
<p>将Downstream的remote address传递到upstream</p>
<ol>
<li>
<p>HTTP Headers
通过x-forwarded-for头，仅支持HTTP协议</p>
</li>
<li>
<p>Proxy Protocol
TCP建立连接的时候，将源地址信息传递过来，需要upstream的主机支持</p>
</li>
<li>
<p>Original Source Listener Filter
Envoy通过socket可以拿到远程的地址也可以借助Proxy Protocol拿到downstream的地址信息、然后把地址信息设置到upstream的socket中，upstream在返回的时候
需要将其流量指向envoy，这里需要让Envoy和upstream部署在一起，然后使用iptables来完成。</p>
</li>
</ol>
<p>TODO(tianqian.zyf): 例子</p>
<h2 id="istio-iptablessh">istio-iptables.sh 分析</h2>
<ul>
<li><code>-p</code> 指定envoy的端口，默认是15001，指的是拦截到的流量将导入到哪个端口，默认是15001</li>
<li><code>-u</code> 指定UID，Effective UID等于指定的这个UID的程序流量不被拦截，默认是1337</li>
<li><code>-g</code> 指定GID，Effective GID等于指定的这个GID的程序流量不被拦截，默认是1337</li>
<li><code>-m</code> 指定流量拦截的模式，REDIRECT还是TPROXY</li>
<li><code>-b</code> 指定哪些inbound的端口被重定向到Envoy中，多个端口按照逗号分割，默认是所有的流量。</li>
<li><code>-d</code> 排除哪些inbound端口不进行流量的重定向</li>
<li><code>-i</code> 指定IP CIDR进行outbound的流量重定向</li>
<li><code>-x</code> 排查哪些IP不进行outbound的流量重定向</li>
<li><code>-k</code> 从哪个虚拟口出去的流量被认为是outbound</li>
</ul>
<h2 id="_4">命令行参数</h2>
<ul>
<li><code>--allow-unknown-fields</code> 关闭protobuf验证，忽略新增字段，核心实现就是 <code>message.GetReflection()-&gt;GetUnknownFields</code></li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="n">allow_unknown_fields_</span> <span class="o">=</span> <span class="n">allow_unknown_fields</span><span class="p">.</span><span class="n">getValue</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">allow_unknown_fields_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MessageUtil</span><span class="o">::</span><span class="n">proto_unknown_fields</span> <span class="o">=</span> <span class="n">ProtoUnknownFieldsMode</span><span class="o">::</span><span class="n">Allow</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 核心实现</span>
  <span class="k">static</span> <span class="kt">void</span> <span class="n">checkUnknownFields</span><span class="p">(</span><span class="k">const</span> <span class="n">Protobuf</span><span class="o">::</span><span class="n">Message</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MessageUtil</span><span class="o">::</span><span class="n">proto_unknown_fields</span> <span class="o">==</span> <span class="n">ProtoUnknownFieldsMode</span><span class="o">::</span><span class="n">Strict</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">message</span><span class="p">.</span><span class="n">GetReflection</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetUnknownFields</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">EnvoyException</span><span class="p">(</span><span class="s">&quot;Protobuf message (type &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">.</span><span class="n">GetTypeName</span><span class="p">()</span> <span class="o">+</span>
                            <span class="s">&quot;) has unknown fields&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li><code>--enable-mutex-tracing</code> 主要是利用了absl库提供的<code>RegisterMutexTracer</code>，将tracer信息通过callback的方式暴露出来</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">MutexTracerImpl</span><span class="o">&amp;</span> <span class="nf">MutexTracerImpl::getOrCreateTracer</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">singleton_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">singleton_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutexTracerImpl</span><span class="p">;</span>
    <span class="c1">// There&#39;s no easy way to unregister a hook. Luckily, this hook is innocuous enough that it</span>
    <span class="c1">// seems safe to leave it registered during testing, even though this technically breaks</span>
    <span class="c1">// hermeticity.</span>
    <span class="n">absl</span><span class="o">::</span><span class="n">RegisterMutexTracer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Envoy</span><span class="o">::</span><span class="n">MutexTracerImpl</span><span class="o">::</span><span class="n">contentionHook</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">singleton_</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li><code>--drain-time-s</code></li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// 连接中有流量的时候才会实际走到这段代码，然后进行Drain处理</span>
  <span class="kt">void</span> <span class="nf">ConnectionManagerImpl::ActiveStream::encodeHeaders</span><span class="p">(</span><span class="n">ActiveStreamEncoderFilter</span><span class="o">*</span> <span class="n">filter</span><span class="p">,</span>
                                                        <span class="n">HeaderMap</span><span class="o">&amp;</span> <span class="n">headers</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">.....</span>
    <span class="c1">// See if we want to drain/close the connection. Send the go away frame prior to encoding the</span>
    <span class="c1">// header block.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connection_manager_</span><span class="p">.</span><span class="n">drain_state_</span> <span class="o">==</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">NotDraining</span> <span class="o">&amp;&amp;</span>
        <span class="n">connection_manager_</span><span class="p">.</span><span class="n">drain_close_</span><span class="p">.</span><span class="n">drainClose</span><span class="p">())</span> <span class="p">{</span>

      <span class="c1">// This doesn&#39;t really do anything for HTTP/1.1 other then give the connection another boost</span>
      <span class="c1">// of time to race with incoming requests. It mainly just keeps the logic the same between</span>
      <span class="c1">// HTTP/1.1 and HTTP/2.</span>
      <span class="n">connection_manager_</span><span class="p">.</span><span class="n">startDrainSequence</span><span class="p">();</span>
      <span class="n">connection_manager_</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">named_</span><span class="p">.</span><span class="n">downstream_cx_drain_close_</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
      <span class="n">ENVOY_STREAM_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;drain closing connection&quot;</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">.......</span>
   <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">ConnectionManagerImpl::startDrainSequence</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">drain_state_</span> <span class="o">==</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">NotDraining</span><span class="p">);</span>
    <span class="n">drain_state_</span> <span class="o">=</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">Draining</span><span class="p">;</span>
    <span class="n">codec_</span><span class="o">-&gt;</span><span class="n">shutdownNotice</span><span class="p">();</span>
    <span class="n">drain_timer_</span> <span class="o">=</span> <span class="n">read_callbacks_</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">().</span><span class="n">dispatcher</span><span class="p">().</span><span class="n">createTimer</span><span class="p">(</span>
        <span class="p">[</span><span class="k">this</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span> <span class="n">onDrainTimeout</span><span class="p">();</span> <span class="p">});</span>
    <span class="n">drain_timer_</span><span class="o">-&gt;</span><span class="n">enableTimer</span><span class="p">(</span><span class="n">config_</span><span class="p">.</span><span class="n">drainTimeout</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// Drain 超时时间，默认是5000ms，如果是http2的协议会先发一个goAway协议帧，如果是http协议就什么都不做</span>
  <span class="kt">void</span> <span class="nf">ConnectionManagerImpl::onDrainTimeout</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">drain_state_</span> <span class="o">!=</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">NotDraining</span><span class="p">);</span>
    <span class="n">codec_</span><span class="o">-&gt;</span><span class="n">goAway</span><span class="p">();</span>
    <span class="n">drain_state_</span> <span class="o">=</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">Closing</span><span class="p">;</span>
    <span class="n">checkForDeferredClose</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 最后会调用close</span>
  <span class="kt">void</span> <span class="nf">ConnectionManagerImpl::checkForDeferredClose</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">drain_state_</span> <span class="o">==</span> <span class="n">DrainState</span><span class="o">::</span><span class="n">Closing</span> <span class="o">&amp;&amp;</span> <span class="n">streams_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">codec_</span><span class="o">-&gt;</span><span class="n">wantsToWrite</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">read_callbacks_</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">().</span><span class="n">close</span><span class="p">(</span><span class="n">Network</span><span class="o">::</span><span class="n">ConnectionCloseType</span><span class="o">::</span><span class="n">FlushWriteAndDelay</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li><code>--file-flush-interval-msec</code> access log文件的刷盘间隔</li>
</ul>
<h2 id="xds-resource-patching">xDS resource patching</h2>
<p>目前endpoint整体是一个resource，xDS的增量只能是resource粒度的增加和减少，对于endpoint来说，他整体就是一个resource，做不了增量的加和减少，因此社区提出了xDS resource patching的机制
可以针对一个resource内部做merge、add、remove、modtify等操作，目前还在review中。</p>
<p>https://github.com/envoyproxy/envoy/issues/8400</p>
<h2 id="rebalance">rebalance</h2>
<p>用于在多个worker线程之间平衡连接数，目前使用的epoll的方式内核的分配策略是LIFO，会导致连接会分配到固定的前几个worker线程中，这个在大多数情况是OK的，但是对于envoy egress http2
这种少量长连接的场景来说并不是太适合，这种场景连接数并不多，但是连接上的负载很大。</p>
<ul>
<li>https://github.com/envoyproxy/envoy/pull/8422</li>
<li>https://blog.cloudflare.com/the-sad-state-of-linux-socket-balancing/</li>
</ul>
<h2 id="http-dynamic-forward-proxy">HTTP dynamic forward proxy</h2>
<p>目前Envoy是支持dynamic forward(istio使用这个能力做egress)，这是通过iptables来实现的，通过iptables保留实际要访问的真实ip(也可以是通过http的header x-envoy-original-dst-host 来传递)，然后通过这个ip动态添加到cluster中，但这个方案并不通用依赖iptables，HTTP dynamic forward proxy则是使用http host header进行动态dns解析，然后通过新增的cluster type(dynamic_forward_proxy)来实现将动态解析的DNS结果放到集群中并把解析结果缓存起来，当第一次请求的时候没有对应的DNS解析结果时，会通过新增的http dynamic forward proxy filter中断当前的请求，然后异步进行DNS解析，等解析完成后再继续转发请求。后续请求进来的时候，直接使用DNS的缓存结果进行请求转发。</p>
<p>https://github.com/envoyproxy/envoy/pull/7307</p>
<h2 id="on-demand-vhds">on-demand VHDS</h2>
<p><code>RouteConfiguration</code>下面包含了<code>route.VirtualHost</code>，<code>route.VirtualHost</code>里面再包含Route和Action，istio创建virtual service的时候，会导致整个<code>RouteConfiguration</code>都发生更新，实际只是新增一个<code>VirtualHost</code>或者，是更新一个<code>VirtualHost</code>条目。通过VHDS可以将<code>RouteConfiguration</code>和<code>VirtualHost</code>解耦。结合差量更新还可以做到按需更新。此外这里的on-demand指的是当发起请求的时候，会通过on-demand filter去服务端查询对应的路由条目，然后合并到<code>RouteConfiguration</code>中，而不是一次性全下发下来。</p>
<p>https://github.com/envoyproxy/envoy/pull/8617</p>
<h2 id="stats-symbol">stats symbol优化</h2>
<p>引入symbol tables，将一个metrics按照"."号分割成多个部分，每一个部分进行编码存在symbol table中，并分配一个symbol id，重复引用相同的部分仅需要保存symbol id，通过这个id来找到对应的字符串。</p>
<p>https://github.com/envoyproxy/envoy/pull/5321</p>
<h2 id="wasm">wasm</h2>
<p>目前wasm主要是google的人在主导，有一个独立的仓库envoy-wasm，目前istio已经在使用这个仓库做一些实验性的功能，将mixer的部分能力通过wasm的方式来提供，与此同时wasm的代码也在同步提交到
Envoy官方社区，一旦全部合并进去，istio会将仓库重新指向envoy官方昂哭。</p>
<p>https://github.com/envoyproxy/envoy/pulls?utf8=%E2%9C%93&amp;q=wasm
https://istio.io/docs/ops/telemetry/in-proxy-service-telemetry/</p>
<h2 id="adaptive-concurrency">adaptive concurrency</h2>
<p>参考Netflix’s concurrency limits Java library.的算法实现了一个七层的http filter，用来做自适应的并发限流。</p>
<p>https://github.com/envoyproxy/envoy/pull/8582
https://github.com/envoyproxy/envoy/issues/7789
https://github.com/Netflix/concurrency-limits</p>
<p>The adaptive concurrency filter dynamically adjusts the allowed number of requests that can be
outstanding (concurrency) to all hosts in a given cluster at any time. Concurrency values are
calculated using latency sampling of completed requests and comparing the measured samples in a time
window against the expected latency for hosts in the cluster.</p>
<p>一个http filter，用于动态调整允许发出去的请求，并发度通过对已完成请求的延迟采样和一个时间窗口中测量的样本进行比较，群集中主机的预期延迟。</p>
<p>Gradient Controller: 梯度控制器根据定期测量的理想round-trip时间
Concurrency Controllers:  实现了一个算法，用于对每一个请求负责转发的决策，并记录延迟用来计算并发限制</p>
<h2 id="grpc-xds">Grpc &amp; xDS</h2>
<p>从最上层开始分析(以cds为例):</p>
<ol>
<li>cds_api创建订阅器</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CdsApiImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CdsApi</span><span class="p">,</span>
                   <span class="n">Config</span><span class="o">::</span><span class="n">SubscriptionCallbacks</span><span class="p">,</span>
                   <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">upstream</span><span class="o">&gt;</span> <span class="p">{</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&gt;</span> <span class="n">subscription_</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CdsApiImpl</span><span class="o">::</span><span class="n">CdsApiImpl</span><span class="p">(</span><span class="k">const</span> <span class="n">envoy</span><span class="o">::</span><span class="n">config</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">ConfigSource</span><span class="o">&amp;</span> <span class="n">cds_config</span><span class="p">,</span>
                       <span class="n">ClusterManager</span><span class="o">&amp;</span> <span class="n">cm</span><span class="p">,</span> <span class="n">Stats</span><span class="o">::</span><span class="n">Scope</span><span class="o">&amp;</span> <span class="n">scope</span><span class="p">,</span>
                       <span class="n">ProtobufMessage</span><span class="o">::</span><span class="n">ValidationVisitor</span><span class="o">&amp;</span> <span class="n">validation_visitor</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">cm_</span><span class="p">(</span><span class="n">cm</span><span class="p">),</span> <span class="n">scope_</span><span class="p">(</span><span class="n">scope</span><span class="p">.</span><span class="n">createScope</span><span class="p">(</span><span class="s">&quot;cluster_manager.cds.&quot;</span><span class="p">)),</span>
      <span class="n">validation_visitor_</span><span class="p">(</span><span class="n">validation_visitor</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 通过SubscriptionFactory来创建的</span>
  <span class="n">subscription_</span> <span class="o">=</span> <span class="n">cm_</span><span class="p">.</span><span class="n">subscriptionFactory</span><span class="p">().</span><span class="n">subscriptionFromConfigSource</span><span class="p">(</span>
      <span class="n">cds_config</span><span class="p">,</span> <span class="n">loadTypeUrl</span><span class="p">(</span><span class="n">cds_config</span><span class="p">.</span><span class="n">resource_api_version</span><span class="p">()),</span> <span class="o">*</span><span class="n">scope_</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>返回的是一个<code>Subscription</code>，CDS可以通过这个接口设置和更新要订阅的资源名</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Subscription</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">Subscription</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Start a configuration subscription asynchronously. This should be called once and will continue</span>
<span class="cm">   * to fetch throughout the lifetime of the Subscription object.</span>
<span class="cm">   * @param resources set of resource names to fetch.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">resource_names</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Update the resources to fetch.</span>
<span class="cm">   * @param resources vector of resource names to fetch. It&#39;s a (not unordered_)set so that it can</span>
<span class="cm">   * be passed to std::set_difference, which must be given sorted collections.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">updateResourceInterest</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">update_to_these_names</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>实际上是创建了<code>GrpcMuxSubscriptionImpl</code>，并将<code>CdsApiImpl</code>传给<code>GrpcMuxSubscriptionImpl</code>通过<code>SubscriptionCallbacks</code>将订阅到的内容回调给<code>CdsApiImpl</code></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="k">case</span> <span class="n">envoy</span><span class="o">::</span><span class="n">config</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">ConfigSource</span><span class="o">::</span><span class="n">ConfigSourceSpecifierCase</span><span class="o">::</span><span class="nl">kAds</span><span class="p">:</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cm_</span><span class="p">.</span><span class="n">adsMux</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isDelta</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">DeltaSubscriptionImpl</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">cm_</span><span class="p">.</span><span class="n">adsMux</span><span class="p">(),</span> <span class="n">type_url</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span>
          <span class="n">Utility</span><span class="o">::</span><span class="n">configSourceInitialFetchTimeout</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">GrpcMuxSubscriptionImpl</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">cm_</span><span class="p">.</span><span class="n">adsMux</span><span class="p">(),</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">type_url</span><span class="p">,</span> <span class="n">dispatcher_</span><span class="p">,</span>
          <span class="n">Utility</span><span class="o">::</span><span class="n">configSourceInitialFetchTimeout</span><span class="p">(</span><span class="n">config</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>SubscriptionCallbacks继承了<code>SubscriptionCallbacks</code>和<code>Subscription</code></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GrpcMuxSubscriptionImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Subscription</span><span class="p">,</span>
                                <span class="n">GrpcMuxCallbacks</span><span class="p">,</span>
                                <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">config</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">GrpcMuxSharedPtr</span> <span class="n">grpc_mux_</span><span class="p">;</span>
    <span class="n">SubscriptionCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks_</span><span class="p">;</span>
    <span class="n">GrpcMuxWatchPtr</span> <span class="n">watch_</span><span class="p">{};</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>GrpcMuxCallbacks本质上和SubscriptionCallbacks是一样的，<code>GrpcMuxSubscriptionImpl</code>通过底层的<code>GrpcMuxSharedPtr</code>(它会回调GrpcMuxCallbacks把收到的内容返回给GrpcMuxSubscriptionImpl)
GrpcMuxSubscriptionImpl再调用<code>SubscriptionCallbacks</code>把收到的内容透传给上层的CDS API。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">GrpcMuxSubscriptionImpl::onConfigUpdate</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">Protobuf</span><span class="o">::</span><span class="n">RepeatedPtrField</span><span class="o">&lt;</span><span class="n">ProtobufWkt</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;&amp;</span> <span class="n">resources</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">version_info</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">.......</span>
  <span class="n">callbacks_</span><span class="p">.</span><span class="n">onConfigUpdate</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="n">version_info</span><span class="p">);</span>
  <span class="p">.......</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>接下来看下这个<code>GrpcMuxWatchPtr watch_{};</code>，它是通过<code>grpc_mux_</code>创建的。可以通过<code>GrpcMuxWatch</code>来取消订阅。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">watch_</span> <span class="o">=</span> <span class="n">grpc_mux_</span><span class="o">-&gt;</span><span class="n">subscribe</span><span class="p">(</span><span class="n">type_url_</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Handle on an muxed gRPC subscription. The subscription is canceled on destruction.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">GrpcMuxWatch</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">GrpcMuxWatch</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>最后就剩下最为核心的<code>grpc_mux_</code>了，它是通过<code>cm_.adsMux()</code>创建出来的。是ClusterManagerImpl的成员，看起来是所有上层的xDS订阅是复用同一个<code>GrpcMuxSharedPtr</code>了</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ClusterManagerImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ClusterManager</span><span class="p">,</span> <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">upstream</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">Config</span><span class="o">::</span><span class="n">GrpcMuxSharedPtr</span> <span class="n">adsMux</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ads_mux_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">Config</span><span class="o">::</span><span class="n">GrpcMuxSharedPtr</span> <span class="n">ads_mux_</span><span class="p">;</span>
<span class="p">}</span>

      <span class="n">ads_mux_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">::</span><span class="n">GrpcMuxImpl</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">local_info</span><span class="p">,</span>
          <span class="n">Config</span><span class="o">::</span><span class="n">Utility</span><span class="o">::</span><span class="n">factoryForGrpcApiConfigSource</span><span class="p">(</span><span class="o">*</span><span class="n">async_client_manager_</span><span class="p">,</span>
                                                         <span class="n">dyn_resources</span><span class="p">.</span><span class="n">ads_config</span><span class="p">(),</span> <span class="n">stats</span><span class="p">)</span>
              <span class="o">-&gt;</span><span class="n">create</span><span class="p">(),</span>
          <span class="n">main_thread_dispatcher</span><span class="p">,</span>
          <span class="o">*</span><span class="n">Protobuf</span><span class="o">::</span><span class="n">DescriptorPool</span><span class="o">::</span><span class="n">generated_pool</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">FindMethodByName</span><span class="p">(</span>
              <span class="n">dyn_resources</span><span class="p">.</span><span class="n">ads_config</span><span class="p">().</span><span class="n">transport_api_version</span><span class="p">()</span> <span class="o">==</span>
                      <span class="n">envoy</span><span class="o">::</span><span class="n">config</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">ApiVersion</span><span class="o">::</span><span class="n">V3ALPHA</span>
                  <span class="o">?</span> <span class="s">&quot;envoy.service.discovery.v3alpha.AggregatedDiscoveryService.&quot;</span>
                    <span class="s">&quot;StreamAggregatedResources&quot;</span>
                  <span class="o">:</span> <span class="s">&quot;envoy.service.discovery.v2.AggregatedDiscoveryService.&quot;</span>
                    <span class="s">&quot;StreamAggregatedResources&quot;</span><span class="p">),</span>
          <span class="n">random_</span><span class="p">,</span> <span class="n">stats_</span><span class="p">,</span>
          <span class="n">Envoy</span><span class="o">::</span><span class="n">Config</span><span class="o">::</span><span class="n">Utility</span><span class="o">::</span><span class="n">parseRateLimitSettings</span><span class="p">(</span><span class="n">dyn_resources</span><span class="p">.</span><span class="n">ads_config</span><span class="p">()),</span>
          <span class="n">bootstrap</span><span class="p">.</span><span class="n">dynamic_resources</span><span class="p">().</span><span class="n">ads_config</span><span class="p">().</span><span class="n">set_node_on_first_message_only</span><span class="p">());</span>
</code></pre></div>
</td></tr></table>
<p>其实现包含了多个，可能是增量实现NewGrpcMuxImpl、也有可能是全量实现GrpcMuxImpl、或者是空实现NullGrpcMuxImpl，我们主要看下<code>GrpcMuxImpl</code>的实现</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GrpcMuxImpl</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">GrpcMux</span><span class="p">,</span>
      <span class="k">public</span> <span class="n">GrpcStreamCallbacks</span><span class="o">&lt;</span><span class="n">envoy</span><span class="o">::</span><span class="n">service</span><span class="o">::</span><span class="n">discovery</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">DiscoveryResponse</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="k">public</span> <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">config</span><span class="o">&gt;</span> <span class="p">{</span>
 <span class="k">private</span><span class="o">:</span>
   <span class="n">GrpcStream</span><span class="o">&lt;</span><span class="n">envoy</span><span class="o">::</span><span class="n">service</span><span class="o">::</span><span class="n">discovery</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">DiscoveryRequest</span><span class="p">,</span>
             <span class="n">envoy</span><span class="o">::</span><span class="n">service</span><span class="o">::</span><span class="n">discovery</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">DiscoveryResponse</span><span class="o">&gt;</span>
      <span class="n">grpc_stream_</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>核心是grpc_stream_，通过GrpcStream可以发送、建立stream流</p>
<p><code>GrpcStream</code> Grpc中的一个流是对<code>Grpc::AsyncStream</code>的封装，继承自<code>Grpc::AsyncStreamCallbacks</code>，提供了一个<code>void onReceiveMessage(std::unique_ptr&lt;ResponseProto&gt;&amp;&amp; message) override</code>接口
用于返回收到的message，组合了<code>Grpc::AsyncClient</code>用来创建<code>Grpc::AsyncStream</code>，提供了sendMessage来发送<code>stream</code>，同时也提供了<code>onReceiveMessage</code>，当收到message后，回调<code>GrpcStreamCallbacks</code>的onDiscoveryResponse方法</p>
<p><code>Grpc::AsyncStreamCallbacks</code> 提供了<code>onReceiveMessage</code>的回调，通过<code>Grpc::AsyncStream</code>发出message后，通过这个callback获得返回的消息</p>
<p><code>Grpc::AsyncClient</code> grpc Client 来创建一个<code>Grpc::AsyncStream</code></p>
<p><code>GrpcStreamCallbacks</code>，提供了几个和stream相关的callback</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">ResponseProto</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">GrpcStreamCallbacks</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">GrpcStreamCallbacks</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * For the GrpcStream to prompt the context to take appropriate action in response to the</span>
<span class="cm">   * gRPC stream having been successfully established.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onStreamEstablished</span><span class="p">()</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * For the GrpcStream to prompt the context to take appropriate action in response to</span>
<span class="cm">   * failure to establish the gRPC stream.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onEstablishmentFailure</span><span class="p">()</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * For the GrpcStream to pass received protos to the context.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onDiscoveryResponse</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ResponseProto</span><span class="o">&gt;&amp;&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * For the GrpcStream to call when its rate limiting logic allows more requests to be sent.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onWriteable</span><span class="p">()</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p><code>GrpcSubscriptionImpl</code></p>
<p><code>Config::Subscription</code> 所有订阅的抽象接口，提供了start和updateResourceInterest来更新资源的订阅，目前有几个实现:</p>
<ol>
<li><code>GrpcSubscriptionImpl</code> 对应xDS</li>
<li><code>GrpcMuxSubscriptionImpl</code> 对应ADS</li>
<li><code>DeltaSubscriptionImpl</code> 增量xDS</li>
<li><code>GrpcMuxSubscriptionImpl</code> 增量ADS</li>
<li><code>HttpSubscriptionImpl</code> REST</li>
</ol>
<p><code>SubscriptionCallbacks</code> 提供<code>onConfigUpdate</code>、<code>onConfigUpdateFailed</code>、<code>resourceName</code>等回调，每一个xDS类型都继承这个callback用来接收配置更新的通知</p>
<p><code>GrpcMux</code> 用来管理单个stream上的多个订阅的，典型的就是ADS stream上处理EDS、CDS、LDS等订阅，主要是提供了start、pause、resume、addOrUpdateWatch等等</p>
<p><code>GrpcMuxWatch</code></p>
<p><code>GrpcMuxWatchImpl</code> 继承 <code>GrpcMuxWatch</code> 每订阅一次资源就创建一个<code>GrpcMuxWatchImpl</code>，析构的时候可以用来进行cancel资源订阅。</p>
<p><code>GrpcMuxCallbacks</code> 核心的ADS回调，用于对接收到的xDS资源进行对应的回调，核心接口是:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * A grouping of callbacks that a GrpcMux should provide to its GrpcStream.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">GrpcMuxCallbacks</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">GrpcMuxCallbacks</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Called when a configuration update is received.</span>
<span class="cm">   * @param resources vector of fetched resources corresponding to the configuration update.</span>
<span class="cm">   * @param version_info update version.</span>
<span class="cm">   * @throw EnvoyException with reason if the configuration is rejected. Otherwise the configuration</span>
<span class="cm">   *        is accepted. Accepted configurations have their version_info reflected in subsequent</span>
<span class="cm">   *        requests.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onConfigUpdate</span><span class="p">(</span><span class="k">const</span> <span class="n">Protobuf</span><span class="o">::</span><span class="n">RepeatedPtrField</span><span class="o">&lt;</span><span class="n">ProtobufWkt</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;&amp;</span> <span class="n">resources</span><span class="p">,</span>
                              <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">version_info</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Called when either the subscription is unable to fetch a config update or when onConfigUpdate</span>
<span class="cm">   * invokes an exception.</span>
<span class="cm">   * @param reason supplies the update failure reason.</span>
<span class="cm">   * @param e supplies any exception data on why the fetch failed. May be nullptr.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onConfigUpdateFailed</span><span class="p">(</span><span class="n">Envoy</span><span class="o">::</span><span class="n">Config</span><span class="o">::</span><span class="n">ConfigUpdateFailureReason</span> <span class="n">reason</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">EnvoyException</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Obtain the &quot;name&quot; of a v2 API resource in a google.protobuf.Any, e.g. the route config name for</span>
<span class="cm">   * a RouteConfiguration, based on the underlying resource type.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="nf">resourceName</span><span class="p">(</span><span class="k">const</span> <span class="n">ProtobufWkt</span><span class="o">::</span><span class="n">Any</span><span class="o">&amp;</span> <span class="n">resource</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>等于SubscriptionCallbacks，两者是一致的，含义相同。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Subscription</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">Subscription</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Start a configuration subscription asynchronously. This should be called once and will continue</span>
<span class="cm">   * to fetch throughout the lifetime of the Subscription object.</span>
<span class="cm">   * @param resources set of resource names to fetch.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">resource_names</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Update the resources to fetch.</span>
<span class="cm">   * @param resources vector of resource names to fetch. It&#39;s a (not unordered_)set so that it can</span>
<span class="cm">   * be passed to std::set_difference, which must be given sorted collections.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">updateResourceInterest</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">update_to_these_names</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">SubscriptionCallbacks</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">SubscriptionCallbacks</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onConfigUpdate</span><span class="p">(</span><span class="k">const</span> <span class="n">Protobuf</span><span class="o">::</span><span class="n">RepeatedPtrField</span><span class="o">&lt;</span><span class="n">ProtobufWkt</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;&amp;</span> <span class="n">resources</span><span class="p">,</span>
                              <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">version_info</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span>
  <span class="nf">onConfigUpdate</span><span class="p">(</span><span class="k">const</span> <span class="n">Protobuf</span><span class="o">::</span><span class="n">RepeatedPtrField</span><span class="o">&lt;</span><span class="n">envoy</span><span class="o">::</span><span class="n">service</span><span class="o">::</span><span class="n">discovery</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">Resource</span><span class="o">&gt;&amp;</span>
                     <span class="n">added_resources</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">Protobuf</span><span class="o">::</span><span class="n">RepeatedPtrField</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">removed_resources</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">system_version_info</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onConfigUpdateFailed</span><span class="p">(</span><span class="n">ConfigUpdateFailureReason</span> <span class="n">reason</span><span class="p">,</span> <span class="k">const</span> <span class="n">EnvoyException</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="nf">resourceName</span><span class="p">(</span><span class="k">const</span> <span class="n">ProtobufWkt</span><span class="o">::</span><span class="n">Any</span><span class="o">&amp;</span> <span class="n">resource</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>所有的上层API(LDS/CDS/EDS/..)等都继承了<code>SubscriptionCallbacks</code>用于获取订阅到的数据。
GrpcMuxSubscriptionImpl继承GrpcMuxCallbacks和Subscription可以给上层API(CDS/LDS/EDS...)等提供资源订阅的接口(Subscription)来订阅资源
每一类资源都需要有一个GrpcMuxSubscriptionImpl类，这个类负责提供资源订阅、更新资源等，还有将订阅的内容回调给上层API</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SubscriptionFactory</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">SubscriptionFactory</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Subscription factory interface.</span>
<span class="cm">   *</span>
<span class="cm">   * @param config envoy::api::v2::core::ConfigSource to construct from.</span>
<span class="cm">   * @param type_url type URL for the resource being subscribed to.</span>
<span class="cm">   * @param scope stats scope for any stats tracked by the subscription.</span>
<span class="cm">   * @param callbacks the callbacks needed by all Subscription objects, to deliver config updates.</span>
<span class="cm">   *                  The callbacks must not result in the deletion of the Subscription object.</span>
<span class="cm">   * @return SubscriptionPtr subscription object corresponding for config and type_url.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="n">SubscriptionPtr</span>
  <span class="nf">subscriptionFromConfigSource</span><span class="p">(</span><span class="k">const</span> <span class="n">envoy</span><span class="o">::</span><span class="n">config</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">ConfigSource</span><span class="o">&amp;</span> <span class="n">config</span><span class="p">,</span>
                               <span class="n">absl</span><span class="o">::</span><span class="n">string_view</span> <span class="n">type_url</span><span class="p">,</span> <span class="n">Stats</span><span class="o">::</span><span class="n">Scope</span><span class="o">&amp;</span> <span class="n">scope</span><span class="p">,</span>
                               <span class="n">SubscriptionCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>


  <span class="k">case</span> <span class="n">envoy</span><span class="o">::</span><span class="n">config</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">ConfigSource</span><span class="o">::</span><span class="n">ConfigSourceSpecifierCase</span><span class="o">::</span><span class="nl">kAds</span><span class="p">:</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cm_</span><span class="p">.</span><span class="n">adsMux</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isDelta</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">DeltaSubscriptionImpl</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">cm_</span><span class="p">.</span><span class="n">adsMux</span><span class="p">(),</span> <span class="n">type_url</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span>
          <span class="n">Utility</span><span class="o">::</span><span class="n">configSourceInitialFetchTimeout</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">GrpcMuxSubscriptionImpl</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">cm_</span><span class="p">.</span><span class="n">adsMux</span><span class="p">(),</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">type_url</span><span class="p">,</span> <span class="n">dispatcher_</span><span class="p">,</span>
          <span class="n">Utility</span><span class="o">::</span><span class="n">configSourceInitialFetchTimeout</span><span class="p">(</span><span class="n">config</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>针对每一个type_url的资源都创建一个订阅器，等待内容回调。实际订阅器就是GrpcMuxSubscriptionImpl对象，接下来我们看下<code>GrpcMuxSubscriptionImpl</code>对象</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GrpcMuxSubscriptionImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Subscription</span><span class="p">,</span>
                                <span class="n">GrpcMuxCallbacks</span><span class="p">,</span>
                                <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">config</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">GrpcMuxSubscriptionImpl</span><span class="p">(</span><span class="n">GrpcMuxSharedPtr</span> <span class="n">grpc_mux</span><span class="p">,</span> <span class="n">SubscriptionCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks</span><span class="p">,</span>
                          <span class="n">SubscriptionStats</span> <span class="n">stats</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">string_view</span> <span class="n">type_url</span><span class="p">,</span>
                          <span class="n">Event</span><span class="o">::</span><span class="n">Dispatcher</span><span class="o">&amp;</span> <span class="n">dispatcher</span><span class="p">,</span>
                          <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">init_fetch_timeout</span><span class="p">);</span>

  <span class="c1">// Config::Subscription</span>
  <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">resource_names</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">updateResourceInterest</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">update_to_these_names</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

  <span class="c1">// Config::GrpcMuxCallbacks</span>
  <span class="kt">void</span> <span class="nf">onConfigUpdate</span><span class="p">(</span><span class="k">const</span> <span class="n">Protobuf</span><span class="o">::</span><span class="n">RepeatedPtrField</span><span class="o">&lt;</span><span class="n">ProtobufWkt</span><span class="o">::</span><span class="n">Any</span><span class="o">&gt;&amp;</span> <span class="n">resources</span><span class="p">,</span>
                      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">version_info</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">onConfigUpdateFailed</span><span class="p">(</span><span class="n">Envoy</span><span class="o">::</span><span class="n">Config</span><span class="o">::</span><span class="n">ConfigUpdateFailureReason</span> <span class="n">reason</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">EnvoyException</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="nf">resourceName</span><span class="p">(</span><span class="k">const</span> <span class="n">ProtobufWkt</span><span class="o">::</span><span class="n">Any</span><span class="o">&amp;</span> <span class="n">resource</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">disableInitFetchTimeoutTimer</span><span class="p">();</span>

  <span class="n">GrpcMuxSharedPtr</span> <span class="n">grpc_mux_</span><span class="p">;</span>
  <span class="n">SubscriptionCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks_</span><span class="p">;</span>
  <span class="n">SubscriptionStats</span> <span class="n">stats_</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_url_</span><span class="p">;</span>
  <span class="n">GrpcMuxWatchPtr</span> <span class="n">watch_</span><span class="p">{};</span>
  <span class="n">Event</span><span class="o">::</span><span class="n">Dispatcher</span><span class="o">&amp;</span> <span class="n">dispatcher_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">init_fetch_timeout_</span><span class="p">;</span>
  <span class="n">Event</span><span class="o">::</span><span class="n">TimerPtr</span> <span class="n">init_fetch_timeout_timer_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<p>组合了GrpcMuxSharedPtr(NewGrpcMuxImpl)增量实现、或者(GrpcMuxImpl)全量实现
<code>GrpcMuxImpl</code> 通过调用底层的<code>GrpcStream</code>来发送stream，同时继承了<code>GrpcStreamCallbacks</code>用来接收stream返回的message</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GrpcMuxImpl</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">GrpcMux</span><span class="p">,</span>
      <span class="k">public</span> <span class="n">GrpcStreamCallbacks</span><span class="o">&lt;</span><span class="n">envoy</span><span class="o">::</span><span class="n">service</span><span class="o">::</span><span class="n">discovery</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">DiscoveryResponse</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="k">public</span> <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">config</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">GrpcStream</span><span class="o">&lt;</span><span class="n">envoy</span><span class="o">::</span><span class="n">service</span><span class="o">::</span><span class="n">discovery</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">DiscoveryRequest</span><span class="p">,</span>
             <span class="n">envoy</span><span class="o">::</span><span class="n">service</span><span class="o">::</span><span class="n">discovery</span><span class="o">::</span><span class="n">v3alpha</span><span class="o">::</span><span class="n">DiscoveryResponse</span><span class="o">&gt;</span>
      <span class="n">grpc_stream_</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">GrpcStream</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Grpc</span><span class="o">::</span><span class="n">AsyncStreamCallbacks</span><span class="o">&lt;</span><span class="n">ResponseProto</span><span class="o">&gt;</span><span class="p">,</span>
                   <span class="k">public</span> <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">config</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">Grpc</span><span class="o">::</span><span class="n">AsyncClient</span><span class="o">&lt;</span><span class="n">RequestProto</span><span class="p">,</span> <span class="n">ResponseProto</span><span class="o">&gt;</span> <span class="n">async_client_</span><span class="p">;</span>
    <span class="n">Grpc</span><span class="o">::</span><span class="n">AsyncStream</span><span class="o">&lt;</span><span class="n">RequestProto</span><span class="o">&gt;</span> <span class="n">stream_</span><span class="p">{};</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Manage one or more gRPC subscriptions on a single stream to management server. This can be used</span>
<span class="cm"> * for a single xDS API, e.g. EDS, or to combined multiple xDS APIs for ADS.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">GrpcMux</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">GrpcMux</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="n">GrpcMuxWatchPtr</span> <span class="nf">subscribe</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type_url</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">resources</span><span class="p">,</span>
                                    <span class="n">GrpcMuxCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">pause</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type_url</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">resume</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type_url</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">isDelta</span><span class="p">()</span> <span class="k">const</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="c1">// For delta</span>
  <span class="k">virtual</span> <span class="n">Watch</span><span class="o">*</span> <span class="nf">addOrUpdateWatch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type_url</span><span class="p">,</span> <span class="n">Watch</span><span class="o">*</span> <span class="n">watch</span><span class="p">,</span>
                                  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">resources</span><span class="p">,</span>
                                  <span class="n">SubscriptionCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks</span><span class="p">,</span>
                                  <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">init_fetch_timeout</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">removeWatch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type_url</span><span class="p">,</span> <span class="n">Watch</span><span class="o">*</span> <span class="n">watch</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">paused</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type_url</span><span class="p">)</span> <span class="k">const</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<h2 id="initmanager">InitManager</h2>
<p><code>WatcherHandle</code>、<code>Mannager</code>、<code>Target</code>、<code>TargetHandle</code>、<code>Watcher</code>、<code>WatcherHandle</code></p>
<p>一个WatcherImpl持有一个ReadyFn的回调，通过WatcherImpl可以创建WatcherHandle持有对ReadyFn的弱回调。
TargetImpl和TargetHandleImpl和WatcherImpl和WatcherHandle类似，只是前者是持有ReadyFn后者是持有InternalInitalizeFn</p>
<h2 id="grpc-client">grpc client</h2>
<p>基本概念解释:</p>
<ul>
<li><code>AsyncRequest</code> An in-flight gRPC unary RPC. 单向的grpc请求，可能正在发送中，可以cancel掉</li>
<li><code>RawAsyncStream</code>  An in-flight gRPC stream. 通过grpc stream来发送请求</li>
<li><code>RawAsyncRequestCallbacks</code></li>
<li><code>RawAsyncStreamCallbacks</code></li>
<li>
<p><code>RawAsyncClient</code>  发送grpc请求，异步接收响应</p>
</li>
<li>
<p><code>AsyncClientImpl</code>
继承自RawAsyncClient，具备发送单向grpc消息，返回一个AsyncRequest，可以对这个请求做cancel，response通过RawAsyncRequestCallbacks返回
也可以发送grpc stream，返回一个RawAsyncStream，一个stream，通过这个stream可以发送消息，response通过RawAsyncStreamCallbacks返回</p>
</li>
</ul>
<h2 id="envoy_1">Envoy 性能优化</h2>
<h2 id="http-filter-status">Http filter status</h2>
<p>分为两类:</p>
<ul>
<li>FilterHeadersStatus</li>
<li>Continue</li>
<li>StopIteration                  // 停止对下面的filter进行iterate，除非主动调用continueDecoding()/continueEncoding()来继续</li>
<li>ContinueAndEndStream           // 继续iterate下面的filter，但是忽略后续的data和trailer</li>
<li>StopAllIterationAndBuffer      // 停止iterate下面的filter，但是会继续buffer后续的data，达到buffer的限制后会返回401或500</li>
<li>
<p>StopAllIterationAndWatermark   // 停止iterate下面的filter，但是会继续buffer后续的data，直到触发high watermark</p>
</li>
<li>
<p>FilterDataStatus</p>
</li>
<li>Continue</li>
<li>StopIterationAndBuffer</li>
<li>StopIterationAndWatermark</li>
<li>
<p>StopIterationNoBuffer</p>
</li>
<li>
<p>FilterTrailersStatus</p>
</li>
<li>Continue</li>
<li>
<p>StopIteration</p>
</li>
<li>
<p>FilterMetadataStatus</p>
</li>
<li>Continue</li>
</ul>
<p>## TLS证书</p>
<p><code>yaml
  static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 443
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
          codec_type: auto
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains:
              - "*"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: service1
          http_filters:
          - name: envoy.filters.http.router
            typed_config: {}
      # 服务端验证
      transport_socket:
        name: envoy.transport_socket.tls
        typed_config:
          "@type": type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext
          common_tls_context:
            # 证书相关的信息
            tls_certificates:
            # 证书
            - certificate_chain: { filename: "/root/gateway/api.alimesh.alibaba-inc.com_SHA256withRSA_EC.crt" }
            # 私钥
              private_key: { filename: "/root/gateway/api.alimesh.alibaba-inc.com_SHA256withRSA_EC.key" }
              # 客户端验证
            validation_context:
              trusted_ca:
                # 验证客户端证书的root ca，一般用系统的就足够
                filename: "/etc/ssl/certs/ca-certificates.crt"
                # 验证模式(Peer certificate verification mode.)，默认客户端证书必须是经过指定CA列表中的CA进行验证的
              trust_chain_verification: ACCEPT_UNTRUSTED
          require_client_certificate: false
  clusters:
  - name: service1
    connect_timeout: 0.25s
    type: strict_dns
    lb_policy: round_robin
    transport_socket:
      name: envoy.transport_socket.tls
      typed_config:
          "@type": type.googleapis.com/envoy.api.v2.auth.UpstreamTlsContext
          CommonTlsContext:
            validation_context:
              trust_chain_verification: ACCEPT_UNTRUSTED
    load_assignment:
      cluster_name: service1
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 9999
admin:
  access_log_path: "/dev/null"
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 8001</code></p>
<p>## xDS transport next steps</p>
<ol>
<li>Collections: 没有一种通用机制来选择资源子集，大家现在普遍的做法是通过在Node中添加一些信息让控制面可以进行计算子集。但是这种方式不通用。Envoy希望引入namesapce机制来选择子集
     更通用的方法可以是引入一个key/value属性集合去选择请求的资源，对于增量xDS来说也是有意义的。</li>
</ol>
<p>Ref:
  https://github.com/envoyproxy/envoy/pull/10689
  https://github.com/envoyproxy/envoy/issues/10373</p>
<ol>
<li>Resource immutability: xDS目前没有一个不可以变的资源名到资源的映射关系，目前是控制面结合Node信息来生成或者修改资源名，两个客户端可能看到相同资源名的不同资源，这对于xDS Cache并不优化
     同时这种行为也会影响多控制面的联邦，不同的控制面必须具有一个全局的资源命名方式。</li>
</ol>
<p>Ref:
  https://docs.google.com/document/d/1X9fFzqBZzrSmx2d0NkmjDW2tc8ysbLQS9LaRQRxdJZU/edit?disco=AAAAGQ_84vU&amp;ts=5e61532c&amp;usp_dm=false</p>
<ol>
<li>
<p>Per-xDS type resource name semantics: VHDS的资源名是一种特殊结构，格式要求为<code>&lt;route configuration name&gt;/&lt;host entry&gt;</code>，这允许控制面根据这种格式来查询指定路由配置中virtual host中的entry
     在这种情况下，资源名其实就是扮演了namesapce的角色。在未来其他的资源类型的名字将可能需要某种结构，理想的资源命名方案将允许结构，同时留给控制平面一些自由，以便在需要时继续使用不透明命名，而不是将不透明和结构化形式任意混合在一起。</p>
</li>
<li>
<p>Flat representation: 现如今，资源标识已成为资源名称，节点信息，ConfigSource的权限，URL类型和版本的大杂烩。
    在无法处理相关proto3消息的人员或系统之间进行通信时，没有标准格式可以对这些信息进行简明的编码。
    URI提供了一种强大的符合标准的方式来指定此信息。未来的xDS资源命名方案将受益于具有规范的URI表示（除了规范的proto3定义）</p>
</li>
<li>
<p>Implicit resource payload naming
    虽然在增量发现中，我们在DeltaDiscoveryResponse中的“资源”消息中有明确提供的资源名称，但SotW资源有效负载却不是这种情况。这意味着xDS代理，缓存和其他中介必须具有按资源类型的识别和反序列化才能知道正在传递的资源有效负载。我们需要为DiscoveryResponses中的SotW资源命名提供更好的解决方案，可能会弃用现有的重复的Any，并用v3 / v4 xDS中的重复的Resource代替。</p>
</li>
<li>
<p>Aliasing
    VHDS为xDS引入了别名，因为同一个虚拟主机资源可能会被多个名称（例如， routeConfigA / foo.com，routeConfigA / bar.com）使用。此机制尚未在xDS的其他地方广泛使用，因此用更通用的替代它是理想的。一个有吸引力的替代方案（将在下面的联合讨论中用于其他目的）也将对xDS引入重定向功能。当查询routeConfigA / foo.com或routeConfigA / bar.com时，管理服务器可能会发出重定向，导致xDS客户端获取某些CanonicalVirtualHost资源。通过消除概念上的复杂性，这简化了xDS控制平面的要求。</p>
</li>
</ol>
<h2 id="cluster">自定义cluster实现的关键点</h2>
<ol>
<li>如果这个cluster需要依赖其他cluster才能获取到地址信息，那么这个cluster的initializa phase需要设置为Secondary，否则是Primary</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// Upstream::Cluster</span>
  <span class="n">Upstream</span><span class="o">::</span><span class="n">Cluster</span><span class="o">::</span><span class="n">InitializePhase</span> <span class="nf">initializePhase</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Upstream</span><span class="o">::</span><span class="n">Cluster</span><span class="o">::</span><span class="n">InitializePhase</span><span class="o">::</span><span class="n">Primary</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ol>
<li><code>cluster</code>的初始化需要放到<code>startPreInit</code>中，初始化完成后需要调用<code>onPreInitComplete</code>来完成初始化，最好做一个超时控制</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>  <span class="c1">// Upstream::ClusterImplBase</span>
  <span class="kt">void</span> <span class="nf">startPreInit</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>host更新的时候需要按照优先级为纬度来进行更新，并按照优先级纬度统计locality weight map，通过PriorityStateManager来管理</li>
</ol>
<p>PriorityStateManager 在初始化优先级的时候会自动构建好locality weight map</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">PriorityStateManager::initializePriorityFor</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">envoy</span><span class="o">::</span><span class="n">api</span><span class="o">::</span><span class="n">v2</span><span class="o">::</span><span class="n">endpoint</span><span class="o">::</span><span class="n">LocalityLbEndpoints</span><span class="o">&amp;</span> <span class="n">locality_lb_endpoint</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">priority</span> <span class="o">=</span> <span class="n">locality_lb_endpoint</span><span class="p">.</span><span class="n">priority</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">priority_state_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">priority_state_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">priority</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">priority_state_</span><span class="p">[</span><span class="n">priority</span><span class="p">].</span><span class="n">first</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">priority_state_</span><span class="p">[</span><span class="n">priority</span><span class="p">].</span><span class="n">first</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">HostVector</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">locality_lb_endpoint</span><span class="p">.</span><span class="n">has_locality</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">locality_lb_endpoint</span><span class="p">.</span><span class="n">has_load_balancing_weight</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">priority_state_</span><span class="p">[</span><span class="n">priority</span><span class="p">].</span><span class="n">second</span><span class="p">[</span><span class="n">locality_lb_endpoint</span><span class="p">.</span><span class="n">locality</span><span class="p">()]</span> <span class="o">=</span>
        <span class="n">locality_lb_endpoint</span><span class="p">.</span><span class="n">load_balancing_weight</span><span class="p">().</span><span class="n">value</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>计算host变更(增加多少、减少多少，发生变化)，如果没有host变更，但是其他的一些信息发生了变更也需要进行lb重建</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code> <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">host_set</span> <span class="o">=</span> <span class="n">priority_set_</span><span class="p">.</span><span class="n">getOrCreateHostSet</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">overprovisioning_factor</span><span class="p">);</span>
  <span class="n">HostVectorSharedPtr</span> <span class="nf">current_hosts_copy</span><span class="p">(</span><span class="k">new</span> <span class="n">HostVector</span><span class="p">(</span><span class="n">host_set</span><span class="p">.</span><span class="n">hosts</span><span class="p">()));</span>

  <span class="n">HostVector</span> <span class="n">hosts_added</span><span class="p">;</span>
  <span class="n">HostVector</span> <span class="n">hosts_removed</span><span class="p">;</span>
  <span class="c1">// We need to trigger updateHosts with the new host vectors if they have changed. We also do this</span>
  <span class="c1">// when the locality weight map or the overprovisioning factor. Note calling updateDynamicHostList</span>
  <span class="c1">// is responsible for both determining whether there was a change and to perform the actual update</span>
  <span class="c1">// to current_hosts_copy, so it must be called even if we know that we need to update (e.g. if the</span>
  <span class="c1">// overprovisioning factor changes).</span>
  <span class="c1">// TODO(htuch): We eagerly update all the host sets here on weight changes, which isn&#39;t great,</span>
  <span class="c1">// since this has the knock on effect that we rebuild the load balancers and locality scheduler.</span>
  <span class="c1">// We could make this happen lazily, as we do for host-level weight updates, where as things age</span>
  <span class="c1">// out of the locality scheduler, we discover their new weights. We don&#39;t currently have a shared</span>
  <span class="c1">// object for locality weights that we can update here, we should add something like this to</span>
  <span class="c1">// improve performance and scalability of locality weight updates.</span>
  <span class="k">const</span> <span class="kt">bool</span> <span class="n">hosts_updated</span> <span class="o">=</span> <span class="n">updateDynamicHostList</span><span class="p">(</span><span class="n">new_hosts</span><span class="p">,</span> <span class="o">*</span><span class="n">current_hosts_copy</span><span class="p">,</span> <span class="n">hosts_added</span><span class="p">,</span>
                                                   <span class="n">hosts_removed</span><span class="p">,</span> <span class="n">updated_hosts</span><span class="p">,</span> <span class="n">all_hosts_</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">hosts_updated</span> <span class="o">||</span> <span class="n">host_set</span><span class="p">.</span><span class="n">overprovisioningFactor</span><span class="p">()</span> <span class="o">!=</span> <span class="n">overprovisioning_factor</span> <span class="o">||</span>
      <span class="n">locality_weights_map</span> <span class="o">!=</span> <span class="n">new_locality_weights_map</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">all_of</span><span class="p">(</span><span class="n">current_hosts_copy</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">current_hosts_copy</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">(),</span>
                       <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">host</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">()</span> <span class="o">==</span> <span class="n">priority</span><span class="p">;</span> <span class="p">}));</span>
    <span class="n">locality_weights_map</span> <span class="o">=</span> <span class="n">new_locality_weights_map</span><span class="p">;</span>
    <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>
              <span class="s">&quot;EDS hosts or locality weights changed for cluster: {} current hosts {} priority {}&quot;</span><span class="p">,</span>
              <span class="n">info_</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">(),</span> <span class="n">host_set</span><span class="p">.</span><span class="n">hosts</span><span class="p">().</span><span class="n">size</span><span class="p">(),</span> <span class="n">host_set</span><span class="p">.</span><span class="n">priority</span><span class="p">());</span>
    <span class="c1">// lb 重建</span>
    <span class="n">priority_state_manager</span><span class="p">.</span><span class="n">updateClusterPrioritySet</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">current_hosts_copy</span><span class="p">),</span>
                                                    <span class="n">hosts_added</span><span class="p">,</span> <span class="n">hosts_removed</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">nullopt</span><span class="p">,</span>
                                                    <span class="n">overprovisioning_factor</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>locality_weight_map发生变化</li>
<li>overprovisioning_factor发生变化</li>
<li>host发生变更(新增、删除)，host没有变更，但是有一些信息发生了变化)</li>
</ol>
<p>Host信息发生变化</p>
<ol>
<li>host优先级变化</li>
<li>host metadata变化</li>
<li>host配置的健康地址发生了变化</li>
</ol>
<p>这些都会导致lb重建，需要更新priorityset，即使没有任何机器发生变化</p>
<ol>
<li>lb重建和priority set更新</li>
</ol>
<p>通过priority_state_manager的updateClusterPrioritySet方法可以更新priorityset并重建lb</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">priority_state_manager</span><span class="p">.</span><span class="n">updateClusterPrioritySet</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">current_hosts_copy</span><span class="p">),</span>
                                                    <span class="n">hosts_added</span><span class="p">,</span> <span class="n">hosts_removed</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">nullopt</span><span class="p">,</span>
                                                    <span class="n">overprovisioning_factor</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>这个方法主要做了几件事:</p>
<ol>
<li>根据locality weight map还有是否开启zone aware路由来构建LocalityWeights lb</li>
<li>按照locality纬度将机器组织起来，并最终构建HostsPerLocalityImpl</li>
<li>调用priorityset的updateHosts方法更新priority set，并传入计算出来的新增、和删除host用来进行通知</li>
<li>处理健康检查</li>
</ol>
<h2 id="_5">连接池</h2>
<h2 id="filterchain">FilterChain</h2>
<p>FilterChainFactory接口，通过这个接口可以创建Network filter chain、Listener filter chain、Udp listener filter chain</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Creates a chain of network filters for a new connection.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">FilterChainFactory</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">FilterChainFactory</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Called to create the network filter chain.</span>
<span class="cm">   * @param connection supplies the connection to create the chain on.</span>
<span class="cm">   * @param filter_factories supplies a list of filter factories to create the chain from.</span>
<span class="cm">   * @return true if filter chain was created successfully. Otherwise</span>
<span class="cm">   *   false, e.g. filter chain is empty.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">createNetworkFilterChain</span><span class="p">(</span><span class="n">Connection</span><span class="o">&amp;</span> <span class="n">connection</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FilterFactoryCb</span><span class="o">&gt;&amp;</span> <span class="n">filter_factories</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Called to create the listener filter chain.</span>
<span class="cm">   * @param listener supplies the listener to create the chain on.</span>
<span class="cm">   * @return true if filter chain was created successfully. Otherwise false.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">createListenerFilterChain</span><span class="p">(</span><span class="n">ListenerFilterManager</span><span class="o">&amp;</span> <span class="n">listener</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Called to create a Udp Listener Filter Chain object</span>
<span class="cm">   *</span>
<span class="cm">   * @param udp_listener supplies the listener to create the chain on.</span>
<span class="cm">   * @param callbacks supplies the callbacks needed to create a filter.</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">createUdpListenerFilterChain</span><span class="p">(</span><span class="n">UdpListenerFilterManager</span><span class="o">&amp;</span> <span class="n">udp_listener</span><span class="p">,</span>
                                            <span class="n">UdpReadFilterCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks</span><span class="p">)</span> <span class="n">PURE</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
<h2 id="extension-config-discovery-service">Extension Config Discovery Service</h2>
                
              
              
                
<script src="https://utteranc.es/client.js"
        repo="zyfjeff/zyfjeff.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../overload_manager/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Overload manager分析" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Overload manager分析
            </div>
          </div>
        </a>
      
      
        
        <a href="../stats_symbol/" class="md-footer__link md-footer__link--next" aria-label="下一页: Stats Symbol分析" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Stats Symbol分析
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 - 2021 程序员的Cookbook
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/zyfjeff" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "toc.integrate"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
    
  </body>
</html>