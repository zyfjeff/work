
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://zyfjeff.github.io/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/book/KubernetesPrograming/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>Programming Kubernetes - 程序员的Cookbook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#programming-kubernetes" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="程序员的Cookbook" class="md-header__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            程序员的Cookbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Programming Kubernetes
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      About
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-tabs__link">
        博客
      </a>
    </li>
  

  

  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../blog/" class="md-tabs__link md-tabs__link--active">
        学习笔记
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/bootstrap/" class="md-tabs__link">
        开源项目
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-tabs__link">
        编程语言
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-tabs__link">
        计算机基础
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="程序员的Cookbook" class="md-nav__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    程序员的Cookbook
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        博客
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="博客" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          博客
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Doc
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Doc" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Doc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_1" type="checkbox" id="__nav_2_1_1" >
      
      <label class="md-nav__link" for="__nav_2_1_1">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_1">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-nav__link">
        如何在Linux环境下实现一个调试器
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2" type="checkbox" id="__nav_2_1_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_2">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/%E5%A6%82%E4%BD%95mock%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" class="md-nav__link">
        如何mock系统调用
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2_2" type="checkbox" id="__nav_2_1_2_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2_2">
        Effective Model Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Effective Model Cpp" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_1_2_2">
          <span class="md-nav__icon md-icon"></span>
          Effective Model Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item1/" class="md-nav__link">
        Item1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item38/" class="md-nav__link">
        Item38 Be aware of varying thread handle destructor behavior
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item39/" class="md-nav__link">
        Item39 Consider void futures for one-shot event communication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item40/" class="md-nav__link">
        Item40 Use std::atomic for concurrency, volatile for specific memory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item41/" class="md-nav__link">
        Item41 Consider pass by value for copyable parameters that are cheap to move and always copied.
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item42/" class="md-nav__link">
        Item42 Consider emplacement instead of insertion
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_3" type="checkbox" id="__nav_2_1_3" >
      
      <label class="md-nav__link" for="__nav_2_1_3">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_3">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/dispatcher/" class="md-nav__link">
        Envoy源码分析之Dispatcher
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/thread_local/" class="md-nav__link">
        Envoy源码分析之ThreadLocal
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_4" type="checkbox" id="__nav_2_1_4" >
      
      <label class="md-nav__link" for="__nav_2_1_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%B8%AD%E7%9A%84%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E6%9C%89%E4%BB%80%E4%B9%88%3F/" class="md-nav__link">
        Linux中的可执行程序有什么?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%BF%A1%E5%8F%B7%E4%B8%93%E9%A2%98FAQ/" class="md-nav__link">
        Linux 信号FAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/%E5%85%B3%E4%BA%8E%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E8%AE%A8%E8%AE%BA/" class="md-nav__link">
        关于文件写入的原子性讨论
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_5" type="checkbox" id="__nav_2_1_5" >
      
      <label class="md-nav__link" for="__nav_2_1_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/lifetime-error-cases/" class="md-nav__link">
        常见的生命周期错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/macros/" class="md-nav__link">
        Macros
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/match-pattern/" class="md-nav__link">
        Match pattern
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-error-handle/" class="md-nav__link">
        Rust错误处理指南
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-match/" class="md-nav__link">
        Rust match
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-misconceptions/" class="md-nav__link">
        常见的生命周期概念错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-module/" class="md-nav__link">
        Rust module
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-variance/" class="md-nav__link">
        Rust variance
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        学习笔记
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="学习笔记" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          学习笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Blog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Blog" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        Can Reordering of Release/Acquire Operations Introduce Deadlock?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/readling_list/" class="md-nav__link">
        待阅读列表
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" checked>
      
      <label class="md-nav__link" for="__nav_3_2">
        Book
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Book" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Book
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%20PracticalSystemProgrammingForRust/" class="md-nav__link">
        Practical System Programing For Rust
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ConcurrencyModernCpp/" class="md-nav__link">
        Concurrency Modern C++
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CppTemplate/" class="md-nav__link">
        C++ Templates
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Programming Kubernetes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Programming Kubernetes
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter1-introduction" class="md-nav__link">
    Chapter1. Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chapter2-kubernetes-api-basics" class="md-nav__link">
    Chapter2. Kubernetes API Basics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chapter3-basics-of-client-go" class="md-nav__link">
    Chapter3. Basics of client-go
  </a>
  
    <nav class="md-nav" aria-label="Chapter3. Basics of client-go">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-goapiapimachinery" class="md-nav__link">
    client-go、api、apimachinery三个重要的仓库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-and-using-a-client" class="md-nav__link">
    Creating and Using a Client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versioningcompatibillity" class="md-nav__link">
    Versioning和Compatibillity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-objects-in-go" class="md-nav__link">
    Kubernetes Objects in Go
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-sets" class="md-nav__link">
    Client Sets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#informers-and-caching" class="md-nav__link">
    Informers and Caching
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-owner" class="md-nav__link">
    Object Owner
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-machinery-in-depth" class="md-nav__link">
    API Machinery in Depth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheme" class="md-nav__link">
    Scheme
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chapter4-using-custom-resources" class="md-nav__link">
    Chapter4. Using Custom Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subresources" class="md-nav__link">
    Subresources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customresourcedefinition" class="md-nav__link">
    CustomResourceDefinition
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automating-code-generation" class="md-nav__link">
    Automating Code Generation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solutions-for-writing-operators" class="md-nav__link">
    Solutions for Writing OPerators
  </a>
  
    <nav class="md-nav" aria-label="Solutions for Writing OPerators">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#controller" class="md-nav__link">
    Controller编程基础
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubebuilder" class="md-nav__link">
    Kubebuilder
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operator-sdk" class="md-nav__link">
    Operator-SDK
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shipping-controller-and-operator" class="md-nav__link">
    Shipping Controller and Operator
  </a>
  
    <nav class="md-nav" aria-label="Shipping Controller and Operator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#packageing" class="md-nav__link">
    Packageing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-api-server" class="md-nav__link">
    Custom API Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-custom-resources" class="md-nav__link">
    Advanced Custom Resources
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../LuaPrograming/" class="md-nav__link">
        Lua Programing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../MathematicsForComputerScience/" class="md-nav__link">
        Mathematics For Computer Science
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../MuduoCpp/" class="md-nav__link">
        Linux C++ 服务端编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../OS/" class="md-nav__link">
        操作系统导论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ebpf/" class="md-nav__link">
        ebpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3">
        Course
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Course" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Course
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1" type="checkbox" id="__nav_3_3_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1">
        6.824
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="6.824" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_1">
          <span class="md-nav__icon md-icon"></span>
          6.824
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1_1" type="checkbox" id="__nav_3_3_1_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1_1">
        Lecture1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lecture1" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_3_1_1">
          <span class="md-nav__icon md-icon"></span>
          Lecture1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../course/6.824/lecture1/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../course/6.824/lecture1/paper-note/" class="md-nav__link">
        Paper note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_2" type="checkbox" id="__nav_3_3_2" >
      
      <label class="md-nav__link" for="__nav_3_3_2">
        Ultimate Go Programing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ultimate Go Programing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_2">
          <span class="md-nav__icon md-icon"></span>
          Ultimate Go Programing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../course/Ultimate_Go_Programing/" class="md-nav__link">
        Ultimate Go Programing
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_3" type="checkbox" id="__nav_3_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3_3">
        信息论
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="信息论" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_3">
          <span class="md-nav__icon md-icon"></span>
          信息论
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../course/%E4%BF%A1%E6%81%AF%E8%AE%BA/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      <label class="md-nav__link" for="__nav_3_4">
        English
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="English" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          English
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_1" type="checkbox" id="__nav_3_4_1" >
      
      <label class="md-nav__link" for="__nav_3_4_1">
        Class1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class1" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_1">
          <span class="md-nav__icon md-icon"></span>
          Class1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class1/READMEN/" class="md-nav__link">
        READMEN
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class1/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class1/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_2" type="checkbox" id="__nav_3_4_2" >
      
      <label class="md-nav__link" for="__nav_3_4_2">
        Class2
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class2" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_2">
          <span class="md-nav__icon md-icon"></span>
          Class2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class2/kk/" class="md-nav__link">
        Kk
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class2/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class2/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_3" type="checkbox" id="__nav_3_4_3" >
      
      <label class="md-nav__link" for="__nav_3_4_3">
        Hearing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Hearing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_3">
          <span class="md-nav__icon md-icon"></span>
          Hearing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/hearing/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_4" type="checkbox" id="__nav_3_4_4" >
      
      <label class="md-nav__link" for="__nav_3_4_4">
        Open lan
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Open lan" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_4">
          <span class="md-nav__icon md-icon"></span>
          Open lan
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/open-lan/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_5" type="checkbox" id="__nav_3_4_5" >
      
      <label class="md-nav__link" for="__nav_3_4_5">
        Syntax
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Syntax" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_5">
          <span class="md-nav__icon md-icon"></span>
          Syntax
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/syntax/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_6" type="checkbox" id="__nav_3_4_6" >
      
      <label class="md-nav__link" for="__nav_3_4_6">
        Walk for us
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Walk for us" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_6">
          <span class="md-nav__icon md-icon"></span>
          Walk for us
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/walk_for_us/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_7" type="checkbox" id="__nav_3_4_7" >
      
      <label class="md-nav__link" for="__nav_3_4_7">
        Word list
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Word list" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_7">
          <span class="md-nav__icon md-icon"></span>
          Word list
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/word_list/word/" class="md-nav__link">
        Word
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" type="checkbox" id="__nav_3_5" >
      
      <label class="md-nav__link" for="__nav_3_5">
        Paper
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Paper" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Paper
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/bitcask/" class="md-nav__link">
        Bitcask
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        开源项目
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="开源项目" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          开源项目
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      <label class="md-nav__link" for="__nav_4_1">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/bootstrap/" class="md-nav__link">
        Bootstrap启动过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/cluster/" class="md-nav__link">
        Cluster分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/cluster_manager/" class="md-nav__link">
        Cluster Manager初始化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/dpdk/" class="md-nav__link">
        DPDK
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/drain_manager/" class="md-nav__link">
        Drain manager分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/eds/" class="md-nav__link">
        EDS更新过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/load_balancer/" class="md-nav__link">
        Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/lua/" class="md-nav__link">
        Lua filter实现分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/overload_manager/" class="md-nav__link">
        Overload manager分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/proxy/" class="md-nav__link">
        Envoy源码分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/stats_symbol/" class="md-nav__link">
        Stats Symbol分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/subset_lb/" class="md-nav__link">
        Subset Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/wasm/" class="md-nav__link">
        Envoy Proxy Wasm分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89Cluster/" class="md-nav__link">
        如何实现自定义Cluster
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/kubernetes/" class="md-nav__link">
        Helm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/kubernetes/basic/" class="md-nav__link">
        Basic
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/kubernetes/tips/" class="md-nav__link">
        Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      <label class="md-nav__link" for="__nav_4_3">
        Leveldb
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Leveldb" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Leveldb
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/leveldb/leveldb/" class="md-nav__link">
        Leveldb源码分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      <label class="md-nav__link" for="__nav_4_4">
        Pilot
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Pilot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Pilot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/" class="md-nav__link">
        WIP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/ConfigUpdate/" class="md-nav__link">
        配置更新分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/EnvoyFilter/" class="md-nav__link">
        EnvoyFilter分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/PushContext/" class="md-nav__link">
        PushContext分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/concept/" class="md-nav__link">
        基本概念和接口
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/xds-process/" class="md-nav__link">
        XDS处理流程分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        编程语言
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="编程语言" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          编程语言
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      <label class="md-nav__link" for="__nav_5_1">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-nav__link">
        C++基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp17/" class="md-nav__link">
        C++17 In Details
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp20/" class="md-nav__link">
        C++20
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/design/" class="md-nav__link">
        Design
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/guidelines/" class="md-nav__link">
        Guidelines
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/libevent/" class="md-nav__link">
        Libevent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/memory_order/" class="md-nav__link">
        C++ Memory Order
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_8" type="checkbox" id="__nav_5_1_8" >
      
      <label class="md-nav__link" for="__nav_5_1_8">
        Tips
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tips" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_8">
          <span class="md-nav__icon md-icon"></span>
          Tips
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-1/" class="md-nav__link">
        Tip of the Week #1: string_view
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-10/" class="md-nav__link">
        Tip of the Week #10: Splitting Strings, not Hairs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-101/" class="md-nav__link">
        Tip of the Week #101: Return Values, References, and Lifetimes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-103/" class="md-nav__link">
        Tip of the Week #103: Flags Are Globals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-107/" class="md-nav__link">
        Tip of the Week #107: Reference Lifetime Extension
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-108/" class="md-nav__link">
        Tip of the Week #108: Avoid std::bind
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-109/" class="md-nav__link">
        Tip of the Week #109: Meaningful `const` in Function Declarations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-11/" class="md-nav__link">
        Tip of the Week #11: Return Policy
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-112/" class="md-nav__link">
        Tip of the Week #112: emplace vs. push_back
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-117/" class="md-nav__link">
        Tip of the Week #117: Copy Elision and Pass-by-value
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-119/" class="md-nav__link">
        Tip of the Week #119: Using-declarations and namespace aliases
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-120/" class="md-nav__link">
        Tip of the Week #120: Return Values are Untouchable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-122/" class="md-nav__link">
        Tip of the Week #122: Test Fixtures, Clarity, and Dataflow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-123/" class="md-nav__link">
        Tip of the Week #123: absl::optional and std::unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-126/" class="md-nav__link">
        Tip of the Week #126: `make_unique` is the new `new`
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-24/" class="md-nav__link">
        Tip of the Week #24: Copies, Abbrv
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-3/" class="md-nav__link">
        Tip of the Week #3: String Concatenation and operator+ vs. StrCat()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-36/" class="md-nav__link">
        Tip of the Week #36: New Join API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-42/" class="md-nav__link">
        Tip of the Week #42: Prefer Factory Functions to Initializer Methods
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-45/" class="md-nav__link">
        Tip of the Week #45: Avoid Flags, Especially in Library Code
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-49/" class="md-nav__link">
        Tip of the Week #49: Argument-Dependent Lookup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-55/" class="md-nav__link">
        Tip of the Week #55: Name Counting and unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-59/" class="md-nav__link">
        Tip of the Week #59: Joining Tuples
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-61/" class="md-nav__link">
        Tip of the Week #61: Default Member Initializers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-64/" class="md-nav__link">
        Tip of the Week #64: Raw String Literals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-65/" class="md-nav__link">
        Tip of the Week #65: Putting Things in their Place
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-74/" class="md-nav__link">
        Tip of the Week #74: Delegating and Inheriting Constructors
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-77/" class="md-nav__link">
        Tip of the Week #77: Temporaries, Moves, and Copies
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-86/" class="md-nav__link">
        Tip of the Week #86: Enumerating with Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-88/" class="md-nav__link">
        Tip of the Week #88: Initialization: =, (), and {}
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-90/" class="md-nav__link">
        Tip of the Week #90: Retired Flags
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-93/" class="md-nav__link">
        Tip of the Week #93: using absl::Span
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-94/" class="md-nav__link">
        Tip of the Week #94: Callsite Readability and bool Parameters
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-99/" class="md-nav__link">
        Tip of the Week #99: Nonmember Interface Etiquette
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      <label class="md-nav__link" for="__nav_5_2">
        Golang
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Golang" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Golang
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/note/" class="md-nav__link">
        Go Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      <label class="md-nav__link" for="__nav_5_3">
        Lua
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lua" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Lua
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/lua/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" >
      
      <label class="md-nav__link" for="__nav_5_4">
        Python
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/python/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" >
      
      <label class="md-nav__link" for="__nav_5_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/Note/" class="md-nav__link">
        Rust学习笔记
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5_3" type="checkbox" id="__nav_5_5_3" >
      
      <label class="md-nav__link" for="__nav_5_5_3">
        Library
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Library" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_5_3">
          <span class="md-nav__icon md-icon"></span>
          Library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/library/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        计算机基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="计算机基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          计算机基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      <label class="md-nav__link" for="__nav_6_1">
        Algorithm
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Algorithm" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          Algorithm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-nav__link">
        负载均衡算法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/skiplist/" class="md-nav__link">
        跳表分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      <label class="md-nav__link" for="__nav_6_2">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/" class="md-nav__link">
        OS基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/Reverse/" class="md-nav__link">
        Reverse
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/compiler/" class="md-nav__link">
        编译器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/concurrency/" class="md-nav__link">
        并发编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/gdb/" class="md-nav__link">
        GDB Tips
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/review/" class="md-nav__link">
        面试题
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/tls/" class="md-nav__link">
        SSL
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_8" type="checkbox" id="__nav_6_2_8" >
      
      <label class="md-nav__link" for="__nav_6_2_8">
        Bazel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bazel" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_8">
          <span class="md-nav__icon md-icon"></span>
          Bazel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/bazel/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      <label class="md-nav__link" for="__nav_6_3">
        Design
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Design" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Design
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/design/" class="md-nav__link">
        设计模式
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      <label class="md-nav__link" for="__nav_6_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/asm_syscall/" class="md-nav__link">
        Linux: x86-64 syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_socket_balancing/" class="md-nav__link">
        三种常见的socket balancing模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_syscall/" class="md-nav__link">
        Linux syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/shell/" class="md-nav__link">
        Shell
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_6" type="checkbox" id="__nav_6_4_6" >
      
      <label class="md-nav__link" for="__nav_6_4_6">
        Bpf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bpf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_6">
          <span class="md-nav__icon md-icon"></span>
          Bpf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/READMME/" class="md-nav__link">
        READMME
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/seccomp-bpf/" class="md-nav__link">
        Seccomp bpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_7" type="checkbox" id="__nav_6_4_7" >
      
      <label class="md-nav__link" for="__nav_6_4_7">
        Ftrace
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ftrace" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_7">
          <span class="md-nav__icon md-icon"></span>
          Ftrace
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/ftrace/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_8" type="checkbox" id="__nav_6_4_8" >
      
      <label class="md-nav__link" for="__nav_6_4_8">
        Fuse
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Fuse" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_8">
          <span class="md-nav__icon md-icon"></span>
          Fuse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/fuse/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_9" type="checkbox" id="__nav_6_4_9" >
      
      <label class="md-nav__link" for="__nav_6_4_9">
        Io
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Io" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_9">
          <span class="md-nav__icon md-icon"></span>
          Io
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/io/io_uring/" class="md-nav__link">
        Io uring
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_10" type="checkbox" id="__nav_6_4_10" >
      
      <label class="md-nav__link" for="__nav_6_4_10">
        Network
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Network" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_10">
          <span class="md-nav__icon md-icon"></span>
          Network
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/epoll/" class="md-nav__link">
        Epoll
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/ip_transparent/" class="md-nav__link">
        Ip transparent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp-ip-program/" class="md-nav__link">
        Tcp ip program
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_back_log/" class="md-nav__link">
        Tcp back log
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_fast_open/" class="md-nav__link">
        Tcp fast open
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_splicing/" class="md-nav__link">
        SOCKMAP - TCP splicing of the future
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/time_wait/" class="md-nav__link">
        Time wait
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/virtual-network/" class="md-nav__link">
        Virtual network
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_11" type="checkbox" id="__nav_6_4_11" >
      
      <label class="md-nav__link" for="__nav_6_4_11">
        Perf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Perf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_11">
          <span class="md-nav__icon md-icon"></span>
          Perf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/perf/" class="md-nav__link">
        性能优化基础
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_12" type="checkbox" id="__nav_6_4_12" >
      
      <label class="md-nav__link" for="__nav_6_4_12">
        Synchronization
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Synchronization" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_12">
          <span class="md-nav__icon md-icon"></span>
          Synchronization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/memory_order/" class="md-nav__link">
        Memory order
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_13" type="checkbox" id="__nav_6_4_13" >
      
      <label class="md-nav__link" for="__nav_6_4_13">
        System interface
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="System interface" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_13">
          <span class="md-nav__icon md-icon"></span>
          System interface
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/system_interface/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      <label class="md-nav__link" for="__nav_6_5">
        Why
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Why" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          Why
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/why/" class="md-nav__link">
        计算机基础百科
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zyfjeff/zyfjeff.github.io/edit/master/docs/学习笔记/book/KubernetesPrograming.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="programming-kubernetes">Programming Kubernetes</h1>
<h2 id="chapter1-introduction">Chapter1. Introduction</h2>
<ul>
<li>Kubernetes Native Application</li>
</ul>
<p>何为Kubernetes-native的Application，感知是跑在Kubernetes上，并依靠Kubernetes提供的API(指的是与API Server直接交互来查询资源的状态或者更新这些资源的状态)来进行编程的Application，被称之为Kubernetes Native Application。</p>
<ul>
<li>
<p>Kubernetest 扩展系统
kubernetest提供了很强大的扩展系统，通常来说有多种方式来实现扩展，下面是一些常见的Kubernetes的扩展点，更多细节可以看<a href="https://speakerdeck.com/mhausenblas/extending-kubernetes-101">extending-kubernetes-101</a>:</p>
<ul>
<li><code>cloud-controller-manager</code> 对接各个云厂商提供的能力，比如Load Balancer、VM等</li>
<li><code>Binary kubectl plug-ins</code> 通过二进制扩展kubelet子命令</li>
<li><code>Binary kubelet plug-ins</code> 通过二进制扩展网络、存储、容器运行时等</li>
<li><code>Access extensions in the API server</code> 比如dynamic admission control with webhooks</li>
<li><code>Custom resources</code> 和 <code>custom controllers</code></li>
<li><code>Custom API servers</code></li>
<li>Scheduler externsions，通过webhook来实现自己的调度器</li>
<li>Authentication with webhooks</li>
</ul>
</li>
<li>
<p>Controll Loop
Kubernetest的controller的实现本质上是一个control loop，通过API server来watch某种资源的状态，然后根据当前状态向着终态走。</p>
</li>
</ul>
<blockquote>
<p>a controller implements a control loop, watching the shared state of the cluster through the API server and making changes in an attempt to move the current state toward the desired state
Kubernetes并不会根据当前的状态和预期的状态来计算达到预期状态所需要的命令序列，从而来实现所谓的声明式系统，相反Kubernetes仅仅会根据当前的状态计算出下一个命令，如果没有可用的命令，则Kubernetes就达到稳态了</p>
</blockquote>
<p>典型的Control loop的流程如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>1. 读取资源的状态(更可取的方式是通过事件驱动的方式来读取)
2. 改变集群中对象的状态，比如启动一个POD、创建一个网络端点、查询一个cloud API等
3. 通过API server来更新Setp1中的资源状态(Optimistic Concurrency)mak
4. 循环重复，返回到Setp1
</code></pre></div>
</td></tr></table>
<p><img alt="controll-loop" src="../images/controll-loop.jpg" /></p>
<p>Controller 核心数据结构:
    1. informers 提供一种扩展、可持续的方式来查看资源的状态，并实现了resync机制(强制执行定期对帐，通常用于确保群集状态和缓存在内存中的假定状态不会漂移)
    2. Work queues 用于将状态变化的事件进行排队处理，便于去实现重试(发生错误的时候，重新投入到队列中)</p>
<ul>
<li>Events</li>
</ul>
<p>Kubernetes中大量使用事件和一些松耦合的组件。其他的一些分布式系统主要是RPC来触发行为，但是Kubernetes没有这么做。
Kubernetes控制器通过监控Kubernetes对象在API server中的改变(添加、删除、更新)等。当这些事件发生，Kubernetes控制器执行对应的业务逻辑。</p>
<p>下面是一个POD创建的过程:</p>
<ol>
<li>deployment控制器(属于controller-manager组件)通过deployment informer发现了一个deployment创建的事件，于是开始创建一个replica set</li>
<li>replica set控制器(属于controller-manager组件)通过replica set informer发现一个新的replica set创建，于是开始创建一个POD对象</li>
<li>scheduler(属于kube-scheduler组件)，他也是一个控制器，通过pod informer发现了一个POD对象的创建，并且spec.nodeName是空，于是就将其放到了scheduling的队列中</li>
<li>kubelet(也是一个控制器)同样也发现了一个新的POD对象的创建，但是spec.nodeName是空，和自己的node name并不一致，因此就忽略了这个事件，继续sleep</li>
<li>scheduler从队列中获取一个POD，并更新spec.nodeName字段，填入要调度到的nodeName，写入到API server</li>
<li>kubelect组件因为POD状态发生了改变被唤醒，通过比较spec.nodeName和自己的nodeName，如果匹配到了，就根据POD对象创建对应的容器。并根据容器引擎的执行情况来更新POD状态</li>
<li>replica set控制器发现POD变化了额，但是什么也没做</li>
<li>最终POD terminates，kubelet会收到通知，并获取POD对象，更新其状态为terminated。</li>
<li>replica set控制器发现POD的状态为terminated，于是删除POD对象，重新创建一个新的</li>
<li>到此结束</li>
</ol>
<p>通过上面POD创建的过程可以看出，整个过程中有很多独立的Controller，每一个Controller就是一个control loop。
他们之间通过informer接收到事件来触发对应的逻辑。这些事件是API Server发送给informer的。informer内部通过watche的方式得到通知。</p>
<blockquote>
<p>这里说的Event事件和Kubernetes中的Event对象是两回事，Event对象主要是给用户提供一种logging机制，用户编写的Controller可以创建Event对象来记录一些内部事件
比如kubelet会通过Event对象暴露内部的生命周期事件。这些Event对象可以像其他的kubernetes对象(Pod、Deployment等)一样进行查询。这些事件对象默认只存放
1个小时。1个小时候后便会从etcd中删除。</p>
</blockquote>
<ul>
<li>Level triger vs Edge triger</li>
</ul>
<p>Kubernetes中大量依赖事件来解耦各个组件，事件的高效通知对于Kubernetes来说至关重要，典型的二种实现事件通知的机制如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Edge-driven triggers
At the point in time the state change occurs, a handler is triggered—for example, from no pod to pod running.

* Level-driven triggers
The state is checked at regular intervals and if certain conditions are met (for example, pod running), then a handler is triggered.
</code></pre></div>
</td></tr></table>
<p>水平触发不具备可扩展性，本质上是polling、polling的间隔会影响controller的实时性，边缘触发更加高效，但是如果某个Controller存在bug就会导致事件丢失，这对于
边缘触发来说是无法接受的，而水平触发却不会存在这个问题，因为总是能够通过polling的方式获取到最终的状态。两者结合一下，事件通过边缘触发来通知，每次收到事件后通过pooling的方式
获取到资源的最终状态，那么即使中间丢失了一个事件也无所谓，比如replica set控制器中，预期要创建3个POD，因此每次POD创建都会产生一个事件，replica set通过事件就可以知道当前状态
和预期的状态还差多少，然后继续创建POD，如果因为网络问题导致中间丢失了一个事件，那么这就会导致创建的POD和预期的不符，这个时候如果结合水平触发，在下一次事件到来的时候主动查一下
当前的状态，这样就可以避免了中间事件丢失导致状态不对的问题，同时也借助了边缘触发达到了高效的事件通知。但是这样仍然存在问题。如果正好是最后一个事件丢失了呢? 这样就没有机会去查询当前
状态了。如果能够再结合定时查询就可以解决这个问题了，这个定时查询在Kubernetes中称之为resync。总结下，有三种事件通知策略：</p>
<ol>
<li>Edge driven trigger 没有处理事件丢失的问题</li>
<li>Edge driven trigger + Level-driven triggers，总是去获取最新的状态(当有事件来的时候)，因此即使丢失一个事件，仍然可以通过获取最新的状态来进行业务逻辑</li>
<li>Edge driven trigger + Level-driven triggers + resync 如果最后一个事件丢失了，后面没有事件来了，所以也不会去触发(Level-driven triggers)，这个时候需要借助resync来得到最新的状态。</li>
</ol>
<p>上面的这三种策略对应如下图:</p>
<p><img alt="event driven trigger" src="../images/event-trigger.png" /></p>
<p>kubernetes实现了上面的第三种策略，通过这种方式来实现高效的事件通知，如果你想知道更多关于水平触发以及reconcile请参考<a href="https://hackernoon.com/level-triggering-and-reconciliation-in-kubernetes-1f17fe30333d">level-triggering-and-reconciliation-in-kubernetes</a></p>
<ul>
<li>Optimistic Concurrency</li>
</ul>
<p>在Controller的Control loop中会改变集群中对象的状态(比如创建一个POD)，然后将结果写到资源中的status中。实际中Controller通常会部署多个，因此这里更新资源的status字段是会存在并发写的。 </p>
<p>下图中描述了一种解决方案：</p>
<p><img alt="optimistic-concurrent" src="../images/optimistic_concurrent.jpg" /></p>
<p>这个解决方案是基于共享状态构建的新的并行调度器体系结构，使用无锁乐观并发控制，以实现可扩展性和性能可伸缩性。这种架构正在谷歌的下一代集群管理系统Omega中使用
Kubernetes大量参考了Omega。为了做了无锁并发写，Kubernetes也采用了乐观并发。这意味着当API Server探测到并发写(通过resource version来判断)，
它会拒绝掉后续的写操作。然后交由Controller自己来处理写入冲突的问题。可以简单的用下面的代码来表示这个过程。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
<span class="k">for</span> <span class="nx">retries</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">retries</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">retries</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">foo</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">break</span>
    <span class="p">}</span>

    <span class="p">&lt;</span><span class="nx">update</span><span class="o">-</span><span class="nx">the</span><span class="o">-</span><span class="nx">world</span><span class="o">-</span><span class="nx">and</span><span class="o">-</span><span class="nx">foo</span><span class="p">&gt;</span>

    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Update</span><span class="p">(</span><span class="nx">foo</span><span class="p">)</span>
    <span class="c1">// 通过资源版本(ObjectMeta字段中的resource version)来判断当前是否有人在写入，是否会产生并发写的冲突</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">IsConflict</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">break</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>乐观并发很适合Kubernetest中Controller的Controll Loop，Controll Loop中的水平触发总是获取到最新的状态，这个和乐观并发在失败后总是基于最新状态
再次发生写入的思想不谋而合。</p>
<blockquote>
<p>写冲突错误在Controller中是完全正常的。我们应该总是预期它们会出现，并优雅地处理它们。
client.Get返回的对象foo，包含了ObjectMeta字段，这个字段中包含了resource version，API Server借助这个字段来探测并发写。
边缘触发 + 水平触发 + resync + optimistic concurrency 是Kubernetes 事件驱动架构的核心</p>
</blockquote>
<ul>
<li>Operators</li>
</ul>
<p>一个SRE是一人，他来操作其他开发工程师写的软件，这个软件是具有领域知识的，因此要运维需要掌握这个软件的领域知识才能运维好。而这些运维所需要的领域知识称之为Operator。
一个Operator就是一个具有领域知识的用于运维的controller，借助了Kubernetes API进行扩展的Controller，借助这个Controller就可以实现简单的配置就达到运维复杂的带有状态的应用程序的效果。
一般来说，这个Controller通过一组具有领域知识的schema组成的crd来实现自动化运维。</p>
<p><strong>*Reference</strong></p>
<ul>
<li><a href="https://speakerdeck.com/mhausenblas/extending-kubernetes-101">extending-kubernetes-101</a></li>
<li><a href="https://medium.com/@dominik.tornow/the-mechanics-of-kubernetes-ac8112eaa302">The Mechanics of Kubernetes</a></li>
<li><a href="https://engineering.bitnami.com/articles/a-deep-dive-into-kubernetes-controllers.html">A deep dive into Kubernetes controllers</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/38968012">深入浅出Event Sourcing和CQRS</a></li>
<li><a href="https://www.mgasch.com/post/k8sevents/">Events, the DNA of Kubernetes</a></li>
<li><a href="https://www.mgasch.com/post/sched-reconcile/">QoS, "Node allocatable" and the Kubernetes Scheduler</a></li>
<li><a href="https://hackernoon.com/level-triggering-and-reconciliation-in-kubernetes-1f17fe30333d">level-triggering-and-reconciliation-in-kubernetes</a></li>
<li><a href="https://coreos.com/blog/introducing-operators.html">introducing-operators</a></li>
</ul>
<h2 id="chapter2-kubernetes-api-basics">Chapter2. Kubernetes API Basics</h2>
<ul>
<li>API Server</li>
</ul>
<p>API Server在Kubernetes中是一个核心组件，集群中所有的组件都是通过API Server来和底层的分布式存储etcd进行交互的。API Server的主要指责有几下几点:</p>
<ol>
<li>所有的组件通过API Server来解耦，通过API Server来产生事件和消费事件。</li>
<li>负责对象的存储和读取，API Server最终还会和底层的etcd交互，将Kubernetes中的对象存储在etcd中。</li>
<li>API Server负责给集群内部的组件做代理，例如对Kubernetes dashboard、strea logs、service ports、以及kubectl exec等</li>
</ol>
<p>API Server提供了符合RESTful类型的接口，主要是用于处理HTTP请求去查询和操作Kubernetes的资源，不同的HTTP method所代表的语义不同:</p>
<ol>
<li><code>Get</code> 获取到指定类型的资源，比如POD、或者是获取一个资源list，例如一个namespace下的所有POD</li>
<li><code>POST</code> 创建一个资源，比如service、deployment等</li>
<li><code>PUT</code> 更新一个已经存在的资源，比如改变一个POD中的容器镜像</li>
<li><code>PATCH</code> 部分更新存在的资源，更多细节见: <a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-a-json-merge-patch-to-update-a-deployment">Use a JSON merge patch to update a Deployment</a></li>
<li><code>DELETE</code> 销毁一个资源</li>
</ol>
<blockquote>
<p>kubectl -n THENAMESPACE get pods 等同于 HTTP GET /api/v1/namespaces/THENAMESPACE/pods的结果。</p>
</blockquote>
<ul>
<li>
<p>API Terminology</p>
</li>
<li>
<p><strong>Kind</strong>: </p>
</li>
</ul>
<p>表示实体的类型，每一个对象都有一个Kind字段，kind主要有三类。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>1. 表示一个持久化的实体对象，比如Pod、Endpoints等
2. 一个或多个kind实体，比如PodList、NodeLists等
3. 特殊目的，比如binding、scale
</code></pre></div>
</td></tr></table>
<ol>
<li><strong>API Group</strong>: 一堆Kind的逻辑上所属集合</li>
<li><strong>Version</strong>: API group或者是对象的版本，一个group或对象可以存在多个版本。</li>
<li><strong>Resource</strong>: 通常小写、复数形式(pods) 用来识别一系列的HTTP endpoints路径，用来暴露对象的CRUD语义，例如: <code>.../pods/nginx</code> 查看名为nginx的pod</li>
</ol>
<blockquote>
<p>所有的Resource都是具有CRUD语义的，但是也存在一些Resource可以支持更多的action，比如<code>.../pod/nginx/port-forward</code>，这个时候我们称之为<code>Subresources</code>。这需要通过自定义协议来替代RESET。例如exec是通过<code>WebSockets</code>来实现的。</p>
</blockquote>
<p>在Kubernetes中，每一个Kind是直接映射到一个Golang类型的。</p>
<blockquote>
<p>Resources和Kind是相互的，Resources指定HTTP endpoints，而Kind是这个endpoints返回对象的类型，也是etcd中持久化的对象。
每一个对象都可以按照version v1来表示，也可以按照v1beta1来表示，可以返回不同的版本</p>
</blockquote>
<p><code>Resources</code>是API group和version的一部分，三者被称之为GVR(GroupVersionResource)，一个<code>GVR</code>唯一标示一个HTTP path。例如: <code>/apis/batch/v1/namespaces/default/jobs</code>
通过<code>GVR</code>可以获取到类型为kind的对象，同理这个对象也是属于这个version和Group的。因此称之为<code>GVK</code>(GroupVersionKind)</p>
<blockquote>
<p>核心组zai /api/v1，命名组zai /apis/$name/$version，，为什么核心组不是/apis/core/v1呢? 这是因为历史原因导致的，API Group是核心组之后引入的。</p>
</blockquote>
<p>例如下面这个http paths，就可以映射到一个<code>GVR</code>，通过<code>GVR</code>可以获取到类型为Kind的对象，也就间接的映射到了一个<code>GVK</code>。</p>
<p><img alt="gvr" src="../images/gvr.jpg" /></p>
<blockquote>
<p>GVK到GVR的映射在Kubernetes中被称之为<code>REST Mapping</code>。
除了GVR描述的HTTP path外，还存在另外一种类型的HTTP path，比如<code>/metrics</code>、<code>logs</code>、<code>healthz</code>等
通过在HTTP path后面添加<code>?watch=true</code>就可以watch到请求的资源，具体细节见: <a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes">watch modus</a></p>
</blockquote>
<p>知道了HTTP path就可以通过curl访问API Server获取到资源，平时我们通过kubectl命令获取资源的方式内部其实也是通过访问HTTP path的方式来获取的，下面列举了两种通过HTTP path获取资源的方式。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>kubectl proxy --port<span class="o">=</span><span class="m">8080</span>
curl http://127.0.0.1:8080/apis/batch/v1

或

kubectl get --raw /apis/batch/v1
</code></pre></div>
</td></tr></table>
<ul>
<li>
<p>API Server如何处理请求</p>
</li>
<li>
<p>首先HTTP request会被<code>DefaultBuildHandlerChain</code>注册的filters chain来处理(鉴权、admission、validation等)</p>
</li>
<li>接着根据HTTP path走到分发器，通过分发器来路由到最终的handler</li>
<li>每一个gvr都会注册一个handler</li>
</ul>
<p><img alt="apiserver process" src="../images/apiserver-process.jpg" /></p>
<p><strong>*Reference</strong></p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-a-json-merge-patch-to-update-a-deployment">Use a JSON merge patch to update a Deployment</a></li>
<li><a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes">watch modus</a></li>
</ul>
<h2 id="chapter3-basics-of-client-go">Chapter3. Basics of client-go</h2>
<h3 id="client-goapiapimachinery"><code>client-go</code>、<code>api</code>、<code>apimachinery</code>三个重要的仓库</h3>
<p><code>client-go</code>、<code>api</code>、<code>apimachinery</code>是Kubernetes client中最核心的三个仓库。</p>
<ol>
<li><a href="https://github.com/kubernetes/client-go">client-go</a>仓库是用来访问kubernetes的client的接口。</li>
<li>Pod、Deployment等对象则是放在<a href="https://github.com/kubernetes/api">api</a>的仓库中，例如Pod对象，它属于core group，对于v1版本来说，它的位置就在<code>api/core/v1</code>目录下。
   Pod的类型定义就在<code>types.go</code>文件中。这个目录下还包含了一些其他文件，部分文件都是通过代码生成器自动生成的。</li>
<li>最后一个仓库是<a href="https://github.com/kubernetes/apimachinery">apimachinery</a>，包含了所有通用的用来构建类似Kubernetes风格API的模块。</li>
</ol>
<h3 id="creating-and-using-a-client">Creating and Using a Client</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>package main

import (
    &quot;fmt&quot;
    &quot;os&quot;
    &quot;path/filepath&quot;
    &quot;time&quot;

    &quot;k8s.io/apimachinery/pkg/util/wait&quot;
    &quot;k8s.io/client-go/informers&quot;
    &quot;k8s.io/client-go/rest&quot;

    &quot;k8s.io/client-go/kubernetes&quot;
    &quot;k8s.io/client-go/tools/cache&quot;
    &quot;k8s.io/client-go/tools/clientcmd&quot;
)

func main() {
    // 先从集群Pod中/var/run/secrets/kubernetes.io/serviceaccount获取到service account转换为rest.Config
    config, err := rest.InClusterConfig()
    if err != nil {
        // 获取service account失败，直接去读取kubeconfig文件
        kubeconfig := filepath.Join(&quot;~&quot;, &quot;.kube&quot;, &quot;config&quot;)
        // 或者是从环境变量中获取到kubeconfig的位置
        if envvar := os.Getenv(&quot;KUBECONFIG&quot;); len(envvar) &gt; 0 {
            kubeconfig = envvar
        }
        // 通过kubeconfig文件构建rest.Config
        config, err = clientcmd.BuildConfigFromFlags(&quot;&quot;, kubeconfig)
        if err != nil {
            fmt.Printf(&quot;The kubeconfig cannot be loaded: %v\n&quot;, err)
            os.Exit(1)
        }
        // 返回的config可以做一些自定义操作，比如自定义UserAgent、自定义AcceptContentTypes、超时实际、限流等
        // config.UserAgent = fmt.Sprintf(&quot;Go %s&quot;, runtime.GOOS);
        // config.AcceptContentTypes = &quot;application/vnd.kubernetes.protobuf,application/json&quot;
    }
    // 用reset.Config构建kubernetes client
    clientset, err := kubernetes.NewForConfig(config)
    // 读取book namespace下的名为example的Pod对象
    pod, err = “clientset.CoreV1().Pods(&quot;book&quot;).Get(&quot;example&quot;, metav1.GetOptions{})
}
</code></pre></div>
</td></tr></table>
<h3 id="versioningcompatibillity">Versioning和Compatibillity</h3>
<p>Kubernetes API是带有版本的，每个对象都有不同的版本，我们可以在api仓库中的<code>apps</code>目录下可以看到各个版本的对象存在，同样的，对于client-go来说，针对不同的对象也存在不同的版本的接口。我们可以在
client-go仓库下的<code>kubernestes/typed/apps</code>目录下找到对应版本对象的接口。Kubernestes和<code>client-go</code>是共用相同的api仓库的，因此client-go的版本需要和kubernetes具有兼容的版本才能发挥作用，
否则Api Server会拒绝掉<code>client-go</code>发出来的请求。如果client-go的版本比kubernertes的要新，那么当携带某些新增字段的时候，kubernetes可能会拒绝掉，也有可能会忽略掉，这个要看具体的字段的行为。
kubernetes为了解决对象版本兼容问题，在实际将对象存储在etcd中时会按照一个称之为内部版本的对象存储进去，不同版本的API请求过来的时候，通过预定义的转换器进行转换来实现版本之间的兼容。</p>
<h3 id="kubernetes-objects-in-go">Kubernetes Objects in Go</h3>
<p>Kubernetes中的资源，准确来说对应到Go中就是一个对象，资源的类型对应到yaml中的Kind字段，比如下面这个Pod资源。其yaml中的Kind字段就是Pod。
在Kubernetest中会通过一个<code>struct</code>来表示这个Pod，我们还可以发现的Kubernetes中所有的资源都会有一些公共的字段，比如apiVersion、Kind、metadata、spec等。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pod-demo</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myapp</span>
    <span class="nt">tier</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fronted</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myapp</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ikubernetes/myapp:v1</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">busybox</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">busybox:latest</span>
    <span class="nt">command</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;bin/sh&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;echo</span><span class="nv"> </span><span class="s">$(date)</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">/tmp/txt;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">5&quot;</span>
</code></pre></div>
</td></tr></table>
<p>Kubernetes中资源所对应的对象都默认实现了<code>runtime.Object</code>接口，这个接口很简单，定义如下。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>// Object interface must be supported by all API types registered with Scheme. Since objects in a scheme are
// expected to be serialized to the wire, the interface an Object must provide to the Scheme allows
// serializers to set the kind, version, and group the object is represented as. An Object may choose
// to return a no-op ObjectKindAccessor in cases where it is not expected to be serialized.
type Object interface {
    GetObjectKind() schema.ObjectKind
    DeepCopyObject() Object
}


// All objects that are serialized from a Scheme encode their type information. This interface is used
// by serialization to set type information from the Scheme onto the serialized version of an object.
// For objects that cannot be serialized or have unique requirements, this interface may be a no-op.
type ObjectKind interface {
    // SetGroupVersionKind sets or clears the intended serialized kind of an object. Passing kind nil
    // should clear the current setting.
    SetGroupVersionKind(kind GroupVersionKind)
    // GroupVersionKind returns the stored group, version, and kind of an object, or nil if the object does
    // not expose or provide these fields.
    GroupVersionKind() GroupVersionKind
}
</code></pre></div>
</td></tr></table>
<blockquote>
<p>每一个对象都要满足Object接口的约束，可以看出通过这些接口可以设置和获取对象的GVK，以及进行深度拷贝。</p>
</blockquote>
<p>每一个Kubernetes对象都会嵌入一个<code>metav1.TypeMeta struct</code>。还有一个<code>metav1.ObjectMeta</code></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>// TypeMeta describes an individual object in an API response or request
// with strings representing the type of the object and its API schema version.
// Structures that are versioned or persisted should inline TypeMeta.
//
// +k8s:deepcopy-gen=false
type TypeMeta struct {
    // Kind is a string value representing the REST resource this object represents.
    // Servers may infer this from the endpoint the client submits requests to.
    // Cannot be updated.
    // In CamelCase.
    // More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds
    // +optional
    Kind string `json:&quot;kind,omitempty&quot; protobuf:&quot;bytes,1,opt,name=kind&quot;`

    // APIVersion defines the versioned schema of this representation of an object.
    // Servers should convert recognized schemas to the latest internal value, and
    // may reject unrecognized values.
    // More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#resources
    // +optional
    APIVersion string `json:&quot;apiVersion,omitempty&quot; protobuf:&quot;bytes,2,opt,name=apiVersion&quot;`
}

type ObjectMeta struct {
    Name string `json:&quot;name,omitempty&quot;`
    Namespace string `json:&quot;namespace,omitempty&quot;`
    UID types.UID `json:&quot;uid,omitempty&quot;`
    ResourceVersion string `json:&quot;resourceVersion,omitempty&quot;`
    CreationTimestamp Time `json:&quot;creationTimestamp,omitempty&quot;`
    DeletionTimestamp *Time `json:&quot;deletionTimestamp,omitempty&quot;`
    Labels map[string]string `json:&quot;labels,omitempty&quot;`
    Annotations map[string]string `json:&quot;annotations,omitempty&quot;`
    ...
}
</code></pre></div>
</td></tr></table>
<blockquote>
<p>每一个对象都会包含一个<code>metav1.TypeMeta struct</code>字段和一个<code>metav1.ObjectMeta</code>字段
前者用来描述一个对象，比如是什么kind，什么APIVersion，后者则是一些元信息，比如label、注解、其中ResourceVersion就是用来实现乐观并发(optimistic-concurrency)等</p>
</blockquote>
<p>例如一个POD对象如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>// Pod is a collection of containers that can run on a host. This resource is created
// by clients and scheduled onto hosts.
type Pod struct {
    metav1.TypeMeta `json:&quot;,inline&quot;`
    // Standard object&#39;s metadata.
    // More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata
    // +optional
    metav1.ObjectMeta `json:&quot;metadata,omitempty&quot; protobuf:&quot;bytes,1,opt,name=metadata&quot;`

    // Specification of the desired behavior of the pod.
    // More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status
    // +optional
    Spec PodSpec `json:&quot;spec,omitempty&quot; protobuf:&quot;bytes,2,opt,name=spec&quot;`

    // Most recently observed status of the pod.
    // This data may not be up to date.
    // Populated by the system.
    // Read-only.
    // More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status
    // +optional
    Status PodStatus `json:&quot;status,omitempty&quot; protobuf:&quot;bytes,3,opt,name=status&quot;`
}
</code></pre></div>
</td></tr></table>
<p>每一个对象都有自己独立的Spec和Status，通常Spec表示用户的期望，Status则是期望的的结果，是Controller和Operator来负责填充。也存在一些异常情况，比如endpoints和RBAC</p>
<blockquote>
<p>请求分为长请求和短请求，对于长请求一般来说是诸如watch、一些Subresources(exec、sport-forward)等，对于短请求则会有60s的超时时间，当API server下线的时候会等待60s直到服务完这些短请求
对于长请求则直接断掉。从而实现所谓的优雅关闭。</p>
</blockquote>
<h3 id="client-sets">Client Sets</h3>
<p>在上面的example中，通过<code>kubernetes.NewForConfig(config)</code>创建了一个<code>Clientset</code>，一个<code>Clientset</code>是可以用来访问多个<code>API Group</code>和资源的接口，其定义如下。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// Clientset contains the clients for groups. Each group has exactly one</span>
<span class="c1">// version included in a Clientset.</span>
<span class="kd">type</span> <span class="nx">Clientset</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryClient</span>
    <span class="nx">admissionregistrationV1</span>      <span class="o">*</span><span class="nx">admissionregistrationv1</span><span class="p">.</span><span class="nx">AdmissionregistrationV1Client</span>
    <span class="nx">admissionregistrationV1beta1</span> <span class="o">*</span><span class="nx">admissionregistrationv1beta1</span><span class="p">.</span><span class="nx">AdmissionregistrationV1beta1Client</span>
    <span class="nx">appsV1</span>                       <span class="o">*</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">AppsV1Client</span>
    <span class="nx">appsV1beta1</span>                  <span class="o">*</span><span class="nx">appsv1beta1</span><span class="p">.</span><span class="nx">AppsV1beta1Client</span>
    <span class="nx">appsV1beta2</span>                  <span class="o">*</span><span class="nx">appsv1beta2</span><span class="p">.</span><span class="nx">AppsV1beta2Client</span>
    <span class="nx">auditregistrationV1alpha1</span>    <span class="o">*</span><span class="nx">auditregistrationv1alpha1</span><span class="p">.</span><span class="nx">AuditregistrationV1alpha1Client</span>
    <span class="nx">authenticationV1</span>             <span class="o">*</span><span class="nx">authenticationv1</span><span class="p">.</span><span class="nx">AuthenticationV1Client</span>
    <span class="nx">authenticationV1beta1</span>        <span class="o">*</span><span class="nx">authenticationv1beta1</span><span class="p">.</span><span class="nx">AuthenticationV1beta1Client</span>
    <span class="nx">authorizationV1</span>              <span class="o">*</span><span class="nx">authorizationv1</span><span class="p">.</span><span class="nx">AuthorizationV1Client</span>
    <span class="nx">authorizationV1beta1</span>         <span class="o">*</span><span class="nx">authorizationv1beta1</span><span class="p">.</span><span class="nx">AuthorizationV1beta1Client</span>
    <span class="nx">autoscalingV1</span>                <span class="o">*</span><span class="nx">autoscalingv1</span><span class="p">.</span><span class="nx">AutoscalingV1Client</span>
    <span class="nx">autoscalingV2beta1</span>           <span class="o">*</span><span class="nx">autoscalingv2beta1</span><span class="p">.</span><span class="nx">AutoscalingV2beta1Client</span>
    <span class="nx">autoscalingV2beta2</span>           <span class="o">*</span><span class="nx">autoscalingv2beta2</span><span class="p">.</span><span class="nx">AutoscalingV2beta2Client</span>
    <span class="nx">batchV1</span>                      <span class="o">*</span><span class="nx">batchv1</span><span class="p">.</span><span class="nx">BatchV1Client</span>
    <span class="nx">batchV1beta1</span>                 <span class="o">*</span><span class="nx">batchv1beta1</span><span class="p">.</span><span class="nx">BatchV1beta1Client</span>
    <span class="nx">batchV2alpha1</span>                <span class="o">*</span><span class="nx">batchv2alpha1</span><span class="p">.</span><span class="nx">BatchV2alpha1Client</span>
    <span class="nx">certificatesV1beta1</span>          <span class="o">*</span><span class="nx">certificatesv1beta1</span><span class="p">.</span><span class="nx">CertificatesV1beta1Client</span>
    <span class="nx">coordinationV1beta1</span>          <span class="o">*</span><span class="nx">coordinationv1beta1</span><span class="p">.</span><span class="nx">CoordinationV1beta1Client</span>
    <span class="nx">coordinationV1</span>               <span class="o">*</span><span class="nx">coordinationv1</span><span class="p">.</span><span class="nx">CoordinationV1Client</span>
    <span class="nx">coreV1</span>                       <span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">CoreV1Client</span>
    <span class="nx">discoveryV1alpha1</span>            <span class="o">*</span><span class="nx">discoveryv1alpha1</span><span class="p">.</span><span class="nx">DiscoveryV1alpha1Client</span>
    <span class="nx">discoveryV1beta1</span>             <span class="o">*</span><span class="nx">discoveryv1beta1</span><span class="p">.</span><span class="nx">DiscoveryV1beta1Client</span>
    <span class="nx">eventsV1beta1</span>                <span class="o">*</span><span class="nx">eventsv1beta1</span><span class="p">.</span><span class="nx">EventsV1beta1Client</span>
    <span class="nx">extensionsV1beta1</span>            <span class="o">*</span><span class="nx">extensionsv1beta1</span><span class="p">.</span><span class="nx">ExtensionsV1beta1Client</span>
    <span class="nx">flowcontrolV1alpha1</span>          <span class="o">*</span><span class="nx">flowcontrolv1alpha1</span><span class="p">.</span><span class="nx">FlowcontrolV1alpha1Client</span>
    <span class="nx">networkingV1</span>                 <span class="o">*</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">NetworkingV1Client</span>
    <span class="nx">networkingV1beta1</span>            <span class="o">*</span><span class="nx">networkingv1beta1</span><span class="p">.</span><span class="nx">NetworkingV1beta1Client</span>
    <span class="nx">nodeV1alpha1</span>                 <span class="o">*</span><span class="nx">nodev1alpha1</span><span class="p">.</span><span class="nx">NodeV1alpha1Client</span>
    <span class="nx">nodeV1beta1</span>                  <span class="o">*</span><span class="nx">nodev1beta1</span><span class="p">.</span><span class="nx">NodeV1beta1Client</span>
    <span class="nx">policyV1beta1</span>                <span class="o">*</span><span class="nx">policyv1beta1</span><span class="p">.</span><span class="nx">PolicyV1beta1Client</span>
    <span class="nx">rbacV1</span>                       <span class="o">*</span><span class="nx">rbacv1</span><span class="p">.</span><span class="nx">RbacV1Client</span>
    <span class="nx">rbacV1beta1</span>                  <span class="o">*</span><span class="nx">rbacv1beta1</span><span class="p">.</span><span class="nx">RbacV1beta1Client</span>
    <span class="nx">rbacV1alpha1</span>                 <span class="o">*</span><span class="nx">rbacv1alpha1</span><span class="p">.</span><span class="nx">RbacV1alpha1Client</span>
    <span class="nx">schedulingV1alpha1</span>           <span class="o">*</span><span class="nx">schedulingv1alpha1</span><span class="p">.</span><span class="nx">SchedulingV1alpha1Client</span>
    <span class="nx">schedulingV1beta1</span>            <span class="o">*</span><span class="nx">schedulingv1beta1</span><span class="p">.</span><span class="nx">SchedulingV1beta1Client</span>
    <span class="nx">schedulingV1</span>                 <span class="o">*</span><span class="nx">schedulingv1</span><span class="p">.</span><span class="nx">SchedulingV1Client</span>
    <span class="nx">settingsV1alpha1</span>             <span class="o">*</span><span class="nx">settingsv1alpha1</span><span class="p">.</span><span class="nx">SettingsV1alpha1Client</span>
    <span class="nx">storageV1beta1</span>               <span class="o">*</span><span class="nx">storagev1beta1</span><span class="p">.</span><span class="nx">StorageV1beta1Client</span>
    <span class="nx">storageV1</span>                    <span class="o">*</span><span class="nx">storagev1</span><span class="p">.</span><span class="nx">StorageV1Client</span>
    <span class="nx">storageV1alpha1</span>              <span class="o">*</span><span class="nx">storagev1alpha1</span><span class="p">.</span><span class="nx">StorageV1alpha1Client</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>比如通过<code>Clientset</code>的appsV1接口，就可以访问apps组，v1 version下的所有资源，在这个组下有DaemonSet、ControllerRevision、Deployment、ReplcaSets、StatefulSet等资源，appsV1定义如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// DeploymentsGetter has a method to return a DeploymentInterface.</span>
<span class="c1">// A group&#39;s client should implement this interface.</span>
<span class="kd">type</span> <span class="nx">DeploymentsGetter</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Deployments</span><span class="p">(</span><span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">DeploymentInterface</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">AppsV1Interface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">RESTClient</span><span class="p">()</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">Interface</span>
    <span class="nx">ControllerRevisionsGetter</span>
    <span class="nx">DaemonSetsGetter</span>
    <span class="nx">DeploymentsGetter</span>
    <span class="nx">ReplicaSetsGetter</span>
    <span class="nx">StatefulSetsGetter</span>
<span class="p">}</span>

<span class="c1">// AppsV1Client is used to interact with features provided by the apps group.</span>
<span class="kd">type</span> <span class="nx">AppsV1Client</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">restClient</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">Interface</span>
<span class="p">}</span>

<span class="c1">// DeploymentInterface has methods to work with Deployment resources.</span>
<span class="kd">type</span> <span class="nx">DeploymentInterface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Create</span><span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">Update</span><span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">UpdateStatus</span><span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">Delete</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nx">DeleteCollection</span><span class="p">(</span><span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">,</span> <span class="nx">listOptions</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="kt">error</span>
    <span class="nx">Get</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">List</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">DeploymentList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">Watch</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">Patch</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">pt</span> <span class="nx">types</span><span class="p">.</span><span class="nx">PatchType</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">subresources</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">GetScale</span><span class="p">(</span><span class="nx">deploymentName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">autoscalingv1</span><span class="p">.</span><span class="nx">Scale</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nx">UpdateScale</span><span class="p">(</span><span class="nx">deploymentName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">scale</span> <span class="o">*</span><span class="nx">autoscalingv1</span><span class="p">.</span><span class="nx">Scale</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">autoscalingv1</span><span class="p">.</span><span class="nx">Scale</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

    <span class="nx">DeploymentExpansion</span>
<span class="p">}</span>

<span class="c1">// Get takes name of the deployment, and returns the corresponding deployment object, and an error if there is any.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">deployments</span><span class="p">)</span> <span class="nx">Get</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{}</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Get</span><span class="p">().</span>
        <span class="nx">Namespace</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ns</span><span class="p">).</span>
        <span class="nx">Resource</span><span class="p">(</span><span class="s">&quot;deployments&quot;</span><span class="p">).</span>
        <span class="nx">Name</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span>
        <span class="nx">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">).</span>
        <span class="nx">Do</span><span class="p">().</span>
        <span class="nx">Into</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>AppsV1Client实现了AppsV1Interface接口，通过这个接口可以访问这个组下的所有资源，通过其定义可以看出，最终都是通过rest接口来访问的。
注意观察你会发现上面的接口中都带有一个Options，比如ListOptions、DeleteOptions、GetOptions等，通过这些Options可以自定义一些过滤条件，比如ListOptions中可以指定label selector进行过滤。
另外上面的接口中还有一个Watch接口，这个接口是用来监听对象的所有改变(添加、删除、更新)，返回的watche.Interface其定义如下。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// Interface can be implemented by anything that knows how to watch and report changes.</span>
<span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Stops watching. Will close the channel returned by ResultChan(). Releases</span>
    <span class="c1">// any resources used by the watch.</span>
    <span class="nx">Stop</span><span class="p">()</span>

    <span class="c1">// Returns a chan which will receive all the events. If an error occurs</span>
    <span class="c1">// or Stop() is called, this channel will be closed, in which case the</span>
    <span class="c1">// watch should be completely cleaned up.</span>
    <span class="nx">ResultChan</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">Event</span>
<span class="p">}</span>

<span class="c1">// EventType defines the possible types of events.</span>
<span class="kd">type</span> <span class="nx">EventType</span> <span class="kt">string</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">Added</span>    <span class="nx">EventType</span> <span class="p">=</span> <span class="s">&quot;ADDED&quot;</span>
    <span class="nx">Modified</span> <span class="nx">EventType</span> <span class="p">=</span> <span class="s">&quot;MODIFIED&quot;</span>
    <span class="nx">Deleted</span>  <span class="nx">EventType</span> <span class="p">=</span> <span class="s">&quot;DELETED&quot;</span>
    <span class="nx">Bookmark</span> <span class="nx">EventType</span> <span class="p">=</span> <span class="s">&quot;BOOKMARK&quot;</span>
    <span class="nx">Error</span>    <span class="nx">EventType</span> <span class="p">=</span> <span class="s">&quot;ERROR&quot;</span>

    <span class="nx">DefaultChanSize</span> <span class="kt">int32</span> <span class="p">=</span> <span class="mi">100</span>
<span class="p">)</span>

<span class="c1">// Event represents a single event to a watched resource.</span>
<span class="c1">// +k8s:deepcopy-gen=true</span>
<span class="kd">type</span> <span class="nx">Event</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Type</span> <span class="nx">EventType</span>

    <span class="c1">// Object is:</span>
    <span class="c1">//  * If Type is Added or Modified: the new state of the object.</span>
    <span class="c1">//  * If Type is Deleted: the state of the object immediately before deletion.</span>
    <span class="c1">//  * If Type is Bookmark: the object (instance of a type being watched) where</span>
    <span class="c1">//    only ResourceVersion field is set. On successful restart of watch from a</span>
    <span class="c1">//    bookmark resourceVersion, client is guaranteed to not get repeat event</span>
    <span class="c1">//    nor miss any events.</span>
    <span class="c1">//  * If Type is Error: *api.Status is recommended; other types may make sense</span>
    <span class="c1">//    depending on context.</span>
    <span class="nx">Object</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<blockquote>
<p>不鼓励直接使用watch接口，应该使用封装好的Informes。</p>
</blockquote>
<h3 id="informers-and-caching">Informers and Caching</h3>
<p>Informers通过watch接口实现Cachae和增量更新。并能够很好的处理网络抖动，断网等场景。尽可能的每一种资源类型只创建一个Informers，否则会导致资源的浪费，为此可以通过<code>InformerFactory</code>来创建Informer。
他内部对于同一个资源类型只会创建一个informer实例。</p>
<blockquote>
<p>It is very important to remember that any object passed from the listers to the event handlers is owned by the informers. If you mutate it in any way, 
you risk introducing hard-to-debug cache coherency issues into your application. Always do a deep copy (see “Kubernetes Objects in Go”) before changing an object.</p>
</blockquote>
<p>我们在informers的event回调中切记不要修改对象，否则会导致很难排查的缓存一致性问题，如果要修改的话，请先深拷贝，然后修改。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="nx">informerFactory</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">clientset</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
    <span class="nx">podInformer</span> <span class="o">:=</span> <span class="nx">informerFactory</span><span class="p">.</span><span class="nx">Core</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">()</span>
    <span class="nx">podInformer</span><span class="p">.</span><span class="nx">Informer</span><span class="p">().</span><span class="nx">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
        <span class="nx">AddFunc</span><span class="p">:</span>    <span class="kd">func</span><span class="p">(</span><span class="nx">new</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Create a pod&quot;</span><span class="p">)</span> <span class="p">},</span>
        <span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Update a pod&quot;</span><span class="p">)</span> <span class="p">},</span>
        <span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Delete a pod&quot;</span><span class="p">)</span> <span class="p">},</span>
    <span class="p">})</span>
    <span class="nx">informerFactory</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>
    <span class="nx">informerFactory</span><span class="p">.</span><span class="nx">WaitForCacheSync</span><span class="p">(</span><span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>
    <span class="nx">pod</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">podInformer</span><span class="p">.</span><span class="nx">Lister</span><span class="p">().</span><span class="nx">Pods</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">).</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;details-v1-5974b67c8-n7vdw&quot;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>默认informer会监听所有namespace下的指定资源，也可以通过<code>NewSharedInformerFactoryWithOptions</code>来进行过滤</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">informerFactory</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">NewSharedInformerFactoryWithOptions</span><span class="p">(</span><span class="nx">clientset</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">30</span><span class="p">,</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">WithNamespace</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<p><img alt="informers" src="images/informers.jpg" /></p>
<h3 id="object-owner">Object Owner</h3>
<p>通常来说，在修改一个对象之前，我们总是会问自己，这个对象被谁拥有，或者是在哪个数据结构中? 一般来来说原则如下:</p>
<ol>
<li>Informers and listers拥有他们返回的对象，要修改这个对象的时候，需要进行深拷贝</li>
<li>Clients返回的新对象这个属于调用者</li>
<li>Conversions返回的共享对象，如果调用者拥有输入的对象，那么它不拥有输出的共享对象。</li>
</ol>
<h3 id="api-machinery-in-depth">API Machinery in Depth</h3>
<p>API Machinery仓库实现了基本的Kubernetes类型系统，但是类型系统是什么呢?  类型这个术语并不在API Machinery仓库中存在。
在API Machinery类型对应到的是Kinds。</p>
<ul>
<li>
<p>Kinds</p>
</li>
<li>
<p>在kubernetes中，每一个GVK对应到一个具体的Go类型，相反，一个Go类型可以对应到多个GVK</p>
</li>
<li>Kind并不会一对一和HTTP paths mapping，可能多个kind对应一个HTTP path，也有可能一个也不对应。</li>
</ul>
<blockquote>
<p>例如: admission.k8s.io/v1beta1.AdmissionReview不对应任何HTTP path
例如: meta.k8s.io/v1.Status 对应很多HTTP path</p>
</blockquote>
<p>按照约定kind的命名按照驼峰命名，并且使用单数，而且对于CustomResourceDefinition类型的资源，其kind必须是符合DNS path label(REF 1035)</p>
<ul>
<li>Resources</li>
</ul>
<p>代表一类资源，这个资源是属于一个group，并且是有版本的，所以就有了GVR(GroupVersionResource)，每一个GVR都会对应到一个HTTP path。
通过GVR来应识别出一个Kubernetes的 REST API endpoint，例如GVR apps/v1.deloyment会映射到/apis/apps/v1/namespace/NAMESPACE/deployments
客户端就是通过这种映射关系来构建HTTP path的。</p>
<blockquote>
<p>一个GVR是否是namespaced，或者是集群级别的，这是需要知道的，否则无法构建HTTP Path，按照约定，小写，并且是复数类型的kind，并且遵从DNS path label format
那么这个GVR对应的就是一个集群级别的。直接用kind来映射到HTTP path。
例如: rbac.authorization.k8s.io/v1.clusterroles，映射到HTTP path就是apis/rbac.authorization.k8s.io/v1/clusterroles.</p>
</blockquote>
<h3 id="scheme">Scheme</h3>
<p>虽然每一个Object都会包含<code>TypeMeta</code>，里面包含了Kind和APIVersion但是实际上，我们去访问的时候，并不会拿到对应的信息，这些信息都是空的，相反我们需要通过scheme来获取对象的Kind</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Scheme</span><span class="p">)</span> <span class="nx">ObjectKinds</span><span class="p">(</span><span class="nx">obj</span> <span class="nx">Object</span><span class="p">)</span> <span class="p">([]</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>通过Scheme来连接GVK和Golang类型，Scheme对两者做了映射，Scheme会预先对大量内置类型做映射。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">scheme</span><span class="p">.</span><span class="nx">AddKnownTypes</span><span class="p">(</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;v1&quot;</span><span class="p">,</span> <span class="s">&quot;Pod&quot;</span><span class="p">},</span> <span class="o">&amp;</span><span class="nx">Pod</span><span class="p">{})</span>
</code></pre></div>
</td></tr></table>
<p>最终一个Golang类型，通过shceme映射到GVK，然后GVK通过RESTMapper映射到GVR，最终通过GVR拼接出HTTP path。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>// RESTMapping contains the information needed to deal with objects of a specific
// resource and kind in a RESTful manner.
type RESTMapping struct {
    // Resource is the GroupVersionResource (location) for this endpoint
    Resource schema.GroupVersionResource

    // GroupVersionKind is the GroupVersionKind (data format) to submit to this endpoint
    GroupVersionKind schema.GroupVersionKind

    // Scope contains the information needed to deal with REST Resources that are in a resource hierarchy
    Scope RESTScope
}
</code></pre></div>
</td></tr></table>
<p><img alt="k8s-scheme" src="images/k8s-scheme.jpg" /></p>
<h2 id="chapter4-using-custom-resources">Chapter4. Using Custom Resources</h2>
<p>CRD本身是一个Kubernetes的资源，它描述了在集群中可用的资源，典型的一个CRD定义如下：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apiextensions.k8s.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CustomResourceDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ats.cnat.programming-kubernetes.info</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cnat.programming-kubernetes.info</span>
  <span class="nt">names</span><span class="p">:</span>
    <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">At</span>
    <span class="nt">listKind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AtList</span>
    <span class="nt">plural</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ats</span>
    <span class="nt">singular</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">at</span>
  <span class="nt">scope</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Namespaced</span>
  <span class="nt">subresources</span><span class="p">:</span>
    <span class="nt">status</span><span class="p">:</span> <span class="p p-Indicator">{}</span>

<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1alpha1</span>
<span class="nt">versions</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1alpha1</span>
  <span class="nt">served</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
</td></tr></table>
<p>注意，这个CRD的名字需要资源名的复数形式，然后跟上API group name，上面的CRD中资源名为at，API Group的名字就是<code>cnat.programming-kubernetes.info</code>
定义完这个CRD后，我们就可以创建一个at资源了。然后通过<code>kubectl get ats</code>就可以列出所有创建的at资源。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cnat.programming-kubernetes.info/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">At</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">example-at</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">schedule</span><span class="p">:</span> <span class="s">&quot;2020-12-02T00:30:00Z&quot;</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">shell</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">centos:7</span>
    <span class="nt">command</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;bin/bash&quot;</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;-c&quot;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">echo &quot;Kubernetes native rocks!&quot;</span>
<span class="nt">status</span><span class="p">:</span>
  <span class="nt">phase</span><span class="p">:</span> <span class="s">&quot;pending&quot;</span>
</code></pre></div>
</td></tr></table>
<p>kubectl是如何找到<code>ats</code>资源呢?</p>
<ul>
<li>如何找到自定义资源</li>
<li>通过/apis询问Api server所有的 API group</li>
<li>通过/apis/group/version 查看所有的group存在的资源，找到对应资源所在的Group、VersionheResources</li>
</ul>
<h2 id="subresources">Subresources</h2>
<p>Subresources就是一个特殊的HTTP endpoints，一般是在正常resource后面添加的一个后缀来表示，比如，对于pod资源来说，正常的HTTP Path是
 <code>/api/v1/namespace/namespace/pods/name</code>，他可以有多个Subresources，比如<code>/logs</code>、<code>/portforward</code>、<code>/exec</code>、<code>status</code>。</p>
<p>Subresources所使用的协议是和主资源不一样的，目前为止自定义资源支持/scale和/status两种子资源。</p>
<p>/status子资源的目的是为了和将spec和status进行分离，</p>
<h2 id="customresourcedefinition">CustomResourceDefinition</h2>
<p>每一个自定义资源都可以有subresourcs，默认支持scale、status两类子资源</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">KIND</span><span class="p">:</span>     <span class="l l-Scalar l-Scalar-Plain">CustomResourceDefinition</span>
<span class="nt">VERSION</span><span class="p">:</span>  <span class="l l-Scalar l-Scalar-Plain">apiextensions.k8s.io/v1beta1</span>

<span class="nt">RESOURCE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">subresources &lt;Object&gt;</span>

<span class="nt">DESCRIPTION</span><span class="p">:</span>
     <span class="l l-Scalar l-Scalar-Plain">Subresources describes the subresources for CustomResource Optional, the</span>
     <span class="l l-Scalar l-Scalar-Plain">global subresources for all versions. Top-level and per-version</span>
     <span class="l l-Scalar l-Scalar-Plain">subresources are mutually exclusive.</span>

     <span class="l l-Scalar l-Scalar-Plain">CustomResourceSubresources defines the status and scale subresources for</span>
     <span class="l l-Scalar l-Scalar-Plain">CustomResources.</span>

<span class="nt">FIELDS</span><span class="p">:</span>
   <span class="l l-Scalar l-Scalar-Plain">scale        &lt;Object&gt;</span>
     <span class="l l-Scalar l-Scalar-Plain">Scale denotes the scale subresource for CustomResources</span>

   <span class="l l-Scalar l-Scalar-Plain">status       &lt;map[string]&gt;</span>
     <span class="l l-Scalar l-Scalar-Plain">Status denotes the status subresource for CustomResources</span>
</code></pre></div>
</td></tr></table>
<p>自定义资源可以通过几种方式来访问:</p>
<ol>
<li>使用client-go dynamic client(自定义类型通过Unstructured来表示)</li>
</ol>
<p><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>schema.GroupVersionResource{
  Group: &quot;apps&quot;,
  Version: &quot;v1&quot;,
  Resource: &quot;deployments&quot;,
}
client, err := NewForConfig(cfg)
client.Resource(gvr).Namespace(namespace).Get(&quot;foo&quot;, metav1.GetOptions{})
</code></pre></div>
</td></tr></table>
输入和输出都是<code>unstructured.Unstructured</code>，本质上是一个<code>json.Unmarshal</code>后的结构，用来保存对象。</p>
<ul>
<li>Object通过map[string]interface{}来表示</li>
<li>数组通过[]intreface{}来标志</li>
<li>string、bool、float64、int64是基本类型</li>
</ul>
<p>例如NestedString来获取一个对象中的某个字段，其实就是遍历对象map，找到对应key的value，然后做类型断言，如果找到了就返回。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>type Unstructured struct {
    // Object is a JSON compatible map with string, float, int, bool, []interface{}, or
    // map[string]interface{}
    // children.
    Object map[string]interface{}
}

// NestedFieldNoCopy returns a reference to a nested field.
// Returns false if value is not found and an error if unable
// to traverse obj.
func NestedFieldNoCopy(obj map[string]interface{}, fields ...string) (interface{}, bool, error) {
    var val interface{} = obj

    for i, field := range fields {
        if m, ok := val.(map[string]interface{}); ok {
            val, ok = m[field]
            if !ok {
                return nil, false, nil
            }
        } else {
            return nil, false, fmt.Errorf(&quot;%v accessor error: %v is of the type %T, expected map[string]interface{}&quot;, jsonPath(fields[:i+1]), val, val)
        }
    }
    return val, true, nil
}

// NestedString returns the string value of a nested field.
// Returns false if value is not found and an error if not a string.
func NestedString(obj map[string]interface{}, fields ...string) (string, bool, error) {
    val, found, err := NestedFieldNoCopy(obj, fields...)
    if !found || err != nil {
        return &quot;&quot;, found, err
    }
    s, ok := val.(string)
    if !ok {
        return &quot;&quot;, false, fmt.Errorf(&quot;%v accessor error: %v is of the type %T, expected string&quot;, jsonPath(fields), val, val)
    }
    return s, true, nil
}
</code></pre></div>
</td></tr></table>
<ol>
<li>使用typed client:</li>
<li>kubernetes-sigs/controller-runtime 和 kubebuilder</li>
<li>通过client-gen来生成</li>
</ol>
<p>typed client不使用类似于<code>map [string] interface {}</code>的通用数据结构，而是使用实际的Golang类型，这些类型对于每个GVK都是不同的和特定的</p>
<p>通过<code>scheme.AddKnownTypes</code>进行类型的注册，本质上是构建了一个gvk到对应类型的映射，以及type到gvk的映射表。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>var (
    // TODO: move SchemeBuilder with zz_generated.deepcopy.go to k8s.io/api.
    // localSchemeBuilder and AddToScheme will stay in k8s.io/kubernetes.
    SchemeBuilder      = runtime.NewSchemeBuilder(addKnownTypes)
    localSchemeBuilder = &amp;SchemeBuilder
    AddToScheme        = localSchemeBuilder.AddToScheme
)

// Adds the list of known types to the given scheme.
func addKnownTypes(scheme *runtime.Scheme) error {
    scheme.AddKnownTypes(SchemeGroupVersion,
        &amp;Deployment{},
        &amp;DeploymentList{},
        &amp;StatefulSet{},
        &amp;StatefulSetList{},
        &amp;DaemonSet{},
        &amp;DaemonSetList{},
        &amp;ReplicaSet{},
        &amp;ReplicaSetList{},
        &amp;ControllerRevision{},
        &amp;ControllerRevisionList{},
    )
    metav1.AddToGroupVersion(scheme, SchemeGroupVersion)
    return nil
}

// AddKnownTypes registers all types passed in &#39;types&#39; as being members of version &#39;version&#39;.
// All objects passed to types should be pointers to structs. The name that go reports for
// the struct becomes the &quot;kind&quot; field when encoding. Version may not be empty - use the
// APIVersionInternal constant if you have a type that does not have a formal version.
func (s *Scheme) AddKnownTypes(gv schema.GroupVersion, types ...Object) {
    s.addObservedVersion(gv)
    for _, obj := range types {
        t := reflect.TypeOf(obj)
        if t.Kind() != reflect.Ptr {
            panic(&quot;All types must be pointers to structs.&quot;)
        }
        t = t.Elem()
        s.AddKnownTypeWithName(gv.WithKind(t.Name()), obj)
    }
}

// AddKnownTypeWithName is like AddKnownTypes, but it lets you specify what this type should
// be encoded as. Useful for testing when you don&#39;t want to make multiple packages to define
// your structs. Version may not be empty - use the APIVersionInternal constant if you have a
// type that does not have a formal version.
func (s *Scheme) AddKnownTypeWithName(gvk schema.GroupVersionKind, obj Object) {
    s.addObservedVersion(gvk.GroupVersion())
    t := reflect.TypeOf(obj)
    if len(gvk.Version) == 0 {
        panic(fmt.Sprintf(&quot;version is required on all types: %s %v&quot;, gvk, t))
    }
    if t.Kind() != reflect.Ptr {
        panic(&quot;All types must be pointers to structs.&quot;)
    }
    t = t.Elem()
    if t.Kind() != reflect.Struct {
        panic(&quot;All types must be pointers to structs.&quot;)
    }

    if oldT, found := s.gvkToType[gvk]; found &amp;&amp; oldT != t {
    panic(fmt.Sprintf(&quot;Double registration of different types for %v: old=%v.%v, new=%v.%v in scheme %q&quot;,
                       gvk, oldT.PkgPath(), oldT.Name(), t.PkgPath(), t.Name(), s.schemeName))
    }

    s.gvkToType[gvk] = t

    for _, existingGvk := range s.typeToGVK[t] {
        if existingGvk == gvk {
            return
        }
    }
    s.typeToGVK[t] = append(s.typeToGVK[t], gvk)
}
</code></pre></div>
</td></tr></table>
<h2 id="automating-code-generation">Automating Code Generation</h2>
<p>Golang是一个简单的语言，缺乏类似于元编程的机制来给不同的类型实现算法，因此go选择使用代码生成的方式来实现。</p>
<p>Kubernetest通过代码给每一类资源生成一些方法。主要有四种标准的代码生成。</p>
<ol>
<li><code>deepcopy-gen</code> 生成<code>func (t *T) DeepCopy() *T</code> 和 <code>func (t* T)DeepCopyInto(*T)</code>两个方法</li>
<li><code>client-gen</code> 创建带类型的client sets</li>
<li><code>informer-gen</code></li>
<li><code>lister-gen</code></li>
</ol>
<p>通过上面四种代码生成器可以构建一个强大的控制器，除此之外还有<code>conversion-gen</code>和<code>defaulter-gen</code>两个生成器给编写<code>aggregated API server</code>提供便利。</p>
<blockquote>
<p><code>k8s.io/code-generator</code> 代码生成器仓库，通过<code>generate-groups.sh</code>来触发代码生成。</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nb">set</span> -o pipefail

<span class="c1"># 确保k8s.io/code-generator已经在vendor中了</span>
<span class="nv">SCRIPT_ROOT</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>/..
<span class="nv">CODEGEN_PKG</span><span class="o">=</span><span class="si">${</span><span class="nv">CODEGEN_PKG</span><span class="k">:-$(</span><span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_ROOT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> ls -d -1 ./vendor/k8s.io/code-generator <span class="m">2</span>&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> ../code-generator<span class="k">)</span><span class="si">}</span>

<span class="c1"># generate the code with:</span>
<span class="c1"># --output-base    because this script should also be able to run inside the vendor dir of</span>
<span class="c1">#                  k8s.io/kubernetes. The output-base is needed for the generators to output into the vendor dir</span>
<span class="c1">#                  instead of the $GOPATH directly. For normal projects this can be dropped.</span>

<span class="c1"># 调用k8s.io/code-generator中的generate-groups.sh脚本并指定参数</span>
<span class="c1"># 1. 指定生成器的类型</span>
<span class="c1"># 2. 生成的代码所属于的package name(client、informer、lister)</span>
<span class="c1"># 3. API group的package name</span>
<span class="c1"># 4. 要生成的 API group和Version，可以有多个，group:version格式。</span>
<span class="c1"># --output-base 定于生成的代码的基目录</span>
<span class="c1"># --go-header-file 生成的文件是否放入copyright内容</span>
<span class="c1"># deepcoy-gen生成器是直接在API group package中生成的。默认生成的文件是zz_generated前缀。</span>
bash <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CODEGEN_PKG</span><span class="si">}</span><span class="s2">&quot;</span>/generate-groups.sh <span class="s2">&quot;deepcopy,client,informer,lister&quot;</span> <span class="se">\</span>
  k8s.io/sample-controller/pkg/generated k8s.io/sample-controller/pkg/apis <span class="se">\</span>
  samplecontroller:v1alpha1 <span class="se">\</span>
  --output-base <span class="s2">&quot;</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">/../../..&quot;</span> <span class="se">\</span>
  --go-header-file <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SCRIPT_ROOT</span><span class="si">}</span><span class="s2">&quot;</span>/hack/boilerplate.go.txt

<span class="c1"># To use your own boilerplate text append:</span>
<span class="c1">#   --go-header-file &quot;${SCRIPT_ROOT}&quot;/hack/custom-boilerplate.go.txt</span>
</code></pre></div>
</td></tr></table>
<p>这些生成器如何生成代码是可以通过命令行参数来控制，也可以细粒度通过在代码中打tag的方式来控制，主要有两类tag</p>
<ol>
<li>global tags，通常在一个pakcage中的doc.go文件中。</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>+k8s:deepcopy-gen=package           // 给整个pakcgae中的类型都进行deepcopy类型的代码生成
+groupName=samplecontroller.k8s.io  // 指定API group name的全称，默认用的是parent的package name
</code></pre></div>
</td></tr></table>
<ol>
<li>local tags，通常在一个struct类型定义上。</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>// +genclient
// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object  // 不仅仅生成DeepCopy和DeepCopyInto方法，还要生成k8s.io/apimachinery/pkg/runtime.Object接口。
</code></pre></div>
</td></tr></table>
<h2 id="solutions-for-writing-operators">Solutions for Writing OPerators</h2>
<h3 id="controller">Controller编程基础</h3>
<ol>
<li>ownerReference，一个属主具有多个附属对象，每一个附属对象具有ownerReference指向其属主对象。</li>
</ol>
<blockquote>
<p>根据设计，kubernetes 不允许跨命名空间指定属主。这意味着： 
1）命名空间范围的附属只能指定同一的命名空间中的或者集群范围的属主。 
2）集群范围的附属只能指定集群范围的属主，不能指定命名空间范围的属主。</p>
</blockquote>
<p>当你删除对象时，可以指定该对象的附属是否也自动删除。 自动删除附属的行为也称为 级联删除（Cascading Deletion）。
Kubernetes 中有两种 级联删除 模式：后台（Background） 模式和 前台（Foreground） 模式。这个删除策略是可以通过
属主对象的<code>deleteOptions.propagationPolicy</code>来控制的。 可能的取值包括：<code>Orphan</code>、<code>Foreground</code> 或者 <code>Background</code>。
在 后台级联删除 模式下，Kubernetes 会立即删除属主对象，之后垃圾收集器 会在后台删除其附属对象。
在 前台级联删除 模式下，根对象首先进入 <code>deletion in progress</code> 状态。 在 <code>deletion in progress</code> 状态，会有如下的情况：</p>
<ol>
<li>对象仍然可以通过 REST API 可见。</li>
<li>对象的 deletionTimestamp 字段被设置。</li>
<li>对象的 metadata.finalizers 字段包含值 foregroundDeletion</li>
</ol>
<p>一旦对象被设置为<code>deletion in progress</code> 状态，垃圾收集器会删除对象的所有附属。 垃圾收集器在删除了所有有阻塞能力的附属（对象的 ownerReference.blockOwnerDeletion=true） 之后，删除属主对象。
如果一个对象的 ownerReferences 字段被一个控制器（例如 Deployment 或 ReplicaSet）设置， blockOwnerDeletion 也会被自动设置，你不需要手动修改这个字段。</p>
<p>如果删除对象时，不自动删除它的附属，这些附属被称作 孤立对象（Orphaned） 。</p>
<blockquote>
<p>默认是级联删除，通过--cascade可以控制这个行为
kubectl delete  replicaset my-repset --cascade=false 这样my-repset其附属管理的pod对象就不会被删除了。</p>
</blockquote>
<p>下面的代码在创建了Pod后，将这个pod设置Controller的附属对象</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>pod := newPodForCR(instance)
// Set At instance as the owner and controller
owner := metav1.NewControllerRef(instance, cnatv1alpha1.SchemeGroupVersion.WithKind(&quot;At&quot;))
pod.ObjectMeta.OwnerReferences = append(pod.ObjectMeta.OwnerReferences, *owner)
</code></pre></div>
</td></tr></table>
<ol>
<li>Create Controller</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>import (
    &quot;flag&quot;
    &quot;os&quot;
    &quot;path/filepath&quot;
    &quot;time&quot;

    &quot;k8s.io/apimachinery/pkg/util/wait&quot;
    kubeinformers &quot;k8s.io/client-go/informers&quot;
    &quot;k8s.io/client-go/kubernetes&quot;
    &quot;k8s.io/client-go/rest&quot;
    &quot;k8s.io/client-go/tools/clientcmd&quot;
    &quot;k8s.io/klog&quot;

    clientset &quot;github.com/programming-kubernetes/cnat/cnat-client-go/pkg/generated/clientset/versioned&quot;
    informers &quot;github.com/programming-kubernetes/cnat/cnat-client-go/pkg/generated/informers/externalversions&quot;
)

var (
    masterURL  string
    kubeconfig string
)

func main() {
    flag.StringVar(&amp;kubeconfig, &quot;kubeconfig&quot;, defaultKubeconfig(), &quot;Path to a kubeconfig. Only required if out-of-cluster.&quot;)
    flag.StringVar(&amp;masterURL, &quot;master&quot;, &quot;&quot;, &quot;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.&quot;)

    klog.InitFlags(nil)

    flag.Parse()
    // 先探测集群内的配置，如果存在就使用这个配置。否则就使用默认的kubeconfig.
    cfg, err := rest.InClusterConfig()
    if err != nil {
        cfg, err = clientcmd.BuildConfigFromFlags(masterURL, kubeconfig)
        if err != nil {
            klog.Fatalf(&quot;Error building kubeconfig: %s&quot;, err.Error())
        }
    }
    // 通过配置构建kube client
    kubeClient, err := kubernetes.NewForConfig(cfg)
    if err != nil {
        klog.Fatalf(&quot;Error building kubernetes clientset: %s&quot;, err.Error())
    }
    // 创建自定义资源的client
    cnatClient, err := clientset.NewForConfig(cfg)
    if err != nil {
        klog.Fatalf(&quot;Error building cnat clientset: %s&quot;, err.Error())
    }

    // 创建kubeInfomerFactory
    kubeInformerFactory := kubeinformers.NewSharedInformerFactory(kubeClient, time.Minute*10)
    // 创建自定义资源的InfomerFactory
    cnatInformerFactory := informers.NewSharedInformerFactory(cnatClient, time.Minute*10)

    // 创建Controller
    controller := NewController(kubeClient, cnatClient, cnatInformerFactory.Cnat().V1alpha1().Ats(), kubeInformerFactory.Core().V1().Pods())

    // 启动infomer
    // notice that there is no need to run Start methods in a separate goroutine. (i.e. go kubeInformerFactory.Start(stopCh))
    // Start method is non-blocking and runs all registered informers in a dedicated goroutine.
    kubeInformerFactory.Start(wait.NeverStop)
    cnatInformerFactory.Start(wait.NeverStop)

    if err = controller.Run(2, wait.NeverStop); err != nil {
        klog.Fatalf(&quot;Error running controller: %s&quot;, err.Error())
    }
}

func defaultKubeconfig() string {
    fname := os.Getenv(&quot;KUBECONFIG&quot;)
    if fname != &quot;&quot; {
        return fname
    }
    home, err := os.UserHomeDir()
    if err != nil {
        klog.Warningf(&quot;failed to get home directory: %v&quot;, err)
        return &quot;&quot;
    }
    return filepath.Join(home, &quot;.kube&quot;, &quot;config&quot;)
}
</code></pre></div>
</td></tr></table>
<ol>
<li>Event broadcaster</li>
</ol>
<p>Event事件管理机制主要有三部分组成：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* EventRecorder：是事件生成者，k8s组件通过调用它的方法来生成事件；
* EventBroadcaster：事件广播器，负责消费EventRecorder产生的事件，然后分发给broadcasterWatcher；
* broadcasterWatcher：用于定义事件的处理方式，如上报apiserver；
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>import utilruntime &quot;k8s.io/apimachinery/pkg/util/runtime&quot;

// 将自定义资源的scheme添加到kubernetes的scheme中用于logged events
utilruntime.Must(cnatscheme.AddToScheme(scheme.Scheme))
klog.V(4).Info(&quot;Creating event broadcaster&quot;)
// 创建事件广播器
eventBroadcaster := record.NewBroadcaster()
// 将收到的事件通过指定的log函数记录
eventBroadcaster.StartLogging(klog.Infof)
// 将收到的事件通过指定的Event Sink存储，相当于是broadcasterWatcher，这里将收到的事件创建成Events上报给API Server
eventBroadcaster.StartRecordingToSink(&amp;typedcorev1.EventSinkImpl{Interface: kubeClientset.CoreV1().Events(&quot;&quot;)})
// 创建事件生产者
recorder := eventBroadcaster.NewRecorder(scheme.Scheme, corev1.EventSource{Component: controllerAgentName})
// 代码中就可以通过recorder来记录事件了
</code></pre></div>
</td></tr></table>
<ol>
<li>WorkQueue</li>
</ol>
<p>WorkQueue称为工作队列，Kubernetes的WorkQueue队列与普通FIFO（先进先出，First-In, First-Out）队列相比，实现略显复杂，它的主要功能在于标记和去重，并支持如下特性。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* 有序：按照添加顺序处理元素（item）。
* 去重：相同元素在同一时间不会被重复处理，例如一个元素在处理之前被添加了多次，它只会被处理一次。
* 并发性：多生产者和多消费者。
* 标记机制：支持标记功能，标记一个元素是否被处理，也允许元素在处理时重新排队。
* 通知机制：ShutDown方法通过信号量通知队列不再接收新的元素，并通知metric goroutine退出。
* 延迟：支持延迟队列，延迟一段时间后再将元素存入队列。
* 限速：支持限速队列，元素存入队列时进行速率限制。限制一个元素被重新排队（Reenqueued）的次数。
* Metric：支持metric监控指标，可用于Prometheus监控。
</code></pre></div>
</td></tr></table>
<p>WorkQueue支持3种队列，并提供了3种接口，不同队列实现可应对不同的使用场景，分别介绍如下。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Interface：FIFO队列接口，先进先出队列，并支持去重机制。
* DelayingInterface：延迟队列接口，基于Interface接口封装，延迟一段时间后再将元素存入队列。
* RateLimitingInterface：限速队列接口，基于DelayingInterface接口封装，支持元素存入队列时进行速率限制。
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>import &quot;k8s.io/client-go/util/workqueue&quot;

// k8s.io/client-go/util/workqueue/queue.go
type Interface interface {
    Add(item interface{})
    Len() int
    Get() (item interface{}, shutdown bool)
    Done(item interface{})
    ShutDown()
    ShuttingDown() bool
}

/*
Add：给队列添加元素（item），可以是任意类型元素。
Len：返回当前队列的长度。
Get：获取队列头部的一个元素。
Done：标记队列中该元素已被处理。
ShutDown：关闭队列。
ShuttingDown：查询队列是否正在关闭。
*/

// k8s.io/client-go/util/workqueue/rate_limiting_queue.go

// RateLimitingInterface is an interface that rate limits items being added to the queue.
type RateLimitingInterface interface {
    DelayingInterface

    // AddRateLimited adds an item to the workqueue after the rate limiter says it&#39;s ok
    AddRateLimited(item interface{})

    // Forget indicates that an item is finished being retried.  Doesn&#39;t matter whether it&#39;s for perm failing
    // or for success, we&#39;ll stop the rate limiter from tracking it.  This only clears the `rateLimiter`, you
    // still have to call `Done` on the queue.
    Forget(item interface{})

    // NumRequeues returns back how many times the item was requeued
    NumRequeues(item interface{}) int
}

/*
AddRateLimited: 将元素重新放回队列并进行限速
Forget：释放指定元素，清空该元素的排队数。
NumRequeues：获取指定元素的排队数。
*/
</code></pre></div>
</td></tr></table>
<ol>
<li>Scheme</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>import &quot;k8s.io/apimachinery/pkg/runtime/schema&quot;
import metav1 &quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;

// SchemeGroupVersion is group version used to register these objects
var SchemeGroupVersion = schema.GroupVersion{Group: GroupName, Version: &quot;v1alpha1&quot;}

// Adds the list of known types to Scheme.
// AddKnownTypes方法中会通过反射获取到资源对象的名字，然后和GroupVersion组合成GVK，最后用GVK和对象建立映射关系。
func addKnownTypes(scheme *runtime.Scheme) error {
    scheme.AddKnownTypes(SchemeGroupVersion,
        &amp;At{},
        &amp;AtList{},
    )
    // 构建Scheme管理多version
    metav1.AddToGroupVersion(scheme, SchemeGroupVersion)
    return nil
}

func (s *Scheme) AddKnownTypes(gv schema.GroupVersion, types ...Object) {
    s.addObservedVersion(gv)
    for _, obj := range types {
        t := reflect.TypeOf(obj)
        if t.Kind() != reflect.Ptr {
            panic(&quot;All types must be pointers to structs.&quot;)
        }
        t = t.Elem()
        s.AddKnownTypeWithName(gv.WithKind(t.Name()), obj)
    }
}
</code></pre></div>
</td></tr></table>
<ol>
<li>Finalizers</li>
</ol>
<p>Finalizers 字段属于 Kubernetes GC 垃圾收集器，是一种删除拦截机制，能够让控制器实现异步的删除前（Pre-delete）回调。
其存在于任何一个资源对象的 Meta 中，在 k8s 源码中声明为 []string，该 Slice 的内容为需要执行的拦截器名称。</p>
<p>The key point to note is that a finalizer causes “delete” on the object to become an “update” to set deletion timestamp. </p>
<p>finalizer会导致对象的删除变成对象的deletion timestamp字段的更新。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>unc (r *CronJobReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {
    ctx := context.Background()
    log := r.Log.WithValues(&quot;cronjob&quot;, req.NamespacedName)

    var cronJob *batchv1.CronJob
    if err := r.Get(ctx, req.NamespacedName, cronJob); err != nil {
        log.Error(err, &quot;unable to fetch CronJob&quot;)
        // we&#39;ll ignore not-found errors, since they can&#39;t be fixed by an immediate
        // requeue (we&#39;ll need to wait for a new notification), and we can get them
        // on deleted requests.
        return ctrl.Result{}, client.IgnoreNotFound(err)
    }

    // name of our custom finalizer
    myFinalizerName := &quot;storage.finalizers.tutorial.kubebuilder.io&quot;

    // examine DeletionTimestamp to determine if object is under deletion
    if cronJob.ObjectMeta.DeletionTimestamp.IsZero() {
        // The object is not being deleted, so if it does not have our finalizer,
        // then lets add the finalizer and update the object. This is equivalent
        // registering our finalizer.
        // 注册finalizer
        if !containsString(cronJob.ObjectMeta.Finalizers, myFinalizerName) {
            cronJob.ObjectMeta.Finalizers = append(cronJob.ObjectMeta.Finalizers, myFinalizerName)
            if err := r.Update(context.Background(), cronJob); err != nil {
                return ctrl.Result{}, err
            }
        }
    } else {
        // The object is being deleted
        if containsString(cronJob.ObjectMeta.Finalizers, myFinalizerName) {
            // our finalizer is present, so lets handle any external dependency
            if err := r.deleteExternalResources(cronJob); err != nil {
                // if fail to delete the external dependency here, return with error
                // so that it can be retried
                return ctrl.Result{}, err
            }

            // remove our finalizer from the list and update it.
            cronJob.ObjectMeta.Finalizers = removeString(cronJob.ObjectMeta.Finalizers, myFinalizerName)
            if err := r.Update(context.Background(), cronJob); err != nil {
                return ctrl.Result{}, err
            }
        }

        // Stop reconciliation as the item is being deleted
        return ctrl.Result{}, nil
    }

    // Your reconcile logic

    return ctrl.Result{}, nil
}

func (r *Reconciler) deleteExternalResources(cronJob *batch.CronJob) error {
    //
    // delete any external resources associated with the cronJob
    //
    // Ensure that delete implementation is idempotent and safe to invoke
    // multiple types for same object.
}

// Helper functions to check and remove string from a slice of strings.
func containsString(slice []string, s string) bool {
    for _, item := range slice {
        if item == s {
            return true
        }
    }
    return false
}

func removeString(slice []string, s string) (result []string) {
    for _, item := range slice {
        if item == s {
            continue
        }
        result = append(result, item)
    }
    return
}
</code></pre></div>
</td></tr></table>
<p>Ref:
1. https://kubernetes.io/zh/docs/concepts/workloads/controllers/garbage-collection/
2. https://www.kubernetes.org.cn/6839.html
3. https://www.cnblogs.com/luozhiyun/p/13799901.html
4. https://xie.infoq.cn/article/63258ead84821bc3e276de1f7</p>
<h3 id="kubebuilder">Kubebuilder</h3>
<ol>
<li>Install</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nv">os</span><span class="o">=</span><span class="k">$(</span>go env GOOS<span class="k">)</span>
<span class="nv">arch</span><span class="o">=</span><span class="k">$(</span>go env GOARCH<span class="k">)</span>

<span class="c1"># download kubebuilder and extract it to tmp</span>
curl -L https://go.kubebuilder.io/dl/2.3.1/<span class="si">${</span><span class="nv">os</span><span class="si">}</span>/<span class="si">${</span><span class="nv">arch</span><span class="si">}</span> <span class="p">|</span> tar -xz -C /tmp/

<span class="c1"># move to a long-term location and put it on your path</span>
<span class="c1"># (you&#39;ll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)</span>
sudo mv /tmp/kubebuilder_2.3.1_<span class="si">${</span><span class="nv">os</span><span class="si">}</span>_<span class="si">${</span><span class="nv">arch</span><span class="si">}</span> /usr/local/kubebuilder
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/kubebuilder/bin

<span class="c1"># Also, you can install a master snapshot from </span>
https://go.kubebuilder.io/dl/latest/<span class="si">${</span><span class="nv">os</span><span class="si">}</span>/<span class="si">${</span><span class="nv">arch</span><span class="si">}</span>.
</code></pre></div>
</td></tr></table>
<ol>
<li>Create a Project</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>kubebuilder init --domain programming-kubernetes.info --license apache2 --owner <span class="s2">&quot;Programming Kubernetes authors”</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>Create API</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>kubebuilder create api --group cnat --version v1alpha1 --kind At
</code></pre></div>
</td></tr></table>
<ol>
<li>API Interface</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>// AtReconciler reconciles a At object
<span class="nb">type</span> AtReconciler struct <span class="o">{</span>
    client.Client
    Log    logr.Logger
    Scheme *runtime.Scheme
<span class="o">}</span>

// +kubebuilder:rbac:groups<span class="o">=</span>cnat.programming-kubernetes.info,resources<span class="o">=</span>ats,verbs<span class="o">=</span>get<span class="p">;</span>list<span class="p">;</span>watch<span class="p">;</span>create<span class="p">;</span>update<span class="p">;</span>patch<span class="p">;</span>delete
// +kubebuilder:rbac:groups<span class="o">=</span>cnat.programming-kubernetes.info,resources<span class="o">=</span>ats/status,verbs<span class="o">=</span>get<span class="p">;</span>update<span class="p">;</span>patch

// 核心的Reconciler接口，通过client.Client可以访问自定义资源和k8s基本资源
func <span class="o">(</span>r *AtReconciler<span class="o">)</span> Reconcile<span class="o">(</span>req ctrl.Request<span class="o">)</span> <span class="o">(</span>ctrl.Result, error<span class="o">)</span> <span class="o">{</span>
    <span class="nv">_</span> <span class="o">=</span> context.Background<span class="o">()</span>
    <span class="nv">_</span> <span class="o">=</span> r.Log.WithValues<span class="o">(</span><span class="s2">&quot;at&quot;</span>, req.NamespacedName<span class="o">)</span>

    // your logic here

    <span class="k">return</span> ctrl.Result<span class="o">{}</span>, nil
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="operator-sdk">Operator-SDK</h3>
<p>等同于kubebuilder</p>
<h2 id="shipping-controller-and-operator">Shipping Controller and Operator</h2>
<h3 id="packageing">Packageing</h3>
<p>通过helm来渲染YAML文件，解决YAML文件只能是静态的问题，这样就可以动态控制YAML文件了。
还可以通过kustomize</p>
<p>never use the default service account in a namespace</p>
<h2 id="custom-api-server">Custom API Server</h2>
<p>CRD的一些限制:</p>
<ol>
<li>限制只能使用etcd作为存储</li>
<li>不支持protobuf，只能是JSON</li>
<li>只支持/status和/scale两种子资源</li>
<li>不支持graceful deletetion、尽管可以通过Finalizer来模拟，但是不支持指定graceful deletion time</li>
<li>对API Server的负载影响比较大，因为需要用通用的方式来实现所有正常资源需要走的逻辑和算法</li>
<li>只能实现CRUD基本语义</li>
<li>不支持同类资源的存储共享(比如不同API Group的相同资源底层不支持使用相同的存储)</li>
</ol>
<p>相反一个自定义的API Server没有上面的限制。</p>
<ol>
<li>可以使用任何存储，例如metrics API Server可以存储数据在内存中</li>
<li>可以提供protobuf支持</li>
<li>可以提供任意的子资源</li>
<li>可以实现graceful deletion</li>
<li>可以实现所有的操作</li>
<li>可以实现自定义语义，比如原子的分配ip，如果使用webbook的方式可能会因为后续的pipeline导致请求失败，这个时候分配的ip需要取消，但是webhook是没办法做撤销的，需要结合控制器来完成。这就是因为
webhook可能会产生副作用。</li>
<li>可以对底层类型相同的资源，进行共享存储。</li>
</ol>
<p>自定义API Server工作流程:
1. K8s API server接收到请求
2. 请求传递了handler chanin，这里面包含了鉴权、日志审计等
3. 请求会走到kube-aggregator组件，这个组件知道哪些API 请求是需要走自定义API Server的，那些Group走API server这是API Service定义的
4. 转发请求给自定义API Server</p>
<blockquote>
<p>自定义API Server的鉴权可以delegated给k8s的 API Server，通过SubjectAccessReview来实现</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>
</code></pre></div>
</td></tr></table>
<p>// 定义哪些group、version的资源要走自定义Api Server
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apiregistration.k8s.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">APIService</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">API-group-name</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">API-group-version</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">custom-API-server-service-namespace</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">-API-server-service</span>
  <span class="nt">caBundle</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">base64-caBundle</span>
  <span class="nt">insecureSkipTLSVerify</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bool</span>
  <span class="l l-Scalar l-Scalar-Plain">// 相同的group高优先级覆盖低优先级</span>
  <span class="nt">groupPriorityMinimum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2000</span>
  <span class="l l-Scalar l-Scalar-Plain">// 相同group的不同version通过优先级来选择</span>
  <span class="nt">versionPriority</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span>
</code></pre></div>
</td></tr></table></p>
<p>Every API server serves a number of resources and versions 
Some resources have multiple versions. To make multiple versions of a resource possible, the API server converts between versions.
To avoid quadratic growth of necessary conversions between versions, API servers use an internal version when implementing the actual API logic. 
The internal version is also often called hub version because it is a kind of hub that every other version is converted to and from</p>
<p>API Server在内部给每一个资源都维护了一个内部版本，所有的版本都会转换成这个内部版本再去操作。</p>
<ol>
<li>用户发送指定版本的请求给API server(比如v1)</li>
<li>API server解码请求，然后转换为内部版本</li>
<li>API server传递内部版本给admission 和 validation</li>
<li>API server在registry中实现的逻辑是根据内部版本来实现的</li>
<li>etcd读和写带有版本的对象(例如v2，存储版本)，他将从内部版本进行转换。</li>
<li>最终结果会将转换为请求的版本，比如这里就是v1</li>
</ol>
<p>Default和Conversion需要给内部版本和外部版本提供Conversion方法和默认值。</p>
<p>This trick of using a pointer works for primitive types like strings. For maps and arrays, it is often hard to reach roundtrippability without identifying nil maps/arrays and empty maps/arrays.
Most defaulters for maps and arrays in Kubernetes therefore apply the default in both cases, working around encoding and decoding bugs.</p>
<p>对于基本类型如何区分默认的零值是设置了还是没有设置，比如bool默认是false，那用户到底是设置了false、还是没有设置导致默认值用了false呢? k8s通过指针来解决，如果有设置那么指针不为空，否则就是没有设置。</p>
<p>TODO(tianqian.zyf): 实现一个Custom API Server</p>
<h2 id="advanced-custom-resources">Advanced Custom Resources</h2>
<p>versioning、coversion、admission controllers</p>
<p>通过versioning机制可以保证API的演进，同时也可以向后兼容，versiong机制的核心在于Conversion。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apiextensions.k8s.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CustomResourceDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pizzas.restaurant.programming-kubernetes.info</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">restaurant.programming-kubernetes.info</span>
  <span class="nt">names</span><span class="p">:</span>
    <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pizza</span>
    <span class="nt">listKind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PizzaList</span>
    <span class="nt">plural</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pizzas</span>
    <span class="nt">singular</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pizza</span>
  <span class="nt">scope</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Namespaced</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1alpha1</span>
  <span class="nt">versions</span><span class="p">:</span>
  <span class="l l-Scalar l-Scalar-Plain">// 定义v1alpha1为存储版本，</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1alpha1</span>
    <span class="nt">served</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">schema</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1beta1</span>
    <span class="nt">served</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="nt">schema</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
</td></tr></table>
<ol>
<li>The client (e.g., our kubectl get pizza margherita) requests a version.</li>
<li>etcd has stored the object in some version.</li>
<li>If the versions do not match, the storage object is sent to the webhook server for conversion. The webhook returns a response with the converted object.</li>
<li>The converted object is sent back to the client.</li>
</ol>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">ConversionReview</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`json:&quot;,inline&quot;`</span>
    <span class="nx">Request</span> <span class="o">*</span><span class="nx">ConversionRequest</span>
    <span class="nx">Response</span> <span class="o">*</span><span class="nx">ConversionResponse</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
                
              
              
                
<script src="https://utteranc.es/client.js"
        repo="zyfjeff/zyfjeff.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../CppTemplate/" class="md-footer__link md-footer__link--prev" aria-label="上一页: C++ Templates" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              C++ Templates
            </div>
          </div>
        </a>
      
      
        
        <a href="../LuaPrograming/" class="md-footer__link md-footer__link--next" aria-label="下一页: Lua Programing" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Lua Programing
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 - 2021 程序员的Cookbook
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/zyfjeff" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "toc.integrate"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
    
  </body>
</html>