
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://zyfjeff.github.io/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/course/Ultimate_Go_Programing/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>Ultimate Go Programing - 程序员的Cookbook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ultimate-go-programing" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="程序员的Cookbook" class="md-header__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            程序员的Cookbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ultimate Go Programing
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      About
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-tabs__link">
        博客
      </a>
    </li>
  

  

  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../blog/" class="md-tabs__link md-tabs__link--active">
        学习笔记
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/bootstrap/" class="md-tabs__link">
        开源项目
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-tabs__link">
        编程语言
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-tabs__link">
        计算机基础
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="程序员的Cookbook" class="md-nav__button md-logo" aria-label="程序员的Cookbook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    程序员的Cookbook
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/zyfjeff/zyfjeff.github.io/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zyfjeff/zyfjeff.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        博客
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="博客" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          博客
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Doc
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Doc" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Doc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_1" type="checkbox" id="__nav_2_1_1" >
      
      <label class="md-nav__link" for="__nav_2_1_1">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_1">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/basic/linux-debugger/" class="md-nav__link">
        如何在Linux环境下实现一个调试器
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2" type="checkbox" id="__nav_2_1_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_2">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/%E5%A6%82%E4%BD%95mock%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" class="md-nav__link">
        如何mock系统调用
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_2_2" type="checkbox" id="__nav_2_1_2_2" >
      
      <label class="md-nav__link" for="__nav_2_1_2_2">
        Effective Model Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Effective Model Cpp" data-md-level="4">
        <label class="md-nav__title" for="__nav_2_1_2_2">
          <span class="md-nav__icon md-icon"></span>
          Effective Model Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item1/" class="md-nav__link">
        Item1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item38/" class="md-nav__link">
        Item38 Be aware of varying thread handle destructor behavior
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item39/" class="md-nav__link">
        Item39 Consider void futures for one-shot event communication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item40/" class="md-nav__link">
        Item40 Use std::atomic for concurrency, volatile for specific memory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item41/" class="md-nav__link">
        Item41 Consider pass by value for copyable parameters that are cheap to move and always copied.
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/cpp/Effective-Model-Cpp/item42/" class="md-nav__link">
        Item42 Consider emplacement instead of insertion
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_3" type="checkbox" id="__nav_2_1_3" >
      
      <label class="md-nav__link" for="__nav_2_1_3">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_3">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/dispatcher/" class="md-nav__link">
        Envoy源码分析之Dispatcher
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/envoy/thread_local/" class="md-nav__link">
        Envoy源码分析之ThreadLocal
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_4" type="checkbox" id="__nav_2_1_4" >
      
      <label class="md-nav__link" for="__nav_2_1_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%B8%AD%E7%9A%84%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E6%9C%89%E4%BB%80%E4%B9%88%3F/" class="md-nav__link">
        Linux中的可执行程序有什么?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/Linux%E4%BF%A1%E5%8F%B7%E4%B8%93%E9%A2%98FAQ/" class="md-nav__link">
        Linux 信号FAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/linux/%E5%85%B3%E4%BA%8E%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E8%AE%A8%E8%AE%BA/" class="md-nav__link">
        关于文件写入的原子性讨论
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_5" type="checkbox" id="__nav_2_1_5" >
      
      <label class="md-nav__link" for="__nav_2_1_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/lifetime-error-cases/" class="md-nav__link">
        常见的生命周期错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/macros/" class="md-nav__link">
        Macros
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/match-pattern/" class="md-nav__link">
        Match pattern
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-error-handle/" class="md-nav__link">
        Rust错误处理指南
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-match/" class="md-nav__link">
        Rust match
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-misconceptions/" class="md-nav__link">
        常见的生命周期概念错误
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-module/" class="md-nav__link">
        Rust module
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%8D%9A%E5%AE%A2/doc/rust/rust-variance/" class="md-nav__link">
        Rust variance
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        学习笔记
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="学习笔记" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          学习笔记
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Blog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Blog" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        Can Reordering of Release/Acquire Operations Introduce Deadlock?
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/readling_list/" class="md-nav__link">
        待阅读列表
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Book
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Book" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Book
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/%20PracticalSystemProgrammingForRust/" class="md-nav__link">
        Practical System Programing For Rust
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/ConcurrencyModernCpp/" class="md-nav__link">
        Concurrency Modern C++
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/CppTemplate/" class="md-nav__link">
        C++ Templates
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/KubernetesPrograming/" class="md-nav__link">
        Programming Kubernetes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/LuaPrograming/" class="md-nav__link">
        Lua Programing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/MathematicsForComputerScience/" class="md-nav__link">
        Mathematics For Computer Science
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/MuduoCpp/" class="md-nav__link">
        Linux C++ 服务端编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/OS/" class="md-nav__link">
        操作系统导论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../book/ebpf/" class="md-nav__link">
        ebpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" checked>
      
      <label class="md-nav__link" for="__nav_3_3">
        Course
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Course" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Course
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1" type="checkbox" id="__nav_3_3_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1">
        6.824
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="6.824" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_1">
          <span class="md-nav__icon md-icon"></span>
          6.824
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1_1" type="checkbox" id="__nav_3_3_1_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1_1">
        Lecture1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lecture1" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_3_1_1">
          <span class="md-nav__icon md-icon"></span>
          Lecture1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../6.824/lecture1/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../6.824/lecture1/paper-note/" class="md-nav__link">
        Paper note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_2" type="checkbox" id="__nav_3_3_2" checked>
      
      <label class="md-nav__link" for="__nav_3_3_2">
        Ultimate Go Programing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ultimate Go Programing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_2">
          <span class="md-nav__icon md-icon"></span>
          Ultimate Go Programing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Ultimate Go Programing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Ultimate Go Programing
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lesson-1-design-guidelines" class="md-nav__link">
    Lesson 1: Design Guidelines
  </a>
  
    <nav class="md-nav" aria-label="Lesson 1: Design Guidelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#philosophy" class="md-nav__link">
    Philosophy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-reviews" class="md-nav__link">
    Code Reviews
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lesson2-language-syntax" class="md-nav__link">
    Lesson2: Language Syntax
  </a>
  
    <nav class="md-nav" aria-label="Lesson2: Language Syntax">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#variable" class="md-nav__link">
    Variable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#struct" class="md-nav__link">
    Struct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pointer" class="md-nav__link">
    Pointer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#garbage-collection" class="md-nav__link">
    Garbage Collection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compiler-and-runtime-optimizations" class="md-nav__link">
    Compiler And Runtime Optimizations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constans" class="md-nav__link">
    Constans
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#array" class="md-nav__link">
    Array
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice" class="md-nav__link">
    slice
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#map" class="md-nav__link">
    map
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method" class="md-nav__link">
    method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interface" class="md-nav__link">
    interface
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reflection" class="md-nav__link">
    reflection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exporting" class="md-nav__link">
    exporting
  </a>
  
    <nav class="md-nav" aria-label="exporting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#composition" class="md-nav__link">
    Composition
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handing" class="md-nav__link">
    Error Handing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pacakgeing" class="md-nav__link">
    Pacakgeing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goroutines-and-concurrency" class="md-nav__link">
    Goroutines And Concurrency
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-race" class="md-nav__link">
    Data Race
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#channels" class="md-nav__link">
    Channels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compile-args" class="md-nav__link">
    Compile args
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reading-todo" class="md-nav__link">
    Reading TODO
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_3" type="checkbox" id="__nav_3_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3_3">
        信息论
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="信息论" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_3">
          <span class="md-nav__icon md-icon"></span>
          信息论
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%BF%A1%E6%81%AF%E8%AE%BA/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      <label class="md-nav__link" for="__nav_3_4">
        English
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="English" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          English
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_1" type="checkbox" id="__nav_3_4_1" >
      
      <label class="md-nav__link" for="__nav_3_4_1">
        Class1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class1" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_1">
          <span class="md-nav__icon md-icon"></span>
          Class1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class1/READMEN/" class="md-nav__link">
        READMEN
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class1/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class1/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_2" type="checkbox" id="__nav_3_4_2" >
      
      <label class="md-nav__link" for="__nav_3_4_2">
        Class2
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Class2" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_2">
          <span class="md-nav__icon md-icon"></span>
          Class2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class2/kk/" class="md-nav__link">
        Kk
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class2/note/" class="md-nav__link">
        Note
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/class2/sentence/" class="md-nav__link">
        Sentence
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_3" type="checkbox" id="__nav_3_4_3" >
      
      <label class="md-nav__link" for="__nav_3_4_3">
        Hearing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Hearing" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_3">
          <span class="md-nav__icon md-icon"></span>
          Hearing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/hearing/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_4" type="checkbox" id="__nav_3_4_4" >
      
      <label class="md-nav__link" for="__nav_3_4_4">
        Open lan
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Open lan" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_4">
          <span class="md-nav__icon md-icon"></span>
          Open lan
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/open-lan/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_5" type="checkbox" id="__nav_3_4_5" >
      
      <label class="md-nav__link" for="__nav_3_4_5">
        Syntax
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Syntax" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_5">
          <span class="md-nav__icon md-icon"></span>
          Syntax
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/syntax/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_6" type="checkbox" id="__nav_3_4_6" >
      
      <label class="md-nav__link" for="__nav_3_4_6">
        Walk for us
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Walk for us" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_6">
          <span class="md-nav__icon md-icon"></span>
          Walk for us
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/walk_for_us/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_7" type="checkbox" id="__nav_3_4_7" >
      
      <label class="md-nav__link" for="__nav_3_4_7">
        Word list
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Word list" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_7">
          <span class="md-nav__icon md-icon"></span>
          Word list
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../english/word_list/word/" class="md-nav__link">
        Word
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" type="checkbox" id="__nav_3_5" >
      
      <label class="md-nav__link" for="__nav_3_5">
        Paper
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Paper" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Paper
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/bitcask/" class="md-nav__link">
        Bitcask
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        开源项目
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="开源项目" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          开源项目
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      <label class="md-nav__link" for="__nav_4_1">
        Envoy
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Envoy" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Envoy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/bootstrap/" class="md-nav__link">
        Bootstrap启动过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/cluster/" class="md-nav__link">
        Cluster分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/cluster_manager/" class="md-nav__link">
        Cluster Manager初始化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/dpdk/" class="md-nav__link">
        DPDK
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/drain_manager/" class="md-nav__link">
        Drain manager分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/eds/" class="md-nav__link">
        EDS更新过程分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/load_balancer/" class="md-nav__link">
        Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/lua/" class="md-nav__link">
        Lua filter实现分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/overload_manager/" class="md-nav__link">
        Overload manager分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/proxy/" class="md-nav__link">
        Envoy源码分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/stats_symbol/" class="md-nav__link">
        Stats Symbol分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/subset_lb/" class="md-nav__link">
        Subset Load Balancer分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/wasm/" class="md-nav__link">
        Envoy Proxy Wasm分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/envoy/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89Cluster/" class="md-nav__link">
        如何实现自定义Cluster
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/kubernetes/" class="md-nav__link">
        Helm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/kubernetes/basic/" class="md-nav__link">
        Basic
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/kubernetes/tips/" class="md-nav__link">
        Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      <label class="md-nav__link" for="__nav_4_3">
        Leveldb
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Leveldb" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Leveldb
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/leveldb/leveldb/" class="md-nav__link">
        Leveldb源码分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      <label class="md-nav__link" for="__nav_4_4">
        Pilot
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Pilot" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Pilot
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/" class="md-nav__link">
        WIP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/ConfigUpdate/" class="md-nav__link">
        配置更新分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/EnvoyFilter/" class="md-nav__link">
        EnvoyFilter分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/PushContext/" class="md-nav__link">
        PushContext分析
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/concept/" class="md-nav__link">
        基本概念和接口
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/pilot/xds-process/" class="md-nav__link">
        XDS处理流程分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        编程语言
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="编程语言" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          编程语言
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      <label class="md-nav__link" for="__nav_5_1">
        Cpp
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cpp" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Cpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/basic/" class="md-nav__link">
        C++基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp17/" class="md-nav__link">
        C++17 In Details
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/cpp20/" class="md-nav__link">
        C++20
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/design/" class="md-nav__link">
        Design
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/guidelines/" class="md-nav__link">
        Guidelines
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/libevent/" class="md-nav__link">
        Libevent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/memory_order/" class="md-nav__link">
        C++ Memory Order
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_8" type="checkbox" id="__nav_5_1_8" >
      
      <label class="md-nav__link" for="__nav_5_1_8">
        Tips
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tips" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_8">
          <span class="md-nav__icon md-icon"></span>
          Tips
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-1/" class="md-nav__link">
        Tip of the Week #1: string_view
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-10/" class="md-nav__link">
        Tip of the Week #10: Splitting Strings, not Hairs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-101/" class="md-nav__link">
        Tip of the Week #101: Return Values, References, and Lifetimes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-103/" class="md-nav__link">
        Tip of the Week #103: Flags Are Globals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-107/" class="md-nav__link">
        Tip of the Week #107: Reference Lifetime Extension
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-108/" class="md-nav__link">
        Tip of the Week #108: Avoid std::bind
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-109/" class="md-nav__link">
        Tip of the Week #109: Meaningful `const` in Function Declarations
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-11/" class="md-nav__link">
        Tip of the Week #11: Return Policy
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-112/" class="md-nav__link">
        Tip of the Week #112: emplace vs. push_back
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-117/" class="md-nav__link">
        Tip of the Week #117: Copy Elision and Pass-by-value
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-119/" class="md-nav__link">
        Tip of the Week #119: Using-declarations and namespace aliases
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-120/" class="md-nav__link">
        Tip of the Week #120: Return Values are Untouchable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-122/" class="md-nav__link">
        Tip of the Week #122: Test Fixtures, Clarity, and Dataflow
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-123/" class="md-nav__link">
        Tip of the Week #123: absl::optional and std::unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-126/" class="md-nav__link">
        Tip of the Week #126: `make_unique` is the new `new`
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-24/" class="md-nav__link">
        Tip of the Week #24: Copies, Abbrv
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-3/" class="md-nav__link">
        Tip of the Week #3: String Concatenation and operator+ vs. StrCat()
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-36/" class="md-nav__link">
        Tip of the Week #36: New Join API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-42/" class="md-nav__link">
        Tip of the Week #42: Prefer Factory Functions to Initializer Methods
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-45/" class="md-nav__link">
        Tip of the Week #45: Avoid Flags, Especially in Library Code
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-49/" class="md-nav__link">
        Tip of the Week #49: Argument-Dependent Lookup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-55/" class="md-nav__link">
        Tip of the Week #55: Name Counting and unique_ptr
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-59/" class="md-nav__link">
        Tip of the Week #59: Joining Tuples
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-61/" class="md-nav__link">
        Tip of the Week #61: Default Member Initializers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-64/" class="md-nav__link">
        Tip of the Week #64: Raw String Literals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-65/" class="md-nav__link">
        Tip of the Week #65: Putting Things in their Place
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-74/" class="md-nav__link">
        Tip of the Week #74: Delegating and Inheriting Constructors
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-77/" class="md-nav__link">
        Tip of the Week #77: Temporaries, Moves, and Copies
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-86/" class="md-nav__link">
        Tip of the Week #86: Enumerating with Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-88/" class="md-nav__link">
        Tip of the Week #88: Initialization: =, (), and {}
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-90/" class="md-nav__link">
        Tip of the Week #90: Retired Flags
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-93/" class="md-nav__link">
        Tip of the Week #93: using absl::Span
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-94/" class="md-nav__link">
        Tip of the Week #94: Callsite Readability and bool Parameters
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/cpp/tips/tips-99/" class="md-nav__link">
        Tip of the Week #99: Nonmember Interface Etiquette
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      <label class="md-nav__link" for="__nav_5_2">
        Golang
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Golang" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Golang
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/note/" class="md-nav__link">
        Go Tips
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      <label class="md-nav__link" for="__nav_5_3">
        Lua
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Lua" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Lua
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/lua/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" >
      
      <label class="md-nav__link" for="__nav_5_4">
        Python
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/python/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" >
      
      <label class="md-nav__link" for="__nav_5_5">
        Rust
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rust" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Rust
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/Note/" class="md-nav__link">
        Rust学习笔记
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5_3" type="checkbox" id="__nav_5_5_3" >
      
      <label class="md-nav__link" for="__nav_5_5_3">
        Library
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Library" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_5_3">
          <span class="md-nav__icon md-icon"></span>
          Library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/library/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        计算机基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="计算机基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          计算机基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      <label class="md-nav__link" for="__nav_6_1">
        Algorithm
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Algorithm" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          Algorithm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/" class="md-nav__link">
        负载均衡算法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/algorithm/skiplist/" class="md-nav__link">
        跳表分析
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      <label class="md-nav__link" for="__nav_6_2">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/" class="md-nav__link">
        OS基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/Reverse/" class="md-nav__link">
        Reverse
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/compiler/" class="md-nav__link">
        编译器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/concurrency/" class="md-nav__link">
        并发编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/gdb/" class="md-nav__link">
        GDB Tips
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/review/" class="md-nav__link">
        面试题
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/tls/" class="md-nav__link">
        SSL
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_8" type="checkbox" id="__nav_6_2_8" >
      
      <label class="md-nav__link" for="__nav_6_2_8">
        Bazel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bazel" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_8">
          <span class="md-nav__icon md-icon"></span>
          Bazel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/basic/bazel/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      <label class="md-nav__link" for="__nav_6_3">
        Design
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Design" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Design
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/design/" class="md-nav__link">
        设计模式
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      <label class="md-nav__link" for="__nav_6_4">
        Linux
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Linux" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/asm_syscall/" class="md-nav__link">
        Linux: x86-64 syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_socket_balancing/" class="md-nav__link">
        三种常见的socket balancing模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/linux_syscall/" class="md-nav__link">
        Linux syscall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/shell/" class="md-nav__link">
        Shell
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_6" type="checkbox" id="__nav_6_4_6" >
      
      <label class="md-nav__link" for="__nav_6_4_6">
        Bpf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Bpf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_6">
          <span class="md-nav__icon md-icon"></span>
          Bpf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/READMME/" class="md-nav__link">
        READMME
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/bpf/seccomp-bpf/" class="md-nav__link">
        Seccomp bpf
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_7" type="checkbox" id="__nav_6_4_7" >
      
      <label class="md-nav__link" for="__nav_6_4_7">
        Ftrace
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ftrace" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_7">
          <span class="md-nav__icon md-icon"></span>
          Ftrace
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/ftrace/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_8" type="checkbox" id="__nav_6_4_8" >
      
      <label class="md-nav__link" for="__nav_6_4_8">
        Fuse
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Fuse" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_8">
          <span class="md-nav__icon md-icon"></span>
          Fuse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/fuse/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_9" type="checkbox" id="__nav_6_4_9" >
      
      <label class="md-nav__link" for="__nav_6_4_9">
        Io
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Io" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_9">
          <span class="md-nav__icon md-icon"></span>
          Io
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/io/io_uring/" class="md-nav__link">
        Io uring
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_10" type="checkbox" id="__nav_6_4_10" >
      
      <label class="md-nav__link" for="__nav_6_4_10">
        Network
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Network" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_10">
          <span class="md-nav__icon md-icon"></span>
          Network
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/epoll/" class="md-nav__link">
        Epoll
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/ip_transparent/" class="md-nav__link">
        Ip transparent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp-ip-program/" class="md-nav__link">
        Tcp ip program
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_back_log/" class="md-nav__link">
        Tcp back log
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_fast_open/" class="md-nav__link">
        Tcp fast open
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/tcp_splicing/" class="md-nav__link">
        SOCKMAP - TCP splicing of the future
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/time_wait/" class="md-nav__link">
        Time wait
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/network/virtual-network/" class="md-nav__link">
        Virtual network
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_11" type="checkbox" id="__nav_6_4_11" >
      
      <label class="md-nav__link" for="__nav_6_4_11">
        Perf
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Perf" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_11">
          <span class="md-nav__icon md-icon"></span>
          Perf
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/perf/" class="md-nav__link">
        性能优化基础
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_12" type="checkbox" id="__nav_6_4_12" >
      
      <label class="md-nav__link" for="__nav_6_4_12">
        Synchronization
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Synchronization" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_12">
          <span class="md-nav__icon md-icon"></span>
          Synchronization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/synchronization/memory_order/" class="md-nav__link">
        Memory order
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4_13" type="checkbox" id="__nav_6_4_13" >
      
      <label class="md-nav__link" for="__nav_6_4_13">
        System interface
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="System interface" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_4_13">
          <span class="md-nav__icon md-icon"></span>
          System interface
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/linux/system_interface/" class="md-nav__link">
        Index
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      <label class="md-nav__link" for="__nav_6_5">
        Why
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Why" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          Why
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/why/" class="md-nav__link">
        计算机基础百科
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zyfjeff/zyfjeff.github.io/edit/master/docs/学习笔记/course/Ultimate_Go_Programing/README.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="ultimate-go-programing">Ultimate Go Programing</h1>
<h2 id="lesson-1-design-guidelines">Lesson 1: Design Guidelines</h2>
<h3 id="philosophy">Philosophy</h3>
<ol>
<li>
<p>Open Your Mind:</p>
<ul>
<li>Technology changes quickly but people's minds change slowly.</li>
<li>Easy to adopt new technology but hard to adopt new ways of thinking.</li>
</ul>
</li>
<li>
<p>Interesting Questions - What do they mean to you?</p>
<ul>
<li>Is it a good program?</li>
<li>Is it an efficient program?</li>
<li>Is it correct?</li>
<li>Was it done on time?</li>
<li>What did it cost?</li>
</ul>
</li>
<li>
<p>Aspire To</p>
<ul>
<li>Be a champion for quality, efficiency and simplicity.</li>
<li>Have a point of view.</li>
<li>Value introspection and self-review.</li>
</ul>
</li>
<li>
<p>Reading Code</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>“If most computer people lack understanding and knowledge, then what they will select will also be lacking.” - Alan Kay</p>
<p>"The software business is one of the few places we teach people to write before we teach them to read." - Tom Love (inventor of Objective C)</p>
<p>"Code is read many more times than it is written." - Dave Cheney</p>
<p>"Programming is, among other things, a kind of writing. One way to learn writing is to write, but in all other forms of writing, one also reads. </p>
<p>We read examples both good and bad to facilitate learning. But how many programmers learn to write programs by reading programs?" - Gerald M. Weinberg</p>
<p>"Skill develops when we produce, not consume." - Katrina Owen</p>
</div>
</li>
<li>
<p>Productivity vs Performance</p>
<p>遵循Go的idioms和guideliness，我们将会同时拥有性能和开发效率，在过于这是需要二选一的，而大家更多是选择了开发效率，并希望通过硬件的发展来提高性能。这也导致了为此设计的语言产生了大量低效的软件。</p>
</li>
<li>
<p>Correctness vs Performance</p>
<p>您想要编写针对正确性进行了优化的代码。不要根据您认为可能会更好的性能来做出编码决策。您必须进行基准测试以了解代码是否不够快以此来决定是否需要优化。</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>"Make it correct, make it clear, make it concise, make it fast. In that order." - Wes Dyer</p>
<p>"Good engineering is less about finding the "perfect" solution and more about understanding the tradeoffs and being able to explain them." - JBD</p>
<p>"The correctness of the implementation is the most important concern, but there is no royal road to correctness. It involves diverse tasks such as thinking of invariants, testing and code reviews. Optimization should be done, but not prematurely." - Al Aho (inventor of AWK)</p>
<p>"The basic ideas of good style, which are fundamental to write clearly and simply, are just as important now as they were 35 years ago. Simple, straightforward code is just plain easier to work with and less likely to have problems. As programs get bigger and more complicated, it's even more important to have clean, simple code." - Brian Kernighan</p>
<p>"Problems can usually be solved with simple, mundane solutions. That means there's no glamorous work. You don't get to show off your amazing skills. You just build something that gets the job done and then move on. This approach may not earn you oohs and aahs, but it lets you get on with it." - Jason Fried</p>
</div>
</li>
<li>
<p>Code Reviews</p>
<p>没有设计哲学，您就无法看一段代码，函数或算法，并确定它是好是坏。这四个主要类别是代码审查的基础，应按此顺序排列优先级：完整性，可读性，简单性和性能。您必须有意识地并且有充分的理由能够解释您选择的类别。</p>
</li>
</ol>
<h3 id="code-reviews">Code Reviews</h3>
<ul>
<li>
<p>Integrity</p>
<p><strong>We need to become very serious about reliability.</strong></p>
<ol>
<li>
<p>Integrity is about every allocation, read and write of memory being accurate, consistent and efficient. The type system is critical to making sure we have this micro level of integrity.</p>
</li>
<li>
<p>Integrity is about every data transformation being accurate, consistent and efficient. Writing less code and error handling is critical to making sure we have this macro level of integrity.</p>
</li>
</ol>
<p><strong>Write Less Code</strong></p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>There have been studies that have researched the number of bugs you can expect to have in your software. The industry average is around 15 to 50 bugs per 1000 lines of code. One simple way to reduce the number of bugs, and increase the integrity of your software, is to write less code.</p>
</div>
<p><strong>Error Handling</strong></p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>When error handling is treated as an exception and not part of the main code, you can expect the majority of your critical failures to be due to error handling.</p>
</div>
</li>
<li>
<p>Readability</p>
<p>代码要易于阅读和理解，而无需花费精力。同样重要的是，它不隐藏每行代码，功能，程序包及其运行的整体生态系统的成本/影响。</p>
<p><strong>Code Must Never Lie</strong></p>
</li>
<li>
<p>Simplicity</p>
<p>我们必须了解，简单性很难设计，而且构建起来很复杂。我们必须将许多维护和设计变得简单，因为这可能导致更多的问题。它可能会引起可读性问题，并可能导致性能问题。</p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>"Simplicity is a great virtue but it requires hard work to achieve it and education to appreciate it. And to make matters worse: complexity sells better." - Edsger W. Dijkstra
"Everything should be made as simple as possible, but not simpler." - Albert Einstein
"You wake up and say, I will be productive, not simple, today." - Dave Cheney</p>
</div>
<p>封装是我们40年来一直试图解决的问题。 Go对该软件包采取了一种新的方法。提升封装水平，并在语言级别提供更丰富的支持。</p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>"The purpose of abstraction is not to be vague, but to create a new semantic level in which one can be absolutely precise - Edsger W. Dijkstra</p>
</div>
</li>
<li>
<p>Performance</p>
<p>我们必须减少计算以获得所需的结果。</p>
<p>Rules of Performance:
* Never guess about performance.
* Measurements must be relevant.
* Profile before you decide something is performance critical.
* Test to know you are correct.</p>
</li>
<li>
<p>Micro-Optimizations</p>
<p>微观优化是要尽可能地压缩每个代码快性能。当以此优先级编写代码时，很难编写可读，简单或惯用的代码。您正在编写巧妙的代码，这些代码可能需要<code>unsafe</code>的软件包，或者可能需要放入汇编中。</p>
</li>
</ul>
<h2 id="lesson2-language-syntax">Lesson2: Language Syntax</h2>
<h3 id="variable">Variable</h3>
<ul>
<li>
<p>When variables are being declared to their zero value, use the keyword var.</p>
</li>
<li>
<p>When variables are being declared and initialized, use the short variable declaration operator.</p>
</li>
<li>
<p>小心<code>:=</code>赋值</p>
</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">string</span>

    <span class="nx">killswitch</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;KILLSWITCH&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">killswitch</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;kill switch is off&quot;</span><span class="p">)</span>
        <span class="c1">// data被当作全新的变量，覆盖了上面的data</span>
        <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getData</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;ERROR!&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Data was fetched! %d\n&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">getData</span><span class="p">()</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Simulating getting the data from a datasource - lets say a DB.</span>
    <span class="k">return</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;there&quot;</span><span class="p">,</span><span class="s">&quot;are&quot;</span><span class="p">,</span><span class="s">&quot;no&quot;</span><span class="p">,</span><span class="s">&quot;strings&quot;</span><span class="p">,</span><span class="s">&quot;on&quot;</span><span class="p">,</span><span class="s">&quot;me&quot;</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Reference
<a href="https://talks.golang.org/2014/names.slide#1">What's in a name?</a></li>
</ul>
<h3 id="struct">Struct</h3>
<ul>
<li>
<p>Memory alignment</p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>All memory is allocated on an alignment boundary to minimize memory defragmentation. To determine the alignment boundary Go is using for your architecture, you can run the unsafe.Alignof function. The alignment boundary in Go for the 64bit Darwin platform is 8 bytes. So when Go determines the memory allocation for our structs, it will pad bytes to make sure the final memory footprint is a multiple of 8. The compiler will determine where to add the padding.</p>
<p>为什么要填充1个字节呢？,这个目的是为了让整体的大小是字的倍数，字长一般都是2、4、8、16这样的2的幂次方，对于64位的CPU来说，这里只需要填充1个字节就可以满足这个要求。</p>
</div>
<p>CPU每次读取内存都是按照一个字来读取，不同的CPU架构所代表的大小不同，对于64位的CPU来说，一个字就是8个字节，CPU每次读和写都只能操作一个字的内存，因此为了高效的读取变量，我们应该让变量
占用的内存控制在一个字内，而不是跨两个字，这样会导致CPU多读取一次。为此我们需要对内存进行padding，以保证变量不会跨多个字存放。比如下面这个结构体。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Example</span> <span class="kd">struct</span><span class="p">{</span>
    <span class="nx">BoolValue</span> <span class="kt">bool</span>
    <span class="nx">IntValue</span>  <span class="kt">int16</span>
    <span class="nx">FloatValue</span> <span class="kt">float32</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>上面的<code>struct</code>最终会padding一个字节，总占用为8个字节，通过这段代码<a href="Lesson2/alignment.go">alignment</a>可以看出，<code>BoolValue</code>的地方填充了一个字节。</p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>为什么是在<code>BoolValue</code>处填充一个字节呢?，而不是在<code>IntValue</code>的旁边填充？ 或者是在<code>FloatValue</code>的旁边填充呢? 
可以试着枚举一下，如果是在<code>IntValue</code>处填充1个字节，那么如果字长是2字节，那么<code>IntValue</code>就会跨多个字存放(一半在前一个字，一半在后一个字)，为了解决这个问题，只能是在<code>BoolValue</code>处填充。
大家可以试着枚举下，假设位长位2、4、8的时候，在哪里填充可以避免跨多个字存放，最后的结论就是在<code>BoolValue</code>处存放最佳。</p>
</div>
</li>
<li>
<p>Anonymous struct</p>
<p>Go中是不允许隐式类型转换的，两个不同的struct即使是具有完全相同的字段和顺序，也不能进行隐式转换。但是通过匿名struct就可以做了。具体代码见<a href="Lesson2/anonymous_struct.go">anonymous_struct.go</a></p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p>"Implicit conversion of types is the Halloween special of coding. Whoever thought of them deserves their own special hell." - Martin Thompson</p>
<p>我们应该尽可能去避免使用隐式转换。</p>
</div>
</li>
<li>
<p>Embedded Types</p>
<p>结构体类型可以包含匿名或嵌入式字段。这也称为嵌入类型，当我们将一个类型嵌入到结构中时，该类型的名称将充当随后嵌入字段的字段名称。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Admin</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">User</span>
    <span class="nx">Level</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>这并非继承，而是一种组合模式，接着我们来看看如何创建带有嵌入式字段的<code>struct</code></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">admin</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Admin</span><span class="p">{</span>
        <span class="c1">// 和创建普通的struct一样，使用类型名作为字段名</span>
        <span class="nx">User</span><span class="p">:</span> <span class="nx">User</span><span class="p">{</span>
            <span class="nx">Name</span><span class="p">:</span>  <span class="s">&quot;john smith&quot;</span><span class="p">,</span>
            <span class="nx">Email</span><span class="p">:</span> <span class="s">&quot;john@email.com&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">Level</span><span class="p">:</span> <span class="s">&quot;super&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">SendNotification</span><span class="p">(</span><span class="nx">admin</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Output</span>
<span class="nx">User</span><span class="p">:</span> <span class="nx">Sending</span> <span class="nx">User</span> <span class="nx">Email</span> <span class="nx">To</span> <span class="nx">john</span> <span class="nx">smith</span><span class="p">&lt;</span><span class="nx">john</span><span class="err">@</span><span class="nx">email</span><span class="p">.</span><span class="nx">com</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></table>
<p>通过这种方式的组合，使得Admin实现User所有的接口。</p>
</li>
<li>
<p>Reference</p>
<ul>
<li>
<p><a href="https://www.ardanlabs.com/blog/2013/07/understanding-type-in-go.html">Understanding Type in Go</a></p>
</li>
<li>
<p><a href="https://www.ardanlabs.com/blog/2013/07/object-oriented-programming-in-go.html">Object Oriented Programming in Go</a></p>
</li>
<li>
<p><a href="https://dave.cheney.net/2015/10/09/padding-is-hard">Padding is hard</a></p>
</li>
</ul>
</li>
</ul>
<h3 id="pointer">Pointer</h3>
<p>指针语义和值语义，前者是共享的，存在副作用，涉及到data race、逃逸分析等，而后者无副作用，但是存在拷贝开销。
在Go中是goroutine中是没办法指向另外一个goroutine的栈的，这是因为goroutine的栈是会增长的，如果发生增长会导致栈被拷贝到另外一个更大的栈空间上，这就导致了指针失效了。下面这段代码演示了栈增长的情况。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="c1">// Number of elements to grow each stack frame.</span>
<span class="c1">// Run with 10 and then with 1024</span>
<span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">1024</span>

<span class="c1">// main is the entry point for the application.</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">:=</span> <span class="s">&quot;HELLO&quot;</span>
    <span class="nx">stackCopy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="nx">size</span><span class="p">]</span><span class="kt">int</span><span class="p">{})</span>
<span class="p">}</span>

<span class="c1">// stackCopy recursively runs increasing the size</span>
<span class="c1">// of the stack.</span>
<span class="kd">func</span> <span class="nx">stackCopy</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="kt">string</span><span class="p">,</span> <span class="nx">c</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">a</span> <span class="p">[</span><span class="nx">size</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">println</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="o">*</span><span class="nx">s</span><span class="p">)</span>

    <span class="nx">c</span><span class="o">++</span>
    <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="mi">10</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">stackCopy</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>与 GCC 相似，在 Golang 的 goroutine 的实现中也应用了类似的技术。在 1.3 版本及以前采用的是分段栈的实现，在初始时会对每个 goroutine 分配 8KB 的内存，而在 goroutine 内部每个函数的调用时，会检查栈空间是否足够使用，若不够则调用 morestack 进行额外的栈空间申请，申请完毕后连接到旧栈空间上，在函数结束时会调用 lessstack 来回收多余的栈空间。由于栈的缩减是一个相对来说开销较大的逻辑，尤其在一个较深的递归中，会有较多的 morestack 和 lessstack 调用，这种问题被成为热分裂问题。Golang 1.4 通过栈复制法来解决这个问题，在栈空间不足时，不会申请一个新的栈空间块链接到老的栈空间快上，而是创建一个原来两倍大小的栈空间块，并将旧栈信息拷贝至新栈中。这样对于栈的缩减，没有多余的开销，同时在第二次拓展栈时，也无需再次申请空间。针对栈复制中指针的问题，由于垃圾回收机制的存在，可以找到哪部分的栈使用了指针，通过对应可以将指针地址进行相应的更新。</p>
</div>
<ul>
<li>
<p>逃逸分析</p>
<ol>
<li>
<p>当函数中返回的值被函数外所引用的时候，会导致这个值进行了逃逸，分配在堆上，例如下面这个例子</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="kt">string</span>
    <span class="nx">email</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">u1</span> <span class="o">:=</span> <span class="nx">createUser</span><span class="p">()</span>

    <span class="nb">println</span><span class="p">(</span><span class="s">&quot;u1&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 这里返回的指针指向栈上分配的user，这会导致逃逸分析生效</span>
<span class="c1">// 将user分配在堆上，避免因为函数结束栈被清理导致指针失效。</span>
<span class="c1">// 避免内联，否则就没有逃逸分析了</span>
<span class="c1">//go:noinline</span>
<span class="kd">func</span> <span class="nx">createUser</span><span class="p">()</span> <span class="o">*</span><span class="nx">user</span> <span class="p">{</span>
    <span class="nx">u</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">{</span>
        <span class="nx">name</span><span class="p">:</span>  <span class="s">&quot;Bill&quot;</span><span class="p">,</span>
        <span class="nx">email</span><span class="p">:</span> <span class="s">&quot;bill@ardanlabs.com&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nb">println</span><span class="p">(</span><span class="s">&quot;U&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">u</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>逃逸分析的结果如下<a href="Lesson2/escape/escape1.go">escape1.go</a>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./escape.go:17:6: cannot inline createUserV1: marked go:noinline
./escape.go:31:6: cannot inline createUserV2: marked go:noinline
./escape.go:8:6: cannot inline main: <span class="k">function</span> too complex: cost <span class="m">133</span> exceeds budget <span class="m">80</span>
./escape.go:32:2: u escapes to heap:
./escape.go:32:2:   flow: ~r0 <span class="o">=</span> <span class="p">&amp;</span>u:
./escape.go:32:2:     from <span class="p">&amp;</span>u <span class="o">(</span>address-of<span class="o">)</span> at ./escape.go:38:9
./escape.go:32:2:     from <span class="k">return</span> <span class="p">&amp;</span>u <span class="o">(</span><span class="k">return</span><span class="o">)</span> at ./escape.go:38:2
./escape.go:32:2: moved to heap: u
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>当编译器发现一个值的大小无法在栈上存放的时候会将其分配在堆上</p>
</li>
<li>
<p>当编译器无法在编译时知道值的大小时就选择在堆上进行分配</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;bytes&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">size</span> <span class="o">:=</span> <span class="mi">10</span>
    <span class="c1">// size的值是编译时无法知道的，如果这里改成10，就不会有逃逸分析了</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBuffer</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>逃逸分析的结果如下<a href="Lesson2/escape/escape2.go">escape2.go</a>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./escape2.go:7:6: cannot inline main: <span class="k">function</span> too complex: cost <span class="m">84</span> exceeds budget <span class="m">80</span>
./escape2.go:10:22: inlining call to bytes.NewBuffer func<span class="o">([]</span>byte<span class="o">)</span> *bytes.Buffer <span class="o">{</span> <span class="k">return</span> <span class="p">&amp;</span>bytes.Buffer literal <span class="o">}</span>
./escape2.go:9:11: make<span class="o">([]</span>byte, size<span class="o">)</span> escapes to heap:
./escape2.go:9:11:   flow: <span class="o">{</span>heap<span class="o">}</span> <span class="o">=</span> <span class="p">&amp;</span><span class="o">{</span>storage <span class="k">for</span> make<span class="o">([]</span>byte, size<span class="o">)}</span>:
./escape2.go:9:11:     from make<span class="o">([]</span>byte, size<span class="o">)</span> <span class="o">(</span>non-constant size<span class="o">)</span> at ./escape2.go:9:11
./escape2.go:9:11: make<span class="o">([]</span>byte, size<span class="o">)</span> escapes to heap
./escape2.go:10:22: <span class="p">&amp;</span>bytes.Buffer literal does not escape
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>当变量赋值给interface或者函数的时候会导致逃逸</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;bytes&quot;</span>
<span class="p">)</span>

<span class="c1">//go:noinline</span>
<span class="kd">func</span> <span class="nx">InterfaceMethod</span><span class="p">(</span><span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">size</span> <span class="o">:=</span> <span class="mi">10</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">NewBuffer</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
    <span class="c1">// 导致逃逸分析</span>
    <span class="nx">InterfaceMethod</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>逃逸分析的结果如下<a href="Lesson2/escape/escape3.go">escape3.go</a>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./escape3.go:8:6: cannot inline InterfaceMethod: marked go:noinline
./escape3.go:11:6: cannot inline main: <span class="k">function</span> too complex: cost <span class="m">145</span> exceeds budget <span class="m">80</span>
./escape3.go:14:22: inlining call to bytes.NewBuffer func<span class="o">([]</span>byte<span class="o">)</span> *bytes.Buffer <span class="o">{</span> <span class="k">return</span> <span class="p">&amp;</span>bytes.Buffer literal <span class="o">}</span>
./escape3.go:8:22: value does not escape
./escape3.go:13:11: make<span class="o">([]</span>byte, size<span class="o">)</span> escapes to heap:
./escape3.go:13:11:   flow: <span class="o">{</span>heap<span class="o">}</span> <span class="o">=</span> <span class="p">&amp;</span><span class="o">{</span>storage <span class="k">for</span> make<span class="o">([]</span>byte, size<span class="o">)}</span>:
./escape3.go:13:11:     from make<span class="o">([]</span>byte, size<span class="o">)</span> <span class="o">(</span>non-constant size<span class="o">)</span> at ./escape3.go:13:11
./escape3.go:13:11: make<span class="o">([]</span>byte, size<span class="o">)</span> escapes to heap
./escape3.go:14:22: <span class="p">&amp;</span>bytes.Buffer literal does not escape
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>赋值给指针导致的逃逸</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">BenchmarkAssignmentIndirect</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">type</span> <span class="nx">X</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="o">*</span><span class="kt">int</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i1</span> <span class="kt">int</span>
        <span class="nx">x1</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">X</span><span class="p">{</span>
            <span class="nx">p</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">i1</span><span class="p">,</span> <span class="c1">// GOOD: i1 does not escape</span>
        <span class="p">}</span>
        <span class="nx">_</span> <span class="p">=</span> <span class="nx">x1</span>

        <span class="kd">var</span> <span class="nx">i2</span> <span class="kt">int</span>
        <span class="nx">x2</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">X</span><span class="p">{}</span>
        <span class="nx">x2</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">i2</span> <span class="c1">// BAD: Cause of i2 escape</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>逃逸分析的结果如下<a href="Lesson2/escape/flaws/example1/example1_test.go">example1_test.go</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./example1_test.go:5:6: cannot inline BenchmarkAssignmentIndirect: unhandled op DCLTYPE
./example1_test.go:16:7: i2 escapes to heap:
./example1_test.go:16:7:   flow: <span class="o">{</span>heap<span class="o">}</span> <span class="o">=</span> <span class="p">&amp;</span>i2:
./example1_test.go:16:7:     from <span class="p">&amp;</span>i2 <span class="o">(</span>address-of<span class="o">)</span> at ./example1_test.go:18:10
./example1_test.go:16:7:     from x2.p <span class="o">=</span> <span class="p">&amp;</span>i2 <span class="o">(</span>assign<span class="o">)</span> at ./example1_test.go:18:8
./example1_test.go:5:34: b does not escape
./example1_test.go:16:7: moved to heap: i2
./example1_test.go:11:9: <span class="p">&amp;</span>X literal does not escape
./example1_test.go:17:9: <span class="p">&amp;</span>X literal does not escape
</code></pre></div>
</td></tr></table>
<p>如果是赋值给指针的指针也是会导致逃逸的。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span>
    <span class="nx">pp</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="o">*</span><span class="kt">int</span><span class="p">)</span>
    <span class="o">*</span><span class="nx">pp</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">i</span> <span class="c1">// BAD: i escapes</span>
    <span class="nx">_</span> <span class="p">=</span> <span class="nx">pp</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>逃逸分析的结果如下<a href="Lesson2/escape/escape3.go">escape4.go</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./escape4.go:3:6: can inline main with cost <span class="m">20</span> as: func<span class="o">()</span> <span class="o">{</span> i :<span class="o">=</span> <span class="m">0</span><span class="p">;</span> pp :<span class="o">=</span> new<span class="o">(</span>*int<span class="o">)</span><span class="p">;</span> *pp <span class="o">=</span> <span class="p">&amp;</span>i<span class="p">;</span> <span class="nv">_</span> <span class="o">=</span> pp <span class="o">}</span>
./escape4.go:4:2: i escapes to heap:
./escape4.go:4:2:   flow: <span class="o">{</span>heap<span class="o">}</span> <span class="o">=</span> <span class="p">&amp;</span>i:
./escape4.go:4:2:     from <span class="p">&amp;</span>i <span class="o">(</span>address-of<span class="o">)</span> at ./escape4.go:6:8
./escape4.go:4:2:     from *pp <span class="o">=</span> <span class="p">&amp;</span>i <span class="o">(</span>assign<span class="o">)</span> at ./escape4.go:6:6
./escape4.go:4:2: moved to heap: i
./escape4.go:5:11: new<span class="o">(</span>*int<span class="o">)</span> does not escape
</code></pre></div>
</td></tr></table>
</li>
</ol>
</li>
</ul>
<p>对于接口的使用意见:</p>
<p>Use an interface when:</p>
<ol>
<li>users of the API need to provide an implementation detail.</li>
<li>API’s have multiple implementations they need to maintain internally.</li>
<li>parts of the API that can change have been identified and require decoupling.</li>
</ol>
<p>Don’t use an interface:</p>
<ol>
<li>for the sake of using an interface.</li>
<li>to generalize an algorithm.</li>
<li>when users can declare their own interfaces.</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code>go build -gcflags "-m -m"</code> 添加gcflags可以显示处哪些变量进行了逃逸</p>
</div>
<h3 id="garbage-collection">Garbage Collection</h3>
<p>垃圾回收几个阶段:</p>
<ol>
<li>
<p>Mark Setup - STW</p>
<p>在这个阶段需要找到一个安全点，让所有的goroutine都停下来，在1.14之前，Go中的函数调用是一个安全点，当gorountine执行函数调用的时候就停止，但是这个存在一个问题，如果一个goroutine
一直在做密集的计算，没有进行函数调用，这会导致GC的采集停止不前。在1.14后Go中引入了抢占来解决这个问题。</p>
<p><a href="https://github.com/golang/go/issues/24543">runtime: non-cooperative goroutine preemption</a></p>
</li>
<li>
<p>Marking - Concurrent</p>
<p>在标记阶段，垃圾回收会控制自己所占用的CPU为整体的1/4(其他的CPU用于程序运行)，在这个阶段，GC会扫描goroutine的栈，找到栈中指向堆的指针进行标记。标记阶段的吞吐量为<code>1MB/ms * 1/4 * CPU核心数</code>
如果在标记阶段，应用分配内存的速度大于标记的速度，这个时候会启用<code>Mark Assist</code>占用更多的CPU来协助进行标记。但是不会占用太多的<code>Mark Assist</code>，与其这样占用太多<code>Mark Assist</code>，还不如今早开启下一次GC回收。所以GC会控制<code>Mark Assist</code>的数量。</p>
</li>
<li>
<p>Mark Termination - STW</p>
<p>标记阶段的最后工作是Mark Termination，关闭内存屏障，停止后台标记以及辅助标记，做一些清理工作，整个过程也需要STW，大概需要60-90微秒。在此之后，所有的P都能继续为应用程序G服务了。</p>
</li>
<li>
<p>Sweeping - Concurrent</p>
<p>在标记工作完成之后，剩下的就是清理过程了，清理过程的本质是将没有被使用的内存块整理回收给上一个内存管理层级(mcache -&gt; mcentral -&gt; mheap -&gt; OS)，清理回收的开销被平摊到应用程序的每次内存分配操作中，
直到所有内存都Sweeping完成。当然每个层级不会全部将待清理内存都归还给上一级，避免下次分配再申请的开销，比如Go1.12对mheap归还OS内存做了优化，使用NADV_FREE延迟归还内存。</p>
</li>
</ol>
<p><strong>GC percentage</strong></p>
<p>runtime中有一个配置选项叫做 GC Percentage，默认值是100。这个值代表了下一次回收开始之前，有多少新的堆内存可以分配。GC Percentage设置为100意味着，基于回收完成之后被标记为生存的堆内存数量，下一次回收的开始必须在有100%以上的新内存分配到堆内存时启动。如果新分配的内存并没有到达100%就触发了下一次GC，这个可能是因为应用内存分配速度太快，GC不希望分配太多的<code>Mark Assist</code>，因此尽快的启动了下一次GC。</p>
<p><strong>GC Trcae</strong></p>
<ol>
<li><code>GODEBUG=gctrace=1</code> 开启GC Trace</li>
<li>
<p><code>GODEBUG=gctrace=1,gcpacertrace=1</code> 开启更详细的GC Trace</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>gc <span class="m">1405</span> @6.068s <span class="m">11</span>%: <span class="m">0</span>.058+1.2+0.083 ms clock, <span class="m">0</span>.70+2.5/1.5/0+0.99 ms cpu, <span class="m">7</span>-&gt;11-&gt;6 MB, <span class="m">10</span> MB goal, <span class="m">12</span> P
gc <span class="m">1406</span> @6.070s <span class="m">11</span>%: <span class="m">0</span>.051+1.8+0.076 ms clock, <span class="m">0</span>.61+2.0/2.5/0+0.91 ms cpu, <span class="m">8</span>-&gt;11-&gt;6 MB, <span class="m">13</span> MB goal, <span class="m">12</span> P
gc <span class="m">1407</span> @6.073s <span class="m">11</span>%: <span class="m">0</span>.052+1.8+0.20 ms clock, <span class="m">0</span>.62+1.5/2.2/0+2.4 ms cpu, <span class="m">8</span>-&gt;14-&gt;8 MB, <span class="m">13</span> MB goal, <span class="m">12</span> P

字段含义如下:
// General
gc <span class="m">1405</span>     : The <span class="m">1405</span> GC run since the program started
@6.068s     : Six seconds since the program started
<span class="m">11</span>%         : Eleven percent of the available CPU so far has been spent <span class="k">in</span> GC

// Wall-Clock
<span class="m">0</span>.058ms     : STW        : Mark Start       - Write Barrier on
<span class="m">1</span>.2ms       : Concurrent : Marking
<span class="m">0</span>.083ms     : STW        : Mark Termination - Write Barrier off and clean up

// CPU Time
<span class="m">0</span>.70ms      : STW        : Mark Start
<span class="m">2</span>.5ms       : Concurrent : Mark - Assist Time <span class="o">(</span>GC performed <span class="k">in</span> line with allocation<span class="o">)</span>
<span class="m">1</span>.5ms       : Concurrent : Mark - Background GC <span class="nb">time</span>
0ms         : Concurrent : Mark - Idle GC <span class="nb">time</span>
<span class="m">0</span>.99ms      : STW        : Mark Term

// Memory
7MB         : Heap memory <span class="k">in</span>-use before the Marking started
11MB        : Heap memory <span class="k">in</span>-use after the Marking finished
6MB         : Heap memory marked as live after the Marking finished
10MB        : Collection goal <span class="k">for</span> heap memory <span class="k">in</span>-use after Marking finished

// Threads
12P         : Number of logical processors or threads used to run Goroutines
</code></pre></div>
</td></tr></table>
</li>
</ol>
<p>GC调优的意见:</p>
<ol>
<li>Maintain the smallest heap possible.</li>
<li>Find an optimal consistent pace.</li>
<li>Stay within the goal for every collection.</li>
<li>Minimize the duration of every collection, STW and Mark Assist.</li>
</ol>
<h3 id="compiler-and-runtime-optimizations">Compiler And Runtime Optimizations</h3>
<ol>
<li>
<p>Non-scannable objects
    Garbage collector does not scan underlying buffers of slices, channels and maps when element type does not contain pointers (both key and value for maps). </p>
<p>垃圾回收期不会扫描元素是指针类型的map、slices、channnel。下面这个map就不会影响GC的采集时间。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Key</span> <span class="p">[</span><span class="mi">64</span><span class="p">]</span><span class="kt">byte</span> <span class="c1">// SHA-512 hash</span>
<span class="kd">type</span> <span class="nx">Value</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span>      <span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="kt">byte</span>
    <span class="nx">Balance</span>   <span class="kt">uint64</span>
    <span class="nx">Timestamp</span> <span class="kt">int64</span>
<span class="p">}</span>
<span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">Key</span><span class="p">]</span><span class="nx">Value</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>Function Inlining</p>
<p>只有小的、短的函数才会内联，函数中要小于40个表达式、并且不包含复杂的语句，比如loop、labels、closures、panic、recover、select、switch等</p>
</li>
<li>
<p><code>go build -x</code></p>
<p>显示build的过程</p>
</li>
<li>
<p><code>go build -gcflags="-S"</code></p>
<p>显示golang中间汇编结果</p>
</li>
<li>
<p><code>go tool objdump -s main.main hello</code></p>
<p>二进制反汇编</p>
</li>
<li>
<p><code>go tool nm escape1</code></p>
<p>查看二进制符号信息</p>
</li>
<li>
<p><code>GOSSAFUNC=main go build &amp;&amp; open ssa.html</code></p>
<p>SSA 代表 static single-assignment，是一种IR(中间表示代码)，要保证每个变量只被赋值一次。</p>
</li>
<li>
<p><code>go build -gcflags="-m"</code></p>
<p>逃逸分析</p>
</li>
<li>
<p><code>go build -gcflags="-l -N"</code></p>
<p>禁止优化和禁止内联</p>
</li>
</ol>
<h3 id="constans">Constans</h3>
<p>在Go中是不能在不同的数字类型的变量之间做操作的，比如不能用float64和int之间做操作，需要强制类型转换，但是有的时候我们发现我们可以做类似<code>2 * time.Second</code>、<code>1 &lt;&lt; ('t' + 2.0)</code>
这样的操作，这是因为他们都是常量，并非是变量。</p>
<ul>
<li>
<p>常量存在默认类型</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%T %v\n&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%T %v\n&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%T %v\n&quot;</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%T %v\n&quot;</span><span class="p">,</span> <span class="m">0i</span><span class="p">,</span> <span class="m">0i</span><span class="p">)</span>

<span class="c1">// 输出结果</span>
<span class="kt">int</span> <span class="mi">0</span>
<span class="kt">float64</span> <span class="mi">0</span>
<span class="kt">int32</span> <span class="mi">120</span>
<span class="kt">complex128</span> <span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="m">0i</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>不同类型的常量操作，会进行类型转换</p>
<p>转换规则按照integer, rune, floating-point, complex.的先后顺序</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">answer</span> <span class="p">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mf">0.33</span>   <span class="c1">// 按照上面的规则，integer会转换为floating-point，最终结果就是浮点数了</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>数字常量可以说是integer, floating-point, complex and rune等四种kind，此外还有bool、string两种kind类型的常量。</p>
</li>
<li>常量不是变量</li>
<li>常量只存在于编译时</li>
<li>
<p>无类型的常量可以隐式转换为有类型的常量，但是变量不行需要强制转换</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Duration</span> <span class="kt">int64</span>
<span class="c1">// Common durations. There is no definition for units of Day or larger</span>
<span class="c1">// to avoid confusion across daylight savings time zone transitions.</span>
<span class="kd">const</span> <span class="p">(</span>
        <span class="nx">Nanosecond</span>  <span class="nx">Duration</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="nx">Microsecond</span>          <span class="p">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="nx">Nanosecond</span>
        <span class="nx">Millisecond</span>          <span class="p">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="nx">Microsecond</span>
        <span class="nx">Second</span>               <span class="p">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="nx">Millisecond</span>
        <span class="nx">Minute</span>               <span class="p">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">Second</span>
        <span class="nx">Hour</span>                 <span class="p">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">Minute</span>
<span class="p">)</span>
<span class="c1">// Add returns the time t+d.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">Time</span><span class="p">)</span> <span class="nx">Add</span><span class="p">(</span><span class="nx">d</span> <span class="nx">Duration</span><span class="p">)</span> <span class="nx">Time</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Use the time package to get the current date/time.</span>
    <span class="nx">now</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>

    <span class="c1">// 这里的5转换成常量Duration了</span>
    <span class="c1">// Subtract 5 nanoseconds from now using a literal constant.</span>
    <span class="nx">literal</span> <span class="o">:=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1">// Subtract 5 seconds from now using a declared constant.</span>
    <span class="kd">const</span> <span class="nx">timeout</span> <span class="p">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="c1">// time.Duration(5) * time.Duration(1000000000)</span>
    <span class="nx">constant</span> <span class="o">:=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="o">-</span><span class="nx">timeout</span><span class="p">)</span>

    <span class="c1">// Subtract 5 nanoseconds from now using a variable of type int64.</span>
    <span class="nx">minusFive</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
    <span class="nx">variable</span> <span class="o">:=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">minusFive</span><span class="p">)</span>

    <span class="c1">// example4.go:50: cannot use minusFive (type int64) as type time.Duration in argument to now.Add</span>

    <span class="c1">// Display the values.</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Now     : %v\n&quot;</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Literal : %v\n&quot;</span><span class="p">,</span> <span class="nx">literal</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Constant: %v\n&quot;</span><span class="p">,</span> <span class="nx">constant</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Variable: %v\n&quot;</span><span class="p">,</span> <span class="nx">variable</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>无类型的常量有Kind，但是没有类型</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="c1">// 无类型常量，精度理论上无限制</span>
    <span class="c1">// Untyped Constants.</span>
    <span class="kd">const</span> <span class="nx">ui</span> <span class="p">=</span> <span class="mi">12345</span>    <span class="c1">// kind: integer</span>
    <span class="kd">const</span> <span class="nx">uf</span> <span class="p">=</span> <span class="mf">3.141592</span> <span class="c1">// kind: floating-point</span>

    <span class="c1">// 下面就是有类型的常量了，这是有精度限制的，取决于常量类型</span>
    <span class="c1">// Typed Constants still use the constant type system but their precision</span>
    <span class="c1">// is restricted.</span>
    <span class="kd">const</span> <span class="nx">ti</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">12345</span>        <span class="c1">// type: int</span>
    <span class="kd">const</span> <span class="nx">tf</span> <span class="kt">float64</span> <span class="p">=</span> <span class="mf">3.141592</span> <span class="c1">// type: float64</span>
    <span class="c1">// 这里声明uint8的值为1000就超过限制了，会编译报错，但是改成无类型的常量就没有这个限制了</span>
    <span class="c1">// ./constants.go:XX: constant 1000 overflows uint8</span>
    <span class="c1">// const myUint8 uint8 = 1000</span>

    <span class="c1">// 有类型和无类型进行算术运算会进行类型转换。</span>
    <span class="kd">const</span> <span class="nx">one</span> <span class="kt">int8</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="kd">const</span> <span class="nx">two</span> <span class="p">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">one</span> <span class="c1">// int8(2) * int8(1)</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>integer常量精度至少256bits</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="p">(</span>
    <span class="c1">// Max integer value on 64 bit architecture.</span>
    <span class="nx">maxInt</span> <span class="p">=</span> <span class="mi">9223372036854775807</span>

    <span class="c1">// Much larger value than int64.</span>
    <span class="nx">bigger</span> <span class="p">=</span> <span class="mi">9223372036854775808543522345</span>

    <span class="c1">// 有类型的常量受到了类型的精度限制，无类型常量则没有限制</span>
    <span class="c1">// Will NOT compile</span>
    <span class="c1">// biggerInt int64 = 9223372036854775808543522345</span>
<span class="p">)</span>
</code></pre></div>
</td></tr></table>
</li>
</ul>
<h3 id="array">Array</h3>
<p>面向数据的设计原则:</p>
<ul>
<li>If you don't understand the data, you don't understand the problem.</li>
<li>All problems are unique and specific to the data you are working with.</li>
<li>Data transformations are at the heart of solving problems. Each function, method and work-flow must focus on implementing the specific data transformations required to solve the problems.</li>
<li>If your data is changing, your problems are changing. When your problems are changing, the data transformations needs to change with it.</li>
<li>Uncertainty about the data is not a license to guess but a directive to STOP and learn more.</li>
<li>Solving problems you don't have, creates more problems you now do.</li>
<li>If performance matters, you must have mechanical sympathy for how the hardware and operating system work.</li>
<li>Minimize, simplify and REDUCE the amount of code required to solve each problem. Do less work by not wasting effort.</li>
<li>Code that can be reasoned about and does not hide execution costs can be better understood, debugged and performance tuned.</li>
<li>Coupling data together and writing code that produces predictable access patterns to the data will be the most performant.</li>
<li>Changing data layouts can yield more significant performance improvements than changing just the algorithms.</li>
<li>Efficiency is obtained through algorithms but performance is obtained through data structures and layouts.</li>
</ul>
<p>我们在设计数据结构的时候需要考虑数据的存储形式，应该尽可能的考虑到对底层硬件平台的依赖，比如需要考虑到缓存，设计的数据结构需要对缓存友好，
一般来说，链表的是缓存不友好的，而数组这种连续内存的数据结构是缓存友好的，可以充分利用缓存来加速。</p>
<ul>
<li>CPU的缓存主要是通过将主内存中的数据缓存在cache line上</li>
<li>Cache line目前一般是32个字节或者是64个字节，这个取决于对应的硬件平台</li>
<li>CPU核心不会直接访问主内存，他们往往只能访问本地的缓存</li>
<li>数据和指令都可以存在缓存中</li>
<li>高速缓存行按L1-&gt; L2-&gt; L3的顺序排列，因为新的高速缓存行需要存储在高速缓存中。</li>
<li>硬件喜欢沿着Cache line线性的访问数据和指令</li>
<li>主内存建立在相对较快的廉价内存上。高速缓存建立在非常快速且昂贵的内存上。</li>
<li>访问主内存的速度非常慢，我们需要缓存。<ul>
<li>从主存储器访问一个字节将导致读取并缓存整个缓存行。</li>
<li>在高速缓存行中写入一个字节需要写入整个高速缓存行。</li>
</ul>
</li>
<li>
<p>小 等于 快</p>
<ul>
<li>适合放入缓存中紧凑数据结构是最快的</li>
<li>仅遍历缓存的数据是最快的</li>
</ul>
</li>
<li>
<p>可预测的访问模式最重要</p>
<ul>
<li>只要可行，尽可能使用线性数组遍历</li>
<li>提供常规的内存访问模式</li>
<li>硬件可以对所需的内存做出更好的预测</li>
</ul>
</li>
<li>
<p>缓存未命中也会导致TLB缓存未命中</p>
<ul>
<li>将虚拟地址转换为物理地址需要Cache</li>
<li>需要等待OS告诉我们真正要访问的内存在哪里</li>
</ul>
</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>3GHz(3 clock cycles/ns) * 4 instructions per cycle = 12 instructions per ns!

1 ns ............. 1 ns .............. 12 instructions  (one) 
1 µs .......... 1000 ns .......... 12,000 instructions  (thousand)
1 ms ..... 1,000,000 ns ...... 12,000,000 instructions  (million)
1 s .. 1,000,000,000 ns .. 12,000,000,000 instructions  (billion)

L1 - 64KB Cache (Per Core)
    4 cycles of latency at 1.3 ns
    Stalls for 16 instructions

L2 - 256KB Cache (Per Core)
    12 cycles of latency at 4 ns
    Stalls for 48 instructions

L3 - 8MB Cache
    40 cycles of latency at 13.3 ns
    Stalls for 160 instructions

Main Memory
    100 cycle of latency at 33.3 ns
    Stalled for 400 instructions
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>L1 cache reference ......................... 0.5 ns ...................  6 ins
Branch mispredict ............................ 5 ns ................... 60 ins
L2 cache reference ........................... 7 ns ................... 84 ins
Mutex lock/unlock ........................... 25 ns .................. 300 ins
Main memory reference ...................... 100 ns ................. 1200 ins           
Compress 1K bytes with Zippy ............. 3,000 ns (3 µs) ........... 36k ins
Send 2K bytes over 1 Gbps network ....... 20,000 ns (20 µs) ........  240k ins
SSD random read ........................ 150,000 ns (150 µs) ........ 1.8M ins
Read 1 MB sequentially from memory ..... 250,000 ns (250 µs) .......... 3M ins
Round trip within same datacenter ...... 500,000 ns (0.5 ms) .......... 6M ins
Read 1 MB sequentially from SSD* ..... 1,000,000 ns (1 ms) ........... 12M ins
Disk seek ........................... 10,000,000 ns (10 ms) ......... 120M ins
Read 1 MB sequentially from disk .... 20,000,000 ns (20 ms) ......... 240M ins
Send packet CA-&gt;Netherlands-&gt;CA .... 150,000,000 ns (150 ms) ........ 1.8B ins
</code></pre></div>
</td></tr></table>
<ul>
<li>range的语义</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// All material is licensed under the Apache License Version 2.0, January 2004</span>
<span class="c1">// http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="c1">// Sample program to show how the for range has both value and pointer semantics.</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Using the pointer semantic form of the for range.</span>
    <span class="nx">friends</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;Annie&quot;</span><span class="p">,</span> <span class="s">&quot;Betty&quot;</span><span class="p">,</span> <span class="s">&quot;Charley&quot;</span><span class="p">,</span> <span class="s">&quot;Doug&quot;</span><span class="p">,</span> <span class="s">&quot;Edward&quot;</span><span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Bfr[%s] : &quot;</span><span class="p">,</span> <span class="nx">friends</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">// 这种是指针语义，通过下标来访问friends，不产生临时变量</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">friends</span> <span class="p">{</span>
        <span class="nx">friends</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Jack&quot;</span>

        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Aft[%s]\n&quot;</span><span class="p">,</span> <span class="nx">friends</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Using the value semantic form of the for range.</span>
    <span class="nx">friends</span> <span class="p">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;Annie&quot;</span><span class="p">,</span> <span class="s">&quot;Betty&quot;</span><span class="p">,</span> <span class="s">&quot;Charley&quot;</span><span class="p">,</span> <span class="s">&quot;Doug&quot;</span><span class="p">,</span> <span class="s">&quot;Edward&quot;</span><span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Bfr[%s] : &quot;</span><span class="p">,</span> <span class="nx">friends</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">// 这种是值语义，v每次拷贝friends中的元素，修改friends不会影响v</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">friends</span> <span class="p">{</span>
        <span class="nx">friends</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Jack&quot;</span>

        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;v[%s]\n&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Using the value semantic form of the for range but with pointer</span>
    <span class="c1">// semantic access. DON&#39;T DO THIS.</span>
    <span class="nx">friends</span> <span class="p">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;Annie&quot;</span><span class="p">,</span> <span class="s">&quot;Betty&quot;</span><span class="p">,</span> <span class="s">&quot;Charley&quot;</span><span class="p">,</span> <span class="s">&quot;Doug&quot;</span><span class="p">,</span> <span class="s">&quot;Edward&quot;</span><span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Bfr[%s] : &quot;</span><span class="p">,</span> <span class="nx">friends</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">// 不要这种写法，会存在data race的，因为v每次拷贝的是friends中元素的指针，修改 friends会影响v</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="o">&amp;</span><span class="nx">friends</span> <span class="p">{</span>
        <span class="nx">friends</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Jack&quot;</span>

        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;v[%s]\n&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="slice">slice</h3>
<p>slice、channel、map、function、interface都是引用类型，这些数据结构内部都有指针，默认值是nil。</p>
<ul>
<li>nil和empty不一样</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// 这里的s是nil，nil表示slice内部的指针、size、cap等都是0</span>
<span class="kd">var</span> <span class="nx">s</span> <span class="p">[]</span><span class="kt">string</span>
<span class="c1">// 这里的s是empty，表示内部指针指向了一个全局的位置、size和cap都是0</span>
<span class="nx">s</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span> <span class="p">{}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>通过make来创建slice可以指定length和cap，如果只指定length的话，cap默认等于length</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Create a slice with a length of 5 elements.</span>
    <span class="nx">fruits</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="nx">fruits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Apple&quot;</span>
    <span class="nx">fruits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Orange&quot;</span>
    <span class="nx">fruits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Banana&quot;</span>
    <span class="nx">fruits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Grape&quot;</span>
    <span class="nx">fruits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Plum&quot;</span>

    <span class="c1">// 会存在访问越界</span>
    <span class="c1">// You can&#39;t access an index of a slice beyond its length.</span>
    <span class="nx">fruits</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Runtime error&quot;</span>

    <span class="c1">// Error: panic: runtime error: index out of range</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">fruits</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>slice在cap小于1024的时候总是按照100%来增长，到了1024后则按照25%来增长。</li>
</ul>
<p>具体细节见<a href="Lesson2/cap.go">cap.go</a></p>
<ul>
<li>在slice的基础上可以再创建slice，创建的slice和之前的slice是共享底层的存储</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">orgSlice</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="nx">orgSlice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Apple&quot;</span>
    <span class="nx">orgSlice</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Orange&quot;</span>
    <span class="nx">orgSlice</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Banana&quot;</span>
    <span class="nx">orgSlice</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Grape&quot;</span>
    <span class="nx">orgSlice</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;Plum&quot;</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;cap: %d, length: %d\n&quot;</span><span class="p">,</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">orgSlice</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nx">orgSlice</span><span class="p">))</span>

    <span class="c1">// 可以通过orgSlice[2:4:cap]来指定cap，将cap和length设置为相同，这样就可以在</span>
    <span class="c1">// append的时候避免对原来的slice进行修改。其中cap不能超过原来slice的最大cap范围</span>
    <span class="nx">slice2</span> <span class="o">:=</span> <span class="nx">orgSlice</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
    <span class="c1">// length为2，cap为6，这里需要小心了，因为cap和length不相同，因此在append的时候</span>
    <span class="c1">// 不会进行拷贝，而是直接在原来的基础上操作，这个是存在副作用的，会影响到orgSlice，例如下面这个例子</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;cap: %d, length: %d\n&quot;</span><span class="p">,</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">slice2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nx">slice2</span><span class="p">))</span>

    <span class="c1">//  Append会导致orgSlice中的元素被覆盖</span>
    <span class="nx">slice2</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">slice2</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;slice2: %v\n&quot;</span><span class="p">,</span> <span class="nx">slice2</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;orgSlice: %v %d\n&quot;</span><span class="p">,</span> <span class="nx">orgSlice</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">orgSlice</span><span class="p">))</span>

    <span class="nx">slice3</span> <span class="o">:=</span> <span class="nx">orgSlice</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;cap: %d, length: %d\n&quot;</span><span class="p">,</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">slice3</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nx">slice3</span><span class="p">))</span>
    <span class="c1">// 这里append不会影响orgSlice，因为orgSlice和slice3两个结束位置都是相同的，</span>
    <span class="c1">// 这里的append只会在未使用的区域添加新的元素，orgSlice感知不到。后续orgSlice</span>
    <span class="c1">// 如果也进行append的化，会导致两个Slice的内容相互覆盖了。</span>
    <span class="nx">slice3</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">slice3</span><span class="p">,</span> <span class="s">&quot;test3&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;slice3: %v\n&quot;</span><span class="p">,</span> <span class="nx">slice3</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;orgSlice: %v %d\n&quot;</span><span class="p">,</span> <span class="nx">orgSlice</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">orgSlice</span><span class="p">))</span>

<span class="p">}</span>

<span class="c1">// 输出</span>
<span class="nx">cap</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span> <span class="mi">5</span>
<span class="nx">cap</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span> <span class="mi">2</span>
<span class="nx">slice2</span><span class="p">:</span> <span class="p">[</span><span class="nx">Banana</span> <span class="nx">Grape</span> <span class="nx">test</span><span class="p">]</span>
<span class="nx">orgSlice</span><span class="p">:</span> <span class="p">[</span><span class="nx">Apple</span> <span class="nx">Orange</span> <span class="nx">Banana</span> <span class="nx">Grape</span> <span class="nx">test</span><span class="p">]</span>
<span class="nx">cap</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">length</span><span class="p">:</span> <span class="mi">3</span>
<span class="nx">slice3</span><span class="p">:</span> <span class="p">[</span><span class="nx">Banana</span> <span class="nx">Grape</span> <span class="nx">test</span> <span class="nx">test3</span><span class="p">]</span>
<span class="nx">orgSlice</span><span class="p">:</span> <span class="p">[</span><span class="nx">Apple</span> <span class="nx">Orange</span> <span class="nx">Banana</span> <span class="nx">Grape</span> <span class="nx">test</span><span class="p">]</span> <span class="mi">5</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>引用slice中的元素时需要小心因为append带来的副作用 </li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">likes</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Declare a slice of 3 users.</span>
    <span class="nx">users</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">user</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1">// Share the user at index 1.</span>
    <span class="c1">// 这里引用了slice中的元素</span>
    <span class="nx">shareUser</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">users</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">// Add a like for the user that was shared.</span>
    <span class="c1">// 操作引用本身也会导致slice中对应元素发生变化</span>
    <span class="nx">shareUser</span><span class="p">.</span><span class="nx">likes</span><span class="o">++</span>

    <span class="c1">// Display the number of likes for all users.</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">users</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;User: %d Likes: %d\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">users</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">likes</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Add a new user.</span>
    <span class="c1">// append会导致copy的发生，那么之前对slice中元素的引用和append后的slice是两个独立的slice，互不影响。</span>
    <span class="nx">users</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">users</span><span class="p">,</span> <span class="nx">user</span><span class="p">{})</span>

    <span class="c1">// Add another like for the user that was shared.</span>
    <span class="c1">// 这是在操作append前的slice</span>
    <span class="nx">shareUser</span><span class="p">.</span><span class="nx">likes</span><span class="o">++</span>

    <span class="c1">// Display the number of likes for all users.</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;*************************&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">users</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;User: %d Likes: %d\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">users</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">likes</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Notice the last like has not been recorded.</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>copy函数只会拷贝两个slice中的最小长度。当两个slice存在重叠的时候，copy函数也可以正确工作</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// Insert inserts the value into the slice at the specified index,</span>
<span class="c1">// which must be in range.</span>
<span class="c1">// The slice must have room for the new element.</span>
<span class="kd">func</span> <span class="nx">Insert</span><span class="p">(</span><span class="nx">slice</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>
    <span class="c1">// Grow the slice by one element.</span>
    <span class="nx">slice</span> <span class="p">=</span> <span class="nx">slice</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">// Use copy to move the upper part of the slice out of the way and open a hole.</span>
    <span class="nb">copy</span><span class="p">(</span><span class="nx">slice</span><span class="p">[</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="nx">slice</span><span class="p">[</span><span class="nx">index</span><span class="p">:])</span>
    <span class="c1">// Store the new value.</span>
    <span class="nx">slice</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nx">value</span>
    <span class="c1">// Return the result.</span>
    <span class="k">return</span> <span class="nx">slice</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>小心slice的迭代，值语义和指针语义</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Using the value semantic form of the for range.</span>
    <span class="nx">friends</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;Annie&quot;</span><span class="p">,</span> <span class="s">&quot;Betty&quot;</span><span class="p">,</span> <span class="s">&quot;Charley&quot;</span><span class="p">,</span> <span class="s">&quot;Doug&quot;</span><span class="p">,</span> <span class="s">&quot;Edward&quot;</span><span class="p">}</span>
    <span class="c1">// 值语义，这里会对friends进行拷贝，因此在迭代过程中修改friends不会影响迭代结果的</span>
    <span class="c1">// v每次都会对friends中的元素进行拷贝</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">friends</span> <span class="p">{</span>
        <span class="nx">friends</span> <span class="p">=</span> <span class="nx">friends</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;v[%s]\n&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Using the pointer semantic form of the for range.</span>
    <span class="nx">friends</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;Annie&quot;</span><span class="p">,</span> <span class="s">&quot;Betty&quot;</span><span class="p">,</span> <span class="s">&quot;Charley&quot;</span><span class="p">,</span> <span class="s">&quot;Doug&quot;</span><span class="p">,</span> <span class="s">&quot;Edward&quot;</span><span class="p">}</span>
    <span class="c1">// 指针语义，friends并不会拷贝，因此迭代器中修改friends会影响迭代</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">friends</span> <span class="p">{</span>
        <span class="nx">friends</span> <span class="p">=</span> <span class="nx">friends</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;v[%s]\n&quot;</span><span class="p">,</span> <span class="nx">friends</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>小心slice迭代，始终只有一个迭代器变量</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Age</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">jackie</span> <span class="o">:=</span> <span class="nx">Dog</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;Jackie&quot;</span><span class="p">,</span>
        <span class="nx">Age</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Jackie Addr: %p\n&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">jackie</span><span class="p">)</span>

    <span class="nx">sammy</span> <span class="o">:=</span> <span class="nx">Dog</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;Sammy&quot;</span><span class="p">,</span>
        <span class="nx">Age</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Sammy Addr: %p\n&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sammy</span><span class="p">)</span>

    <span class="nx">dogs</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Dog</span><span class="p">{</span><span class="nx">jackie</span><span class="p">,</span> <span class="nx">sammy</span><span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="c1">// dog每次迭代都会拷贝一次</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">dogs</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Name: %s Age: %d\n&quot;</span><span class="p">,</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">Age</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Addr: %p\n&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">dog</span><span class="p">)</span>  <span class="c1">// 这里输出的地址总是一样的</span>

        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">allDogs</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Dog</span><span class="p">{}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">dogs</span> <span class="p">{</span>
        <span class="c1">// 这里会存在问题，因此存的都是指针，，但是dog变量只有一个，只是每次进行copy，因此这里最终append的都是最后一个元素</span>
        <span class="nx">allDogs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">allDogs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">dog</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">allDogs</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Name: %s Age: %d\n&quot;</span><span class="p">,</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">Age</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>string其实就是slice的一个只读版本，也包含了指针和size，但是因为是只读的，所以没有cap字段</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;unicode/utf8&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Declare a string with both chinese and english characters.</span>
    <span class="nx">s</span> <span class="o">:=</span> <span class="s">&quot;世界 means world&quot;</span>

    <span class="c1">// UTFMax is 4 -- up to 4 bytes per encoded rune.</span>
    <span class="kd">var</span> <span class="nx">buf</span> <span class="p">[</span><span class="nx">utf8</span><span class="p">.</span><span class="nx">UTFMax</span><span class="p">]</span><span class="kt">byte</span>

    <span class="c1">// Iterate over the string.</span>
    <span class="c1">// 默认遍历string是按照rune来遍历的，一个rune是一个可变大小。</span>
    <span class="c1">// i指向这个rune在string中的offset</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span> <span class="p">{</span>

        <span class="c1">// Capture the number of bytes for this rune.</span>
        <span class="nx">rl</span> <span class="o">:=</span> <span class="nx">utf8</span><span class="p">.</span><span class="nx">RuneLen</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>

        <span class="c1">// Calculate the slice offset for the bytes associated</span>
        <span class="c1">// with this rune.</span>
        <span class="nx">si</span> <span class="o">:=</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">rl</span>

        <span class="c1">// Copy of rune from the string to our buffer.</span>
        <span class="nb">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:],</span> <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">:</span><span class="nx">si</span><span class="p">])</span>

        <span class="c1">// Display the details.</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%2d: %q; codepoint: %#6x; encoded bytes: %#v\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">rl</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="map">map</h3>
<ul>
<li>map的迭代总是无序的</li>
<li>map的key必须是可hash的、而且是可比较的，slice没办法作为key，因为不可比较</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="c1">// user represents someone using the program.</span>
<span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">name</span>    <span class="kt">string</span>
    <span class="nx">surname</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// users defines a set of users.</span>
<span class="kd">type</span> <span class="nx">users</span> <span class="p">[]</span><span class="nx">user</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Declare and make a map that uses a slice as the key.</span>
    <span class="c1">// 这里的users是slice，是不可比较的，不能作为key</span>
    <span class="nx">u</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">users</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>

    <span class="c1">// ./example3.go:22: invalid map key type users</span>

    <span class="c1">// Iterate over the map.</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">u</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>map中的元素是不可寻址的</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="c1">// player represents someone playing our game.</span>
<span class="kd">type</span> <span class="nx">player</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">name</span>  <span class="kt">string</span>
    <span class="nx">score</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Declare a map with initial values using a map literal.</span>
    <span class="nx">players</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">player</span><span class="p">{</span>
        <span class="s">&quot;anna&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s">&quot;Anna&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">},</span>
        <span class="s">&quot;jacob&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;Jacob&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="c1">// Trying to take the address of a map element fails.</span>
    <span class="nx">anna</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">players</span><span class="p">[</span><span class="s">&quot;anna&quot;</span><span class="p">]</span>
    <span class="nx">anna</span><span class="p">.</span><span class="nx">score</span><span class="o">++</span>

    <span class="c1">// ./example4.go:23:10: cannot take the address of players[&quot;anna&quot;]</span>

    <span class="c1">// Instead take the element, modify it, and put it back.</span>
    <span class="nx">player</span> <span class="o">:=</span> <span class="nx">players</span><span class="p">[</span><span class="s">&quot;anna&quot;</span><span class="p">]</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">score</span><span class="o">++</span>
    <span class="nx">players</span><span class="p">[</span><span class="s">&quot;anna&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">player</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>空map和nil是不同的</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="c1">// 空map</span>
    <span class="nx">users</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">user</span><span class="p">)</span>
    <span class="c1">// nil</span>
    <span class="kd">var</span> <span class="nx">users</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">user</span>
</code></pre></div>
</td></tr></table>
<h3 id="method">method</h3>
<ul>
<li>方法本质上是个带有receive的函数</li>
<li>receiver会给方法绑定一个类型，可以是值语义也可以是指针语义</li>
<li>值语义意味着每次方法调用都是通过副本进行操作的</li>
<li>指针语义意味着每次方法调用都是共享相同的实例</li>
<li>坚持给定类型的单一语义并保持一致</li>
<li>用值语义还是指针语义<ol>
<li>如果类型是一个map、func、chan，不要使用指针语义，如果类型是slice，并且没有reslice或者重新分配slice的需求，也不要使用指针语义</li>
<li>如果方法需要修改操作，那么必须使用指针语义</li>
<li>如果类型包含了锁、文件fd等不可拷贝的资源则必须要用指针语义</li>
<li>如果类型是大型的数据结构或者数组，那么为了效率应该使用指针</li>
<li>如果类型是数组或切片，并且其元素是指针，而且可能会被修改，则最好使用指针语义，因为它将使读者更加清楚意图。</li>
<li>如果类型是小的数组或者struct中包含了一些基本类型，并且没有指针，也没有可修改的字段。仅仅是一些基本类型，那么使用值语义可以减少gc的压力。</li>
<li>最后如有疑问请使用指针语义</li>
</ol>
</li>
</ul>
<h3 id="interface">interface</h3>
<ul>
<li>接口本身就是引用类型，不需要通过指针来共享</li>
<li>
<p>如何判断一个类型是否实现了某个接口?</p>
<ol>
<li>对于一个指针来说，其方法集包含了值语义和指针语义作为reciver实现的方法</li>
<li>对于一个值来说，其方法集仅限于使用值语义作为reciver实现的方法</li>
</ol>
</li>
</ul>
<p>下面这个例子中，user作为值来说，其方法集只有使用值作为receiver的方法，但是User的Notify是用指针作为receiver来实现的，因此user并没有实现Notify接口，
把它换成指针类型就可以了。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Email</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">SendNotification</span><span class="p">(</span><span class="nx">notify</span> <span class="nx">Notifier</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">notify</span><span class="p">.</span><span class="nx">Notify</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">)</span> <span class="nx">Notify</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;User: Sending User Email To %s&lt;%s&gt;\n&quot;</span><span class="p">,</span>
        <span class="nx">u</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
        <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span>  <span class="s">&quot;janet jones&quot;</span><span class="p">,</span>
        <span class="nx">Email</span><span class="p">:</span> <span class="s">&quot;janet@email.com&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">SendNotification</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Output:</span>
<span class="nx">cannot</span> <span class="nx">use</span> <span class="nx">user</span> <span class="p">(</span><span class="kd">type</span> <span class="nx">User</span><span class="p">)</span> <span class="nx">as</span> <span class="kd">type</span> <span class="nx">Notifier</span> <span class="nx">in</span> <span class="nx">function</span> <span class="nx">argument</span><span class="p">:</span>
      <span class="nx">User</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">implement</span> <span class="nx">Notifier</span> <span class="p">(</span><span class="nx">Notify</span> <span class="nx">method</span> <span class="nx">has</span> <span class="nx">pointer</span> <span class="nx">receiver</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>嵌入式类型其包含的方法集和外部类型是什么关系?</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// Admin包含了嵌入式类型User，因此User实现的Notify接口，Admin也实现了。</span>
<span class="kd">type</span> <span class="nx">Admin</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">User</span>
    <span class="nx">Level</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">admin</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Admin</span><span class="p">{</span>
        <span class="nx">User</span><span class="p">:</span> <span class="nx">User</span><span class="p">{</span>
            <span class="nx">Name</span><span class="p">:</span>  <span class="s">&quot;john smith&quot;</span><span class="p">,</span>
            <span class="nx">Email</span><span class="p">:</span> <span class="s">&quot;john@email.com&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">Level</span><span class="p">:</span> <span class="s">&quot;super&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">SendNotification</span><span class="p">(</span><span class="nx">admin</span><span class="p">)</span>
    <span class="c1">// 也可以这样来调用，因为嵌入类型在外部类型中就是一个字段名为类型名的字段。</span>
    <span class="c1">// admin.User.Notify()</span>

<span class="p">}</span>

<span class="c1">// Output</span>
<span class="nx">User</span><span class="p">:</span> <span class="nx">Sending</span> <span class="nx">User</span> <span class="nx">Email</span> <span class="nx">To</span> <span class="nx">john</span> <span class="nx">smith</span><span class="p">&lt;</span><span class="nx">john</span><span class="err">@</span><span class="nx">email</span><span class="p">.</span><span class="nx">com</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>当我们嵌入一个类型时，该类型的方法成为外部类型的方法，但是当它们被调用时，该方法的接收者是内部类型，而不是外部类型。</p>
</div>
<p>给定一个结构类型S和一个名为T的类型，那么该结构体S的方法集为:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>1. 如果S包含匿名字段T，则`S`和`*S`的方法集会包括以T作为receiver的方法。
2. `*S`还额外包含了以`*T`作为receiver的方法
</code></pre></div>
</td></tr></table>
<ul>
<li>外部类型和嵌入式类型实现了相同的interface怎么办?</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Admin</span><span class="p">)</span> <span class="nx">Notify</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Admin: Sending Admin Email To %s&lt;%s&gt;\n&quot;</span><span class="p">,</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">Email</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">admin</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Admin</span><span class="p">{</span>
        <span class="nx">User</span><span class="p">:</span> <span class="nx">User</span><span class="p">{</span>
            <span class="nx">Name</span><span class="p">:</span>  <span class="s">&quot;john smith&quot;</span><span class="p">,</span>
            <span class="nx">Email</span><span class="p">:</span> <span class="s">&quot;john@email.com&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">Level</span><span class="p">:</span> <span class="s">&quot;super&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1">// 外部类型所实现的方法优先覆盖嵌入式类型</span>
    <span class="nx">SendNotification</span><span class="p">(</span><span class="nx">admin</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Output</span>
<span class="nx">Admin</span><span class="p">:</span> <span class="nx">Sending</span> <span class="nx">Admin</span> <span class="nx">Email</span> <span class="nx">To</span> <span class="nx">john</span> <span class="nx">smith</span><span class="p">&lt;</span><span class="nx">john</span><span class="err">@</span><span class="nx">email</span><span class="p">.</span><span class="nx">com</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>interface会保存值，在调用的时候，使用保存的值来调用</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">type</span> <span class="nx">printer</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nb">print</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="nx">user</span><span class="p">)</span> <span class="nb">print</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;User Name:&quot;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">u</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">{</span><span class="s">&quot;Bill&quot;</span><span class="p">}</span>
    <span class="c1">// 这里会对u进行拷贝，并保存在interface中</span>
    <span class="nx">entities</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">printer</span><span class="p">{</span>
        <span class="nx">u</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="nx">u</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// 这里修改u，并不会影响已经拷贝的u</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&quot;Bill_CHG&quot;</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">entities</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nb">print</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>当使用值接收器（值语义）实现接口时，可以在接口内部存储值和地址的副本。但是，当使用指针接收器（指针语义）实现接口时，只能存储地址的副本。</p>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">type</span> <span class="nx">notifier</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">notify</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">duration</span> <span class="kt">int</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">duration</span><span class="p">)</span> <span class="nx">notify</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Sending Notification in&quot;</span><span class="p">,</span> <span class="o">*</span><span class="nx">d</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">duration</span><span class="p">(</span><span class="mi">42</span><span class="p">).</span><span class="nx">notify</span><span class="p">()</span>
<span class="p">}</span>
<span class="c1">// 使用指针作为receiver的时候，是不能将值传递给interface的，必须传递的是一个可以取地址的变量。</span>
<span class="c1">//  duration(42)是一个常量是没有地址的，只存在于编译时</span>
<span class="p">.</span><span class="o">/</span><span class="nx">prog</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span> <span class="nx">cannot</span> <span class="nx">call</span> <span class="nx">pointer</span> <span class="nx">method</span> <span class="nx">on</span> <span class="nx">duration</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="p">.</span><span class="o">/</span><span class="nx">prog</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span> <span class="nx">cannot</span> <span class="nx">take</span> <span class="nx">the</span> <span class="nx">address</span> <span class="nx">of</span> <span class="nx">duration</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>
<p>interface是可以比较的，比较的是接口内部存储的数据，而不是接口本身。使用指针语义时，将比较地址。使用值语义时，将比较值。</p>
</li>
<li>
<p>深入interface</p>
</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// All material is licensed under the Apache License Version 2.0, January 2004</span>
<span class="c1">// http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="c1">// Sample program that explores how interface assignments work when</span>
<span class="c1">// values are stored inside the interface.</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;unsafe&quot;</span>
<span class="p">)</span>

<span class="c1">// notifier provides support for notifying events.</span>
<span class="kd">type</span> <span class="nx">notifier</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">notify</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// user represents a user in the system.</span>
<span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// notify implements the notifier interface.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="nx">user</span><span class="p">)</span> <span class="nx">notify</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Alert&quot;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">inspect</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">notifier</span><span class="p">,</span> <span class="nx">u</span> <span class="o">*</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 一个interface两个字大小，第一个字存储方法集，第二个字存储值</span>
    <span class="nx">word</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="o">+</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">u</span><span class="p">))</span>
    <span class="c1">// 可以看到interface始终存储地址，只是这个地址指向的内容到底是值拷贝后的对象，还是指针拷贝后的对象。</span>
    <span class="nx">value</span> <span class="o">:=</span> <span class="p">(</span><span class="o">**</span><span class="nx">user</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="nx">word</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Addr User: %p  Word Value: %p  Ptr Value: %v\n&quot;</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="o">*</span><span class="nx">value</span><span class="p">,</span> <span class="o">**</span><span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// Create a notifier interface and concrete type value.</span>
    <span class="kd">var</span> <span class="nx">n1</span> <span class="nx">notifier</span>
    <span class="nx">u</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">{</span><span class="s">&quot;bill&quot;</span><span class="p">}</span>

    <span class="c1">// Store a copy of the user value inside the notifier</span>
    <span class="c1">// interface value.</span>
    <span class="nx">n1</span> <span class="p">=</span> <span class="nx">u</span>

    <span class="c1">// We see the interface has its own copy.</span>
    <span class="c1">// Addr User: 0x1040a120  Word Value: 0x10427f70  Ptr Value: {bill}</span>
    <span class="c1">// 通过输出结果可值，interface中存储的值和赋值过来的值不一样，因此其指向的是拷贝后的值</span>
    <span class="nx">inspect</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n1</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">)</span>

    <span class="c1">// Make a copy of the interface value.</span>
    <span class="nx">n2</span> <span class="o">:=</span> <span class="nx">n1</span>

    <span class="c1">// We see the interface is sharing the same value stored in</span>
    <span class="c1">// the n1 interface value.</span>
    <span class="c1">// Addr User: 0x1040a120  Word Value: 0x10427f70  Ptr Value: {bill}</span>
    <span class="c1">// 指针赋值后，大家都是指向相同的值</span>
    <span class="nx">inspect</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n2</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">)</span>

    <span class="c1">// Store a copy of the user address value inside the</span>
    <span class="c1">// notifier interface value.</span>
    <span class="nx">n1</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">u</span>

    <span class="c1">// We see the interface is sharing the u variables value</span>
    <span class="c1">// directly. There is no copy.</span>
    <span class="c1">// Addr User: 0x1040a120  Word Value: 0x1040a120  Ptr Value: {bill}</span>
    <span class="c1">// 当传递指针的时候，interface中存储的就是地址了。</span>
    <span class="nx">inspect</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n1</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Output</span>
<span class="nx">Addr</span> <span class="nx">User</span><span class="p">:</span> <span class="mh">0xc000010200</span>  <span class="nx">Word</span> <span class="nx">Value</span><span class="p">:</span> <span class="mh">0xc000068f68</span>  <span class="nx">Ptr</span> <span class="nx">Value</span><span class="p">:</span> <span class="p">{</span><span class="nx">bill</span><span class="p">}</span>
<span class="nx">Addr</span> <span class="nx">User</span><span class="p">:</span> <span class="mh">0xc000010200</span>  <span class="nx">Word</span> <span class="nx">Value</span><span class="p">:</span> <span class="mh">0xc000068f68</span>  <span class="nx">Ptr</span> <span class="nx">Value</span><span class="p">:</span> <span class="p">{</span><span class="nx">bill</span><span class="p">}</span>
<span class="nx">Addr</span> <span class="nx">User</span><span class="p">:</span> <span class="mh">0xc000010200</span>  <span class="nx">Word</span> <span class="nx">Value</span><span class="p">:</span> <span class="mh">0xc000010200</span>  <span class="nx">Ptr</span> <span class="nx">Value</span><span class="p">:</span> <span class="p">{</span><span class="nx">bill</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="reflection">reflection</h3>
<ul>
<li>反射是interface到反射对象的转换</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;reflect&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="kt">float64</span> <span class="p">=</span> <span class="mf">3.4</span>
    <span class="c1">// TypeOf的参数是interface{},任意输入都会转换为interface{}</span>
    <span class="c1">// 然后通过反射获取到类型信息</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;type:&quot;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;value:&quot;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">String</span><span class="p">())</span>
    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;type:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Type</span><span class="p">())</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;kind is float64:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Float64</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;value:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Float</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TypeOf</span><span class="p">(</span><span class="nx">i</span> <span class="kd">interface</span><span class="p">{})</span> <span class="nx">Type</span>
</code></pre></div>
</td></tr></table>
<p>获取反射对象的值或者给对象设置值时，这些方法的参数或者返回值的类型是可容纳该值的最大类型上：
例如，所有有符号整数的是int64。也就是说，反射对象的Int方法返回一个int64，而SetInt值接收一个int64作为参数，例如下面这个例子:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;reflect&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="kt">uint8</span> <span class="p">=</span> <span class="sc">&#39;x&#39;</span>
    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;type:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Type</span><span class="p">())</span>                            <span class="c1">// uint8.</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;kind is uint8: &quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint8</span><span class="p">)</span> <span class="c1">// true.</span>
    <span class="c1">// 获取值的时候，Uint返回的是uint64，因此这里需要转型</span>
    <span class="nx">x</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">Uint</span><span class="p">())</span>                                       <span class="c1">// v.Uint returns a uint64.</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>通过反射获取到的类型是其底层的真实类型，而不是类型别名</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">MyInt</span> <span class="kt">int</span>
<span class="kd">var</span> <span class="nx">x</span> <span class="nx">MyInt</span> <span class="p">=</span> <span class="mi">7</span>
<span class="c1">// v.Kind == reflect.Int</span>
<span class="nx">v</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>反射也可以从反射对象转换为interface</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;reflect&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="kt">uint8</span> <span class="p">=</span> <span class="sc">&#39;x&#39;</span>
    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="c1">// 将反射对象变成了interface，然后传递给了Println</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">Interface</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>要修改反射对象，该值必须可设置。</li>
</ul>
<p>可设置是反射对象的属性，并非所有反射对象都具有它。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;reflect&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="kt">float64</span> <span class="p">=</span> <span class="mf">3.4</span>
    <span class="c1">// 这里是将x传递给了ValueOf进行拷贝才有了反射对象v，因为通过v修改值也只是对拷贝进行了修改，并不是修改x本身</span>
    <span class="c1">// 因此v不具有可设置值的属性</span>
    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="c1">// settability of v: false</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;settability of v:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">CanSet</span><span class="p">())</span>
    <span class="c1">// panic: reflect.Value.SetFloat using unaddressable value</span>
    <span class="nx">v</span><span class="p">.</span><span class="nx">SetFloat</span><span class="p">(</span><span class="mf">7.1</span><span class="p">)</span> <span class="c1">// Error: will panic.</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>改成下面这样就可以设置值了</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="kd">var</span> <span class="nx">x</span> <span class="kt">float64</span> <span class="p">=</span> <span class="mf">3.4</span>
    <span class="c1">// 反射对象p本身是不可设置的，其指向的元素才是可设置的。因为p的类型是*float64</span>
    <span class="c1">// 指针的值是没办法修改的，修改指针的值只会导致指向另外一个对象</span>
    <span class="c1">// 通过Elem可以获取到其指向的值，也就是*p，*p才是可以设置的。</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">x</span><span class="p">)</span> <span class="c1">// Note: take the address of x.</span>
    <span class="c1">// type of p: *float64</span>
    <span class="c1">// settability of p: false</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;type of p:&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Type</span><span class="p">())</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;settability of p:&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">CanSet</span><span class="p">())</span>

    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Elem</span><span class="p">()</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;settability of v:&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">CanSet</span><span class="p">())</span>
    <span class="nx">v</span><span class="p">.</span><span class="nx">SetFloat</span><span class="p">(</span><span class="mf">7.1</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">Interface</span><span class="p">())</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>此外，还可以通过反射来修改struct的值，struct中的大写开头的字段才是导出字段，是可以被修改的，其他的字段是不具备可设置属性的</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">T</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">A</span> <span class="kt">int</span>
    <span class="nx">B</span> <span class="kt">string</span>
<span class="p">}</span>
<span class="nx">t</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">{</span><span class="mi">23</span><span class="p">,</span> <span class="s">&quot;skidoo&quot;</span><span class="p">}</span>
<span class="nx">s</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">).</span><span class="nx">Elem</span><span class="p">()</span>
<span class="nx">typeOfT</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Type</span><span class="p">()</span>
<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">NumField</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="c1">// 获取到字段</span>
    <span class="nx">f</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d: %s %s = %v\n&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span>
        <span class="nx">typeOfT</span><span class="p">.</span><span class="nx">Field</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Type</span><span class="p">(),</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Interface</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="exporting">exporting</h2>
<ul>
<li>package是go的基本编译单元，</li>
<li>代码被编译到package中，并最终链接在一起</li>
<li>标识符根据字母大小写导出（或保持未导出）</li>
<li>通过import导入package，就可以访问这个package中已经导出的标识符了</li>
<li>任何包都可以使用未导出类型的值，但是使用起来很烦人</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">counters</span>

<span class="c1">// alertCounter is an unexported type that</span>
<span class="c1">// contains an integer counter for alerts.</span>
<span class="kd">type</span> <span class="nx">alertCounter</span> <span class="kt">int</span>

<span class="c1">// NewAlertCounter creates and returns objects of</span>
<span class="c1">// the unexported type alertCounter.</span>
<span class="kd">func</span> <span class="nx">NewAlertCounter</span><span class="p">(</span><span class="nx">value</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">alertCounter</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">alertCounter</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 间接访问未导出的标识符</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;test/counters&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Create a variable of the unexported type using the</span>
    <span class="c1">// exported NewAlertCounter function from the package counters.</span>
    <span class="nx">counter</span> <span class="o">:=</span> <span class="nx">counters</span><span class="p">.</span><span class="nx">NewAlertCounter</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Counter: %d\n&quot;</span><span class="p">,</span> <span class="nx">counter</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>struct的字段名或者方法名如果是小写是无法被外部直接访问的</li>
<li>如果struct中嵌入的类型是未导出的，则无法直接初始化，需要显示的访问嵌入式类型中导出的字段来初始化</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">animals</span>

<span class="c1">// animal represents information about all animals.</span>
<span class="kd">type</span> <span class="nx">animal</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Age</span>  <span class="kt">int</span>
<span class="p">}</span>

<span class="c1">// Dog represents information about dogs.</span>
<span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">animal</span>
    <span class="nx">BarkStrength</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;test/animals&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Create an object of type Dog from the animals package.</span>
    <span class="c1">// This will NOT compile.</span>
    <span class="nx">dog</span> <span class="o">:=</span> <span class="nx">animals</span><span class="p">.</span><span class="nx">Dog</span><span class="p">{</span>
        <span class="c1">// 无法编译</span>
        <span class="nx">animal</span><span class="p">:</span> <span class="nx">animals</span><span class="p">.</span><span class="nx">animal</span><span class="p">{</span>
            <span class="nx">Name</span><span class="p">:</span> <span class="s">&quot;Chole&quot;</span><span class="p">,</span>
            <span class="nx">Age</span><span class="p">:</span>  <span class="mi">1</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">BarkStrength</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Counter: %#v\n&quot;</span><span class="p">,</span> <span class="nx">dog</span><span class="p">)</span>

    <span class="c1">// Create an object of type Dog from the animals package.</span>
    <span class="nx">dog</span> <span class="o">:=</span> <span class="nx">animals</span><span class="p">.</span><span class="nx">Dog</span><span class="p">{</span>
        <span class="nx">BarkStrength</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1">// 显示访问导出字段来进行初始化</span>
    <span class="nx">dog</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&quot;Chole&quot;</span>
    <span class="nx">dog</span><span class="p">.</span><span class="nx">Age</span> <span class="p">=</span> <span class="mi">1</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Counter: %#v\n&quot;</span><span class="p">,</span> <span class="nx">dog</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="composition">Composition</h3>
<ul>
<li>行为的组合，而不是数据的组合</li>
<li>组合超越了类型嵌入</li>
<li>考虑将行为定义成一个个独立的intreface，然后通过接口组合形成功能更大的接口</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// NailDriver represents behavior to drive nails into a board.</span>
<span class="kd">type</span> <span class="nx">NailDriver</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">DriveNail</span><span class="p">(</span><span class="nx">nailSupply</span> <span class="o">*</span><span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="o">*</span><span class="nx">Board</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// NailPuller represents behavior to remove nails into a board.</span>
<span class="kd">type</span> <span class="nx">NailPuller</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">PullNail</span><span class="p">(</span><span class="nx">nailSupply</span> <span class="o">*</span><span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="o">*</span><span class="nx">Board</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// NailDrivePuller represents behavior to drive and remove nails into a board.</span>
<span class="kd">type</span> <span class="nx">NailDrivePuller</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">NailDriver</span>
    <span class="nx">NailPuller</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>确保每个函数或方法对于它们接受的接口类型都是非常特定的。仅接受您在该函数或方法中使用的行为的接口类型。这将有助于确定所需的较大接口类型。</li>
<li>类型嵌入不是子类型、也不是子类。</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// 面向对象的这种继承的风格</span>
<span class="kd">type</span> <span class="nx">Animal</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">IsMamal</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">Animal</span><span class="p">)</span> <span class="nx">Speak</span><span class="p">()</span> <span class="p">{}</span>

<span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Animal</span>
    <span class="nx">PackFactor</span> <span class="kt">int</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="nx">Dog</span><span class="p">)</span> <span class="nx">Speak</span><span class="p">()</span> <span class="p">{}</span>

<span class="c1">// 基于行为的风格</span>
<span class="kd">type</span> <span class="nx">Speaker</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Speak</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">IsMamal</span> <span class="kt">bool</span>
    <span class="nx">PackFactor</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="nx">Dog</span><span class="p">)</span> <span class="nx">Speak</span><span class="p">()</span> <span class="p">{}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>
<p>是否有必要添加一个接口，checklist如下:</p>
<ol>
<li>package声明了一个接口，该接口与其具体类型的整个API相匹配。</li>
<li>factory函数返回的类型是内部未导出的类型</li>
<li>可以删除该接口，并且对于API用户而言，没有任何更改。</li>
<li>接口未将API与更改分离</li>
</ol>
</li>
</ul>
<p>满足上面条件则没有必要声明接口，下面这个checklist则是需要使用接口的场景:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>1. API的用户需要提供实现细节的时候
2. APi有多个实现的时候
3. 识别出API中可以更改的部分并需要将其去耦合
</code></pre></div>
</td></tr></table>
<ul>
<li>intreface conversion</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="c1">// Mover provides support for moving things.</span>
<span class="kd">type</span> <span class="nx">Mover</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Move</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Locker provides support for locking and unlocking things.</span>
<span class="kd">type</span> <span class="nx">Locker</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Lock</span><span class="p">()</span>
    <span class="nx">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// MoveLocker provides support for moving and locking things.</span>
<span class="kd">type</span> <span class="nx">MoveLocker</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">Mover</span>
    <span class="nx">Locker</span>
<span class="p">}</span>

<span class="c1">// bike represents a concrete type for the example.</span>
<span class="kd">type</span> <span class="nx">bike</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// Move can change the position of a bike.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">bike</span><span class="p">)</span> <span class="nx">Move</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Moving the bike&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Lock prevents a bike from moving.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">bike</span><span class="p">)</span> <span class="nx">Lock</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Locking the bike&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Unlock allows a bike to be moved.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">bike</span><span class="p">)</span> <span class="nx">Unlock</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Unlocking the bike&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>


    <span class="kd">var</span> <span class="nx">ml</span> <span class="nx">MoveLocker</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="nx">Mover</span>

    <span class="c1">// bike实现了move、lock、unlock，满足MoveLocker接口</span>
    <span class="nx">ml</span> <span class="p">=</span> <span class="nx">bike</span><span class="p">{}</span>

    <span class="c1">// 可以隐式转换为接口的子集。</span>
    <span class="c1">// Move接口是MoveLocker接口的子集</span>
    <span class="nx">m</span> <span class="p">=</span> <span class="nx">ml</span>

    <span class="c1">// 但是反过来不可以。</span>
    <span class="nx">ml</span> <span class="p">=</span> <span class="nx">m</span>

    <span class="c1">// 将接口转换为具体的值</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.(</span><span class="nx">bike</span><span class="p">)</span>
    <span class="nx">ml</span> <span class="p">=</span> <span class="nx">b</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Runtime Type Assertions</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// car represents something you drive.</span>
<span class="kd">type</span> <span class="nx">car</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// String implements the fmt.Stringer interface.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">car</span><span class="p">)</span> <span class="nx">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;Vroom!&quot;</span>
<span class="p">}</span>

<span class="nx">mvs</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Stringer</span> <span class="o">:=</span> <span class="nx">car</span><span class="p">{}</span>

<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">is</span> <span class="o">:=</span> <span class="nx">mvs</span><span class="p">.(</span><span class="nx">car</span><span class="p">);</span> <span class="nx">is</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Type assertion success&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="error-handing">Error Handing</h2>
<ul>
<li>当错误的上下文比较复杂的时候，通过创建自定义的错误类型类似承载</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">SyntaxError</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">msg</span>    <span class="kt">string</span> <span class="c1">// description of error</span>
    <span class="nx">Offset</span> <span class="kt">int64</span>  <span class="c1">// error occurred after reading Offset bytes</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">SyntaxError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">msg</span> <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>对于一些静态的、简单的错误可以直接使用标准库中的error</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">Sqrt</span><span class="p">(</span><span class="nx">f</span> <span class="kt">float64</span><span class="p">)</span> <span class="p">(</span><span class="kt">float64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">f</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;math: square root of negative number&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>统一定义Package级别的错误(Err前缀，这是go定义错误的命名规范)</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="p">(</span>
    <span class="nx">ErrInvalidUnreadByte</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;bufio: invalid use of UnreadByte&quot;</span><span class="p">)</span>
    <span class="nx">ErrInvalidUnreadRune</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;bufio: invalid use of UnreadRune&quot;</span><span class="p">)</span>
    <span class="nx">ErrBufferFull</span>        <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;bufio: buffer full&quot;</span><span class="p">)</span>
    <span class="nx">ErrNegativeCount</span>     <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;bufio: negative count&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Peek</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">err</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">ErrNegativeCount</span><span class="p">:</span>
        <span class="c1">// Do something specific.</span>
        <span class="k">return</span>
    <span class="k">case</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">ErrBufferFull</span><span class="p">:</span>
        <span class="c1">// Do something specific.</span>
        <span class="k">return</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="c1">// Do something generic.</span>
        <span class="k">return</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>小心error的比较</li>
</ul>
<p>error是个interface，intreface的比较要看其内部存储的是值还是指针，实际比较的时候是用内部存储的类型来比较的，如果存储的指针，那么总是不相同，
如果存储的是值会进行值的比较。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;errors&quot;</span>
<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// errors.New返回的interface内部存储的是指针</span>
  <span class="nx">a</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;same thing&quot;</span><span class="p">);</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;same thing&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;same&quot;</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;no&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="kd">type</span> <span class="nx">ErrNumber</span> <span class="kt">int64</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">ErrNumber</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;error number&quot;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 比较的是ErrNumber的值，因为ErrNumber是值类型存储在intreface中</span>
    <span class="kd">var</span> <span class="nx">err1</span> <span class="kt">error</span> <span class="p">=</span> <span class="nx">ErrNumber</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">err2</span> <span class="kt">error</span> <span class="p">=</span> <span class="nx">ErrNumber</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err1</span> <span class="o">==</span> <span class="nx">err2</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;same&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;no&quot;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>一旦我们使用指针作为receve就标志着我们只能存储指针到interface中，因此这个时候比较interface就总是比较指针了。这种情况下，可以预先在pacakge级别定义好一系列的错误。这样就可以进行比较了，因为此时的接口都是指向相同的错误变量</p>
</div>
<ul>
<li>小心error的赋值</li>
</ul>
<p>error是个interface，一个interface通常来说内部有两个指针，一个指针指向类型，一个指针指向值，当我们将一个自定义的error类型的nil指针赋值给error的时候，
实际上其类型部分已经不是nil了，只是值的部分是nil而已。一个intreface如果是nil的话，就必须内部的所有指针都是nil。 </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">ErrNumber</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">number</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ErrNumber</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;error number&quot;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">err</span> <span class="o">*</span><span class="nx">ErrNumber</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="kd">var</span> <span class="nx">err2</span> <span class="kt">error</span> <span class="p">=</span> <span class="nx">err</span>

    <span class="c1">// 这里会输出not nil，因为err2的类型部分指向了ErrNumber，只是值的部分是nil而已。</span>
    <span class="k">if</span> <span class="nx">err2</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;not nil&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;nil&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li><code>github.com/pkg/errors</code></li>
</ul>
<p>log和error是需要一起处理的，error的地方都是需要记录日志的，记录的日志需要能够帮助我们debug问题。</p>
<ul>
<li>
<p>面向失败编程，而不是成功，因此Go没有实现异常。</p>
</li>
<li>
<p>错误处理方式的进化之路</p>
</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// Get fetches and unmarshals the JSON blob for the key k into v.</span>
<span class="c1">// If the key is not found, Get reports a &quot;key not found&quot; error.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="nx">Get</span><span class="p">(</span><span class="nx">k</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>

<span class="c1">// 第一种方式，不推荐，错误信息不够，而且也强耦合错误类型</span>
<span class="kd">var</span> <span class="nx">ErrNotFound</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;taildb: key not found&quot;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">val</span> <span class="nx">Value</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;my-key&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">val</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">taildb</span><span class="p">.</span><span class="nx">ErrNotFound</span> <span class="p">{</span>
    <span class="c1">// no such key</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// something went very wrong</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// use val</span>
<span class="p">}</span>

<span class="c1">// 第二种方式，通过定义错误类型，可以承载更多的错误上下文，但是仍然存在问题</span>
<span class="c1">// 当有人在这个错误的基础上又添加了错误，那么在得到错误的时候就不知道到底是何种类型了</span>
<span class="kd">type</span> <span class="nx">KeyNotFoundError</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">KeyNotFoundError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;taildb: key %q not found&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">val</span> <span class="nx">Value</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;my-key&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">val</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">isNotFound</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">taildb</span><span class="p">.</span><span class="nx">KeyNotFoundError</span><span class="p">);</span> <span class="nx">isNotFound</span> <span class="p">{</span>
        <span class="c1">// no such key</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// something went very wrong</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// use val</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">accessCheck</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">taildb</span><span class="p">.</span><span class="nx">Tx</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span> <span class="nx">Value</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">val</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// 错误类型再次被封装了，调用accessCheck的地方就没办法拿到真实的错误了。</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;access check: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">val</span><span class="p">.</span><span class="nx">AccessGranted</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errAccessDenied</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>


<span class="c1">// 第三种方式 通过xerrors库可以保留底层的错误类型，这样我们在调用的地方就可以进行转换了。</span>
<span class="c1">// xerrors在1.13的时候将会成为标准库的一部分，届时通过fmt.Errorf(&quot;%w&quot;)同样可以实现相同的效果。</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">val</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;access check: %w&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">val</span> <span class="nx">Value</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">accessCheck</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="s">&quot;my-key&quot;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">notFoundErr</span> <span class="nx">taildb</span><span class="p">.</span><span class="nx">KeyNotFoundError</span>
    <span class="k">if</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">notFoundErr</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// no such key</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// something went very wrong</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// use val</span>
<span class="p">}</span>



<span class="c1">// 第四种方式，对xerrors的使用做了优化</span>
<span class="kd">var</span> <span class="nx">ErrNotFound</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;key not found&quot;</span><span class="p">)</span>
<span class="nx">Inside</span> <span class="nx">taildb</span> <span class="nx">we</span> <span class="nx">can</span> <span class="nx">write</span><span class="p">:</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="nx">Get</span><span class="p">(</span><span class="nx">k</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="nx">noSuchKey</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;taildb: %q: %w&quot;</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">ErrNotFound</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">val</span> <span class="nx">Value</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">accessCheck</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="s">&quot;my-key&quot;</span><span class="p">);</span> <span class="nx">xerrors</span><span class="p">.</span><span class="nx">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">taildb</span><span class="p">.</span><span class="nx">ErrNotFound</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// no such key</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// something went very wrong</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// use val</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="pacakgeing">Pacakgeing</h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Kit                     Application

├── CONTRIBUTORS        ├── cmd/
├── LICENSE             ├── internal/
├── README.md           │   └── platform/
├── cfg/                └── vendor/
├── examples/
├── log/
├── pool/
├── tcp/
├── timezone/
├── udp/
└── web/
</code></pre></div>
</td></tr></table>
<ul>
<li><code>vendor/</code> 所有依赖的三方库的包都需要copy到这个目录下</li>
<li><code>cmd</code> 所有的项目二进制都放在这个目录下，这个目录下对于每一个二进制程序有单独的目录。</li>
<li><code>internal</code> 需要被多个程序用到的package属于这个目录，使用名称<code>internal/</code>的一个好处是，项目从编译器中获得了额外的保护。
             此项目外部的任何软件包都不能从<code>internal/</code>内部导入软件包。因此，这些软件包仅在此项目内部。</li>
<li><code>internal/platform</code> 基础但特定于项目的软件包位于<code>internal/platform/</code>文件夹中。这些软件包将为数据库，身份验证甚至邮件处理等提供支持。</li>
</ul>
<h2 id="goroutines-and-concurrency">Goroutines And Concurrency</h2>
<p>Goroutines是由Go调度程序创建并独立运行的函数。 Go调度程序负责goroutine的管理和执行。</p>
<ul>
<li>
<p>Goroutines简称为G、Goroutines运行在逻辑处理器上，简称为P，而这个逻辑的处理器和OS提供的Thread绑定在一起，这个Thread简称为M，而这个Thread则有OS负责绑定到一个处理器上运行。</p>
</li>
<li>
<p><code>GODEBUG=schedtrace=1000</code> 输出go runtime的调度trace信息，每隔1000微妙</p>
</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>SCHED 0ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">1</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="nv">threads</span><span class="o">=</span><span class="m">2</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">idlethreads</span><span class="o">=</span><span class="m">0</span>
<span class="nv">runqueue</span><span class="o">=</span><span class="m">0</span> <span class="o">[</span><span class="m">1</span><span class="o">]</span>

SCHED 1009ms<span class="o">(</span>程序运行到现在的时间<span class="o">)</span>: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>配置的逻辑处理器数量<span class="o">)</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="o">(</span>有多少处理器是闲置的<span class="o">)</span>
<span class="nv">threads</span><span class="o">=</span><span class="m">3</span><span class="o">(</span>总共有三个线程运行，其中二个是服务go runtime的，另外一个才是绑定到处理器上运行<span class="o">)</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span> <span class="nv">idlethreads</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>有多少个线程闲置<span class="o">)</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">0</span><span class="o">(</span>有多少协程在全局运行队列<span class="o">)</span> <span class="o">[</span><span class="m">9</span><span class="o">](</span>有多少个协程在本地运行队列<span class="o">)</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>SCHED 2002ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">2</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="nv">threads</span><span class="o">=</span><span class="m">4</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span>
<span class="nv">idlethreads</span><span class="o">=</span><span class="m">1</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">0</span> <span class="o">[</span><span class="m">4</span> <span class="m">4</span><span class="o">]</span>

2002ms        : 在程序运行了2s左右输出的trace信息
<span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">2</span>  : 配置了2个逻辑处理器
<span class="nv">threads</span><span class="o">=</span><span class="m">4</span>     : 有四个线程在运行，2个服务于go runtime，还有2个服务于处理器
<span class="nv">idlethreads</span><span class="o">=</span><span class="m">1</span> : 有1个线程是闲置的
<span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span>   : 有0个处理器是处于闲置状态
<span class="nv">runqueue</span><span class="o">=</span><span class="m">0</span>    : 有0个协程在全局运行队列中
<span class="o">[</span><span class="m">4</span> <span class="m">4</span><span class="o">]</span>         : 每一个处理器上的本地运行队列中都有4个协程在等待被运行。
</code></pre></div>
</td></tr></table>
<ul>
<li><code>GODEBUG=schedtrace=1000,scheddetail=1</code> 显示等详细的调度trace信息</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>SCHED 4028ms: <span class="nv">gomaxprocs</span><span class="o">=</span><span class="m">2</span> <span class="nv">idleprocs</span><span class="o">=</span><span class="m">0</span> <span class="nv">threads</span><span class="o">=</span><span class="m">4</span> <span class="nv">spinningthreads</span><span class="o">=</span><span class="m">0</span>
<span class="nv">idlethreads</span><span class="o">=</span><span class="m">1</span> <span class="nv">runqueue</span><span class="o">=</span><span class="m">2</span> <span class="nv">gcwaiting</span><span class="o">=</span><span class="m">0</span> <span class="nv">nmidlelocked</span><span class="o">=</span><span class="m">0</span> <span class="nv">stopwait</span><span class="o">=</span><span class="m">0</span> <span class="nv">sysmonwait</span><span class="o">=</span><span class="m">0</span>
P0: <span class="nv">status</span><span class="o">=</span><span class="m">1</span> <span class="nv">schedtick</span><span class="o">=</span><span class="m">10</span> <span class="nv">syscalltick</span><span class="o">=</span><span class="m">0</span> <span class="nv">m</span><span class="o">=</span><span class="m">3</span> <span class="nv">runqsize</span><span class="o">=</span><span class="m">3</span> <span class="nv">gfreecnt</span><span class="o">=</span><span class="m">0</span>
P1: <span class="nv">status</span><span class="o">=</span><span class="m">1</span> <span class="nv">schedtick</span><span class="o">=</span><span class="m">10</span> <span class="nv">syscalltick</span><span class="o">=</span><span class="m">1</span> <span class="nv">m</span><span class="o">=</span><span class="m">2</span> <span class="nv">runqsize</span><span class="o">=</span><span class="m">3</span> <span class="nv">gfreecnt</span><span class="o">=</span><span class="m">0</span>
M3: <span class="nv">p</span><span class="o">=</span><span class="m">0</span> <span class="nv">curg</span><span class="o">=</span><span class="m">4</span> <span class="nv">mallocing</span><span class="o">=</span><span class="m">0</span> <span class="nv">throwing</span><span class="o">=</span><span class="m">0</span> <span class="nv">gcing</span><span class="o">=</span><span class="m">0</span> <span class="nv">locks</span><span class="o">=</span><span class="m">0</span> <span class="nv">dying</span><span class="o">=</span><span class="m">0</span> <span class="nv">helpgc</span><span class="o">=</span><span class="m">0</span> <span class="nv">spinning</span><span class="o">=</span><span class="m">0</span> <span class="nv">blocked</span><span class="o">=</span><span class="m">0</span> <span class="nv">lockedg</span><span class="o">=</span>-1
M2: <span class="nv">p</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>表示这个线程绑定在哪个处理器上了<span class="o">)</span> <span class="nv">curg</span><span class="o">=</span><span class="m">10</span> <span class="nv">mallocing</span><span class="o">=</span><span class="m">0</span> <span class="nv">throwing</span><span class="o">=</span><span class="m">0</span> <span class="nv">gcing</span><span class="o">=</span><span class="m">0</span> <span class="nv">locks</span><span class="o">=</span><span class="m">0</span> <span class="nv">dying</span><span class="o">=</span><span class="m">0</span> <span class="nv">helpgc</span><span class="o">=</span><span class="m">0</span> <span class="nv">spinning</span><span class="o">=</span><span class="m">0</span> <span class="nv">blocked</span><span class="o">=</span><span class="m">0</span> <span class="nv">lockedg</span><span class="o">=</span>-1
M1: <span class="nv">p</span><span class="o">=</span>-1 <span class="nv">curg</span><span class="o">=</span>-1 <span class="nv">mallocing</span><span class="o">=</span><span class="m">0</span> <span class="nv">throwing</span><span class="o">=</span><span class="m">0</span> <span class="nv">gcing</span><span class="o">=</span><span class="m">0</span> <span class="nv">locks</span><span class="o">=</span><span class="m">1</span> <span class="nv">dying</span><span class="o">=</span><span class="m">0</span> <span class="nv">helpgc</span><span class="o">=</span><span class="m">0</span> <span class="nv">spinning</span><span class="o">=</span><span class="m">0</span> <span class="nv">blocked</span><span class="o">=</span><span class="m">0</span> <span class="nv">lockedg</span><span class="o">=</span>-1
M0: <span class="nv">p</span><span class="o">=</span>-1 <span class="nv">curg</span><span class="o">=</span>-1 <span class="nv">mallocing</span><span class="o">=</span><span class="m">0</span> <span class="nv">throwing</span><span class="o">=</span><span class="m">0</span> <span class="nv">gcing</span><span class="o">=</span><span class="m">0</span> <span class="nv">locks</span><span class="o">=</span><span class="m">0</span> <span class="nv">dying</span><span class="o">=</span><span class="m">0</span> <span class="nv">helpgc</span><span class="o">=</span><span class="m">0</span> <span class="nv">spinning</span><span class="o">=</span><span class="m">0</span> <span class="nv">blocked</span><span class="o">=</span><span class="m">0</span> <span class="nv">lockedg</span><span class="o">=</span>-1
G1: <span class="nv">status</span><span class="o">=</span><span class="m">4</span><span class="o">(</span>semacquire<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G2: <span class="nv">status</span><span class="o">=</span><span class="m">4</span><span class="o">(</span>force gc <span class="o">(</span>idle<span class="o">))</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G3: <span class="nv">status</span><span class="o">=</span><span class="m">4</span><span class="o">(</span>GC sweep <span class="nb">wait</span><span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G4: <span class="nv">status</span><span class="o">=</span><span class="m">2</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span><span class="m">3</span> <span class="nv">lockedm</span><span class="o">=</span>-1
G5: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G6: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>stack growth<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G7: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G8: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G9: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>stack growth<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G10: <span class="nv">status</span><span class="o">=</span><span class="m">2</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span><span class="m">2</span><span class="o">(</span>表示这个协程此时在哪个线程中运行<span class="o">)</span> <span class="nv">lockedm</span><span class="o">=</span>-1
G11: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G12: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G13: <span class="nv">status</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>sleep<span class="o">)</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
G17: <span class="nv">status</span><span class="o">=</span><span class="m">4</span><span class="o">(</span>timer goroutine <span class="o">(</span>idle<span class="o">))</span> <span class="nv">m</span><span class="o">=</span>-1 <span class="nv">lockedm</span><span class="o">=</span>-1
</code></pre></div>
</td></tr></table>
<p>P表示处理器、M表示线程、G表示协程。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>status: http://golang.org/src/runtime/
Gidle,            // <span class="m">0</span>
Grunnable,        // <span class="m">1</span> runnable and on a run queue
Grunning,         // <span class="m">2</span> running
Gsyscall,         // <span class="m">3</span> performing a syscall
Gwaiting,         // <span class="m">4</span> waiting <span class="k">for</span> the runtime
Gmoribund_unused, // <span class="m">5</span> currently unused, but hardcoded <span class="k">in</span> gdb scripts
Gdead,            // <span class="m">6</span> goroutine is dead
Genqueue,         // <span class="m">7</span> only the Gscanenqueue is used
Gcopystack,       // <span class="m">8</span> <span class="k">in</span> this state when newstack is moving the stack
</code></pre></div>
</td></tr></table>
<ul>
<li>
<p><code>GOMAXPROCS</code> 控制go协程可以在多少个core上运行。</p>
</li>
<li>
<p>Concurrency Pattern</p>
<ul>
<li>
<p>Generator</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">boring</span><span class="p">(</span><span class="s">&quot;boring!&quot;</span><span class="p">)</span> <span class="c1">// Function returning a channel.</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;You say: %q\n&quot;</span><span class="p">,</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;You&#39;re boring; I&#39;m leaving.&quot;</span><span class="p">)</span>

    <span class="kd">func</span> <span class="nx">boring</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">string</span> <span class="p">{</span> <span class="c1">// Returns receive-only channel of strings.</span>
        <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">)</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// We launch the goroutine from inside the function.</span>
            <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
                <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s %d&quot;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
                <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="mf">1e3</span><span class="p">))</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}()</span>
        <span class="k">return</span> <span class="nx">c</span> <span class="c1">// Return the channel to the caller.</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>上面的代码存在协程泄漏，需要考虑加入context</p>
</div>
</li>
<li>
<p>Fan in</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">cs</span> <span class="o">...&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
    <span class="nx">out</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>

    <span class="c1">// Start an output goroutine for each input channel in cs.  output</span>
    <span class="c1">// copies values from c to out until c is closed, then calls wg.Done.</span>
    <span class="nx">output</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span> <span class="p">{</span>
            <span class="nx">out</span> <span class="o">&lt;-</span> <span class="nx">n</span>
        <span class="p">}</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cs</span> <span class="p">{</span>
        <span class="k">go</span> <span class="nx">output</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Start a goroutine to close out once all the output goroutines are</span>
    <span class="c1">// done.  This must start after the wg.Add call.</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
        <span class="nb">close</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">out</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>Fan out</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">fanOutSem</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">emps</span> <span class="o">:=</span> <span class="mi">2000</span>
    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">emps</span><span class="p">)</span>

    <span class="nx">g</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">GOMAXPROCS</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="nx">sem</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">g</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">e</span> <span class="p">&lt;</span> <span class="nx">emps</span><span class="p">;</span> <span class="nx">e</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">emp</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sem</span> <span class="o">&lt;-</span> <span class="kc">true</span>
            <span class="p">{</span>
                <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
                <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="s">&quot;paper&quot;</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;employee : sent signal :&quot;</span><span class="p">,</span> <span class="nx">emp</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="o">&lt;-</span><span class="nx">sem</span>
        <span class="p">}(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">emps</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span>
        <span class="nx">emps</span><span class="o">--</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;manager : recv&#39;d signal :&quot;</span><span class="p">,</span> <span class="nx">emps</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>Drop</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">drop</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">cap</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cap</span><span class="p">)</span>

    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ch</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;employee : recv&#39;d signal :&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="kd">const</span> <span class="nx">work</span> <span class="p">=</span> <span class="mi">2000</span>
    <span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">w</span> <span class="p">&lt;</span> <span class="nx">work</span><span class="p">;</span> <span class="nx">w</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="s">&quot;paper&quot;</span><span class="p">:</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;manager : sent signal :&quot;</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;manager : dropped data :&quot;</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;manager : sent shutdown signal&quot;</span><span class="p">)</span>

    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>pooling</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">pooling</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">)</span>

    <span class="nx">g</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">GOMAXPROCS</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">e</span> <span class="p">&lt;</span> <span class="nx">g</span><span class="p">;</span> <span class="nx">e</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">emp</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ch</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;employee %d : recv&#39;d signal : %s\n&quot;</span><span class="p">,</span> <span class="nx">emp</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;employee %d : recv&#39;d shutdown signal\n&quot;</span><span class="p">,</span> <span class="nx">emp</span><span class="p">)</span>
        <span class="p">}(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">work</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">w</span> <span class="p">&lt;</span> <span class="nx">work</span><span class="p">;</span> <span class="nx">w</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="s">&quot;paper&quot;</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;manager : sent signal :&quot;</span><span class="p">,</span> <span class="nx">w</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;manager : sent shutdown signal&quot;</span><span class="p">)</span>

    <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</li>
<li>
<p>Pipeline</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">gen</span><span class="p">(</span><span class="nx">nums</span> <span class="o">...</span><span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">out</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nums</span> <span class="p">{</span>
            <span class="nx">out</span> <span class="o">&lt;-</span> <span class="nx">n</span>
        <span class="p">}</span>
        <span class="nb">close</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">out</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">sq</span><span class="p">(</span><span class="nx">in</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">out</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">in</span> <span class="p">{</span>
            <span class="nx">out</span> <span class="o">&lt;-</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">n</span>
        <span class="p">}</span>
        <span class="nb">close</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">out</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Set up the pipeline and consume the output.</span>
    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sq</span><span class="p">(</span><span class="nx">sq</span><span class="p">(</span><span class="nx">gen</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="c1">// 16 then 81</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</li>
</ul>
</li>
</ul>
<h2 id="data-race">Data Race</h2>
<ul>
<li><code>go build -race/go test -race</code> 开启race检测</li>
<li>map默认自带race检测</li>
<li>对于接口的read/write是存在data race的，因为interface是个双字大小的类型，赋值的时候不是原子的，需要修改指向的类型，还需要修改指向的值。</li>
</ul>
<h2 id="channels">Channels</h2>
<p>channels允许goroutines通过信号语义相互通信，Channels通过使用发送/接收数据或通过识别各个Channels上的状态变化来完成此信号。
不要以Channels是队列的思想来设计软件，而要专注于信号语义来简化同步。</p>
<ul>
<li>
<p>使用channels编排和协调goroutine</p>
<ol>
<li>关注channels提供的信令语义，而不是数据共享。</li>
<li>信号分为有数据和无数据的。</li>
<li>对于使用channels来作为数据共享的场景需要质疑</li>
</ol>
</li>
<li>
<p>Unbuffered channels</p>
<ol>
<li>接收发生在发送之前</li>
<li>100%保证信号到达</li>
<li>对于何时收到信号是未知的，因为你发送的时候，接收端可能还没有在接收</li>
</ol>
</li>
<li>
<p>Buffered channels</p>
<ol>
<li>发送发生在接收前</li>
<li>减少了信号之间的阻塞延迟，多次信号发送之间是没有延迟的</li>
<li>不保证信号被接收了，可能一直在队列中<ul>
<li>缓冲区越大，保证越少</li>
<li>缓冲区为1的话，可以保证只有一个信号被延迟发送。</li>
</ul>
</li>
</ol>
</li>
<li>
<p>Closing channels</p>
<ol>
<li>Close发生在接收前</li>
<li>是一种没有数据的信号</li>
<li>用于取消或者是deadline是最佳的</li>
</ol>
</li>
<li>
<p>NIL channels</p>
<ol>
<li>发送和接收是阻塞的</li>
<li>关闭了信号</li>
<li>非常适合速率限制或短期停工</li>
</ol>
</li>
<li>
<p>往Closed的channel发送信号会导致panic，但是接收是可以的，会立即返回。</p>
</li>
<li>
<p>close channel或者是对struct{}类型的channel进行send属于无数据的信号，这类信号通常用于stop、cannecel等场景。也可以使用Context</p>
</li>
</ul>
<p>Channels内部是一个hchan结构，这个结构大致如下:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">hchan</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">buf</span>  <span class="nx">CircularQueue</span>
    <span class="nx">sendx</span> <span class="kt">uint64</span>
    <span class="nx">recvx</span> <span class="kt">uint64</span>
    <span class="nx">lock</span> <span class="nx">mutex</span>
    <span class="nx">sendq</span> <span class="nx">sudog</span>
    <span class="nx">recvq</span> <span class="nx">sudog</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">sudog</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">G</span> <span class="nx">Coroutine</span>
    <span class="nx">elem</span> <span class="nx">T</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>一个circular queue，chan的读和写实际就是操作sendx、recvx、chan本身其实就是一个指向hchan的指针。当chan是buffer的channel的时候写入和读取就是简单的加锁然后移动sendx、recvx
当chan为unbuffer或者buffer满的时候发生写入或者buffer空的时候发生读取的时候都会导致阻塞，这个时候go runtime会调用gopark把当前协程的状态设置为waitting，然后从当前协程中移除
放入全局队列中。然后这个协程所对应的OS Thread会继续从可运行队列中运行下一个协程。然后把当前协程和要写入的值放入一个类为sudog的send queue中。当有receive从协程接收的时候会
从send queue中出队，把值放到circular queue中或者如果是一个unbuffered的chan则直接赋值给receiver，最后调用go runtime中的goready将当前协程设置为runable。等待调度到OS Thread中
被运行。同样当receive出现阻塞的时候，过程和send类似。</p>
<h2 id="context">Context</h2>
<ul>
<li>Context提供了key-value的映射，key和value都是<code>interface{}</code>类型，key必须具备相等性比较，而value则允许被多个协程安全的使用。 </li>
<li>到server的请求应该创建一个Context</li>
<li>从Server中发出的请求应该可以接收Context参数</li>
<li>进来的请求和出去的请求之间必须能否传递Context</li>
<li>取消Context后，从该Context派生的所有Context也会被取消</li>
<li>不要将上下文存储在结构类型中；而是将上下文明确传递给需要它的每个函数</li>
<li>即使函数允许，也不要传递nil Context。如果不确定使用哪个上下文，请传递context.TODO。</li>
<li>仅将上下文值用于请求范围的进程和API间的传递，而不用于将可选参数传递给函数。</li>
<li>可以将相同的上下文传递给在不同goroutine中运行的函数。上下文对于由多个goroutine同时使用是安全的。</li>
</ul>
<h2 id="testing">Testing</h2>
<ul>
<li>使用httptest来做mockClient</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">handlers</span><span class="p">.</span><span class="nx">Routes</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// TestSendJSON testing the sendjson internal endpoint.</span>
<span class="kd">func</span> <span class="nx">TestSendJSON</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">url</span> <span class="o">:=</span> <span class="s">&quot;/sendjson&quot;</span>
    <span class="nx">statusCode</span> <span class="o">:=</span> <span class="mi">200</span>

    <span class="nx">t</span><span class="p">.</span><span class="nx">Log</span><span class="p">(</span><span class="s">&quot;Given the need to test the SendJSON endpoint.&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">r</span> <span class="o">:=</span> <span class="nx">httptest</span><span class="p">.</span><span class="nx">NewRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="nx">w</span> <span class="o">:=</span> <span class="nx">httptest</span><span class="p">.</span><span class="nx">NewRecorder</span><span class="p">()</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">DefaultServeMux</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>

        <span class="nx">testID</span> <span class="o">:=</span> <span class="mi">0</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\tTest %d:\tWhen checking %q for status code %d&quot;</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Code</span> <span class="o">!=</span> <span class="mi">200</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould receive a status code of %d for the response. Received[%d].&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Code</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould receive a status code of %d for the response.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>

            <span class="kd">var</span> <span class="nx">u</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Name</span>  <span class="kt">string</span>
                <span class="nx">Email</span> <span class="kt">string</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewDecoder</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">Body</span><span class="p">).</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">u</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould be able to decode the response.&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould be able to decode the response.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">)</span>

            <span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Name</span> <span class="o">==</span> <span class="s">&quot;Bill&quot;</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould have \&quot;Bill\&quot; for Name in the response.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould have \&quot;Bill\&quot; for Name in the response : %q&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="o">==</span> <span class="s">&quot;bill@ardanlabs.com&quot;</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould have \&quot;bill@ardanlabs.com\&quot; for Email in the response.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould have \&quot;bill@ardanlabs.com\&quot; for Email in the response : %q&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>使用httptest来做mockServer</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// mockServer returns a pointer to a server to handle the mock get call.</span>
<span class="kd">func</span> <span class="nx">mockServer</span><span class="p">()</span> <span class="o">*</span><span class="nx">httptest</span><span class="p">.</span><span class="nx">Server</span> <span class="p">{</span>
    <span class="nx">f</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">Header</span><span class="p">().</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/xml&quot;</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintln</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">feed</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">httptest</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">f</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// TestDownload validates the http Get function can download content and</span>
<span class="c1">// the content can be unmarshaled and clean.</span>
<span class="kd">func</span> <span class="nx">TestDownload</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">statusCode</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span>

    <span class="nx">server</span> <span class="o">:=</span> <span class="nx">mockServer</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">server</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="nx">t</span><span class="p">.</span><span class="nx">Log</span><span class="p">(</span><span class="s">&quot;Given the need to test downloading content.&quot;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">testID</span> <span class="o">:=</span> <span class="mi">0</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\tTest %d:\tWhen checking %q for status code %d&quot;</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould be able to make the Get call : %v&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould be able to make the Get call.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">)</span>

            <span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

            <span class="k">if</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">!=</span> <span class="nx">statusCode</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould receive a %d status code : %v&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould receive a %d status code.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>

            <span class="kd">var</span> <span class="nx">d</span> <span class="nx">Document</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">xml</span><span class="p">.</span><span class="nx">NewDecoder</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">).</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">d</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould be able to unmarshal the response : %v&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould be able to unmarshal the response.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Channel</span><span class="p">.</span><span class="nx">Items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Logf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould have 1 item in the feed.&quot;</span><span class="p">,</span> <span class="nx">succeed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;\t%s\tTest %d:\tShould have 1 item in the feed : %d&quot;</span><span class="p">,</span> <span class="nx">failed</span><span class="p">,</span> <span class="nx">testID</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Channel</span><span class="p">.</span><span class="nx">Items</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h2 id="compile-args">Compile args</h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">panic</span><span class="p">:</span> <span class="nx">Aw</span><span class="p">,</span> <span class="nx">snap</span>
 <span class="nx">goroutine</span> <span class="mi">1</span> <span class="p">[</span><span class="nx">running</span><span class="p">]:</span>
 <span class="nx">main</span><span class="p">.</span><span class="nx">main</span><span class="p">()</span>
         <span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">johnpili</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="nx">company</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">event</span><span class="o">-</span><span class="nx">document</span><span class="o">-</span><span class="nx">pusher</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">42</span> <span class="o">+</span><span class="mh">0x3e</span>

<span class="p">&gt;</span> <span class="k">go</span> <span class="nx">build</span> <span class="o">-</span><span class="nx">trimpath</span>

<span class="nx">panic</span><span class="p">:</span> <span class="nx">Aw</span><span class="p">,</span> <span class="nx">snap</span>
 <span class="nx">goroutine</span> <span class="mi">1</span> <span class="p">[</span><span class="nx">running</span><span class="p">]:</span>
 <span class="nx">main</span><span class="p">.</span><span class="nx">main</span><span class="p">()</span>
         <span class="nx">src</span><span class="o">/</span><span class="nx">company</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">event</span><span class="o">-</span><span class="nx">document</span><span class="o">-</span><span class="nx">pusher</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">42</span> <span class="o">+</span><span class="mh">0x3e</span>
</code></pre></div>
</td></tr></table>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://docs.google.com/document/d/1wAaf1rYoM4S4gtnPh0zOlGzWtrZFQ5suE8qr2sD8uWQ/pub">Contiguous stacks</a></li>
<li><a href="https://blog.cloudflare.com/how-stacks-are-handled-in-go/">How Stacks are Handled in Go</a></li>
<li><a href="https://github.com/qcrao/Go-Questions/blob/master/GC/GC.md">gc</a></li>
<li><a href="https://docs.google.com/document/d/1CxgUBPlx9iJzkz9JWkb6tIpTe5q32QDmz8l0BouG0Cw/edit">Go Escape Analysis Flaws</a></li>
</ul>
<h2 id="reading-todo">Reading TODO</h2>
<ul>
<li>https://brunocalza.me/how-buffer-pool-works-an-implementation-in-go/</li>
<li>https://www.youtube.com/watch?v=f6kdp27TYZs</li>
<li>https://talks.golang.org/2013/advconc.slide#1</li>
<li>https://steveazz.xyz/blog/go-performance-tools-cheat-sheet/</li>
</ul>
                
                  
                
              
              
                
<script src="https://utteranc.es/client.js"
        repo="zyfjeff/zyfjeff.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../6.824/lecture1/paper-note/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Paper note" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Paper note
            </div>
          </div>
        </a>
      
      
        
        <a href="../%E4%BF%A1%E6%81%AF%E8%AE%BA/note/" class="md-footer__link md-footer__link--next" aria-label="下一页: Note" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Note
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 - 2021 程序员的Cookbook
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/zyfjeff" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "toc.integrate"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
    
  </body>
</html>